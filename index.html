<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jerry - Mental Health Companion</title>
    
    <!-- PWA Meta Tags -->
    <link rel="icon" type="image/png" sizes="32x32" href="JerryIcon.png">
    <link rel="apple-touch-icon" href="JerryIcon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3355d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Jerry">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #jerrySprite {
            position: relative;
            width: 160px; /* 16 pixels * 10 per pixel */
            height: 160px;
            transform-origin: center bottom;
            transition: transform 0.3s ease-in-out;
        }

        #jerrySprite.bounce {
            transform: scale(1.1);
        }


        /* Light Theme Overrides */
        body.light-theme {
            background: linear-gradient(135deg, #fdf6f0 0%, #f7ede5 100%);
            color: #3e3e3e;
        }

        body.light-theme .app-container {
            background: #f7ede5;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        body.light-theme .affirmation-banner {
            background: linear-gradient(90deg, #e3b88d, #f0c9a2);
            color: #3e3e3e;
        }

        body.light-theme .tab-container {
            background: #eae3de;
            border-bottom: 1px solid #d8cfc4;
        }

        body.light-theme .tab {
            color: #6b7280;
        }

        body.light-theme .tab.active {
            color: #e3b88d;
            background: #f7ede5;
            border-bottom: 2px solid #e3b88d;
        }

        body.light-theme .tab:hover {
            background: rgba(227,184,141,0.1);
            color: #c27c48;
        }

        body.light-theme .screen {
            background-color: #f7ede5;
        }

        body.light-theme .form-label {
            color: #4b4b4b;
        }

        body.light-theme .form-input,
        body.light-theme .form-textarea {
            background: #ffffff;
            border: 1px solid #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .form-input:focus {
            border-color: #e3b88d;
        }

        body.light-theme .btn {
            background: #e3b88d;
            color: #3e3e3e;
        }

        body.light-theme .btn:hover {
            background: #cfa273;
        }

        body.light-theme .btn-secondary {
            background: #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .btn-secondary:hover {
            background: #cbb7a2;
        }

        body.light-theme .rating-btn {
            background: #ffffff;
            border: 1px solid #d8cfc4;
            color: #6b7280;
        }

        body.light-theme .rating-btn.active,
        body.light-theme .rating-btn:hover {
            background: #e3b88d;
            color: #3e3e3e;
            border-color: #e3b88d;
        }

        body.light-theme .timer-display {
            color: #e3b88d;
        }

        body.light-theme .progress-section,
        body.light-theme .entry-item,
        body.light-theme .checkbox-container {
            background: #ffffff;
            border-color: #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .notification {
            background: #e3b88d;
            color: #3e3e3e;
        }

        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            background: #1a202c;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .affirmation-banner {
            background: linear-gradient(90deg, #3355d4, #4f46e5);
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            color: white;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-container {
            display: flex;
            background: #2d3748;
            border-bottom: 1px solid #4a5568;
        }
        
        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tab.active {
            color: #3355d4;
            background: #1a202c;
            border-bottom: 2px solid #3355d4;
        }
        
        .tab:hover {
            background: rgba(51, 85, 212, 0.1);
            color: #63b3ed;
        }
        
        .screen {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 120px);
        }
        
        .screen.active {
            display: block;
        }
        
        /* Jerry Sprite Styles */
        .jerry-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .jerry-sprite {
            width: 160px;
            height: 160px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .pixel {
            width: 10px;
            height: 10px;
            position: absolute;
            border-radius: 1px;
        }
        
        .jerry-stats {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }
        
        .stat-bar {
            margin-bottom: 12px;
        }
        
        .stat-label {
            font-size: 12px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .clarity-bar { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
        .insight-bar { background: linear-gradient(90deg, #8b5cf6, #5b21b6); }
        .calm-bar { background: linear-gradient(90deg, #10b981, #047857); }
        
        /* Chat Interface */
        .chat-container {
            background: #2d3748;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-log {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: #1a202c;
            border-radius: 8px;
        }
        
        .message {
            margin-bottom: 12px;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .message.user {
            color: #63b3ed;
        }
        
        .message.jerry {
            color: #68d391;
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 20px;
            color: #e2e8f0;
            outline: none;
            font-size: 14px;
        }
        
        .send-button {
            background: #3355d4;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .send-button:hover {
            background: #2d4aa7;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #cbd5e0;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #3355d4;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            background: #3355d4;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-align: center;
            text-decoration: none;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .btn:hover {
            background: #2d4aa7;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #2d3748;
        }
        
        /* Rating buttons */
        .rating-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .rating-btn {
            flex: 1;
            padding: 8px;
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #a0aec0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .rating-btn.active,
        .rating-btn:hover {
            background: #3355d4;
            color: white;
            border-color: #3355d4;
        }
        
        /* Timer Styles */
        .timer-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #3355d4;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
        }
        
        .timer-btn {
            font-size: 18px;
            padding: 16px 32px;
            border-radius: 50px;
        }
        
        /* Progress Tracking */
        .progress-section {
            background: #2d3748;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .progress-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e2e8f0;
        }
        
        /* Entries and History */
        .entry-item {
            background: #2d3748;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3355d4;
        }
        
        .entry-date {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 8px;
        }
        
        .entry-content {
            line-height: 1.5;
        }
        
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px;
            background: #2d3748;
            border-radius: 6px;
        }
        
        .checkbox {
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .checkbox-label {
            flex: 1;
            line-height: 1.4;
            font-size: 14px;
        }
        
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .jerry-sprite {
                width: 120px;
                height: 120px;
            }
            
            .pixel {
                width: 7.5px;
                height: 7.5px;
            }
            
            .timer-display {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="affirmation-banner" id="affirmationBanner">
            Your feelings are valid, even the difficult ones.
        </div>
        
        <div class="tab-container">
            <button class="tab active" onclick="switchTab('jerry')">Jerry</button>
            <button class="tab" onclick="switchTab('checkin')">Check-in</button>
            <button class="tab" onclick="switchTab('cbt')">CBT</button>
            <button class="tab" onclick="switchTab('dbt')">DBT</button>
            <button class="tab" onclick="switchTab('hush')">Hush</button>
            <button class="tab" onclick="switchTab('entries')">Entries</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('settings')">Settings</button>
        </div>
        
        <!-- Jerry Screen -->
        <div class="screen active" id="jerry">
            <div class="jerry-container">
                <div class="jerry-sprite" id="jerrySprite"></div>
                <div class="jerry-stats">
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Clarity</span>
                            <span id="clarityValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill clarity-bar" id="clarityBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Insight</span>
                            <span id="insightValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill insight-bar" id="insightBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Calm</span>
                            <span id="calmValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill calm-bar" id="calmBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span id="levelLabel">Level 1</span>
                            <span id="xpLabel">XP: 0 / 100</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-log" id="chatLog">
                    <div class="message jerry">It's good to see you again.</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." 
                           onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-button" onclick="sendMessage()">â†’</button>
                </div>
            </div>
        </div>
        
        <!-- Check-in Screen -->
        <div class="screen" id="checkin">
            <h2 style="margin-bottom: 20px;">Daily Check-in</h2>
            <div id="checkinContent">
                <div class="form-group">
                    <div class="form-label">How are you feeling emotionally?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse('emotion', 'Good')">Good</button>
                        <button class="rating-btn" onclick="setCheckinResponse('emotion', 'Okay')">Okay</button>
                        <button class="rating-btn" onclick="setCheckinResponse('emotion', 'Bad')">Bad</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your body feeling?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse('physical', 'Energetic')">Energetic</button>
                        <button class="rating-btn" onclick="setCheckinResponse('physical', 'Tired')">Tired</button>
                        <button class="rating-btn" onclick="setCheckinResponse('physical', 'Pain')">Pain</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your mind today?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse('mental', 'Clear')">Clear</button>
                        <button class="rating-btn" onclick="setCheckinResponse('mental', 'Foggy')">Foggy</button>
                        <button class="rating-btn" onclick="setCheckinResponse('mental', 'Overwhelmed')">Overwhelmed</button>
                    </div>
                </div>
                <button class="btn" onclick="completeCheckin()">Complete Check-in</button>
            </div>
        </div>
        
        <!-- CBT Screen -->
        <div class="screen" id="cbt">
            <h2 style="margin-bottom: 20px;">CBT Thought Record</h2>
            <div id="cbtContent">
                <div class="form-group">
                    <label class="form-label" for="cbtSituation">What was the situation or event that triggered the difficult feeling?</label>
                    <textarea class="form-input form-textarea" id="cbtSituation" placeholder="e.g., I had a disagreement with a friend."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtEmotions">What emotions did you feel? (e.g., sad, angry, anxious)</label>
                    <textarea class="form-input form-textarea" id="cbtEmotions" placeholder="List the primary emotions."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtThoughts">What were the automatic thoughts that went through your mind?</label>
                    <textarea class="form-input form-textarea" id="cbtThoughts" placeholder="What did you immediately think or believe?"></textarea>
                </div>
                
                <h3 style="margin: 20px 0 12px;">Which cognitive distortions apply?</h3>
                <div id="cbtDistortions">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="allOrNothing">
                        <label class="checkbox-label" for="allOrNothing"><strong>All-or-Nothing Thinking:</strong> Viewing things in black-and-white categories.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="overgeneralization">
                        <label class="checkbox-label" for="overgeneralization"><strong>Overgeneralization:</strong> Seeing a single negative event as a never-ending pattern of defeat.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mentalFilter">
                        <label class="checkbox-label" for="mentalFilter"><strong>Mental Filter:</strong> Picking out a single negative detail and dwelling on it exclusively.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="jumpingConclusions">
                        <label class="checkbox-label" for="jumpingConclusions"><strong>Jumping to Conclusions:</strong> Making a negative interpretation despite no definite facts.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionalReasoning">
                        <label class="checkbox-label" for="emotionalReasoning"><strong>Emotional Reasoning:</strong> Assuming that your negative emotions necessarily reflect the way things really are.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="shouldStatements">
                        <label class="checkbox-label" for="shouldStatements"><strong>Should Statements:</strong> Motivating yourself with 'shoulds' and 'shouldn'ts'.</label>
                    </div>
                </div>
                
                <button class="btn" onclick="completeCBT()">Complete CBT Session</button>
            </div>
        </div>
        
        <!-- DBT Screen -->
        <div class="screen" id="dbt">
            <h2 style="margin-bottom: 20px;">DBT Skills Check</h2>
            <div id="dbtContent">
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your ANGER (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('anger', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SADNESS (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('sadness', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your FEAR (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('fear', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SHAME (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('shame', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 5)">5</button>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 12px;">DBT Skills to Practice</h3>
                <div id="dbtSkills">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mindfulness">
                        <label class="checkbox-label" for="mindfulness"><strong>Mindfulness:</strong> Observe, Describe, Participate</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="distressTolerance">
                        <label class="checkbox-label" for="distressTolerance"><strong>Distress Tolerance:</strong> TIP, ACCEPTS, Self-Soothe</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionRegulation">
                        <label class="checkbox-label" for="emotionRegulation"><strong>Emotion Regulation:</strong> Check the Facts, Opposite Action</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="interpersonalEffectiveness">
                        <label class="checkbox-label" for="interpersonalEffectiveness"><strong>Interpersonal Effectiveness:</strong> DEAR MAN, GIVE, FAST</label>
                    </div>
                </div>
                
                <button class="btn" onclick="completeDBT()">Complete DBT Session</button>
            </div>
        </div>
        
        <!-- Hush Timer Screen -->
        <div class="screen" id="hush">
            <div class="timer-container">
                <h2 style="margin-bottom: 30px;">Mindfulness Timer</h2>
                <div class="timer-display" id="timerDisplay">03:00</div>
                <button class="btn timer-btn" id="timerButton" onclick="toggleTimer()">Start</button>
            </div>
        </div>
        
        <!-- Entries Screen -->
        <div class="screen" id="entries">
            <h2 style="margin-bottom: 20px;">Your Entries</h2>
            <div id="entriesList">
                <!-- Entries will be populated here -->
            </div>
        </div>
        
        <!-- History Screen -->
        <div class="screen" id="history">
            <h2 style="margin-bottom: 20px;">Conversation History</h2>
            <div id="historyList">
                <!-- History will be populated here -->
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div class="screen" id="settings">
            <h2 style="margin-bottom: 20px;">Settings</h2>
            <div class="form-group">
                <label class="form-label" for="apiKey">Google API Key</label>
                <input type="text" class="form-input" id="apiKey" placeholder="Enter your API key here.">
            </div>
            <button class="btn" onclick="saveSettings()">Save Settings</button>
            
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Theme</h3>
                <button class="btn btn-secondary" onclick="toggleTheme()">Toggle Dark/Light Mode</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Application State
        const appState = {
            jerry: {
                needs: { clarity: 100, insight: 100, calm: 100 },
                lastFed: { clarity: Date.now(), insight: Date.now(), calm: Date.now() },
                level: 1,
                xp: 0,
                xpToNext: 100
            },
            apiKey: localStorage.getItem('hush_api_key') || '',
            currentTab: 'jerry',
            checkinData: {},
            cbtData: {},
            dbtData: {},
            chatHistory: [],
            entries: JSON.parse(localStorage.getItem('hush_entries') || '[]'),
            conversationHistory: JSON.parse(localStorage.getItem('hush_conversations') || '[]'),
            timer: {
                active: false,
                remaining: 180,
                interval: null
            }
        };

        // Jerry Sprite Data
        const jerrySprites = {
            content: [
                [0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0],
                [0,0,3,3,1,1,1,1,1,1,1,1,3,3,0,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [3,1,1,1,1,2,2,1,1,1,2,2,1,1,1,3],
                [3,1,1,1,1,2,2,1,1,1,2,2,1,1,1,3],
                [3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],
                [3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],
                [3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],
                [3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,0,3,3,1,1,1,1,1,1,1,1,3,3,0,0],
                [0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
            lowInsight: [
                [0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0],
                [0,0,3,3,1,1,1,1,1,1,1,1,3,3,0,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [3,1,1,1,4,4,1,1,1,1,4,4,1,1,1,3],
                [3,1,1,1,1,4,4,1,1,4,4,1,1,1,1,3],
                [3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],
                [3,1,1,1,1,1,1,4,4,1,1,1,1,1,1,3],
                [3,1,1,1,1,1,4,1,1,4,1,1,1,1,1,3],
                [3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,0,3,3,1,1,1,1,1,1,1,1,3,3,0,0],
                [0,0,0,0,3,3,3,3,3,3,3,3,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
            lowCalm: [
                [0,0,0,3,3,3,3,3,3,3,3,3,0,0,0,0],
                [0,0,3,1,1,1,1,1,1,1,1,1,3,0,0,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,3,0,0],
                [3,1,1,1,4,4,1,1,1,4,4,1,1,1,3,0],
                [3,1,1,1,4,4,1,1,1,4,4,1,1,1,3,3],
                [3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,1,3,0],
                [0,3,1,1,1,1,1,1,1,1,1,1,1,3,0,0],
                [0,0,3,1,1,1,1,1,1,1,1,1,3,0,0,0],
                [0,0,0,3,3,3,3,3,3,3,3,3,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ]
        };

        const affirmations = [
            "Your feelings are valid, even the difficult ones.",
            "Be kind and patient with yourself today.",
            "Each breath is a new, gentle beginning.",
            "It's okay to rest; you are doing enough.",
            "You are resilient, and you can get through this moment.",
            "Allow yourself to simply be, without judgment."
        ];

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function saveToLocalStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function getFromLocalStorage(key, defaultValue = null) {
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : defaultValue;
        }

        // Tab Management
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update screens
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            appState.currentTab = tabName;
            
            // Update affirmation banner
            updateAffirmationBanner(tabName);
            
            // Load screen-specific data
            if (tabName === 'entries') {
                loadEntries();
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        function updateAffirmationBanner(screenName) {
            const banner = document.getElementById('affirmationBanner');
            if (screenName === 'jerry' || screenName === 'checkin') {
                banner.textContent = affirmations[Math.floor(Math.random() * affirmations.length)];
            } else {
                banner.textContent = '';
            }
        }

        // Jerry Companion Functions
        function updateJerryNeeds() {
            const now = Date.now();
            const decayRates = { clarity: 24, insight: 48, calm: 12 }; // hours
            
            Object.keys(appState.jerry.needs).forEach(need => {
                const hoursSinceLastFed = (now - appState.jerry.lastFed[need]) / (1000 * 60 * 60);
                const decayAmount = (hoursSinceLastFed / decayRates[need]) * 100;
                appState.jerry.needs[need] = Math.max(0, 100 - decayAmount);
            });
            
            updateJerryUI();
            saveJerryState();
        }

        function feedJerry(need, amount = 50) {
            appState.jerry.needs[need] = Math.min(100, appState.jerry.needs[need] + amount);
            appState.jerry.lastFed[need] = Date.now();
            addXP(10);
            saveJerryState();
            updateJerryUI();
        }

        function addXP(amount) {
            appState.jerry.xp += amount;
            if (appState.jerry.xp >= appState.jerry.xpToNext) {
                levelUp();
            }
            saveJerryState();
            updateJerryUI();
        }

        function levelUp() {
            appState.jerry.level++;
            appState.jerry.xp -= appState.jerry.xpToNext;
            appState.jerry.xpToNext = Math.floor(appState.jerry.xpToNext * 1.5);
            showNotification(`Jerry leveled up! Now level ${appState.jerry.level}!`);
        }

        function updateJerryUI() {
            // Update progress bars
            document.getElementById('clarityBar').style.width = `${appState.jerry.needs.clarity}%`;
            document.getElementById('insightBar').style.width = `${appState.jerry.needs.insight}%`;
            document.getElementById('calmBar').style.width = `${appState.jerry.needs.calm}%`;
            
            // Update text values
            document.getElementById('clarityValue').textContent = `${Math.round(appState.jerry.needs.clarity)}%`;
            document.getElementById('insightValue').textContent = `${Math.round(appState.jerry.needs.insight)}%`;
            document.getElementById('calmValue').textContent = `${Math.round(appState.jerry.needs.calm)}%`;
            
            // Update level and XP
            document.getElementById('levelLabel').textContent = `Level ${appState.jerry.level}`;
            document.getElementById('xpLabel').textContent = `XP: ${appState.jerry.xp} / ${appState.jerry.xpToNext}`;
            
            // Update Jerry sprite based on needs
            updateJerrySprite();
        }

        function updateJerrySprite() {
            const needs = appState.jerry.needs;
            let spriteType = 'content';
            
            // Determine sprite based on lowest need
            const minNeed = Math.min(needs.clarity, needs.insight, needs.calm);
            if (minNeed < 50) {
                if (needs.insight === minNeed) {
                    spriteType = 'lowInsight';
                } else if (needs.calm === minNeed) {
                    spriteType = 'lowCalm';
                }
            }
            
            renderJerrySprite(jerrySprites[spriteType]);
        }

        function renderJerrySprite(spriteData) {
            const container = document.getElementById('jerrySprite');
            container.innerHTML = '';
            
            const colors = {
                0: 'transparent',
                1: '#4a90e2', // body
                2: '#ffffff', // eyes
                3: '#6bb6ff', // outline
                4: '#9cc7f0'  // features
            };
            
            spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                    if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        container.appendChild(pixelDiv);
                    }
                });
            });
        }

        function saveJerryState() {
            saveToLocalStorage('hush_jerry_state', appState.jerry);
        }

        function loadJerryState() {
            const saved = getFromLocalStorage('hush_jerry_state');
            if (saved) {
                Object.assign(appState.jerry, saved);
            }
        }

        // Chat Functions
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessageToChat('You', message, 'user');
            input.value = '';
            
            // Add to chat history
            appState.chatHistory.push({ role: 'user', content: message });
            
            // Show thinking indicator
            addMessageToChat('Jerry', 'Thinking...', 'jerry thinking');
            
            try {
                const response = await getAIResponse(message);
                // Remove thinking indicator
                const chatLog = document.getElementById('chatLog');
                const lastMessage = chatLog.lastElementChild;
                if (lastMessage && lastMessage.classList.contains('thinking')) {
                    lastMessage.remove();
                }
                
                addMessageToChat('Jerry', response, 'jerry');
                appState.chatHistory.push({ role: 'assistant', content: response });
                
                // Limit chat history
                if (appState.chatHistory.length > 20) {
                    appState.chatHistory = appState.chatHistory.slice(-20);
                }
                
                saveToLocalStorage('hush_chat_history', appState.chatHistory);
            } catch (error) {
                // Remove thinking indicator
                const chatLog = document.getElementById('chatLog');
                const lastMessage = chatLog.lastElementChild;
                if (lastMessage && lastMessage.classList.contains('thinking')) {
                    lastMessage.remove();
                }
                
                addMessageToChat('Jerry', getFallbackResponse(message), 'jerry');
            }
        }

        function addMessageToChat(speaker, message, className) {
            const chatLog = document.getElementById('chatLog');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.innerHTML = `<strong>${speaker}:</strong> ${message}`;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        async function getAIResponse(message) {

            const apiKey = appState.apiKey || document.getElementById('apiKey')?.value?.trim();
            
            if (!apiKey) {
                throw new Error('No API key configured');
            }
            
            const messages = [
                { role: 'system', content: 'You are Jerry, a friendly, gentle, and supportive AI companion focused on mental health. Keep responses brief and caring, offering emotional support and encouragement. You help users with CBT and DBT techniques when appropriate.' },
                ...appState.chatHistory.slice(-10), // Last 10 messages for context
                { role: 'user', content: message }
            ];
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [
                        { role: 'user', parts: [{ text: `You are Jerry, a friendly, gentle, and supportive AI companion focused on mental health. Keep responses brief and caring, offering emotional support and encouragement. You help users with CBT and DBT techniques when appropriate.\n\nUser: ${message}` }] }
                    ],
                    generationConfig: {
                        maxOutputTokens: 150,
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error('API request failed');
            }
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text.trim();
        }

        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            const responses = {
                'hello': "Hello! It's good to see you.",
                'hi': "Hello! It's good to see you.",
                'how are you': "I'm doing well, thank you! How can I help you today?",
                'thank': "You're very welcome!",
                'bye': "Goodbye! Have a great day!",
                'help': "I'm here to listen and support you. You can talk to me about anything, or try the CBT and DBT tools in the other tabs.",
                'sad': "I'm sorry you're feeling sad. Your emotions are valid. Would you like to talk about what's bothering you?",
                'anxious': "Anxiety can be really difficult. Remember to breathe deeply. I'm here to listen if you'd like to share what's making you anxious.",
                'angry': "It's okay to feel angry. Let's talk about what's causing these feelings."
            };
            
            for (const [key, response] of Object.entries(responses)) {
                if (lowerMessage.includes(key)) {
                    return response;
                }
            }
            
            return "I'm here to listen. Tell me what's on your mind.";
        }

        // Check-in Functions
        function setCheckinResponse(category, choice) {
            appState.checkinData[category] = choice;
            
            // Update button states
            const buttons = document.querySelectorAll(`[onclick*="${category}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function completeCheckin() {
            if (Object.keys(appState.checkinData).length < 3) {
                showNotification('Please answer all questions before continuing.', 'error');
                return;
            }
            
            const entry = {
                timestamp: new Date().toISOString(),
                type: 'Check-in',
                data: { ...appState.checkinData }
            };
            
            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);
            
            feedJerry('clarity', 50);
            addXP(10);
            
            showNotification('Check-in completed! Jerry gained clarity.');
            
            // Reset form
            appState.checkinData = {};
            document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));
            
            // Switch to Jerry tab
            switchTab('jerry');
        }

        // CBT Functions
        function completeCBT() {
            const situation = document.getElementById('cbtSituation').value.trim();
            const emotions = document.getElementById('cbtEmotions').value.trim();
            const thoughts = document.getElementById('cbtThoughts').value.trim();
            
            if (!situation || !emotions || !thoughts) {
                showNotification('Please fill in all fields.', 'error');
                return;
            }
            
            // Get selected distortions
            const distortions = [];
            document.querySelectorAll('#cbtDistortions input:checked').forEach(checkbox => {
                distortions.push(checkbox.nextElementSibling.textContent);
            });
            
            const entry = {
                timestamp: new Date().toISOString(),
                type: 'CBT',
                data: {
                    situation,
                    emotions,
                    thoughts,
                    distortions
                }
            };
            
            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);
            
            feedJerry('insight', 50);
            addXP(20);
            
            showNotification('CBT session completed! Jerry gained insight.');
            
            // Reset form
            document.getElementById('cbtSituation').value = '';
            document.getElementById('cbtEmotions').value = '';
            document.getElementById('cbtThoughts').value = '';
            document.querySelectorAll('#cbtDistortions input').forEach(checkbox => checkbox.checked = false);
            
            // Switch to Jerry tab
            switchTab('jerry');
        }

        // DBT Functions
        function setDBTRating(emotion, value) {
            appState.dbtData[emotion] = value;
            
            // Update button states
            const buttons = document.querySelectorAll(`[onclick*="${emotion}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function completeDBT() {
            const requiredRatings = ['anger', 'sadness', 'fear', 'shame'];
            const missingRatings = requiredRatings.filter(rating => appState.dbtData[rating] === undefined);
            
            if (missingRatings.length > 0) {
                showNotification('Please rate all emotions.', 'error');
                return;
            }
            
            // Get selected skills
            const skills = [];
            document.querySelectorAll('#dbtSkills input:checked').forEach(checkbox => {
                skills.push(checkbox.nextElementSibling.textContent);
            });
            
            const entry = {
                timestamp: new Date().toISOString(),
                type: 'DBT',
                data: {
                    ...appState.dbtData,
                    skills
                }
            };
            
            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);
            
            feedJerry('calm', 50);
            addXP(20);
            
            showNotification('DBT session completed! Jerry feels calmer.');
            
            // Reset form
            appState.dbtData = {};
            document.querySelectorAll('#dbt .rating-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#dbtSkills input').forEach(checkbox => checkbox.checked = false);
            
            // Switch to Jerry tab
            switchTab('jerry');
        }

        function animateJerry() {
            const container = document.getElementById('jerrySprite');
            container.classList.add('bounce');
            setTimeout(() => container.classList.remove('bounce'), 300); // reset
        }

        // Timer Functions
        function toggleTimer() {
            if (!appState.timer.active) {
                startTimer();
            } else {
                stopTimer();
            }
        }

        function startTimer() {
            appState.timer.active = true;
            appState.timer.remaining = 180; // 3 minutes
            
            document.getElementById('timerButton').textContent = 'Stop';
            
            appState.timer.interval = setInterval(() => {
                appState.timer.remaining--;
                updateTimerDisplay();
                
                if (appState.timer.remaining <= 0) {
                    completeTimer();
                }
            }, 1000);
            
            updateTimerDisplay();
        }

        function stopTimer() {
            appState.timer.active = false;
            appState.timer.remaining = 180;
            
            if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
            }
            
            document.getElementById('timerButton').textContent = 'Start';
            document.getElementById('timerDisplay').textContent = '03:00';
        }

        function completeTimer() {
            appState.timer.active = false;
            
            if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
            }
            
            document.getElementById('timerButton').textContent = 'Start';
            document.getElementById('timerDisplay').textContent = 'Done';
            
            feedJerry('calm', 30);
            addXP(15);
            
            showNotification('Mindfulness session completed!');
            
            setTimeout(() => {
                document.getElementById('timerDisplay').textContent = '03:00';
                appState.timer.remaining = 180;
            }, 2000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(appState.timer.remaining / 60);
            const seconds = appState.timer.remaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Entries and History Functions
        function loadEntries() {
            const entriesList = document.getElementById('entriesList');
            entriesList.innerHTML = '';
            
            if (appState.entries.length === 0) {
                entriesList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No entries yet. Complete some activities to see your progress here!</p>';
                return;
            }
            
            appState.entries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'entry-item';
                
                const date = new Date(entry.timestamp).toLocaleDateString();
                const time = new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                let content = '';
                if (entry.type === 'Check-in') {
                    content = `Feeling ${entry.data.emotion || 'N/A'} emotionally, ${entry.data.physical || 'N/A'} physically, ${entry.data.mental || 'N/A'} mentally.`;
                } else if (entry.type === 'CBT') {
                    content = `Situation: ${entry.data.situation?.substring(0, 100)}${entry.data.situation?.length > 100 ? '...' : ''}`;
                } else if (entry.type === 'DBT') {
                    const ratings = Object.entries(entry.data)
                        .filter(([key]) => ['anger', 'sadness', 'fear', 'shame'].includes(key))
                        .map(([key, value]) => `${key}: ${value}`)
                        .join(', ');
                    content = `Emotion ratings: ${ratings}`;
                }
                
                entryDiv.innerHTML = `
                    <div class="entry-date">${date} at ${time}</div>
                    <div class="entry-content"><strong>${entry.type}</strong><br>${content}</div>
                `;
                
                entriesList.appendChild(entryDiv);
            });
        }

        function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (appState.conversationHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No conversation history yet. Chat with Jerry to see your conversations here!</p>';
                return;
            }
            
            // Group conversations by session (this is a simplified approach)
            const sessions = [];
            let currentSession = [];
            
            appState.chatHistory.forEach(message => {
                currentSession.push(message);
            });
            
            if (currentSession.length > 0) {
                sessions.push({
                    timestamp: new Date().toISOString(),
                    conversation: currentSession
                });
            }
            
            sessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'entry-item';
                
                const date = new Date(session.timestamp).toLocaleDateString();
                const time = new Date(session.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const messageCount = session.conversation.length;
                
                sessionDiv.innerHTML = `
                    <div class="entry-date">${date} at ${time}</div>
                    <div class="entry-content">Conversation with ${messageCount} messages</div>
                `;
                
                historyList.appendChild(sessionDiv);
            });
        }

        // Settings Functions
        function loadSettings() {
            document.getElementById('apiKey').value = appState.apiKey || '';
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!apiKey){
                showNotification('Please enter a valid API key.', 'error');
                return;
            }
            
            appState.apiKey = apiKey;
            localStorage.setItem('hush_api_key', apiKey);
            showNotification('Settings saved successfully!');

            addMessageToChat('Jerry', "Thanks! I can now respond to your messages.", 'jerry');
        }

        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            showNotification('Theme updated!');
        }

        // Initialization
        function initializeApp() {
            loadJerryState();
            appState.chatHistory = getFromLocalStorage('hush_chat_history', []);
            appState.apiKey = localStorage.getItem('hush_api_key') || '';
            
            updateJerryUI();
            updateAffirmationBanner('jerry');
            
            // Update Jerry's needs every minute
            setInterval(updateJerryNeeds, 60000);
            
            // Animate Jerry sprite
            setInterval(() => {
                updateJerrySprite();
                animateJerry();
            }, 2000);
            
            // Auto-update affirmations every 10 seconds on Jerry/checkin screens
            setInterval(() => {
                if (appState.currentTab === 'jerry' || appState.currentTab === 'checkin') {
                    updateAffirmationBanner(appState.currentTab);
                }
            }, 10000);

            const apiInput = document.getElementById('apiKey');
            if (apiInput){
                apiInput.addEventListener('input', (e) => {
                    appState.apiKey = e.target.value.trim();
                });
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'jerry-pwa-v1';
                    const urlsToCache = [
                        '/',
                        '/index.html',
                        '/manifest.json',
                        '/JerryIcon.png'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then((cache) => {
                                return cache.addAll(urlsToCache);
                            })
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch((err) => {
                        console.log('ServiceWorker registration failed');
                    });
            });
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
