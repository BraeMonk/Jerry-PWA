<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Jerry - Mental Health Companion</title>

    <script src="https://www.paypal.com/sdk/js?client-id=AQQjfHs0zv-KHqb4Rtn8c8UYMZSb1chU62eafw_y7s3XzUNLZ3HQpQvfV3M-lx5oesJaaC6hNSr1qG7_&vault=true&intent=subscription"></script>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#3355d4">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#A0522D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Jerry">
    <!-- iOS Home Screen icons -->
    <link rel="apple-touch-icon" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="180x180" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="152x152" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="120x120" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="167x167" href="./jerryIcon3.PNG">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Light Theme Overrides */
        body.light-theme {
            background: linear-gradient(135deg, #fdf6f0 0%, #f7ede5 100%);
            color: #3e3e3e;
    }

        body.light-theme .app-container {
            background: #f7ede5;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        body.light-theme .affirmation-banner {
            background: linear-gradient(90deg, #e3b88d, #f0c9a2);
            color: #3e3e3e;
        }

        body.light-theme .tab-container {
            background: #eae3de;
            border-bottom: 1px solid #d8cfc4;
        }

        body.light-theme .tab {
            color: #6b7280;
        }

        body.light-theme .tab.active {
            color: #e3b88d;
            background: #f7ede5;
            border-bottom: 2px solid #e3b88d;
        }

        body.light-theme .tab:hover {
            background: rgba(227,184,141,0.1);
            color: #c27c48;
        }

        body.light-theme .screen {
            background-color: #f7ede5;
        }

        body.light-theme .form-label {
            color: #4b4b4b;
        }

        body.light-theme .form-input,
        body.light-theme .form-textarea {
            background: #ffffff;
            border: 1px solid #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .form-input:focus {
            border-color: #e3b88d;
        }

        body.light-theme .btn {
            background: #e3b88d;
            color: #3e3e3e;
        }

        body.light-theme .btn:hover {
            background: #cfa273;
        }

        body.light-theme .btn-secondary {
            background: #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .btn-secondary:hover {
            background: #cbb7a2;
        }

        body.light-theme .rating-btn {
            background: #ffffff;
            border: 1px solid #d8cfc4;
            color: #6b7280;
        }

        body.light-theme .rating-btn.active,
        body.light-theme .rating-btn:hover {
            background: #e3b88d;
            color: #3e3e3e;
            border-color: #e3b88d;
        }

        body.light-theme .timer-display {
            color: #e3b88d;
        }

        body.light-theme .progress-section,
        body.light-theme .entry-item,
        body.light-theme .checkbox-container {
            background: #ffffff;
            border-color: #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .notification {
            background: #e3b88d;
            color: #3e3e3e;
        }

        /* Light Theme Overrides */
        body.light-theme #journalInput {
            background: #ffffff;
            color: #3e3e3e;
            border: 1px solid #d8cfc4;
        }

        body.light-theme #saveJournalEntry {
            background: #e3b88d;
            color: #3e3e3e;
        }

        body.light-theme #saveJournalEntry:hover {
            background: #cfa273;
        }

        /* Light mode premium subscription card */
        body.light-theme #premiumSection .subscription-card {
            background: #A0522D;          /* main brown background */
            border: 2px solid #8B4513;    /* slightly darker brown border */
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            color: #ffffff;               /* default text color */
        }

        /* Title */
        body.light-theme #premiumSection .subscription-title {
            color: #ffffff;               /* white text */
        }

        /* Price */
        body.light-theme #premiumSection .subscription-price {
            color: #ffffff;
        }

        body.light-theme #premiumSection .subscription-price span {
            color: #f0e6d2; /* slightly lighter for /month text */
        }

        /* Features list */
        body.light-theme #premiumSection .subscription-features li {
            color: #ffffff;               /* white text */
        }

        body.light-theme #premiumSection .subscription-features li span {
            color: #68d391;               /* keep green checkmarks */
        }

        /* Subscription status */
        body.light-theme #premiumSection #subscriptionStatusDisplay .subscription-status.active {
            background: #8B4513;          /* darker brown for status box */
            border: 1px solid #cfa273;   /* matching border */
            color: #ffffff;               /* white text */
        }

        body.light-theme #premiumSection #subscriptionStatusDisplay .subscription-status.active div {
            color: #ffffff;               /* white text */
        }

        /* Cancel button */
        body.light-theme #premiumSection #subscriptionStatusDisplay .btn.btn-danger {
            background: #c03b1f;          /* dark reddish-brown button */
            color: #ffffff;               /* white text */
            width: 100%;
        }

        body.light-theme #premiumSection #subscriptionStatusDisplay .btn.btn-danger:hover {
            background: #a52d1a;          /* slightly darker on hover */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            background: #1a202c;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .affirmation-banner {
            background: linear-gradient(90deg, #3355d4, #4f46e5);
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            color: white;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-container {
            display: flex;
            background: #2d3748;
            border-bottom: 1px solid #4a5568;
        }
        
        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tab.active {
            color: #3355d4;
            background: #1a202c;
            border-bottom: 2px solid #3355d4;
        }
        
        .tab:hover {
            background: rgba(51, 85, 212, 0.1);
            color: #63b3ed;
        }
        
        .screen {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 120px);
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
        
        .screen.active {
            display: block;
        }
        
        /* Jerry Sprite Styles */
        .jerry-container {
            display: flex;
            flex-direction: column;
            align-items: center;        /* horizontal centering */
            justify-content: center; /* stack items top to bottom */
            position: relative;         
            width: 100%;                
            height: 420px;              /* slightly taller for spacing */
            margin: 0;
            z-index: 10;                
            padding-top: 20px;        
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            transition: background 0.5s ease;
        }

        .jerry-sprite {
            width: 160px;
            height: 160px;
            position: relative;
            z-index: 3;
            margin: 0 auto;
            left: -5px;
        }

        .jerry-shadow {
            position: absolute;
            top: 200px;               /* stays just beneath sprite */
            width: 120px;
            height: 18px;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 50%;
            filter: blur(6px);
            z-index: 2;                 
            left: 50%;                  
            transform: translateX(-50%) scaleX(1.2);
            opacity: 0.6;
        }

        /* Background inside container, above stats */
        .jerry-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* leave room for stats at bottom */
            z-index: 0;
            pointer-events: none; /* don’t block Jerry clicks */
            background: linear-gradient(to top, #2d6a4f, #95d5b2, #d8f3dc);
        }

        /* Ensure Jerry sprite pixels are full like the preview */
        .jerry-sprite .pixel {
            width: calc(100% / 16);   /* always fits a 16x16 grid */
            height: calc(100% / 16);
            position: absolute;
            border-radius: 0;   
            margin: 0;
            padding: 0;
            z-index: 3;
            pointer-events: none;
        }
        
        .jerry-stats {
            width: 100%;
            max-width: 300px;
            margin-bottom: 10px;
            margin-top: auto;
            z-index: 4;
        }
        
        .stat-bar {
            margin-bottom: 12px;
            z-index: 4;
        }
        
        .stat-label {
            font-size: 12px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid; /* border color will depend on theme */
            background-color: var(--stat-bg); /* dynamic based on theme */
            color: var(--stat-text);
            z-index: 4;
        }

        /* Light theme */
        body.light-theme {
            --stat-bg: #e3b88d;
            --stat-text: #000000;
        }

        /* Dark theme */
        body.dark-theme {
            --stat-bg: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
            --stat-text: #ffffff;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .clarity-bar { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
        .insight-bar { background: linear-gradient(90deg, #8b5cf6, #5b21b6); }
        .calm-bar { background: linear-gradient(90deg, #10b981, #047857); }
        
        /* Chat Interface */
        .chat-container {
            background: #2d3748;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
            z-index: 4;
        }
        
        .chat-log {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: #1a202c;
            border-radius: 8px;
            z-index: 5;
        }
        
        .message {
            margin-bottom: 12px;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .message.user {
            color: #63b3ed;
        }
        
        .message.jerry {
            color: #68d391;
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            z-index: 10;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 20px;
            color: #e2e8f0;
            outline: none;
            font-size: 16px;

            resize: none;               /* prevent manual resizing */
            overflow-y: auto;           /* scroll when text exceeds box height */
            min-height: 36px;           /* same as original input height */
            max-height: 100px;          /* maximum height before scroll */
            white-space: pre-wrap;
            pointer-events: auto !important;
        }
        
        .send-button {
            background: #3355d4;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .send-button:hover {
            background: #2d4aa7;
        }

        /* Light mode chat box */
        body.light-theme .chat-container {
            background: #A0522D;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        body.light-theme .chat-log {
            background: #e3b88d; /* darker brown for messages area */
            border-radius: 8px;
        }

        body.light-theme .message.user {
            color: #ffffff; /* user messages white */
        }

        body.light-theme .message.jerry {
            color: #3e3e3e; /* Jerry messages dark for contrast */
        }

        body.light-theme .chat-input {
            background: #ffffff; /* input box light */
            color: #3e3e3e;      /* text dark */
            border: 1px solid #d8cfc4;

            resize: none;               /* prevent manual resizing */
            overflow-y: auto;           /* scroll when text exceeds box height */
            min-height: 36px;           /* same as original input height */
            max-height: 100px;          /* maximum height before scroll */
            white-space: pre-wrap;
        }

        body.light-theme .chat-input::placeholder {
            color: #a0aec0; /* placeholder text lighter */
        }

        body.light-theme .send-button {
            background: #e3b88d; /* button brown */
            color: #3e3e3e;      /* button text dark */
        }

        body.light-theme .send-button:hover {
            background: #cfa273; /* slightly darker on hover */
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #cbd5e0;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 16px;
            outline: none;
        }
        
        .form-input:focus {
            border-color: #3355d4;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            background: #3355d4;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            text-align: center;
            text-decoration: none;
            margin: 8px auto;
        }
        
        .btn:hover {
            background: #2d4aa7;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #2d3748;
        }
        
        /* Rating buttons */
        .rating-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .rating-btn {
            flex: 1;
            padding: 8px;
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #a0aec0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .rating-btn.active,
        .rating-btn:hover {
            background: #3355d4;
            color: white;
            border-color: #3355d4;
        }
        
        /* Timer Styles */
        .timer-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #3355d4;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
        }
        
        .timer-btn {
            font-size: 18px;
            padding: 16px 32px;
            border-radius: 50px;
        }
        
        /* Progress Tracking */
        .progress-section {
            background: #2d3748;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .progress-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e2e8f0;
        }
        
        /* Entries and History */
        .entry-item {
            background: #2d3748;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3355d4;
        }
        
        .entry-date {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 8px;
        }
        
        .entry-content {
            line-height: 1.5;
        }
        
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px;
            background: #2d3748;
            border-radius: 6px;
        }
        
        .checkbox {
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .checkbox-label {
            flex: 1;
            line-height: 1.4;
            font-size: 14px;
        }

        #spritePreview {
            position: relative;
            width: 160px;              /* fixed preview size */
            height: 160px;
            background-color: transparent;
            border: none;
            outline: none;
            box-shadow: none;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
            display: flex;
            justify-content: center;    /* center horizontally */
            align-items: center;        /* center vertically */
            padding: 8px;               /* optional padding so sprite isn’t flush with edges */
            box-sizing: border-box;     /* include padding in width/height */
        }


        #spritePreview .pixel {
            position: absolute;
            width: 10px;
            height: 10px;
        }

        #journal {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px);        /* fill full viewport */
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        #journalInput {
            flex: 1;        /* fill remaining space above button */
            min-height: 200px;
            width: 100%;
            padding: 16px;
            font-size: 16px;
            border: 1px solid #4a5568;
            border-radius: 8px;
            background: #2d3748;
            color: #e2e8f0;
            resize: none;
            overflow-y: auto;
            box-sizing: border-box;
            margin-bottom: 80px;   /* spacing above button */
            pointer-events: auto !important;
        }

        #saveJournalEntry {
            position: relative;       /* fixed at bottom of viewport */
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            padding: 12px 30px;
            width: 100%;           /* inherits button style */
            border-radius: 8px;
            background: #3355d4;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            margin-top: 12px;
        }

        #saveJournalEntry:hover {
            background: #2d4aa7;
            transform: translateX(-50%);
        }

        /* --- Journal Entries & Delete Buttons --- */

        /* Entry container */
        .journalEntry,
        .entry-item {
            background: #2d3748;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #3355d4;
            color: #e2e8f0;
            line-height: 1.5;
            transition: background 0.3s ease;
            cursor: default;
        }

        /* Entry date */
        .entry-date {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 8px;
        }

        /* Delete button */
        .delete-entry {
            margin-top: 8px;
            padding: 8px 16px;
            background: #c53030;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .delete-entry:hover {
            background: #9b2c2c;
            transform: translateY(-1px);
        }

        /* --- Filter Dropdown --- */
        #entryFilter {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid #4a5568;
            background: #2d3748;
            color: #e2e8f0;
            margin-bottom: 12px;
            outline: none;
        }

        #entryFilter:focus {
            border-color: #3355d4;
        }

        /* --- Light Theme Overrides --- */
        body.light-theme .journalEntry,
        body.light-theme .entry-item {
            background: #ffffff;
            color: #3e3e3e;
            border-left-color: #e3b88d;
        }

        body.light-theme .journalEntry.expanded {
            background: #f0e8e0;
        }

        body.light-theme .delete-entry {
            background: #e53e3e;
            color: white;
        }

        body.light-theme .delete-entry:hover {
            background: #c53030;
        }

        body.light-theme #entryFilter {
            background: #ffffff;
            color: #3e3e3e;
            border: 1px solid #d8cfc4;
        }

        /* Ensure hover, focus, and expanded states look good */
        body.light-theme #entryFilter:focus {
            border-color: #e3b88d;
        }

        /* Splash Screen */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;              
            transition: opacity 0.5s ease; 
            overflow: hidden; /* needed for pseudo-element */
            pointer-events: none;
        }

        /* Blurred background */
        #splashScreen::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('./jerrySplash2.PNG') no-repeat center center;
            background-size: cover;
            filter: blur(10px); /* adjust blur intensity */
            z-index: 0; /* behind everything */
            pointer-events: none;
        }

        /* Splash image stays above the blurred background */
        #splashScreen img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            border-radius: 12px;           
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); 
            position: relative; /* make sure it’s above the pseudo-element */
            z-index: 1;
        }

        /* Light theme version */
        body.light-theme #splashScreen::before {
            background: url('./jerrySplash.png.png') no-repeat center center;
            background-size: cover;
        }

        /* Header always visible */
        .journalEntry .entryHeader {
            font-weight: bold;
            margin-bottom: 0.25em;
        }

        /* Preview state: clamp to 1 line */
        .journalEntry .entryContent {
            display: -webkit-box;
            -webkit-line-clamp: 1;     /* number of lines to show in preview */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 1.5em;         /* ~1 line of text */
            transition: max-height 0.3s ease;
        }

        /* Expanded: show full text */
        .journalEntry.expanded .entryContent {
            -webkit-line-clamp: unset;
            max-height: 100vh;         /* large enough to fit */
        }

        /* Light mode API option text */
        body.light-theme .api-toggle {
            background: #8B4513 !important; /* dark brown background for contrast */
        }

        body.light-theme .api-toggle .api-option label {
            color: #ffffff; /* main label text */
        }

        body.light-theme .api-toggle .api-option label div {
            color: #f0e6d2; /* description text, slightly lighter */
        }

        body.light-theme .api-toggle input[type="radio"] {
            accent-color: #f0c9a2; /* makes the radio dot match the theme */
        }

        /* Dark theme (default) */
        .def-button {
            color: white;
            text-decoration: none;
            display: block;
            padding: 12px 24px;
            border-radius: 8px;
            background: #3355d4;
            transition: background 0.3s ease;
            border: none;
            text-align: center;
            font-weight: 500;
            margin: 8px auto 16px auto;
        }

        .def-button:hover {
            background: #2d4aa7;
        }

        /* Light theme */
        body.light-theme .def-button {
            background: #e3b88d;
            color: #3e3e3e;
        }

        body.light-theme .def-button:hover {
            background: #8b421f; /* slightly darker on hover */
        }

        /* Bottom overlay drawer, expands downward */
        .overlay {
            display: none; /* hidden by default */
            width: 100%;
            background-color: transparent; /* doesn’t block content */
            padding: 0;
        }

        /* Overlay content box */
        .overlay-content {
            margin: 10px auto; /* centers it horizontally */
            background-color: #3355d4; /* light theme default */
            color: #fff;
            padding: 20px;
            border-radius: 12px;
            max-width: 600px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: left;
            position: relative; /* makes it stay in flow */
        }

        /* Light theme */
        body.light-theme .overlay-content {
            background-color: #e3b88d;
            color: #000;
        }

        /* Dark theme */
        body.dark-theme .overlay-content {
            background-color: #222;
            color: #eee;
        }

        .overlay-close-btn {
            display: block;
            margin: 0 auto 15px;
            font-size: 1em;
            padding: 10px 20px;
            cursor: pointer;
            background-color: #007acc;
            color: #fff;
            border: none;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .overlay-close-btn:hover {
            background-color: #005fa3;
        }

        .overlay.show {
            display: block;
            animation: slideDown 0.3s ease forwards;
        }

        @keyframes slideDown {
            0% { transform: translateY(-20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Open button (Cheat Sheet) */
        .overlay-open-btn {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #3355d4;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .overlay-open-btn:hover {
            background-color: #005fa3;
        }


        #menuTrigger {
            position: relative;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #e2e8f0;
            font-size: 28px;
            text-align: center;
            cursor: pointer;
            z-index: 1000;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #menuTrigger:hover {
            color: #ffffff;
        }

        /* Radial Menu */
        #radialMenuApp {
            position: fixed;
            top: 50px;
            left: 50px;
            width: 320px;
            height: 320px;
            pointer-events: none; /* disables clicks when closed */
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 999;
        }

        #radialMenuApp.open {
            pointer-events: auto;
            opacity: 1;
        }

        /* Radial buttons styling (same as before) */
        .radial-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            cursor: default;
            color: inherit;
        }

        .radial-item {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #2d3748;
            text-align: center;
            line-height: 70px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
            font-size: 14px;
            font-weight: 600;
            color: inherit;
            white-space: nowrap;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .radial-item:hover,
        .radial-item.active {
            transform: scale(1.2);
            background: #4a5568;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }

        /* LIGHT THEME OVERRIDES */
        body.light-theme #menuTrigger {
            color: #A0522D;
        }

        body.light-theme #menuTrigger:hover {
            background: #A0522D;
            color: #ffffff;
        }

        body.light-theme .radial-item {
            background: #A0522D;
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: #3e3e3e;
        }

        body.light-theme .radial-item:hover,
        body.light-theme .radial-item.active {
            background: #e2dcd5;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
        }

        /* LIGHT THEME OVERRIDES FOR RADIAL CENTER ICON */
        body.light-theme .radial-center {
            color: #3e3e3e; /* matches light theme text */
        }

        /* Background blur overlay */
        #radialMenuOverlay {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(6px);   /* applies blur */
            background: rgba(0, 0, 0, 0.2); /* optional dark tint */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 998; /* just below the menu */
        }

        #radialMenuOverlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* ===== Light Theme Overrides ===== */
        body.light-theme #radialMenuOverlay {
            background: rgba(255, 255, 255, 0.3); /* subtle light tint */
            backdrop-filter: blur(6px);
        }

        /* Settings scroll container */
        .background-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .background-option {
            min-width: 100px;
            height: 60px;
            background-color: #2d3748; /* placeholder color */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .background-option:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .background-option.selected {
            border: 2px solid #f59e0b;
        }

        /* Preview image inside the scroll */
        .bg-preview {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        /* Default just follows light/dark theme */
        .jerry-container.bg-default {
            background: none;
        }

        /* Neon Lights — electric blues and magentas */
        .jerry-container.bg-neonLights {
            background: linear-gradient(to top, #00f260, #0575e6);
        }

        /* Background swatches inside the scroll menu */
        .bg-swatch {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin-bottom: 6px;
        }

        /* Noir — monochrome black & white gradient */
        .jerry-container.bg-noir {
            background: linear-gradient(to top, #000000, #444444, #888888, #ffffff);
        }

        /* Swatch for Noir */
        .swatch-noir {
            background: linear-gradient(to top, #000000, #444444, #888888, #ffffff);
        }

        /* Match each gradient theme */
        .swatch-default {
            background: linear-gradient(to bottom, #f9fafb, #e5e7eb); /* light theme */
        }
        body.dark-theme .swatch-default {
            background: linear-gradient(to bottom, #1f2937, #111827); /* dark theme */
        }

        .swatch-neonLights {
            background: linear-gradient(to top, #00f260, #0575e6);
        }

        /* 🌸 Petal — soft lavenders, peaches, and mint greens */
        .jerry-container.bg-petal {
            background: linear-gradient(to top, #E6E6FA, #FFE5B4, #98FB98);
        }

        .swatch-petal {
            background: linear-gradient(to top, #E6E6FA, #FFE5B4, #98FB98);
        }

        /* 🌙 Eclipse — silvers, muted blues, and soft purples */
        .jerry-container.bg-eclipse {
            background: linear-gradient(to top, #2F4F4F, #708090, #B0C4DE, #C0C0C0);
        }

        .swatch-eclipse {
            background: linear-gradient(to top, #2F4F4F, #708090, #B0C4DE, #C0C0C0);
        }

        /* Aurora — northern lights inspired */
        .jerry-container.bg-aurora {
            background: linear-gradient(to top, #0f2027, #2c5364, #6a11cb, #2575fc, #00c9a7);
        }

        .swatch-aurora {
            background: linear-gradient(to top, #0f2027, #6a11cb, #00c9a7);
        }

        /* Ember — fiery glow of coals and flame */
        .jerry-container.bg-ember {
            background: linear-gradient(to top, #3c0a00, #8b0000, #ff4500, #ff8c00, #ffd700);
        }

        .swatch-ember {
            background: linear-gradient(to top, #8b0000, #ff4500, #ffd700);
        }

        /* Woods — forest/photo background */
        .jerry-container.bg-woods {
            background: url('./woodsBG.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-woods {
            background: url('./woodsBG.jpg') no-repeat center center;
            background-size: cover;
        }

        .jerry-container.bg-galactic {
            background: url('./galactic.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-galactic {
            background: url('./galactic.jpg') no-repeat center center;
            background-size: cover;
        }

        .jerry-container.bg-spooky {
            background: url('./Spooky.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-spooky {
            background: url('./Spooky.jpg') no-repeat center center;
            background-size: cover;
        }

        .jerry-container.bg-dreamland {
            background: url('./dreamLand.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-dreamland {
            background: url('./dreamLand.jpg') no-repeat center center;
            background-size: cover;
        }

        .jerry-container.bg-beach {
            background: url('./beachDay.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-beach {
            background: url('./beachDay.jpg') no-repeat center center;
            background-size: cover;
        }

        .jerry-container.bg-arcane {
            background: url('./Arcane.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-arcane {
            background: url('./Arcane.jpg') no-repeat center center;
            background-size: cover;
        }

        .jerry-container.bg-matrix {
            background: url('./Matrix.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-matrix {
            background: url('./Matrix.jpg') no-repeat center center;
            background-size: cover;
        }

        .jerry-container.bg-flare {
            background: url('./Flare.jpg') no-repeat center center;
            background-size: cover;
            /* optional subtle overlay so text stays readable */
            background-blend-mode: overlay;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Swatch for Woods */
        .swatch-flare {
            background: url('./Flare.jpg') no-repeat center center;
            background-size: cover;
        }
        
        .swatch-all {
            background: repeating-linear-gradient(
                45deg,
                #2d6a4f,
                #2d6a4f 5px,
                #0f172a 5px,
                #0f172a 10px,
                #3a7bd5 10px,
                #3a7bd5 15px,
                #ff7e5f 15px,
                #ff7e5f 20px
            );
            border-radius: 4px;
        }

        textarea,
        input {
            font-size: 16px;
        }

        #petContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            z-index: 50;
            cursor: pointer;
            background: transparent;
            border: none;
            pointer-events: none;
        }

        .pet-sprite {
            width: 100%;
            height: 100%;
            display: grid;         /* JS sets grid anyway */
            animation: petIdle 2s infinite alternate;
            pointer-events: auto;
        }

        .pet-sprite.pulse {
            animation: petIdle 2s infinite alternate, pulse 1s infinite;
        }

        @keyframes petIdle {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        #petPreview .pet-sprite {
            background: transparent;
            border: none;
            display: grid;
            grid-gap: 0;                  /* no gaps between pixels */
            width: 100%;
            height: 100%;
            image-rendering: pixelated;   /* optional for crisp scaling */
        }

        #petPreview {
            position: relative;
            display: flex;
            justify-content: center;  /* horizontally center */
            align-items: center;      /* vertically center */
            width: 60px;              /* fixed preview box */
            height: 60px;
            background: transparent;
            border: none;
            padding: 4px;             /* optional padding around sprite */
            box-sizing: border-box;
        }


        .upload-zone {
            border: 2px dashed #aaa;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            background: rgba(0,0,0,0.05);
            transition: background 0.2s, border-color 0.2s;
        }

        .upload-zone.dragover {
            background: rgba(0, 150, 255, 0.1);
            border-color: #0096ff;
        }

        #uploadedSpritesList {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }

        #uploadedSpritesList li {
            padding: 5px 10px;
            margin: 3px 0;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }

        /* Make the sprite containers non-blocking for pointer events */

        /* Keep your individual pixel styling intact */
        .jerry-sprite .pixel,
        #spritePreview .pixel {
            pointer-events: none; /* already set, fine to leave */
        }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .jerry-sprite {
                width: 120px;
                height: 120px;
            }
            
            .pixel {
                width: 10px;
                height: 10px;
            }
            
            .timer-display {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div id="splashScreen">
        <img src="./jerrySplash2.PNG" alt="Splash" id="splashImage" />
    </div>
    <div class="app-container">
        <div class="affirmation-banner" id="affirmationBanner">
            Your feelings are valid, even the difficult ones.
        </div>

        <div id="menuTrigger">☰</div>

        <div id="radialMenuOverlay"></div>
        <div id="radialMenuApp">
            <div class="radial-center">🏠</div>
            <button class="radial-item" onclick="switchTab('jerry', event)">🧍</button>
            <button class="radial-item" onclick="switchTab('checkin', event)">✅</button>
            <button class="radial-item" onclick="switchTab('cbt', event)">💭</button>
            <button class="radial-item" onclick="switchTab('dbt', event)">🧘‍♂️</button>
            <button class="radial-item" onclick="switchTab('journalTab', event)">📓</button>
            <button class="radial-item" onclick="switchTab('hush', event)">🤫</button>
            <button class="radial-item" onclick="switchTab('entries', event)">🗂</button>
            <button class="radial-item" onclick="switchTab('settings', event)">⚙️</button>
        </div>

        <!-- Pet Sprite -->
        <div id="petContainer">
            <div class="pet-sprite" id="petSprite"></div>
        </div>
        
        <!-- Jerry Screen -->
        <div class="screen active" id="jerry">
            <div class="jerry-container" id="jerryWrapper">
                <!--- <div id="jerryHalo"></div> --->
                <div class="jerry-sprite" id="jerrySprite"></div>
                <div class="jerry-shadow"></div>
                <div class="jerry-stats">
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Clarity</span>
                            <span id="clarityValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill clarity-bar" id="clarityBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Insight</span>
                            <span id="insightValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill insight-bar" id="insightBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Calm</span>
                            <span id="calmValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill calm-bar" id="calmBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span id="levelLabel">Level 1</span>
                            <span id="xpLabel">XP: 0 / 100</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-log" id="chatLog">
                    <div class="message jerry">It's good to see you again.</div>
                </div>
                <div class="chat-input-container">
                    <textarea inputmode="text" class="chat-input" id="chatInput" placeholder="Type your message..." ></textarea>
                    <button id="sendButton" class="send-button" onclick="sendMessage()">→</button>
                </div>
            </div>
        </div>
        
        <!-- Check-in Screen -->
        <div class="screen" id="checkin">
            <h2 style="margin-bottom: 20px;">Daily Check-in</h2>
            <div id="checkinContent">
                <div class="form-group">
                    <div class="form-label">How are you feeling emotionally?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'emotion', 'Good')">Good</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'emotion', 'Okay')">Okay</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'emotion', 'Bad')">Bad</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your body feeling?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'physical', 'Energetic')">Energetic</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'physical', 'Tired')">Tired</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'physical', 'Pain')">Pain</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your mind today?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'mental', 'Clear')">Clear</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'mental', 'Foggy')">Foggy</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'mental', 'Overwhelmed')">Overwhelmed</button>
                    </div>
                </div>
                <button class="btn" onclick="completeCheckin()">Complete Check-in</button>
            </div>
        </div>
        
        <!-- CBT Screen -->
        <div class="screen" id="cbt">
            <h2 style="margin-bottom: 20px;">CBT Thought Record</h2>
            <div id="cbtContent">
                <div class="form-group">
                    <label class="form-label" for="cbtSituation">What was the situation or event that triggered the difficult feeling?</label>
                    <textarea inputmode="text" class="form-input form-textarea" id="cbtSituation" placeholder="e.g., I had a disagreement with a friend."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtEmotions">What emotions did you feel? (e.g., sad, angry, anxious)</label>
                    <textarea inputmode="text" class="form-input form-textarea" id="cbtEmotions" placeholder="List the primary emotions."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtThoughts">What were the automatic thoughts that went through your mind?</label>
                    <textarea inputmode="text" class="form-input form-textarea" id="cbtThoughts" placeholder="What did you immediately think or believe?"></textarea>
                </div>
                
                <h3 style="margin: 20px 0 12px;">Which cognitive distortions apply?</h3>
                <div id="cbtDistortions">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="allOrNothing">
                        <label class="checkbox-label" for="allOrNothing"><strong>All-or-Nothing Thinking:</strong> Viewing things in black-and-white categories.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="overgeneralization">
                        <label class="checkbox-label" for="overgeneralization"><strong>Overgeneralization:</strong> Seeing a single negative event as a never-ending pattern of defeat.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mentalFilter">
                        <label class="checkbox-label" for="mentalFilter"><strong>Mental Filter:</strong> Picking out a single negative detail and dwelling on it exclusively.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="jumpingConclusions">
                        <label class="checkbox-label" for="jumpingConclusions"><strong>Jumping to Conclusions:</strong> Making a negative interpretation despite no definite facts.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionalReasoning">
                        <label class="checkbox-label" for="emotionalReasoning"><strong>Emotional Reasoning:</strong> Assuming that your negative emotions necessarily reflect the way things really are.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="shouldStatements">
                        <label class="checkbox-label" for="shouldStatements"><strong>Should Statements:</strong> Motivating yourself with 'shoulds' and 'shouldn'ts'.</label>
                    </div>
                </div>
                
                <button class="btn" onclick="completeCBT()">Complete CBT Session</button>
            </div>
        </div>
        
        <!-- DBT Screen -->
        <div class="screen" id="dbt">
            <h2 style="margin-bottom: 20px;">DBT Skills Check</h2>
            <div id="dbtContent">
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your ANGER (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SADNESS (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your FEAR (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SHAME (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 5)">5</button>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 12px;">DBT Skills to Practice</h3>
                <div id="dbtSkills">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mindfulness">
                        <label class="checkbox-label" for="mindfulness"><strong>Mindfulness:</strong> Observe, Describe, Participate</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="distressTolerance">
                        <label class="checkbox-label" for="distressTolerance"><strong>Distress Tolerance:</strong> TIP, ACCEPTS, Self-Soothe</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionRegulation">
                        <label class="checkbox-label" for="emotionRegulation"><strong>Emotion Regulation:</strong> Check the Facts, Opposite Action</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="interpersonalEffectiveness">
                        <label class="checkbox-label" for="interpersonalEffectiveness"><strong>Interpersonal Effectiveness:</strong> DEAR MAN, GIVE, FAST</label>
                    </div>
                </div>
                
                <button class="btn" onclick="completeDBT()">Complete DBT Session</button>
            </div>
        </div>

        <!-- Journal Tab -->
        <div class="screen" id="journalTab">
            <h2 style="margin-bottom: 16px;">Journal</h2>
            <!-- New Entry Input -->
            <textarea inputmode="text" id="journalInput" placeholder="Write your thoughts here..." rows="5"></textarea>
            <button id="saveJournalEntry">Save Entry</button>
        </div>

        <!-- Hush Timer Screen -->
        <div class="screen" id="hush">
            <div class="timer-container">
                <h2 style="margin-bottom: 30px;">Mindfulness Timer</h2>
                <div class="timer-display" id="timerDisplay">03:00</div>
                <button class="btn timer-btn" id="timerButton" onclick="toggleTimer()">Start</button>
            </div>
        </div>
        
        <!-- Entries Screen -->
        <div class="screen" id="entries">
            <h2 style="margin-bottom: 20px;">Your Entries</h2>
            <div class="filter-container">
                <label for="entryFilter" class="form-label">Filter by type:</label>
                <select id="entryFilter" class="form-input">
                    <option value="all">All</option>
                    <option value="Check-in">Check-in</option>
                    <option value="CBT">CBT</option>
                    <option value="DBT">DBT</option>
                    <option value="Journal">Journal</option>
                </select>
  
            </div>
            <div id="entriesList">
                <!-- Entries will be populated here -->
            </div>
        </div>
        
        <!-- History Screen -->
        <div class="screen" style="display: none;" id="history">
            <h2 style="margin-bottom: 20px;">Conversation History</h2>
            <div id="historyList">
                <!-- History will be populated here -->
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div class="screen" id="settings">
            <h2 style="margin-bottom: 20px;">Settings</h2>

            <!-- Add this inside your settings tab HTML -->
            <div style="margin-bottom: 16px;" id="ambientMusicToggleContainer">
                <label style="margin-left:10px;">
                    Chirp Volume:
                    <input type="range" id="ambientMusicVolume" min="0" max="1" step="0.01" value="0.5">
                </label>
            </div>

            
            <!-- Bot Name Input -->
            <div class="form-group">
                <label class="form-label" for="botName">Companion Name</label>
                <input type="text" inputmode="text" class="form-input" id="botName" placeholder="Enter a name for your companion.">
            </div>

            <!-- API Configuration Section -->
            <div class="form-group">
                <label class="form-label">AI Configuration</label>
                
                <!-- API Option Selection -->
                <div class="api-toggle" style="background: #2d3748; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div class="api-option" style="display: flex; align-items: center; margin-bottom: 12px;">
                        <input type="radio" name="apiOption" id="useOwnApi" value="own" checked style="margin-right: 12px; transform: scale(1.2);">
                        <label for="useOwnApi" style="flex: 1; cursor: pointer;">
                            Use Your Own API Key
                            <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                Free - Bring your own Google AI Studio API key
                            </div>
                        </label>
                    </div>
            
                    <div class="api-option" style="display: flex; align-items: center; margin-bottom: 12px;">
                        <input type="radio" name="apiOption" id="usePremium" value="premium" style="margin-right: 12px; transform: scale(1.2);">
                        <label for="usePremium" style="flex: 1; cursor: pointer;">
                            Use Premium API Service
                            <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                $4.99/month - No setup required, built-in API access
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Own API Key Input (shown by default) -->
                <div id="ownApiSection">
                    <input type="text" inputmode="text" class="form-input" id="apiKey" placeholder="Enter your Google AI Studio API key here.">
                    <div style="font-size: 12px; color: #a0aec0; margin-top: 8px;">
                        Get your free API key at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #3355d4;">Google AI Studio</a>
                    </div>
                </div>

                <!-- Premium Subscription Section (hidden by default) -->
                <div id="premiumSection" style="display: none;">
                    <div class="subscription-card" style="background: #2d3748; border-radius: 12px; padding: 20px; border: 2px solid #4a5568; transition: all 0.3s ease;">
                        <div class="subscription-title" style="font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #3355d4;">
                            🌟 Premium API Access
                        </div>
                        <div class="subscription-price" style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">
                            $4.99<span style="font-size: 16px; color: #a0aec0;">/month</span>
                        </div>
                
                        <ul class="subscription-features" style="list-style: none; margin-bottom: 20px;">
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">✓</span>
                                No API key setup required
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">✓</span>
                                1,000 messages per month
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">✓</span>
                                Faster response times
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">✓</span>
                                Priority support
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">✓</span>
                                Cancel anytime
                            </li>
                        </ul>
                        <div id="paypal-button-container-P-7LR41432T4749780UNC7UVBY"></div>
                        <script src="https://www.paypal.com/sdk/js?client-id=AQQjfHs0zv-KHqb4Rtn8c8UYMZSb1chU62eafw_y7s3XzUNLZ3HQpQvfV3M-lx5oesJaaC6hNSr1qG7_&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

                        <!-- Subscription Status Display -->
                        <div id="subscriptionStatusDisplay" style="display: none;">
                            <div class="subscription-status active" style="background: #1a365d; border: 1px solid #38a169; border-radius: 8px; padding: 16px; margin-bottom: 16px; text-align: center;">
                                <div style="color: #68d391; font-weight: bold; margin-bottom: 8px;">✓ Premium Active</div>
                                <div style="font-size: 12px; color: #a0aec0;">
                                    Messages used this month: <span id="messageUsageDisplay">0 / 1000</span>
                                </div>
                                <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                    Next billing: <span id="nextBillingDate">--</span>
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="cancelSubscription()" style="background: #e53e3e; width: 100%;">
                                Cancel Subscription
                            </button>
                        </div>

                        <!-- PayPal Subscribe Button -->
                        <div id="paypalSubscribeSection">
                            <div id="paypal-button-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="saveSettings()">Save Settings</button>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Sprite</h3>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Sprite Preview</label>
                <div id="spritePreview" style="width: 100px; height: 100px; position: relative; background: transparent; border: none;"></div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" for="spriteStyle">Sprite Style:</label>
                <select class="form-input" id="spriteStyle">
                    <option value="default">Jerry</option>
                    <option value="cornelius">Cornelius</option>
                    <option value="scott">Scott</option>
                    <option value="xeno">Xeno</option>
                    <option value="nano">Nano</option>
                    <option value="astro">Astro</option>
                    <option value="castle">Outpost</option>
                    <option value="ember">Ember</option>
                    <option value="wisp">Wisp</option>
                    <option value="python">Snowball</option>
                    <option value="luna">Luna</option>
                    <option value="matrix">Matrix</option>
                    <option value="glyphton">Glyphton</option>
                    <option value="sassy">Squachi</option>
                    <option value="bramble">Bramble</option>
                    <option value="apples">Apples</option>
                    <option value="earthy">Rootling</option>
                    <option value="drago">Drago</option>
                    <option value="egg">Yolk</option>
                    <option value="lilguy">Lil' Guy</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="spriteTheme">Sprite Theme:</label>
                <select class="form-input" id="spriteTheme">
                    <option value="default">Default</option>
                    <option value="retro8bit">8-Bit</option>
                    <option value="gameboyClassic">Gameboy</option>
                    <option value="synthwave">Synthwave</option>
                    <option value="earthTones">Earth Tones</option>
                    <option value="crystalIce">Crystal Ice</option>
                    <option value="moltenCore">Molten Core</option>
                    <option value="enchantedForest">Enchanted Forest</option>
                    <option value="nesClassic">Game Time</option>
                    <option value="cyberpunk">Cyberpunk</option>
                    <option value="desertSands">Desert Sands</option>
                    <option value="deepOcean">Deep Ocean</option>
                    <option value="cosmicVoid">Cosmic Void</option>
                    <option value="inkWash">Ink Wash</option>
                    <option value="autumnLeaves">Autumn Leaves</option>
                    <option value="sakuraBloom">Sakura Bloom</option>
                </select>
            </div>
            <!-- Background Environment Selection -->
            <div id="backgroundSettings">
                <h4 class="form-label">Sprite Environment:</h4>
                <div class="background-scroll">
                    <div class="background-option" data-bg="default">
                        <span>🚫</span>
                    </div>
                    <div class="background-option" data-bg="neonLights">
                        <div class="bg-swatch swatch-neonLights"></div>
                        <span>Neon Lights</span>
                    </div>
                    <div class="background-option" data-bg="noir">
                        <div class="bg-swatch swatch-noir"></div>
                        <span>Noir</span>
                    </div>
                    <div class="background-option" data-bg="petal">
                        <div class="bg-swatch swatch-petal"></div>
                        <span>Petal</span>
                    </div>

                    <div class="background-option" data-bg="eclipse">
                        <div class="bg-swatch swatch-eclipse"></div>
                        <span>Eclipse</span>
                    </div>

                    <div class="background-option" data-bg="aurora">
                        <div class="bg-swatch swatch-aurora"></div>
                        <span>Aurora</span>
                    </div>

                    <div class="background-option" data-bg="ember">
                        <div class="bg-swatch swatch-ember"></div>
                        <span>Ember</span>
                    </div>
                    <div class="background-option" data-bg="woods">
                        <div class="bg-swatch swatch-woods"></div>
                        <span>Woods</span>
                    </div>

                    <div class="background-option" data-bg="galactic">
                        <div class="bg-swatch swatch-galactic"></div>
                        <span>Galactic</span>
                    </div>
                    <div class="background-option" data-bg="spooky">
                        <div class="bg-swatch swatch-spooky"></div>
                        <span>Spooky</span>
                    </div>
                    <div class="background-option" data-bg="dreamland">
                        <div class="bg-swatch swatch-dreamland"></div>
                        <span>Dreamy</span>
                    </div>
                    <div class="background-option" data-bg="beach">
                        <div class="bg-swatch swatch-beach"></div>
                        <span>Beach</span>
                    </div>
                    <div class="background-option" data-bg="arcane">
                        <div class="bg-swatch swatch-arcane"></div>
                        <span>Arcane</span>
                    </div>
                    <div class="background-option" data-bg="matrix">
                        <div class="bg-swatch swatch-matrix"></div>
                        <span>01001101</span>
                    </div>
                    <div class="background-option" data-bg="flare">
                        <div class="bg-swatch swatch-flare"></div>
                        <span>Flare</span>
                    </div>
                </div>
            </div>
            <div style="margin-top: 40px;">
                <h3 style="margin-bottom: 15px;">Pet</h3>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Pet Preview</label>
                <div id="petPreview"></div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" for="petStyle">Pet Style:</label>
                <select class="form-input" id="petStyle">
                    <option value="none">🚫</option>
                    <option value="miniJerry">Mini Jerry</option>
                    <option value="puff">Puff</option>
                    <option value="spark">Spark</option>
                    <option value="buddy">Buddy</option>
                    <option value="orb">The Visitor</option>
                    <option value="flame">Flame</option>
                    <option value="leaf">Leaf</option>
                    <option value="gem">Crisp</option>
                    <option value="beetle">Bob</option>
                    <option value="star">Nightlight</option>
                    <option value="peepaw">Pee-Paw</option>
                    <option value="flicker">Flicker</option>
                    <option value="grumple">Grumple</option>
                    <option value="dragojr">Drago Jr.</option>
                    <option value="tube">Tube</option>
                    <option value="qube">Qube</option>
                    <option value="chromeo">T-420</option>
                    <option value="rainbow">Stormy</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="petTheme">Pet Theme:</label>
                <select class="form-input" id="petTheme">
        
                    <!-- same themes as sprite -->
                    <option value="default">Default</option>
                    <option value="retro8bit">8-Bit</option>
                    <option value="gameboyClassic">Gameboy</option>
                    <option value="synthwave">Synthwave</option>
                    <option value="earthTones">Earth Tones</option>
                    <option value="crystalIce">Crystal Ice</option>
                    <option value="moltenCore">Molten Core</option>
                    <option value="enchantedForest">Enchanted Forest</option>
                    <option value="nesClassic">Game Time</option>
                    <option value="cyberpunk">Cyberpunk</option>
                    <option value="desertSands">Desert Sands</option>
                    <option value="deepOcean">Deep Ocean</option>
                    <option value="cosmicVoid">Cosmic Void</option>
                    <option value="inkWash">Ink Wash</option>
                    <option value="autumnLeaves">Autumn Leaves</option>
                    <option value="sakuraBloom">Sakura Bloom</option>
                </select>
            </div>

            <div id="spriteUploadZone" class="upload-zone">
                <p>Drag & drop your sprite JSON here or tap the button below to upload</p>
    
                <!-- Label triggers the hidden file input -->
                <label for="spriteFileInput" class="upload-button" 
                    style="cursor: pointer; display: inline-block; padding: 6px 12px; background-color: #3355d4; color: #fff; border-radius: 4px; margin-top: 5px;">
                    Select Sprite JSON
                </label>
                <input type="file" id="spriteFileInput" accept=".json" 
                    style="opacity:0; position:absolute; left:0; top:0; width:1px; height:1px;">
            </div>

            <!-- Inline inputs for naming and category -->
            <div id="spriteUploadInputs" style="display:none; margin-top:10px;">
                <input type="text" id="spriteNameInputInline" placeholder="Sprite Name" style="width:100%; margin-bottom:5px;">
                <select id="spriteCategorySelectInline" style="width:100%; margin-bottom:5px;">
                    <option value="jerry">Jerry</option>
                    <option value="pet">Pet</option>
                </select>
                <button id="spriteUploadSubmitInline" style="width:100%;">Add Sprite</button>
            </div>

            <ul id="uploadedSpritesList"></ul>
            
            <div style="font-size: 12px; color: #a0aec0; margin-top: 8px;">
                Draw your own Jerry! <a href="https://braemonk.github.io/QuikEdit/" target="_blank" style="color: #3355d4;">Jerry Editor</a>
            </div>
            <!-- Rest of your existing settings content -->
            <div style="margin-top: 30px; text-align: center;">
                <button class="overlay-open-btn" id="openDBTOverlay">Cheat Sheet</button>
            </div>
    
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Theme</h3>
                <button class="btn btn-secondary" onclick="toggleTheme()">Toggle Dark/Light Mode</button>
            </div>
        </div>
        
        <div class="notification" id="notification"></div>
        <!-- Overlay -->
        <div id="dbtDefinitionsOverlay" class="overlay">
          <div class="overlay-content">
            <!-- Close Button -->
            <button id="closeDBTDefinitions" class="overlay-close-btn">&times; Close</button>
        
            <!-- DBT Section -->
            <h2>🌀 DBT Definitions</h2>
            <ul>
              <li>🧘 <strong>Mindfulness:</strong> Staying present in the moment, non-judgmentally.</li>
              <li>🔥 <strong>Distress Tolerance:</strong> Surviving crises without making them worse.</li>
              <li>🎭 <strong>Emotion Regulation:</strong> Understanding and managing intense emotions.</li>
              <li>🤝 <strong>Interpersonal Effectiveness:</strong> Balancing your needs with others while maintaining relationships.</li>
            </ul>
        
            <!-- CBT Section -->
            <h2>🧠 CBT Definitions</h2>
            <ul>
              <li>🔍 <strong>Cognitive Distortions:</strong> Biased ways of thinking (e.g., all-or-nothing thinking).</li>
              <li>📝 <strong>Thought Records:</strong> Tracking situations, thoughts, feelings, and evidence for/against beliefs.</li>
              <li>🏃 <strong>Behavioral Activation:</strong> Increasing activities that boost mood and motivation.</li>
              <li>⚡ <strong>Exposure:</strong> Gradually facing fears to reduce avoidance.</li>
            </ul>
        
            <!-- Mental Health Tips Section -->
            <h2>💡 Mental Health Tips & Tricks</h2>
            <ul>
              <li>🌬️ Use <strong>box breathing</strong>: inhale 4s, hold 4s, exhale 4s, hold 4s.</li>
              <li>🌳 Practice <strong>grounding</strong> with “5-4-3-2-1” senses technique.</li>
              <li>📖 <strong>Journal daily</strong> for self-reflection and thought awareness.</li>
              <li>🏃‍♂️ <strong>Movement:</strong> even a 10-minute walk reduces stress and clears the mind.</li>
              <li>💖 <strong>Self-validation:</strong> remind yourself that your feelings make sense in context.</li>
            </ul>
          </div>
        </div>
        

    <script>
        // Application State
        const appState = {
        jerry: {},
        apiKey: localStorage.getItem('hush_api_key') || '',
        currentTab: 'jerry',
        checkinData: {},
        cbtData: {},
        dbtData: {},
        chatHistory: [],
        entries: JSON.parse(localStorage.getItem('hush_entries') || '[]'),
        conversationHistory: JSON.parse(localStorage.getItem('hush_conversations') || '[]'),
        botName: localStorage.getItem('botName') || 'Jerry', // default
        timer: {
                active: false,
                remaining: 180,
                interval: null
        },
        spriteTheme: localStorage.getItem('spriteTheme') || 'default',
        };
        const subscriptionState = {
        isSubscribed: localStorage.getItem('jerry_subscription_active') === 'true',
        subscriptionId: localStorage.getItem('jerry_subscription_id') || null,
        messageCount: parseInt(localStorage.getItem('jerry_message_count') || '0'),
        billingCycle: localStorage.getItem('jerry_billing_cycle') || null,
        apiOption: localStorage.getItem('jerry_api_option') || 'own'
        };

        const PREMIUM_API_KEY = 'GITHUB_SECRET_PREMIUM_API_KEY';

        let currentSpriteStyle = localStorage.getItem('jerrySpriteStyle') || 'default';

        const jerrySprites = {
            default: [
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [3, 1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],
            
            python: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,9,9,9,9,9,9,9,0,0,0,0,0],
                [0,0,0,0,0,9,3,3,3,3,3,3,8,9,0,0,0,0],
                [0,0,0,0,9,5,3,3,3,3,3,3,7,8,9,0,0,0],
                [0,0,0,9,3,3,3,3,9,3,3,3,3,7,8,9,0,0],
                [0,0,0,9,3,3,3,9,1,9,3,3,3,7,8,9,0,0],
                [0,0,0,9,3,3,9,1,1,1,9,3,3,7,8,9,0,0],
                [0,0,0,9,3,9,1,8,8,8,1,9,3,7,8,9,0,0],
                [0,0,0,9,3,9,1,8,9,8,1,9,3,7,8,9,0,0],
                [0,0,0,0,9,9,1,8,9,8,1,9,7,8,9,0,0,0],
                [0,0,0,0,9,9,1,8,8,8,1,9,8,9,9,0,0,0],
                [0,0,0,0,9,4,9,1,1,1,9,9,9,8,9,0,0,0],
                [0,0,0,0,9,7,9,9,1,9,9,7,9,9,0,0,0,0],
                [0,0,0,0,9,8,9,4,9,4,9,8,9,0,0,0,0,0],
                [0,0,0,0,0,9,9,7,9,7,9,9,0,0,0,0,0,0],
                [0,0,0,0,0,0,9,8,9,8,9,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,9,9,9,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,9,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
            
            cornelius: [ // Happy, energetic Jerry - lots of sparkles and bright energy
                [0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],
                [0,0,0,2,2,2,0,0,0,2,2,2,0,0,0,0],
                [0,0,2,3,3,3,2,0,2,3,3,3,2,0,0,0],
                [0,2,3,4,4,4,3,2,3,4,4,4,3,2,0,0],
                [1,3,4,4,4,4,4,3,4,4,4,4,4,3,1,0],
                [0,3,4,4,4,4,4,3,4,4,4,4,4,3,0,0],
                [0,2,3,4,4,4,3,2,3,4,4,4,3,2,0,0],
                [0,0,2,3,3,3,2,1,2,3,3,3,2,0,0,0],
                [0,0,0,2,2,2,3,3,3,2,2,2,0,0,0,0],
                [0,1,0,0,3,3,4,4,4,3,3,0,0,1,0,0],
                [0,0,0,0,2,4,4,4,4,4,2,0,0,0,0,0],
                [0,0,0,0,0,3,4,4,4,3,0,0,0,0,0,0],
                [0,0,1,0,0,2,3,3,3,2,0,0,1,0,0,0],
                [0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            scott: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,2,2,2,2,0,0,2,2,2,0,0,0,0],
                [0,0,2,3,3,3,3,2,2,3,3,3,2,0,0,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [2,3,3,4,4,4,3,3,3,4,4,4,3,3,2,0],
                [2,3,3,3,3,3,3,3,3,3,3,3,3,3,2,0],
                [2,3,3,3,3,3,3,3,3,3,3,3,3,3,2,0],
                [2,3,3,3,3,3,3,3,3,3,3,3,3,3,2,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [0,0,2,3,3,3,3,3,3,3,3,3,2,0,0,0],
                [0,0,0,2,2,3,3,3,3,3,2,2,0,0,0,0],
                [0,0,0,0,0,2,2,2,2,2,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            xeno: [
                [0,0,0,0,2,2,2,0,0,2,2,2,0,0,0,0],
                [0,0,0,2,1,1,2,0,0,2,1,1,2,0,0,0],
                [0,0,2,1,4,4,1,0,0,1,4,4,1,2,0,0],
                [0,2,1,4,3,3,4,2,2,4,3,3,4,1,2,0],
                [2,1,4,3,0,1,3,1,1,3,1,0,3,4,1,2],
                [2,4,1,1,0,0,1,3,3,1,0,0,1,1,4,2],
                [2,4,1,0,0,1,0,1,1,0,1,0,0,1,4,2],
                [2,4,1,0,1,1,1,1,1,1,1,1,0,1,4,2],
                [2,4,1,0,0,1,0,1,1,0,1,0,0,1,4,2],
                [2,4,1,1,0,0,1,3,3,1,0,0,1,1,4,2],
                [2,1,4,3,0,1,3,1,1,3,1,0,3,4,1,2],
                [0,2,1,4,3,3,4,2,2,4,3,3,4,1,2,0],
                [0,0,2,1,4,4,1,0,0,1,4,4,1,2,0,0],
                [0,0,0,2,1,1,2,0,0,2,1,1,2,0,0,0],
                [0,0,0,0,2,2,2,0,0,2,2,2,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            nano: [
                [0,0,2,2,2,2,0,0,0,0,2,2,2,2,0,0],
                [0,2,1,1,3,1,2,0,0,2,1,3,1,1,2,0],
                [2,1,4,4,1,4,1,2,2,1,4,1,4,4,1,2],
                [2,4,1,1,0,1,1,4,4,1,1,0,1,1,4,2],
                [2,4,1,0,0,0,0,1,1,0,0,0,0,1,4,2],
                [2,4,1,0,1,1,1,1,1,1,1,1,0,1,4,2],
                [2,4,1,0,0,1,0,1,1,0,1,0,0,1,4,2],
                [2,4,1,1,0,0,0,1,1,0,0,0,1,1,4,2],
                [2,1,4,1,0,1,1,1,1,1,1,0,1,4,1,2],
                [0,2,1,4,1,4,1,2,2,1,4,1,4,1,2,0],
                [0,0,2,1,3,1,2,0,0,2,1,3,1,2,0,0],
                [0,0,0,2,2,2,0,0,0,0,2,2,2,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            astro: [ // A cosmic, starry Jerry with darker space theme
                [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
                [0,0,0,1,1,2,2,4,4,2,2,1,1,0,0,0],
                [0,0,1,2,4,3,2,1,1,2,3,4,2,1,0,0],
                [0,1,2,3,4,1,3,2,2,3,1,4,3,2,1,0],
                [0,1,2,4,1,2,1,3,3,1,2,1,4,2,1,0],
                [1,2,3,4,2,3,4,1,1,4,3,2,4,3,2,1],
                [1,2,4,1,3,2,4,0,0,4,2,3,1,4,2,1],
                [1,2,2,3,1,4,0,0,0,0,4,1,3,2,2,1],
                [1,2,4,1,3,2,4,0,0,4,2,3,1,4,2,1],
                [1,2,3,4,2,3,4,1,1,4,3,2,4,3,2,1],
                [0,1,2,4,1,2,1,3,3,1,2,1,4,2,1,0],
                [0,1,2,3,4,1,3,2,2,3,1,4,3,2,1,0],
                [0,0,1,2,4,3,2,1,1,2,3,4,2,1,0,0],
                [0,0,0,1,1,2,2,4,4,2,2,1,1,0,0,0],
                [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            castle: [
                [5,0,5,0,5,0,5,5,5,5,0,5,0,5,0,5],
                [5,5,5,5,5,5,7,7,7,7,5,5,5,5,5,5],
                [5,7,7,7,7,5,6,6,6,6,5,7,7,7,7,5],
                [5,7,6,6,7,5,5,5,5,5,5,7,6,6,7,5],
                [0,5,7,6,7,7,7,7,7,7,7,7,6,7,5,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,7,7,7,7,7,7,7,6,5,0,0],
                [0,0,5,6,7,5,5,5,5,5,5,7,6,5,0,0],
                [0,0,5,6,7,7,6,6,6,6,7,7,6,5,0,0],
                [0,5,7,6,6,7,7,7,7,7,7,6,6,7,5,0],
                [0,5,7,5,5,5,6,6,6,6,5,5,5,7,5,0],
                [5,7,6,5,0,0,5,5,5,5,0,0,5,6,7,5]
            ],

            ember: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,1,1,2,2,0,0,2,2,1,1,0,0,0],
                [0,0,1,2,3,3,3,2,2,3,3,3,2,1,0,0],
                [0,1,2,3,3,4,4,3,3,4,4,3,3,2,1,0],
                [0,1,2,3,4,4,4,4,4,4,4,4,3,2,1,0],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [0,1,2,3,4,4,4,4,4,4,4,4,3,2,1,0],
                [0,1,2,3,4,4,4,4,4,4,4,4,3,2,1,0],
                [0,0,1,2,3,4,4,4,4,4,4,3,2,1,0,0],
                [0,0,0,1,2,3,3,4,4,3,3,2,1,0,0,0],
                [0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0],
                [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],


            wisp: [
                [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,2,1,1,2,0,0,0,0,0,0],
                [0,0,0,0,0,2,1,4,4,1,2,0,0,0,0,0],
                [0,0,0,0,2,1,4,3,3,4,1,2,0,0,0,0],
                [0,0,0,2,1,4,4,1,1,4,4,1,2,0,0,0],
                [0,0,2,1,4,1,1,4,4,1,1,4,1,2,0,0],
                [0,2,1,4,1,1,1,1,1,1,1,1,4,1,2,0],
                [0,2,1,1,4,1,1,4,4,1,1,4,1,1,2,0],
                [0,0,2,1,1,4,4,1,1,4,4,1,1,2,0,0],
                [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
                [0,0,0,0,2,1,1,1,1,1,1,2,0,0,0,0],
                [0,0,0,0,0,2,1,1,1,1,2,0,0,0,0,0],
                [0,0,0,0,0,0,2,1,1,2,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            luna: [
                [0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],
                [0,0,0,0,3,1,1,1,1,1,1,3,0,0,0,0],
                [0,0,0,3,1,1,2,1,1,2,1,1,3,0,0,0],
                [0,0,3,1,1,2,1,4,4,1,2,1,1,3,0,0],
                [0,3,1,1,2,1,4,4,4,4,1,2,1,1,3,0],
                [0,3,1,2,1,4,4,4,4,4,4,1,2,1,3,0],
                [3,1,1,2,4,4,4,4,4,4,4,4,1,2,1,3],
                [3,1,2,1,4,4,4,4,4,4,4,4,1,2,1,3],
                [3,1,1,2,1,4,4,4,4,4,4,1,2,1,1,3],
                [0,3,1,1,2,1,4,4,4,4,1,2,1,1,3,0],
                [0,3,1,1,1,2,1,1,1,1,2,1,1,1,3,0],
                [0,0,3,1,1,1,2,2,2,2,1,1,1,3,0,0],
                [0,0,0,3,1,1,1,1,1,1,1,1,3,0,0,0],
                [0,0,0,0,3,3,3,2,2,3,3,3,0,0,0,0],
                [0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            matrix: [
                [0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0],
                [0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0],
                [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
                [0,0,2,1,1,1,3,1,1,3,1,1,1,2,0,0],
                [0,2,1,1,3,3,3,3,3,3,3,3,1,1,2,0],
                [2,1,1,3,3,3,4,4,4,4,3,3,3,1,1,2],
                [2,1,3,3,4,4,4,1,1,4,4,4,3,3,1,2],
                [2,1,3,4,4,1,1,3,3,1,1,4,4,3,1,2],
                [2,1,3,4,1,3,3,3,3,3,3,1,4,3,1,2],
                [2,1,3,4,1,3,3,3,3,3,3,1,4,3,1,2],
                [2,1,3,4,4,1,1,3,3,1,1,4,4,3,1,2],
                [2,1,1,3,3,3,4,4,4,4,3,3,3,1,1,2],
                [0,2,1,1,3,3,3,3,3,3,3,3,1,1,2,0],
                [0,0,2,1,1,1,3,1,1,3,1,1,1,2,0,0],
                [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
                [0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0]
            ],

            sassy: [
                [0, 0, 0, 0, 0, 0, 9, 9, 9, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 9, 1, 1, 1, 1, 9, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0, 0],
                [0, 0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0, 0],
                [0, 0, 0, 0, 9, 9, 9, 1, 1, 9, 9, 9, 0, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 9, 1, 1, 9, 1, 1, 9, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 1, 9, 9, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 9, 1, 9, 1, 1, 1, 1, 1, 1, 9, 1, 9, 0, 0],
                [0, 9, 1, 1, 1, 9, 1, 9, 9, 1, 9, 1, 1, 1, 9, 0],
                [0, 9, 1, 1, 1, 9, 9, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0],
                [0, 9, 1, 9, 1, 1, 1, 9, 1, 1, 1, 1, 9, 1, 9, 0],
                [0, 9, 1, 9, 1, 1, 1, 9, 9, 1, 1, 1, 9, 1, 9, 0],
                [0, 9, 1, 1, 9, 1, 1, 1, 1, 1, 1, 9, 1, 1, 9, 0]
            ],

            bramble: [
                [0,0,0,0,1,1,2,2,2,1,1,0,0,0,0,0],
                [0,0,0,1,2,3,4,4,4,3,2,1,0,0,0,0],
                [0,0,1,2,4,5,6,6,6,5,4,2,1,0,0,0],
                [0,1,2,4,5,6,6,6,6,6,5,4,2,1,0,0],
                [0,2,3,5,6,6,6,6,6,6,6,5,3,2,0,0],
                [0,2,4,5,6,6,6,6,6,6,6,5,4,2,0,0],
                [0,2,4,5,6,6,6,6,6,6,6,5,4,2,0,0],
                [0,1,3,4,5,6,6,6,6,6,5,4,3,1,0,0],
                [0,1,2,3,4,5,6,6,6,5,4,3,2,1,0,0],
                [0,0,1,2,3,4,5,5,5,4,3,2,1,0,0,0],
                [0,0,0,1,2,3,4,4,4,3,2,1,0,0,0,0],
                [0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
                [0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0],
                [0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            apples: [
                [0,0,0,8,10,10,10,8,10,10,9,9,0,0,0,0],
                [0,0,8,9,8,9,8,9,9,5,9,8,9,0,0,0],
                [0,10,9,5,9,9,9,9,9,9,9,9,9,9,0,0],
                [0,8,9,9,5,9,8,10,10,5,9,9,8,5,10,0],
                [0,10,9,9,9,9,9,5,9,9,9,10,10,10,8,0],
                [0,10,8,5,10,9,9,9,9,8,9,5,10,10,10,0],
                [0,0,10,8,10,10,10,10,10,10,10,10,8,10,0,0],
                [0,0,10,10,10,10,9,0,9,7,10,8,10,0,0,0],
                [0,0,0,0,3,0,0,0,0,7,0,7,0,0,0,0],
                [0,0,0,0,3,4,4,6,6,7,7,7,0,0,0,0],
                [0,0,0,0,0,3,4,4,0,7,7,0,0,0,0,0],
                [0,0,0,0,0,0,4,4,0,7,0,0,0,0,0,0],
                [0,0,0,0,0,0,4,4,6,7,0,0,0,0,0,0],
                [0,0,0,0,0,3,4,4,6,6,7,0,0,0,0,0],
                [0,0,0,0,3,4,4,6,6,6,6,7,0,0,0,0],
                [0,0,0,3,4,0,0,6,0,0,0,6,7,0,0,0]
            ],

            earthy: [
                [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0],
                [0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0],
                [0,0,0,1,2,3,3,4,4,3,3,2,1,0,0,0],
                [0,0,1,2,3,4,4,5,5,4,4,3,2,1,0,0],
                [0,0,1,3,4,5,5,6,6,5,5,4,3,1,0,0],
                [0,1,2,3,5,6,2,6,6,2,6,5,3,2,1,0],
                [0,1,2,3,5,6,6,5,5,6,6,5,3,2,1,0],
                [1,2,3,4,5,6,5,4,4,5,6,5,4,3,2,1],
                [1,2,3,4,5,6,5,4,4,5,6,5,4,3,2,1],
                [0,1,2,3,5,6,6,5,5,6,6,5,3,2,1,0],
                [0,1,2,3,5,6,2,6,6,2,6,5,3,2,1,0],
                [0,0,1,3,4,5,5,6,6,5,5,4,3,1,0,0],
                [0,0,1,2,3,4,4,5,5,4,4,3,2,1,0,0],
                [0,0,0,1,2,3,3,4,4,3,3,2,1,0,0,0],
                [0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0],
                [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0]
            ],

            drago: [
                [0,9,9,9,0,9,9,9,0,0,0,0,0,0,0,0],
                [9,9,4,9,0,9,4,9,9,0,0,0,0,0,0,0],
                [9,4,4,9,9,9,4,4,9,9,0,0,0,0,0,0],
                [9,9,4,4,4,4,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,9,9,9,0,0,0,0,0],
                [9,4,4,4,4,4,4,4,9,7,9,0,0,0,0,0],
                [9,9,4,9,4,4,4,9,9,7,9,0,0,0,0,0],
                [9,4,4,4,4,4,9,9,1,9,7,9,0,9,0,0],
                [0,9,9,9,9,9,1,9,1,1,9,7,9,4,9,0],
                [0,0,9,1,1,1,9,1,1,1,1,9,9,4,9,0],
                [0,9,1,4,1,9,1,1,1,1,1,4,4,9,0,0],
                [0,9,9,4,4,9,9,1,9,4,4,4,9,0,0,0],
                [0,0,0,9,4,4,4,9,0,9,9,9,0,0,0,0],
                [0,0,0,0,9,9,9,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            egg: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,9,9,9,9,9,0,0,0,0,0,0],
                [0,0,0,0,9,1,1,2,2,2,9,0,0,0,0,0],
                [0,0,0,9,1,1,1,2,2,2,3,9,0,0,0,0],
                [0,0,9,1,1,1,1,2,2,3,3,3,9,0,0,0],
                [0,0,9,1,1,1,2,2,2,3,3,3,9,0,0,0],
                [0,9,1,1,1,2,2,2,3,3,3,3,4,9,0,0],
                [9,2,2,2,2,2,2,2,3,3,3,3,4,4,9,0],
                [9,2,2,2,2,2,2,3,3,3,3,3,4,4,9,0],
                [9,2,2,2,2,3,3,3,3,3,3,4,4,4,9,0],
                [9,2,2,2,3,3,3,3,3,4,4,4,4,4,9,0],
                [0,9,2,3,3,3,3,3,4,4,4,4,4,9,0,0],
                [0,9,3,3,3,3,4,4,4,4,4,4,4,9,0,0],
                [0,0,9,9,3,4,4,4,4,4,4,9,9,0,0,0],
                [0,0,0,0,9,9,9,9,9,9,9,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            glyphton: [
                [9,9,1,3,5,7,9,9,9,9,7,5,3,1,9,9],
                [9,9,1,3,5,7,9,1,1,9,7,5,3,1,9,9],
                [1,1,9,3,5,7,9,1,1,9,7,5,3,9,1,1],
                [3,3,3,9,7,9,1,1,1,1,9,7,9,3,3,3],
                [5,5,5,7,9,1,0,0,0,0,1,9,7,5,5,5],
                [7,7,7,9,1,9,3,3,3,3,9,1,9,7,7,7],
                [9,9,9,1,0,3,9,0,0,9,3,0,1,9,9,9],
                [9,1,1,1,0,3,0,9,9,0,3,0,1,1,1,9],
                [9,1,1,1,0,3,0,9,9,0,3,0,1,1,1,9],
                [9,9,9,1,0,3,9,0,0,9,3,0,1,9,9,9],
                [7,7,7,9,1,9,3,3,3,3,9,1,9,7,7,7],
                [5,5,5,7,9,1,0,0,0,0,1,9,7,5,5,5],
                [3,3,3,9,7,9,1,1,1,1,9,7,9,3,3,3],
                [1,1,9,3,5,7,9,1,1,9,7,5,3,9,1,1],
                [9,9,1,3,5,7,9,1,1,9,7,5,3,1,9,9],
                [9,9,1,3,5,7,9,9,9,9,7,5,3,1,9,9]
            ],

            lilguy: [
                [0,0,0,10,10,10,10,0,0,0,0,0,0,0,0,0],
                [0,0,10,1,1,10,7,10,0,0,0,0,0,0,0,0],
                [0,10,1,1,1,1,10,7,10,10,0,0,0,0,0,0],
                [0,1,5,5,1,1,10,7,7,7,10,0,0,0,0,0],
                [0,5,1,10,5,1,1,10,7,7,10,0,0,0,0,0],
                [0,5,10,10,5,1,1,10,7,7,10,0,0,0,0,0],
                [0,1,5,5,1,1,10,7,7,7,10,0,0,0,0,0],
                [0,10,1,1,1,1,10,7,10,10,0,0,0,0,0,0],
                [0,0,10,1,1,10,7,10,7,7,10,10,10,0,0,0],
                [0,0,0,10,10,10,10,0,10,7,7,7,10,0,0,0],
                [0,0,0,0,0,0,0,0,0,10,10,7,10,10,0,0],
                [0,0,0,0,0,0,0,0,10,7,7,10,7,7,10,0],
                [0,0,0,0,0,0,0,10,7,10,10,0,10,10,7,10],
                [0,0,0,0,0,0,0,10,7,10,0,0,0,10,7,10],
                [0,0,0,0,0,0,0,10,7,10,0,0,0,10,7,10],
                [0,0,0,0,0,0,0,0,10,0,0,0,0,0,10,0]
            ],
        };
            


        const affirmations = [
        "Your feelings are valid, even the difficult ones.",
        "Be kind and patient with yourself today.",
        "Each breath is a new, gentle beginning.",
        "It's okay to rest; you are doing enough.",
        "You are resilient, and you can get through this moment.",
        "Allow yourself to simply be, without judgment."
        ];

        // Utility Functions
        function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification show ${type}`;
        setTimeout(() => {
                notification.classList.remove('show');
        }, 3000);
        }

        function saveToLocalStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
        }

        function getFromLocalStorage(key, defaultValue = null) {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : defaultValue;
        }

        // POSITION RADIAL MENU ITEMS
        function positionRadialMenu() {
            const items = document.querySelectorAll('.radial-item');
            const radius = 130;
            const centerX = 160;
            const centerY = 160;
            const angleStep = (2 * Math.PI) / items.length;

            items.forEach((item, index) => {
                const angle = index * angleStep - Math.PI / 2; // start at top
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                item.style.left = `${x}px`;
                item.style.top = `${y}px`;
                item.style.transform = 'translate(-50%, -50%)';
            });
        }

        window.addEventListener('DOMContentLoaded', positionRadialMenu);
        window.addEventListener('resize', positionRadialMenu);

        // ELEMENT REFERENCES
        const menuTrigger = document.getElementById('menuTrigger');
        const radialMenu = document.getElementById('radialMenuApp');
        const radialOverlay = document.getElementById('radialMenuOverlay'); // <div id="radialMenuOverlay"></div>

        // TOGGLE RADIAL MENU
        menuTrigger.addEventListener('click', () => {
            const isOpen = radialMenu.classList.toggle('open');
            radialOverlay.classList.toggle('active', isOpen);
        });

        // CLOSE MENU WHEN CLICKING OUTSIDE (overlay)
        radialOverlay.addEventListener('click', () => {
            radialMenu.classList.remove('open');
            radialOverlay.classList.remove('active');
        });
        

        // UPDATED SWITCH TAB FUNCTION
        function switchTab(tabName, event) {
            // Update active state
            document.querySelectorAll('.radial-item').forEach(item => item.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');

            // Switch screens
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Custom tab-specific logic
            if (typeof updateAffirmationBanner === 'function') updateAffirmationBanner(tabName);
            if (tabName === 'entries' && typeof loadEntries === 'function') loadEntries();
            else if (tabName === 'history' && typeof loadHistory === 'function') loadHistory();
            else if (tabName === 'settings' && typeof loadSettings === 'function') loadSettings();

            // Close menu + overlay after selecting
            radialMenu.classList.remove('open');
            radialOverlay.classList.remove('active');
        }

        function updateAffirmationBanner(screenName) {
        const banner = document.getElementById('affirmationBanner');
        if (screenName === 'jerry' || screenName === 'checkin') {
                banner.textContent = affirmations[Math.floor(Math.random() * affirmations.length)];
        } else {
                banner.textContent = '';
        }
        }

        // Function to update bot name
        function setBotName(newName) {
        appState.botName = newName.trim() || 'Jerry';
        localStorage.setItem('botName', appState.botName);
        }

        // Real-time Jerry Needs Decay
        const NEEDS_TICK_INTERVAL = 500; // 500 ms

        function updateJerryNeeds() {
            const now = Date.now();
            const decayRates = { clarity: 6, insight: 24, calm: 12 }; // hours to fully deplete
            const gracePeriod = 10 * 60 * 1000; // 10 minutes

            Object.keys(appState.jerry.needs).forEach(need => {
                const lastFed = appState.jerry.lastFed[need] || now;
                const elapsedSinceLastFed = now - lastFed - gracePeriod;
                const totalDecayMs = decayRates[need] * 60 * 60 * 1000;

                // Only decay if past grace period
                if (elapsedSinceLastFed > 0) {
                    appState.jerry.needs[need] = Math.max(0, 100 - (elapsedSinceLastFed / totalDecayMs) * 100);
                } else {
                    appState.jerry.needs[need] = 100; // still in grace period
                }
            });

            // Track mood
            const minNeed = Math.min(...Object.values(appState.jerry.needs));
            let newMood = 'content';
            if (minNeed < 50) {
                if (appState.jerry.needs.insight === minNeed) newMood = 'lowInsight';
                else if (appState.jerry.needs.calm === minNeed) newMood = 'lowCalm';
            }
            currentMood = newMood;

            updateJerryUI();
            saveJerryState();
        }

        function initializeJerryDecay() {
            setInterval(updateJerryNeeds, NEEDS_TICK_INTERVAL);
        }
            

        function feedJerry(need, amount = 50) {
        appState.jerry.needs[need] = Math.min(100, appState.jerry.needs[need] + amount);
        appState.jerry.lastFed[need] = Date.now();
        addXP(20);
        saveJerryState();
        updateJerryUI();
        }

        function feedAllJerry(amount) {
            ['clarity', 'insight', 'calm'].forEach(need => feedJerry(need, amount));
        }


        function addXP(amount) {
        appState.jerry.xp += amount;
        if (appState.jerry.xp >= appState.jerry.xpToNext) {
                levelUp();
        }
        saveJerryState();
        updateJerryUI();
        }

        function levelUp() {
        appState.jerry.level++;
        appState.jerry.xp -= appState.jerry.xpToNext;
        appState.jerry.xpToNext = Math.floor(appState.jerry.xpToNext * 1.5);
        showNotification(`Jerry leveled up! Now level ${appState.jerry.level}!`);
        }

        function updateJerryUI() {
        // Update progress bars
        document.getElementById('clarityBar').style.width = `${appState.jerry.needs.clarity}%`;
        document.getElementById('insightBar').style.width = `${appState.jerry.needs.insight}%`;
        document.getElementById('calmBar').style.width = `${appState.jerry.needs.calm}%`;

        // Update text values
        document.getElementById('clarityValue').textContent = `${Math.round(appState.jerry.needs.clarity)}%`;
        document.getElementById('insightValue').textContent = `${Math.round(appState.jerry.needs.insight)}%`;
        document.getElementById('calmValue').textContent = `${Math.round(appState.jerry.needs.calm)}%`;

        // Update level and XP
        document.getElementById('levelLabel').textContent = `Level ${appState.jerry.level}`;
        document.getElementById('xpLabel').textContent = `XP: ${appState.jerry.xp} / ${appState.jerry.xpToNext}`;

        // Update Jerry sprite based on needs
        updateJerrySprite();
        }

        // =====================
        // Update Jerry Sprite (drop-in, synced with dropdowns)
        // =====================
        function updateJerrySprite() {
            // Always rebuild dropdowns first so they stay in sync
            if (typeof populateSpriteDropdown === 'function') {
                populateSpriteDropdown(false); // pass false so it doesn’t overwrite appState
            }
        
            // Load saved settings
            const savedSettings = JSON.parse(localStorage.getItem('spriteSettings') || '{}');
            const savedSpriteStyle = savedSettings.style;
            const savedTheme = savedSettings.theme;
        
            // Load custom sprites into jerrySprites
            const customSprites = getFromLocalStorage('customSprites', { jerry: {}, pet: {} });
            if (customSprites.jerry) {
                for (const [id, sprite] of Object.entries(customSprites.jerry)) {
                    if (sprite?.data && Array.isArray(sprite.data) && Array.isArray(sprite.data[0])) {
                        jerrySprites[id] = sprite.data;
                    }
                }
            }
        
            // Determine current sprite
            let currentSpriteStyle = savedSpriteStyle && jerrySprites[savedSpriteStyle]
                ? savedSpriteStyle
                : Object.keys(jerrySprites)[0] || 'default';
        
            // Determine theme
            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            let spriteTheme = savedTheme && colorSets[savedTheme]
                ? savedTheme
                : Object.keys(colorSets)[0] || 'default';
        
            // Get sprite data safely
            let spriteData = jerrySprites[currentSpriteStyle];
            if (!Array.isArray(spriteData) || !Array.isArray(spriteData[0])) {
                console.warn('Invalid Jerry sprite data, using first available sprite');
                const fallbackKey = Object.keys(jerrySprites)[0] || 'default';
                spriteData = jerrySprites[fallbackKey];
                currentSpriteStyle = fallbackKey;
            }
        
            // Clone to avoid mutation
            baseSprite = JSON.parse(JSON.stringify(spriteData));
        
            // Render
            if (typeof renderJerrySprite === 'function') renderJerrySprite(baseSprite, spriteTheme);
            if (typeof renderSpritePreview === 'function') renderSpritePreview(baseSprite, spriteTheme);
        
            // Persist current settings
            localStorage.setItem('spriteSettings', JSON.stringify({ style: currentSpriteStyle, theme: spriteTheme }));
        
            // Update app state
            if (!appState.sprite) appState.sprite = {};
            appState.sprite.currentSprite = currentSpriteStyle;
            appState.sprite.theme = spriteTheme;
        
            // Sync dropdowns with current state
            const spriteSelect = document.getElementById('spriteStyle');
            if (spriteSelect && Array.from(spriteSelect.options).some(opt => opt.value === currentSpriteStyle)) {
                spriteSelect.value = currentSpriteStyle;
            }
        
            const themeSelect = document.getElementById('spriteTheme');
            if (themeSelect && Array.from(themeSelect.options).some(opt => opt.value === spriteTheme)) {
                themeSelect.value = spriteTheme;
            }
        
            console.log(`Jerry sprite updated: ${currentSpriteStyle} (theme: ${spriteTheme})`);
        }



        function getColorSets(isLightMode) {
            return {
                default: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#C0C0C0', 3: '#808080', 4: '#404040', 5: '#000000', 6: '#FF0000', 7: '#00FF00', 8: '#0000FF', 9: '#FFFF00', 10: '#FF00FF'}
                    : {0: 'transparent', 1: '#F8F8F8', 2: '#D0D0D0', 3: '#808080', 4: '#404040', 5: '#000000', 6: '#FF4444', 7: '#44FF44', 8: '#4444FF', 9: '#FFFF44', 10: '#FF44FF'},
                
                retro8bit: isLightMode
                    ? {0: 'transparent', 1: '#F4F4F4', 2: '#E8E8E8', 3: '#BCBCBC', 4: '#7C7C7C', 5: '#A00000', 6: '#FF6A00', 7: '#FFD500', 8: '#00A844', 9: '#0047AB', 10: '#000000'}
                    : {0: 'transparent', 1: '#FFFFFF', 2: '#E0E0E0', 3: '#A8A8A8', 4: '#606060', 5: '#C00000', 6: '#FF8533', 7: '#FFE033', 8: '#33B855', 9: '#3366CC', 10: '#000000'},

                // Gameboy-inspired monochrome with subtle tints
                gameboyClassic: isLightMode
                    ? {0: 'transparent', 1: '#E0F8D0', 2: '#88C070', 3: '#346856', 4: '#081820', 5: '#9BBB0F', 6: '#8BAC0F', 7: '#306230', 8: '#0F380F', 9: '#155015', 10: '#071821'}
                    : {0: 'transparent', 1: '#9BBB0F', 2: '#8BAC0F', 3: '#306230', 4: '#0F380F', 5: '#C4D82F', 6: '#A2B84F', 7: '#4F7F4F', 8: '#2F4F2F', 9: '#1F3F1F', 10: '#0F1F0F'},

                // Vibrant synthwave/vaporwave aesthetic
                synthwave: isLightMode
                    ? {0: 'transparent', 1: '#FF00FF', 2: '#FF0080', 3: '#FF4080', 4: '#FF8000', 5: '#FFFF00', 6: '#80FF00', 7: '#00FFFF', 8: '#0080FF', 9: '#8000FF', 10: '#2D1B69'}
                    : {0: 'transparent', 1: '#FF44FF', 2: '#FF4499', 3: '#FF6699', 4: '#FF9944', 5: '#FFFF44', 6: '#99FF44', 7: '#44FFFF', 8: '#4499FF', 9: '#9944FF', 10: '#1A1A2E'},
                
                // Earth tones perfect for adventure/RPG sprites
                earthTones: isLightMode
                    ? {0: 'transparent', 1: '#FFF8DC', 2: '#D2B48C', 3: '#CD853F', 4: '#A0522D', 5: '#8B4513', 6: '#654321', 7: '#556B2F', 8: '#8FBC8F', 9: '#2F4F4F', 10: '#191970'}
                    : {0: 'transparent', 1: '#F5E6D3', 2: '#C8A882', 3: '#B8860B', 4: '#8B4513', 5: '#654321', 6: '#3E2723', 7: '#4A5D23', 8: '#6B8E5A', 9: '#2E3B2E', 10: '#1C1C3A'},
                
                // Ice and crystal theme
                crystalIce: isLightMode
                    ? {0: 'transparent', 1: '#F0F8FF', 2: '#E6F3FF', 3: '#B3D9FF', 4: '#80BFFF', 5: '#4DA6FF', 6: '#1A8CFF', 7: '#0066CC', 8: '#004C99', 9: '#003366', 10: '#001A33'}
                    : {0: 'transparent', 1: '#E6F7FF', 2: '#CCF0FF', 3: '#99E0FF', 4: '#66D0FF', 5: '#33C0FF', 6: '#00B0FF', 7: '#0099CC', 8: '#007399', 9: '#004D66', 10: '#002633'},

                // Fire and lava theme
                moltenCore: isLightMode
                    ? {0: 'transparent', 1: '#FFFACD', 2: '#FFE4B5', 3: '#FFA500', 4: '#FF6347', 5: '#FF4500', 6: '#DC143C', 7: '#B22222', 8: '#8B0000', 9: '#4B0000', 10: '#000000'}
                    : {0: 'transparent', 1: '#FFF5E1', 2: '#FFCC80', 3: '#FF8F00', 4: '#FF5722', 5: '#D84315', 6: '#BF360C', 7: '#8D2635', 8: '#5D1A1D', 9: '#3E1317', 10: '#1A0A0B'},

                // Forest and nature theme
                enchantedForest: isLightMode
                    ? {0: 'transparent', 1: '#F0FFF0', 2: '#E6FFE6', 3: '#CCFFCC', 4: '#99FF99', 5: '#66CC66', 6: '#339933', 7: '#228B22', 8: '#006400', 9: '#004400', 10: '#002200'}
                    : {0: 'transparent', 1: '#E8F5E8', 2: '#C8E6C8', 3: '#A8D8A8', 4: '#88C488', 5: '#68B068', 6: '#489848', 7: '#387438', 8: '#285028', 9: '#183018', 10: '#081808'},

                // Classic NES-inspired palette
                nesClassic: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#FCFCFC', 3: '#F8F8F8', 4: '#BCBCBC', 5: '#7C7C7C', 6: '#A4E4FC', 7: '#3CBCFC', 8: '#0078F8', 9: '#0000FC', 10: '#000000'}
                    : {0: 'transparent', 1: '#FCFCFC', 2: '#F8F8F8', 3: '#E4E4E4', 4: '#A8A8A8', 5: '#585858', 6: '#94D4E4', 7: '#28A8D8', 8: '#0060C4', 9: '#0000A8', 10: '#000000'},

                // Cyberpunk/tech theme
                cyberpunk: isLightMode
                    ? {0: 'transparent', 1: '#00FFFF', 2: '#00E6E6', 3: '#00CCCC', 4: '#00B3B3', 5: '#FF00FF', 6: '#E600E6', 7: '#CC00CC', 8: '#B300B3', 9: '#4D0080', 10: '#0D001A'}
                    : {0: 'transparent', 1: '#66FFFF', 2: '#33F0F0', 3: '#00E0E0', 4: '#00C8C8', 5: '#FF66FF', 6: '#E633E6', 7: '#CC00CC', 8: '#A800A8', 9: '#6600AA', 10: '#1A0033'},

                // Desert/sand theme
                desertSands: isLightMode
                    ? {0: 'transparent', 1: '#FFF8DC', 2: '#F5DEB3', 3: '#DEB887', 4: '#D2B48C', 5: '#BC9A6A', 6: '#A0522D', 7: '#8B4513', 8: '#654321', 9: '#3E2723', 10: '#2E1A14'}
                    : {0: 'transparent', 1: '#F0E68C', 2: '#E6D875', 3: '#DCC95E', 4: '#B8A248', 5: '#8B7A32', 6: '#6B5B28', 7: '#4A3C1D', 8: '#3A2F17', 9: '#2A2212', 10: '#1A150C'},
   
                // Ocean depths theme
                deepOcean: isLightMode
                    ? {0: 'transparent', 1: '#E0F6FF', 2: '#B3E5FC', 3: '#4FC3F7', 4: '#29B6F6', 5: '#03A9F4', 6: '#0288D1', 7: '#0277BD', 8: '#01579B', 9: '#01447A', 10: '#002F5A'}
                    : {0: 'transparent', 1: '#B3E5FC', 2: '#81D4FA', 3: '#4FC3F7', 4: '#29B6F6', 5: '#0288D1', 6: '#0277BD', 7: '#01579B', 8: '#003C71', 9: '#002952', 10: '#001635'},

                // Cosmic/space them
                cosmicVoid: isLightMode
                    ? {0: 'transparent', 1: '#E1BEE7', 2: '#CE93D8', 3: '#BA68C8', 4: '#AB47BC', 5: '#8E24AA', 6: '#7B1FA2', 7: '#6A1B9A', 8: '#4A148C', 9: '#38006B', 10: '#1A0033'}
                    : {0: 'transparent', 1: '#E1BEE7', 2: '#CE93D8', 3: '#BA68C8', 4: '#9C27B0', 5: '#8E24AA', 6: '#7B1FA2', 7: '#6A1B9A', 8: '#4A148C', 9: '#38006B', 10: '#1A0033'},

                // Monochrome with accent
                inkWash: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#F5F5F5', 3: '#E0E0E0', 4: '#BDBDBD', 5: '#9E9E9E', 6: '#757575', 7: '#424242', 8: '#212121', 9: '#FF5722', 10: '#000000'}
                    : {0: 'transparent', 1: '#F5F5F5', 2: '#E8E8E8', 3: '#D0D0D0', 4: '#A8A8A8', 5: '#808080', 6: '#585858', 7: '#383838', 8: '#181818', 9: '#FF6B3D', 10: '#000000'},
                // Autumn/fall colors
                autumnLeaves: isLightMode
                    ? {0: 'transparent', 1: '#FFF8E7', 2: '#FFE0B3', 3: '#FFCC80', 4: '#FF8F65', 5: '#FF7043', 6: '#F4511E', 7: '#E65100', 8: '#BF360C', 9: '#8D2F00', 10: '#5D1F00'}
                    : {0: 'transparent', 1: '#FFE8CC', 2: '#FFCC80', 3: '#FFB74D', 4: '#FF8A65', 5: '#FF7043', 6: '#F4511E', 7: '#E65100', 8: '#CC4400', 9: '#B33300', 10: '#802200'},
                // Cherry blossom theme
                sakuraBloom: isLightMode
                    ? {0: 'transparent', 1: '#FFF0F5', 2: '#FFE4E1', 3: '#FFC0CB', 4: '#FFB6C1', 5: '#FF91A4', 6: '#FF69B4', 7: '#E91E63', 8: '#C2185B', 9: '#AD1457', 10: '#880E4F'}
                    : {0: 'transparent', 1: '#FFEBEE', 2: '#FFCDD2', 3: '#F8BBD9', 4: '#F48FB1', 5: '#F06292', 6: '#EC407A', 7: '#E91E63', 8: '#C2185B', 9: '#AD1457', 10: '#880E4F'}
            };
        }

        // Fixed rendering functions to accept and use parameters
        function renderJerrySprite(spriteData, spriteTheme) {
            if (!spriteData) return;
            const container = document.getElementById('jerrySprite');
            container.innerHTML = '';

            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            const colors = colorSets[spriteTheme] || colorSets['default'];

            spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                    if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.position = 'absolute';
                        pixelDiv.style.width = '10px';
                        pixelDiv.style.height = '10px';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        pixelDiv.style.pointerEvents = 'none';
                        container.appendChild(pixelDiv);
                    }
                });
            });
        }

        function renderSpritePreview(spriteData, spriteTheme) {
            if (!spriteData) return;
            const previewContainer = document.getElementById('spritePreview');
            previewContainer.innerHTML = '';
        
            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            const colors = colorSets[spriteTheme] || colorSets['default'];
        
            const rows = spriteData.length;
            const cols = spriteData[0].length;
        
            // Base pixel size for preview
            let pixelSize = 10;
        
            // Max container size
            const maxWidth = 160;
            const maxHeight = 160;
        
            // Only scale down if sprite is too large
            if (cols * pixelSize > maxWidth || rows * pixelSize > maxHeight) {
                pixelSize = Math.floor(Math.min(maxWidth / cols, maxHeight / rows));
            }
        
            previewContainer.style.width = `${cols * pixelSize}px`;
            previewContainer.style.height = `${rows * pixelSize}px`;
            previewContainer.style.position = 'relative';
            previewContainer.style.background = 'transparent';
        
            spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                    if (pixel > 0) {
                        const px = document.createElement('div');
                        px.className = 'pixel';
                        px.style.position = 'absolute';
                        px.style.width = `${pixelSize}px`;
                        px.style.height = `${pixelSize}px`;
                        px.style.backgroundColor = colors[pixel];
                        px.style.left = `${x * pixelSize}px`;
                        px.style.top = `${y * pixelSize}px`;
                        px.style.pointerEvents = 'none';
                        previewContainer.appendChild(px);
                    }
                });
            });
        }


        // === Jerry Animation Controller ==
        const jerryContainer = document.getElementById('jerrySprite');

        
        let currentMood = "content";
        let jerryTalking = false;
        let tapActive = false; // is the tap animation running
        let breathTime = 0;
        let shakeOffset = 0;
        let shakeActive = false;

        
        // === Persistent base sprite (includes evolutions/mood) ===
        let baseSprite;


        // === Helper Functions ===
        function getCurrentSprite() {
        return baseSprite;
        }

        // Redraw Jerry sprite
        function drawJerry(spriteData = baseSprite, spriteTheme = appState.spriteTheme || 'default') {
            if (!spriteData) return;
            const container = document.getElementById('jerrySprite');
            container.innerHTML = '';

            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            const colors = colorSets[spriteTheme] || colorSets['default'];

            spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                    if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.position = 'absolute';
                        pixelDiv.style.width = '10px';
                        pixelDiv.style.height = '10px';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        container.appendChild(pixelDiv);
                    }
                });
            });
        }

        // === Animations ===
        const blinkableSprites = ['cornelius', 'scott'];
        const blinkTargets = {
            4: [
                // Left eye block
                [4,4],[4,5],[4,6],
                [5,3],[5,4],[5,5],[5,6],[5,7],
                [6,3],[6,4],[6,5],[6,6],[6,7],
                [7,4],[7,5],[7,6],

                // Right eye block
                [4,10],[4,11],[4,12],
                [5,9],[5,10],[5,11],[5,12],[5,13],
                [6,9],[6,10],[6,11],[6,12],[6,13],
                [7,10],[7,11],[7,12],

                //Bottom eye block
                [10,7],[10,8],[10,9],
                [11,6],[11,7],[11,8],[11,9],[11,10],
                [12,7],[12,8],[12,9]
            ]
        };

        const BLINK_DURATION = 150; // 1/2 second

        function blinkJerry() {
            const currentSprite = getCurrentSprite();
            const spriteCopy = JSON.parse(JSON.stringify(currentSprite));

            const blinkPixels = blinkTargets[4]; // Use the full eye block
            blinkPixels.forEach(([r, c]) => {
                const newR = r - 1;
                const newC = c - 1;
                if (spriteCopy[newR] && spriteCopy[newR][newC] !== undefined) {
                    spriteCopy[newR][newC] = 3; // blink color
                }
            });

            drawJerry(spriteCopy);

            setTimeout(() => {
                drawJerry(currentSprite);
            }, BLINK_DURATION);
        }

        
        // Breathing (brightness + scale)
        function breatheJerry() {
            breathTime += 0.05;
            const brightness = 1 + 0.1 * Math.sin(breathTime); // noticeable pulse
            const scale = 1 + 0.02 * Math.sin(breathTime);
            jerryContainer.style.filter = `brightness(${brightness})`;
            jerryContainer.style.transform = `scale(${scale})`;
        }

        // Mood switching
        function setMood(mood) {
            // Always use the currently selected sprite style, ignore mood variations
            const currentSpriteStyle = localStorage.getItem('jerrySpriteStyle') || 'default';
    
            if (jerrySprites[currentSpriteStyle]) {
                currentMood = mood; // track mood but don't change sprite
                baseSprite = JSON.parse(JSON.stringify(jerrySprites[currentSpriteStyle]));
                drawJerry(getCurrentSprite());
            }
        }

        // Talking animation
        async function jerryTalk(text) {
        jerryTalking = true;
        let frame = 0;
        const talkInterval = setInterval(() => {
                frame = 1 - frame;
                const sprite = JSON.parse(JSON.stringify(getCurrentSprite()));
                let mouth;
                switch (currentMood) {
                case 'content': mouth = [[6, 7], [6, 8]]; break;
                case 'lowInsight': mouth = [[5, 6], [5, 9]]; break;
                case 'lowCalm': mouth = [[4, 6], [4, 9]]; break;
                }
                mouth.forEach(([r, c]) => sprite[r][c] = frame ? 0 : 1);
                drawJerry(sprite);
        }, 200);

        await renderText(text); // your existing text rendering
        clearInterval(talkInterval);
        jerryTalking = false;
        drawJerry(getCurrentSprite());
        }

        //function evolveJerry(level) {
            //if (!jerryContainer) return;

            // Remove any existing halo
            //const oldHalo = document.getElementById('jerryHalo');
            //if (oldHalo) oldHalo.remove();

            //if (level >= 5) {
                // Create halo div
                //const halo = document.createElement('div');
                //halo.id = 'jerryHalo';
                // Minimal inline styles; CSS handles position, transform, and animation
                //halo.style.position = 'absolute';
                //halo.style.width = '40px';
                //halo.style.height = '8px';
                //halo.style.backgroundColor = 'gold';
                //halo.style.borderRadius = '50%';
                //halo.style.zIndex = '10';
                //jerryContainer.appendChild(halo);
            //}

            // Redraw Jerry sprite (sprite will be below the halo due to z-index)
            //drawJerry(getCurrentSprite());
        //}

        function triggerShake() {
            if (shakeActive || !jerryContainer) return; // Add jerryContainer check
            shakeActive = true;
            let i = 0;
            const shakeFrames = 10;
            const amplitude = 5;
            const interval = setInterval(() => {
                shakeOffset = (i % 2 === 0 ? amplitude : -amplitude);
                i++;
                if (i > shakeFrames) {
                    clearInterval(interval);
                    shakeOffset = 0;
                    shakeActive = false;
                }
            }, 30);
        }

        // Add safety check before adding event listener
        if (jerryContainer) {
            jerryContainer.addEventListener('click', triggerShake);
        }        

        function updateJerry() {
            // Safety check - exit if jerryContainer doesn't exist
            if (!jerryContainer) {
                console.warn('jerryContainer not found, stopping animation');
                return;
            }

            breathTime += 0.05;


            // Breathing scale
            const baseScale = 1 + 0.02 * Math.sin(breathTime);

            // Apply transform: shake + breathing
            jerryContainer.style.transform = `translateX(${shakeOffset}px) scale(${baseScale})`;

            // Animate halo (if it exists)
            const halo = document.getElementById('jerryHalo');
            if (halo) {
                const floatOffset = 2 * Math.sin(breathTime); // 2px up/down
                halo.style.top = `${-10 + floatOffset}px`;
            }

            requestAnimationFrame(updateJerry);
        }

        // Only start the animation loop if jerryContainer exists
        if (jerryContainer) {
            updateJerry();
            scheduleBlink();
        }

        function scheduleBlink() {
            if (!blinkableSprites.includes(appState.jerry.sprite)) return;
            
            const delay = 3000 + Math.random() * 3000; // 2–4 seconds
            setTimeout(() => {
                blinkJerry();
                scheduleBlink(); // repeat indefinitely
            }, delay);
        }

        function saveJerryState() {
            // Only ensure lastFed exists for undefined needs, don't overwrite existing timestamps
            if (!appState.jerry.lastFed) appState.jerry.lastFed = {};

            ['clarity', 'insight', 'calm'].forEach(need => {
                if (typeof appState.jerry.lastFed[need] === 'undefined') {
                    appState.jerry.lastFed[need] = Date.now();
                }
            });

            saveToLocalStorage('hush_jerry_state', appState.jerry);
        }

        function loadJerryState() {
            const defaultJerryState = {
                needs: { clarity: 100, insight: 100, calm: 100 },
                lastFed: { clarity: Date.now(), insight: Date.now(), calm: Date.now() },
                level: 1,
                xp: 0,
                xpToNext: 100,
                currentSprite: 'default'
            };

            const saved = getFromLocalStorage('hush_jerry_state');
            if (saved && saved.lastFed) {
                appState.jerry = { ...defaultJerryState, ...saved };
                appState.jerry.lastFed = { ...saved.lastFed }; // <— don’t mix with default lastFed
            } else {
                appState.jerry = defaultJerryState;
            }

            // Ensure lastFed exists for any missing needs
            ['clarity', 'insight', 'calm'].forEach(need => {
                if (typeof appState.jerry.lastFed[need] === 'undefined') {
                    appState.jerry.lastFed[need] = Date.now();
                }
            });

            // Apply immediate decay based on real elapsed time since lastFed
            const now = Date.now();
            const decayRates = { clarity: 6, insight: 24, calm: 12 }; // hours to fully deplete
            const gracePeriod = 10 * 60 * 1000; // 10 minutes

            Object.keys(appState.jerry.needs).forEach(need => {
                const elapsedSinceLastFed = Math.max(0, now - appState.jerry.lastFed[need] - gracePeriod);
                const totalDecayMs = decayRates[need] * 60 * 60 * 1000;
                appState.jerry.needs[need] = Math.max(0, 100 - (elapsedSinceLastFed / totalDecayMs) * 100);
            });
            updateJerryNeeds();
        }

        const petSprites = {
            miniJerry: [
                [0,0,2,2,2,2,0,0],
                [0,2,1,1,1,1,2,0],
                [2,1,0,0,0,0,1,2],
                [2,1,0,2,2,0,1,2],
                [2,1,0,0,0,0,1,2],
                [2,1,0,0,0,0,1,2],
                [0,2,1,1,1,1,2,0],
                [0,0,2,2,2,2,0,0]
            ],

            puff: [
                [0,0,3,3,3,3,0,0],
                [0,3,3,3,3,3,3,0],
                [3,3,0,3,3,0,3,3],
                [3,3,3,3,3,3,3,3],
                [3,3,3,0,0,3,3,3],
                [0,3,3,3,3,3,3,0],
                [0,0,3,3,3,3,0,0],
                [0,0,0,3,3,0,0,0]
            ],

            spark: [
                [0,0,2,0,0,2,0,0],
                [0,2,0,3,3,0,2,0],
                [2,0,3,4,4,3,0,2],
                [0,3,4,4,4,4,3,0],
                [0,3,4,4,4,4,3,0],
                [2,0,3,4,4,3,0,2],
                [0,2,0,3,3,0,2,0],
                [0,0,2,0,0,2,0,0]
            ],

            buddy: [
                [0, 0, 0, 9, 9, 9, 9, 9, 9, 9, 9, 9, 0, 0, 0, 0],
                [0, 0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0],
                [9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0],
                [9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0],
                [9, 1, 9, 9, 1, 1, 1, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [9, 1, 9, 9, 1, 1, 1, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [9, 1, 9, 9, 1, 1, 9, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [9, 1, 1, 1, 1, 9, 9, 9, 1, 1, 1, 1, 1, 1, 9, 0],
                [0, 9, 1, 1, 1, 9, 1, 9, 1, 1, 1, 1, 1, 9, 0, 0],
                [0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 9, 9, 1, 1, 1, 1, 1, 1, 9, 9, 0, 0, 0, 0],
                [0, 0, 0, 9, 1, 9, 1, 9, 1, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 9, 1, 9, 1, 9, 1, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 9, 9, 9, 9, 9, 9, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],

            orb: [
                [0,0,1,2,2,2,1,0],
                [0,1,3,4,4,4,3,1],
                [0,3,5,6,6,6,5,3],
                [0,3,5,6,6,6,5,3],
                [0,3,5,6,6,6,5,3],
                [0,1,3,5,5,5,3,1],
                [0,0,1,3,3,3,1,0],
                [0,0,0,1,1,1,0,0]
            ],

            flame: [
                [0,0,0,2,2,0,0,0],
                [0,0,2,3,3,2,0,0],
                [0,2,3,4,4,3,2,0],
                [2,3,4,4,4,4,3,2],
                [0,2,3,4,4,3,2,0],
                [0,0,2,3,3,2,0,0],
                [0,0,0,2,2,0,0,0],
                [0,0,0,0,0,0,0,0]
            ],

            leaf: [
                [0,0,0,2,2,0,0,0],
                [0,0,2,3,3,2,0,0],
                [0,2,3,3,3,3,2,0],
                [2,3,3,4,4,3,3,2],
                [0,2,3,3,3,3,2,0],
                [0,0,2,3,3,2,0,0],
                [0,0,0,2,2,0,0,0],
                [0,0,0,0,0,0,0,0]
            ],

            gem: [
                [0,0,2,2,2,2,0,0],
                [0,2,3,3,3,3,2,0],
                [2,3,1,3,3,1,3,2],  // eyes (1s)
                [2,3,3,3,3,3,3,2],
                [2,3,3,1,1,3,3,2],  // mouth start
                [2,3,3,3,3,3,3,2],
                [0,2,3,3,3,3,2,0],
                [0,0,2,2,2,2,0,0]
            ],

            beetle: [
                [0,0,0,2,2,0,0,0],
                [0,0,2,3,3,2,0,0],
                [0,2,3,1,1,3,2,0],
                [2,3,3,3,3,3,3,2],
                [2,3,3,3,3,3,3,2],
                [0,2,3,2,2,3,2,0],
                [0,0,2,3,3,2,0,0],
                [0,0,0,2,2,0,0,0]
            ],

            star: [
                [0,0,0,2,0,2,0,0],
                [0,0,2,3,2,3,2,0],
                [0,2,3,4,4,4,3,2],
                [0,3,4,4,4,4,4,3],
                [0,2,3,4,4,4,3,2],
                [0,0,2,3,4,3,2,0],
                [0,0,0,2,3,2,0,0],
                [0,0,0,0,2,0,0,0]
            ],

            peepaw: [
                [0,0,5,5,5,5,0,0],
                [0,6,3,3,3,3,6,0],
                [3,3,1,1,1,1,3,3],
                [3,3,1,1,1,1,3,3],
                [0,4,4,4,4,4,4,0],  
                [5,5,5,5,5,5,5,5],
                [0,3,3,3,3,3,3,0],
                [0,0,3,3,3,3,0,0]
            ],

            flicker: [
                [0,0,1,2,2,1,0,0],
                [0,1,2,3,3,2,1,0],
                [1,2,4,5,5,4,2,1],
                [0,3,5,6,6,5,3,0],
                [0,3,5,6,6,5,3,0],
                [1,2,4,5,5,4,2,1],
                [0,1,2,3,3,2,1,0],
                [0,0,1,2,2,1,0,0]
            ],

            grumple: [
                [0,0,2,2,2,2,0,0],
                [0,2,3,3,3,3,2,0],
                [2,3,4,5,5,4,3,2],
                [2,3,5,6,6,5,3,2],
                [2,3,5,6,6,5,3,2],
                [2,3,4,5,5,4,3,2],
                [0,2,3,3,3,3,2,0],
                [0,0,2,2,2,2,0,0]
            ],

            dragojr: [
                [0,9,9,9,0,9,9,9,0,0,0,0,0,0,0,0],
                [9,9,4,9,0,9,4,9,9,0,0,0,0,0,0,0],
                [9,4,4,9,9,9,4,4,9,9,0,0,0,0,0,0],
                [9,9,4,4,4,4,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,9,9,9,0,0,0,0,0],
                [9,4,4,4,4,4,4,4,9,7,9,0,0,0,0,0],
                [9,9,4,9,4,4,4,9,9,7,9,0,0,0,0,0],
                [9,4,4,4,4,4,9,9,1,9,7,9,0,9,0,0],
                [0,9,9,9,9,9,1,1,1,1,9,7,9,4,9,0],
                [0,0,9,1,1,1,1,1,1,1,1,9,9,4,9,0],
                [0,9,1,4,1,1,9,1,1,1,1,4,4,9,0,0],
                [0,9,9,4,4,1,9,1,9,4,4,4,9,0,0,0],
                [0,0,0,9,4,4,4,9,0,9,9,9,0,0,0,0],
                [0,0,0,0,9,9,9,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            tube: [
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
                [7, 3, 7, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 4, 4, 4, 4, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 3, 4, 4, 3, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 3, 4, 4, 3, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 4, 4, 4, 4, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 4, 4, 4, 4, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 7, 3, 7],
                [7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
                [0, 0, 0, 0, 7, 0, 7, 0, 0, 7, 0, 7, 0, 0, 0, 0],
                [0, 0, 0, 0, 7, 0, 7, 0, 0, 7, 0, 7, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 7, 0, 0, 7, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 5, 5, 0, 0, 5, 5, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],
            
            qube: [
                [0, 0, 0, 0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
                [0, 0, 0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3],
                [0, 0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3],
                [0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 0],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 0, 0],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],

            chromeo: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,4,4,0,0,0,0,0,0,0,0,0,4,4],
                [0,0,4,0,4,0,0,0,0,0,0,0,0,4,0,4],
                [0,4,0,0,0,0,0,0,0,0,0,0,4,0,0,0],
                [5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0],
                [9,9,9,1,9,9,9,9,9,9,1,9,0,0,0,0],
                [9,9,1,9,9,9,9,9,9,1,9,9,0,0,0,0],
                [9,1,9,9,9,0,0,9,1,9,9,9,0,0,0,0],
                [0,9,9,9,0,0,0,0,9,9,9,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            rainbow: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,8,8,8,8,8,8,0,0,0,0,0],
                [0,0,0,0,8,8,4,4,4,4,8,8,0,0,0,0],
                [0,0,0,8,8,4,4,3,3,4,4,8,8,0,0,0],
                [0,0,0,8,4,3,3,0,0,3,3,4,8,0,0,0],
                [0,0,0,8,4,3,0,0,0,0,3,4,8,0,0,0],
                [0,0,0,8,4,3,0,0,0,0,3,4,8,0,0,0],
                [0,0,0,8,4,3,10,0,0,10,3,4,8,0,0,0],
                [0,0,10,10,10,10,10,0,0,10,10,10,10,10,0,0],
                [0,10,10,10,10,10,10,0,0,10,10,10,10,10,10,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
        };

        // Get the current light/dark mode state
        function isLightModeActive() {
            // Check for a theme class on body, or localStorage, or system preference
            const body = document.body;
            const savedTheme = localStorage.getItem('theme');

            if (savedTheme) {
                return savedTheme === 'light';
            }

            // Check for theme classes
            if (body.classList.contains('light-theme') || body.classList.contains('light-mode')) {
                return true;
            }
            if (body.classList.contains('dark-theme') || body.classList.contains('dark-mode')) {
                return false;
            }
            
            // Fall back to system preference
            return !window.matchMedia('(prefers-color-scheme: dark)').matches;
        }

        // Get pet theme colors based on current mode
        function getPetThemeColors(themeName) {
            const isLightMode = isLightModeActive();
            const petThemes = {
                default: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#C0C0C0', 3: '#808080', 4: '#404040', 5: '#000000', 6: '#FF0000', 7: '#00FF00', 8: '#0000FF', 9: '#FFFF00', 10: '#FF00FF'}
                    : {0: 'transparent', 1: '#F8F8F8', 2: '#D0D0D0', 3: '#808080', 4: '#404040', 5: '#000000', 6: '#FF4444', 7: '#44FF44', 8: '#4444FF', 9: '#FFFF44', 10: '#FF44FF'},
                
                retro8bit: isLightMode
                    ? {0: 'transparent', 1: '#F4F4F4', 2: '#E8E8E8', 3: '#BCBCBC', 4: '#7C7C7C', 5: '#A00000', 6: '#FF6A00', 7: '#FFD500', 8: '#00A844', 9: '#0047AB', 10: '#000000'}
                    : {0: 'transparent', 1: '#FFFFFF', 2: '#E0E0E0', 3: '#A8A8A8', 4: '#606060', 5: '#C00000', 6: '#FF8533', 7: '#FFE033', 8: '#33B855', 9: '#3366CC', 10: '#000000'},

                // Gameboy-inspired monochrome with subtle tints
                gameboyClassic: isLightMode
                    ? {0: 'transparent', 1: '#E0F8D0', 2: '#88C070', 3: '#346856', 4: '#081820', 5: '#9BBB0F', 6: '#8BAC0F', 7: '#306230', 8: '#0F380F', 9: '#155015', 10: '#071821'}
                    : {0: 'transparent', 1: '#9BBB0F', 2: '#8BAC0F', 3: '#306230', 4: '#0F380F', 5: '#C4D82F', 6: '#A2B84F', 7: '#4F7F4F', 8: '#2F4F2F', 9: '#1F3F1F', 10: '#0F1F0F'},

                // Vibrant synthwave/vaporwave aesthetic
                synthwave: isLightMode
                    ? {0: 'transparent', 1: '#FF00FF', 2: '#FF0080', 3: '#FF4080', 4: '#FF8000', 5: '#FFFF00', 6: '#80FF00', 7: '#00FFFF', 8: '#0080FF', 9: '#8000FF', 10: '#2D1B69'}
                    : {0: 'transparent', 1: '#FF44FF', 2: '#FF4499', 3: '#FF6699', 4: '#FF9944', 5: '#FFFF44', 6: '#99FF44', 7: '#44FFFF', 8: '#4499FF', 9: '#9944FF', 10: '#1A1A2E'},
                
                // Earth tones perfect for adventure/RPG sprites
                earthTones: isLightMode
                    ? {0: 'transparent', 1: '#FFF8DC', 2: '#D2B48C', 3: '#CD853F', 4: '#A0522D', 5: '#8B4513', 6: '#654321', 7: '#556B2F', 8: '#8FBC8F', 9: '#2F4F4F', 10: '#191970'}
                    : {0: 'transparent', 1: '#F5E6D3', 2: '#C8A882', 3: '#B8860B', 4: '#8B4513', 5: '#654321', 6: '#3E2723', 7: '#4A5D23', 8: '#6B8E5A', 9: '#2E3B2E', 10: '#1C1C3A'},
                
                // Ice and crystal theme
                crystalIce: isLightMode
                    ? {0: 'transparent', 1: '#F0F8FF', 2: '#E6F3FF', 3: '#B3D9FF', 4: '#80BFFF', 5: '#4DA6FF', 6: '#1A8CFF', 7: '#0066CC', 8: '#004C99', 9: '#003366', 10: '#001A33'}
                    : {0: 'transparent', 1: '#E6F7FF', 2: '#CCF0FF', 3: '#99E0FF', 4: '#66D0FF', 5: '#33C0FF', 6: '#00B0FF', 7: '#0099CC', 8: '#007399', 9: '#004D66', 10: '#002633'},

                // Fire and lava theme
                moltenCore: isLightMode
                    ? {0: 'transparent', 1: '#FFFACD', 2: '#FFE4B5', 3: '#FFA500', 4: '#FF6347', 5: '#FF4500', 6: '#DC143C', 7: '#B22222', 8: '#8B0000', 9: '#4B0000', 10: '#000000'}
                    : {0: 'transparent', 1: '#FFF5E1', 2: '#FFCC80', 3: '#FF8F00', 4: '#FF5722', 5: '#D84315', 6: '#BF360C', 7: '#8D2635', 8: '#5D1A1D', 9: '#3E1317', 10: '#1A0A0B'},

                // Forest and nature theme
                enchantedForest: isLightMode
                    ? {0: 'transparent', 1: '#F0FFF0', 2: '#E6FFE6', 3: '#CCFFCC', 4: '#99FF99', 5: '#66CC66', 6: '#339933', 7: '#228B22', 8: '#006400', 9: '#004400', 10: '#002200'}
                    : {0: 'transparent', 1: '#E8F5E8', 2: '#C8E6C8', 3: '#A8D8A8', 4: '#88C488', 5: '#68B068', 6: '#489848', 7: '#387438', 8: '#285028', 9: '#183018', 10: '#081808'},

                // Classic NES-inspired palette
                nesClassic: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#FCFCFC', 3: '#F8F8F8', 4: '#BCBCBC', 5: '#7C7C7C', 6: '#A4E4FC', 7: '#3CBCFC', 8: '#0078F8', 9: '#0000FC', 10: '#000000'}
                    : {0: 'transparent', 1: '#FCFCFC', 2: '#F8F8F8', 3: '#E4E4E4', 4: '#A8A8A8', 5: '#585858', 6: '#94D4E4', 7: '#28A8D8', 8: '#0060C4', 9: '#0000A8', 10: '#000000'},

                // Cyberpunk/tech theme
                cyberpunk: isLightMode
                    ? {0: 'transparent', 1: '#00FFFF', 2: '#00E6E6', 3: '#00CCCC', 4: '#00B3B3', 5: '#FF00FF', 6: '#E600E6', 7: '#CC00CC', 8: '#B300B3', 9: '#4D0080', 10: '#0D001A'}
                    : {0: 'transparent', 1: '#66FFFF', 2: '#33F0F0', 3: '#00E0E0', 4: '#00C8C8', 5: '#FF66FF', 6: '#E633E6', 7: '#CC00CC', 8: '#A800A8', 9: '#6600AA', 10: '#1A0033'},

                // Desert/sand theme
                desertSands: isLightMode
                    ? {0: 'transparent', 1: '#FFF8DC', 2: '#F5DEB3', 3: '#DEB887', 4: '#D2B48C', 5: '#BC9A6A', 6: '#A0522D', 7: '#8B4513', 8: '#654321', 9: '#3E2723', 10: '#2E1A14'}
                    : {0: 'transparent', 1: '#F0E68C', 2: '#E6D875', 3: '#DCC95E', 4: '#B8A248', 5: '#8B7A32', 6: '#6B5B28', 7: '#4A3C1D', 8: '#3A2F17', 9: '#2A2212', 10: '#1A150C'},
   
                // Ocean depths theme
                deepOcean: isLightMode
                    ? {0: 'transparent', 1: '#E0F6FF', 2: '#B3E5FC', 3: '#4FC3F7', 4: '#29B6F6', 5: '#03A9F4', 6: '#0288D1', 7: '#0277BD', 8: '#01579B', 9: '#01447A', 10: '#002F5A'}
                    : {0: 'transparent', 1: '#B3E5FC', 2: '#81D4FA', 3: '#4FC3F7', 4: '#29B6F6', 5: '#0288D1', 6: '#0277BD', 7: '#01579B', 8: '#003C71', 9: '#002952', 10: '#001635'},

                // Cosmic/space them
                cosmicVoid: isLightMode
                    ? {0: 'transparent', 1: '#E1BEE7', 2: '#CE93D8', 3: '#BA68C8', 4: '#AB47BC', 5: '#8E24AA', 6: '#7B1FA2', 7: '#6A1B9A', 8: '#4A148C', 9: '#38006B', 10: '#1A0033'}
                    : {0: 'transparent', 1: '#E1BEE7', 2: '#CE93D8', 3: '#BA68C8', 4: '#9C27B0', 5: '#8E24AA', 6: '#7B1FA2', 7: '#6A1B9A', 8: '#4A148C', 9: '#38006B', 10: '#1A0033'},

                // Monochrome with accent
                inkWash: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#F5F5F5', 3: '#E0E0E0', 4: '#BDBDBD', 5: '#9E9E9E', 6: '#757575', 7: '#424242', 8: '#212121', 9: '#FF5722', 10: '#000000'}
                    : {0: 'transparent', 1: '#F5F5F5', 2: '#E8E8E8', 3: '#D0D0D0', 4: '#A8A8A8', 5: '#808080', 6: '#585858', 7: '#383838', 8: '#181818', 9: '#FF6B3D', 10: '#000000'},
                // Autumn/fall colors
                autumnLeaves: isLightMode
                    ? {0: 'transparent', 1: '#FFF8E7', 2: '#FFE0B3', 3: '#FFCC80', 4: '#FF8F65', 5: '#FF7043', 6: '#F4511E', 7: '#E65100', 8: '#BF360C', 9: '#8D2F00', 10: '#5D1F00'}
                    : {0: 'transparent', 1: '#FFE8CC', 2: '#FFCC80', 3: '#FFB74D', 4: '#FF8A65', 5: '#FF7043', 6: '#F4511E', 7: '#E65100', 8: '#CC4400', 9: '#B33300', 10: '#802200'},
                // Cherry blossom theme
                sakuraBloom: isLightMode
                    ? {0: 'transparent', 1: '#FFF0F5', 2: '#FFE4E1', 3: '#FFC0CB', 4: '#FFB6C1', 5: '#FF91A4', 6: '#FF69B4', 7: '#E91E63', 8: '#C2185B', 9: '#AD1457', 10: '#880E4F'}
                    : {0: 'transparent', 1: '#FFEBEE', 2: '#FFCDD2', 3: '#F8BBD9', 4: '#F48FB1', 5: '#F06292', 6: '#EC407A', 7: '#E91E63', 8: '#C2185B', 9: '#AD1457', 10: '#880E4F'}
            };

            return petThemes[themeName] || petThemes.default;
        }

        // =====================
        // Sprite Rendering
        // =====================

        // Render a pet sprite from array + theme colors
        function renderPetSprite(spriteArray, colors, maxSize = 50) {
            const rows = spriteArray.length;
            const cols = spriteArray[0].length;
        
            // Calculate pixel size to fit sprite inside maxSize
            const pixelSize = Math.floor(Math.min(maxSize / cols, maxSize / rows));
        
            const spriteDiv = document.createElement('div');
            spriteDiv.classList.add('pet-sprite', 'pulse');
            spriteDiv.style.display = 'grid';
            spriteDiv.style.gridTemplateColumns = `repeat(${cols}, ${pixelSize}px)`;
            spriteDiv.style.gridTemplateRows = `repeat(${rows}, ${pixelSize}px)`;
            spriteDiv.style.width = `${cols * pixelSize}px`;
            spriteDiv.style.height = `${rows * pixelSize}px`;
            spriteDiv.style.background = 'transparent';
            spriteDiv.style.pointerEvents = 'none'; // allow click animation
            spriteDiv.style.boxSizing = 'border-box';
        
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const pixelValue = spriteArray[y][x];
                    const px = document.createElement('div');
        
                    px.style.width = `${pixelSize}px`;
                    px.style.height = `${pixelSize}px`;
                    px.style.backgroundColor = pixelValue !== 0 ? colors[pixelValue] : 'transparent';
        
                    spriteDiv.appendChild(px);
                }
            }
        
            // Optional click animation
            spriteDiv.addEventListener('click', () => {
                spriteDiv.style.transform = 'scale(1.2)';
                setTimeout(() => spriteDiv.style.transform = '', 200);
            });
        
            return spriteDiv;
        }


        function renderPetPreview() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');
            const preview = document.getElementById('petPreview');
        
            if (!styleElement || !themeElement || !preview) {
                console.warn('Pet preview elements not found');
                return;
            }
        
            const style = styleElement.value;
            const theme = themeElement.value;
            preview.innerHTML = '';
        
            if (style === 'none') return;
        
            const spriteData = petSprites[style];
            const themeColors = getPetThemeColors(theme);
        
            if (spriteData && themeColors) {
                const rows = spriteData.length;
                const cols = spriteData[0].length;
        
                // Fixed preview size (like #spritePreview)
                const previewWidth = preview.clientWidth || 60;
                const previewHeight = preview.clientHeight || 60;
        
                // Calculate pixel size to fit inside the container
                const pixelSize = Math.floor(Math.min(previewWidth / cols, previewHeight / rows));
        
                // Offset to center the sprite inside preview
                const offsetX = Math.floor((previewWidth - cols * pixelSize) / 2);
                const offsetY = Math.floor((previewHeight - rows * pixelSize) / 2);
        
                spriteData.forEach((row, y) => {
                    row.forEach((pixel, x) => {
                        if (pixel > 0) {
                            const px = document.createElement('div');
                            px.className = 'pixel';
                            px.style.position = 'absolute';
                            px.style.width = `${pixelSize}px`;
                            px.style.height = `${pixelSize}px`;
                            px.style.backgroundColor = themeColors[pixel];
                            px.style.left = `${offsetX + x * pixelSize}px`;
                            px.style.top = `${offsetY + y * pixelSize}px`;
                            preview.appendChild(px);
                        }
                    });
                });
            }
        }

        
        // Render the sticky top-right pet on every page
        function updateStickyPet() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');
            const petContainer = document.getElementById('petContainer');
        
            if (!styleElement || !themeElement || !petContainer) {
                console.warn('Pet sticky elements not found');
                return;
            }
        
            const style = styleElement.value;
            const theme = themeElement.value;
            petContainer.innerHTML = '';
        
            if (style === 'none') return;
        
            const spriteData = petSprites[style];
            const themeColors = getPetThemeColors(theme);
        
            if (spriteData && themeColors) {
                // Use maxSize to scale sprite to fit container
                const maxContainerSize = Math.min(petContainer.clientWidth, petContainer.clientHeight);
                const petSpriteDiv = renderPetSprite(spriteData, themeColors, maxContainerSize);
        
                // Ensure container is fixed at top-right
                petContainer.style.position = 'fixed';
                petContainer.style.top = '10px';
                petContainer.style.right = '10px';
                petContainer.style.zIndex = '50';
                petContainer.style.pointerEvents = 'none'; // optional: pass clicks through
        
                petContainer.appendChild(petSpriteDiv);
            }
        }

        function savePetSettings() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');

            if (!styleElement || !themeElement) return;

            const settings = {
                style: styleElement.value,
                theme: themeElement.value
            };

            try {
                localStorage.setItem('petSettings', JSON.stringify(settings));
            } catch (error) {
                console.warn('Failed to save pet settings:', error);
            }
        }

        function loadPetSettings() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');
        
            if (!styleElement || !themeElement) return;
        
            // Clear existing options
            styleElement.innerHTML = '';
            themeElement.innerHTML = '';
        
            // Populate sprite styles
            styleElement.appendChild(new Option('None', 'none'));
            for (const key in petSprites) {
                styleElement.appendChild(new Option(key, key));
            }
        
            // Populate themes
            const availableThemes = [
                'default', 'candy', 'ocean', 'ember', 'meadow', 'neon', 
                'pastel', 'gothic', 'aurora', 'retroPixel', 'fantasySprite'
            ];
            for (const theme of availableThemes) {
                themeElement.appendChild(new Option(theme, theme));
            }
        
            // Load saved settings
            const savedStyle = localStorage.getItem('petStyle') || 'miniJerry';
            const savedTheme = localStorage.getItem('petTheme') || 'default';
        
            styleElement.value = petSprites[savedStyle] ? savedStyle : 'miniJerry';
            themeElement.value = availableThemes.includes(savedTheme) ? savedTheme : 'default';
        
            // Initial render
            renderPetPreview();
            updateStickyPet();
        
            // Update preview on change
            styleElement.addEventListener('change', () => {
                renderPetPreview();
                updateStickyPet();
                localStorage.setItem('petStyle', styleElement.value);
            });
        
            themeElement.addEventListener('change', () => {
                renderPetPreview();
                updateStickyPet();
                localStorage.setItem('petTheme', themeElement.value);
            });
        }


        function initializePetSystem() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePetSystem);
                return;
            }

            // -----------------------------
            // Initialize appState for both sprite and pet
            // -----------------------------
            if (!appState.sprite) appState.sprite = {};
            if (!appState.pet) appState.pet = {};
            
            // Main sprite settings
            if (!appState.sprite.currentSprite) appState.sprite.currentSprite = 'default';
            if (!appState.sprite.theme) appState.sprite.theme = 'default';
            
            // Pet settings  
            if (!appState.pet.currentSprite) appState.pet.currentSprite = 'none';
            if (!appState.pet.theme) appState.pet.theme = 'default';

            // -----------------------------
            // Load custom sprites
            // -----------------------------
            let customSprites = getFromLocalStorage('customSprites', { jerry: {}, pet: {} });
            if (!customSprites.jerry) customSprites.jerry = {};
            if (!customSprites.pet) customSprites.pet = {};

            // Merge sprites into existing objects without overwriting
            for (const [id, sprite] of Object.entries(customSprites.jerry)) {
                if (sprite?.data && Array.isArray(sprite.data) && Array.isArray(sprite.data[0])) {
                    jerrySprites[id] = sprite.data;
                } else {
                    delete customSprites.jerry[id];
                }
            }

            for (const [id, sprite] of Object.entries(customSprites.pet)) {
                if (sprite?.data && Array.isArray(sprite.data) && Array.isArray(sprite.data[0])) {
                    petSprites[id] = sprite.data;
                } else {
                    delete customSprites.pet[id];
                }
            }

            saveToLocalStorage('customSprites', customSprites);

            // -----------------------------
            // Available themes
            // -----------------------------
            const availableThemes = ['default', 'retro8bit', 'gameboyClassic', 'synthwave', 'earthTones', 'crystalIce', 'moltenCore', 'enchantedForest', 'nesClassic', 'cyberpunk', 'desertSands', 'deepOcean', 'cosmicVoid', 'inkWash', 'autumnLeaves', 'sakuraBloom'];

            // -----------------------------
            // DOM elements - CORRECT IDs
            // -----------------------------
            const spriteStyleSelect = document.getElementById('spriteStyle');
            const spriteThemeSelect = document.getElementById('spriteTheme');
            const spritePreview = document.getElementById('spritePreview');
            
            const petStyleSelect = document.getElementById('petStyle');
            const petThemeSelect = document.getElementById('petTheme');
            const petPreview = document.getElementById('petPreview');
            const petContainer = document.getElementById('petContainer');
            
            const uploadedSpritesList = document.getElementById('uploadedSpritesList');
            const spriteFileInput = document.getElementById('spriteFileInput');
            const spriteUploadZone = document.getElementById('spriteUploadZone');
            const uploadInputs = document.getElementById('spriteUploadInputs');
            const nameInput = document.getElementById('spriteNameInputInline');
            const categorySelect = document.getElementById('spriteCategorySelectInline');
            const uploadSubmit = document.getElementById('spriteUploadSubmitInline');

            if (!spriteStyleSelect || !petStyleSelect) {
                console.warn('Sprite/Pet elements not found');
                return;
            }

            let pendingUpload = null;

            // -----------------------------
            // Populate sprite dropdown (Jerry category)
            // -----------------------------
            function populateSpriteDropdown() {
                if (!spriteStyleSelect || !spriteThemeSelect) return;
            
                // -----------------------------
                // Capture existing built-in options (to preserve original labels)
                // -----------------------------
                const builtInOptions = Array.from(spriteStyleSelect.options).map(opt => ({
                    value: opt.value,
                    text: opt.textContent
                }));
            
                // -----------------------------
                // Clear current options
                // -----------------------------
                spriteStyleSelect.innerHTML = '';
                spriteThemeSelect.innerHTML = '';
            
                // -----------------------------
                // Re-add built-in options exactly as in HTML
                // -----------------------------
                builtInOptions.forEach(opt => {
                    spriteStyleSelect.appendChild(new Option(opt.text, opt.value));
                });
            
                // -----------------------------
                // Add custom Jerry sprites
                // -----------------------------
                Object.entries(customSprites.jerry).forEach(([id, sprite]) => {
                    spriteStyleSelect.appendChild(new Option(`${sprite.name} (Custom)`, id));
                });
            
                // -----------------------------
                // Populate themes
                // -----------------------------
                availableThemes.forEach(theme => {
                    const displayName = theme === 'autumnLeaves' ? 'Autumn Leaves' :
                                        theme === 'sakuraBloom' ? 'Sakura Bloom' :
                                        theme.charAt(0).toUpperCase() + theme.slice(1);
                    spriteThemeSelect.appendChild(new Option(displayName, theme));
                });
            
                // -----------------------------
                // Load saved settings
                // -----------------------------
                const savedSettings = JSON.parse(localStorage.getItem('spriteSettings') || '{}');
                const savedStyle = savedSettings.style;
                const savedTheme = savedSettings.theme || 'default';
            
                // -----------------------------
                // Determine the actual sprite to display
                // -----------------------------
                const styleExists = Array.from(spriteStyleSelect.options).some(opt => opt.value === savedStyle);
                appState.sprite.currentSprite = styleExists ? savedStyle : spriteStyleSelect.options[0]?.value || 'default';
                appState.sprite.theme = savedTheme;
            
                // -----------------------------
                // Set dropdowns to reflect actual current sprite + theme
                // -----------------------------
                spriteStyleSelect.value = appState.sprite.currentSprite;
                spriteThemeSelect.value = appState.sprite.theme;
            }

            // -----------------------------
            // Populate pet dropdown (pet category)
            // -----------------------------
            function populatePetDropdown() {
                if (!petStyleSelect || !petThemeSelect) return;
                
                // Store existing built-in options
                const builtInOptions = Array.from(petStyleSelect.options).map(opt => ({
                    value: opt.value,
                    text: opt.textContent
                }));
                
                petStyleSelect.innerHTML = '';
                petThemeSelect.innerHTML = '';
                
                // Re-add built-in options  
                builtInOptions.forEach(option => {
                    petStyleSelect.appendChild(new Option(option.text, option.value));
                });
                
                // Add custom Pet sprites
                Object.keys(customSprites.pet).forEach(key => {
                    const option = new Option(`${customSprites.pet[key].name} (Custom)`, key);
                    petStyleSelect.appendChild(option);
                });
                
                // Populate themes
                availableThemes.forEach(theme => {
                    const displayName = theme === 'fantasySprite' ? 'Fantasy' : 
                                    theme === 'retroPixel' ? 'Retro' :
                                    theme.charAt(0).toUpperCase() + theme.slice(1);
                    petThemeSelect.appendChild(new Option(displayName, theme));
                });
                
                // Load saved settings
                const savedPetSettings = JSON.parse(localStorage.getItem('petSettings') || '{}');
                const savedStyle = savedPetSettings.style || 'none';
                const savedTheme = savedPetSettings.theme || 'default';
                
                // Validate saved style exists in either built-in or custom sprites
                const styleExists = Array.from(petStyleSelect.options).some(opt => opt.value === savedStyle);
                
                appState.pet.currentSprite = styleExists ? savedStyle : 'none';
                appState.pet.theme = savedTheme;
                
                petStyleSelect.value = appState.pet.currentSprite;
                petThemeSelect.value = appState.pet.theme;
            }

            populateSpriteDropdown();
            populatePetDropdown();

            // -----------------------------
            // Render functions
            // -----------------------------
            function refreshSpriteRender() {
                const spriteId = appState.sprite.currentSprite;
                const theme = appState.sprite.theme || 'default';
                const spriteData = jerrySprites[spriteId] || jerrySprites['default'];
            
                if (typeof renderJerrySprite === 'function') renderJerrySprite(spriteData, theme);
                if (typeof renderSpritePreview === 'function') renderSpritePreview(spriteData, theme);
            }

            
            function refreshPetRender() {
                if (typeof renderPetPreview === 'function') renderPetPreview();
                if (typeof updateStickyPet === 'function') updateStickyPet();
            }

            // -----------------------------
            // Jerry dropdown listeners (fixed)
            // -----------------------------
            if (spriteStyleSelect) {
                spriteStyleSelect.addEventListener('change', () => {
                    const selectedSprite = spriteStyleSelect.value;
                    const currentTheme = appState.sprite.theme || 'default';

                    // Update appState
                    appState.sprite.currentSprite = selectedSprite;

                    // Persist both sprite + theme together
                    localStorage.setItem('spriteSettings', JSON.stringify({
                        style: appState.sprite.currentSprite,
                        theme: currentTheme
                    }));

                    // Refresh render
                    refreshSpriteRender();
                });
            }

            if (spriteThemeSelect) {
                spriteThemeSelect.addEventListener('change', () => {
                    const selectedTheme = spriteThemeSelect.value;

                    // Only update theme in appState
                    appState.sprite.theme = selectedTheme;

                    // Persist both sprite + theme together using appState.sprite.currentSprite
                    localStorage.setItem('spriteSettings', JSON.stringify({
                        style: appState.sprite.currentSprite,
                        theme: appState.sprite.theme
                    }));

                    // Refresh render
                    refreshSpriteRender();
                });
            }


            // -----------------------------
            // Pet dropdown listeners  
            // -----------------------------
            if (petStyleSelect) {
                petStyleSelect.addEventListener('change', () => {
                    const style = petStyleSelect.value;
                    appState.pet.currentSprite = style;
                    localStorage.setItem('petSettings', JSON.stringify({ 
                        style, 
                        theme: appState.pet.theme || 'default' 
                    }));
                    refreshPetRender();
                });
            }

            if (petThemeSelect) {
                petThemeSelect.addEventListener('change', () => {
                    const theme = petThemeSelect.value;
                    appState.pet.theme = theme;
                    localStorage.setItem('petSettings', JSON.stringify({ 
                        style: appState.pet.currentSprite || 'none', 
                        theme 
                    }));
                    refreshPetRender();
                });
            }

            // -----------------------------
            // Uploaded sprites list
            // -----------------------------
            function appendSpriteToList(category, id, sprite) {
                if (!uploadedSpritesList) return;
                const li = document.createElement('li');
                const categoryLabel = category === 'jerry' ? 'Main Character' : 'Pet/Companion';
                li.innerHTML = `<span>${categoryLabel}: ${sprite.name}</span>
                <button onclick="deleteSprite('${category}','${id}','${sprite.name}')">Delete</button>`;
                uploadedSpritesList.appendChild(li);
            }

            function updateUploadList() {
                if (!uploadedSpritesList) return;
                uploadedSpritesList.innerHTML = '';

                for (const [id, sprite] of Object.entries(customSprites.jerry)) {
                    appendSpriteToList('jerry', id, sprite);
                }
                for (const [id, sprite] of Object.entries(customSprites.pet)) {
                    appendSpriteToList('pet', id, sprite);
                }
            }

            window.deleteSprite = function(category, id, name) {
                if (!confirm(`Delete sprite "${name}"?`)) return;
                delete customSprites[category][id];
                if (category === 'jerry') delete jerrySprites[id];
                else delete petSprites[id];
                saveToLocalStorage('customSprites', customSprites);

                // Reset to default if deleted sprite was selected
                if (category === 'jerry' && appState.sprite.currentSprite === id) {
                    appState.sprite.currentSprite = 'default';
                    refreshSpriteRender();
                }
                if (category === 'pet' && appState.pet.currentSprite === id) {
                    appState.pet.currentSprite = 'none';
                    refreshPetRender();
                }

                populateSpriteDropdown();
                populatePetDropdown();
                updateUploadList();
            };

            // -----------------------------
            // Handle sprite file uploads
            // -----------------------------
            async function handleFile(file) {
                if (!file || !nameInput || !categorySelect || !uploadInputs) return;
                try {
                    const text = await file.text();
                    let data = JSON.parse(text);

                    let spriteData = null;

                    if (data.sprite) {
                        spriteData = data.sprite;
                    } else if (Array.isArray(data.sprites) && data.sprites.length > 0) {
                        spriteData = data.sprites[0];
                    } else if (Array.isArray(data) && Array.isArray(data[0])) {
                        spriteData = { name: "Unnamed Sprite", data: data };
                    }

                    if (spriteData && Array.isArray(spriteData.data)) {
                        pendingUpload = {
                            type: "sprite",
                            data: spriteData.data,
                            name: spriteData.name || "Unnamed Sprite"
                        };
                        nameInput.value = pendingUpload.name;
                        categorySelect.style.display = "block";
                        uploadInputs.style.display = "block";
                    } else {
                        console.error("Invalid sprite format:", data);
                        alert("No valid sprite found in file.");
                    }
                } catch (err) {
                    console.error("Error parsing file:", err);
                    alert("Error reading file: " + err.message);
                } finally {
                    if (spriteFileInput) spriteFileInput.value = "";
                }
            }

            if (uploadSubmit) {
                uploadSubmit.addEventListener('click', () => {
                    if (!pendingUpload) {
                        alert("No sprite selected to upload.");
                        return;
                    }
                    
                    if (!nameInput) {
                        alert('Name input not found.');
                        return;
                    }
                    
                    const name = nameInput.value.trim();
                    
                    if (!name) {
                        alert('Please enter a name.');
                        return;
                    }

                    const category = categorySelect.value;
                    const id = `${category}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                    // Add to custom sprites storage
                    customSprites[category][id] = { name, data: pendingUpload.data };
                    
                    // Add to runtime sprite objects based on category
                    if (category === 'jerry') {
                        jerrySprites[id] = pendingUpload.data;
                    } else {
                        petSprites[id] = pendingUpload.data;
                    }

                    // Save to localStorage
                    saveToLocalStorage('customSprites', customSprites);

                    // Clear pending upload and UI
                    pendingUpload = null;
                    nameInput.value = '';
                    categorySelect.style.display = "none";
                    uploadInputs.style.display = "none";

                    // Update appropriate dropdown based on category
                    if (category === 'jerry') {
                        populateSpriteDropdown();
                        refreshSpriteRender();
                    } else {
                        populatePetDropdown();
                        refreshPetRender();
                    }
                    
                    updateUploadList();
                    
                    const categoryLabel = category === 'jerry' ? 'Main Character' : 'Pet/Companion';
                    console.log(`Successfully uploaded sprite "${name}" to ${categoryLabel} category`);
                });
            }

            // File input change handler
            if (spriteFileInput) {
                spriteFileInput.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files.length > 0) {
                        handleFile(e.target.files[0]);
                    }
                });
            }

            // Drag & drop
            if (spriteUploadZone) {
                spriteUploadZone.addEventListener('dragover', (e) => {
                    if (e.dataTransfer?.types.includes('Files')) {
                        e.preventDefault();
                        spriteUploadZone.classList.add('dragover');
                    }
                });    

                spriteUploadZone.addEventListener('dragleave', (e) => {
                    if (!spriteUploadZone.contains(e.relatedTarget)) {
                        spriteUploadZone.classList.remove('dragover');
                    }
                });

                spriteUploadZone.addEventListener('drop', (e) => {
                    if (e.dataTransfer?.files && e.dataTransfer.files.length > 0) {
                        e.preventDefault();
                        spriteUploadZone.classList.remove('dragover');
                        handleFile(e.dataTransfer.files[0]);
                    }
                });
            }

            // -----------------------------
            // Final render
            // -----------------------------
            refreshSpriteRender();
            refreshPetRender();
            updateUploadList();
        }



        // === Chat Functions ===
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessageToChat('user', message, 'user');
            input.value = '';

            // Add to history
            appState.chatHistory.push({ role: 'user', content: message });

            // Add thinking indicator and keep reference
            const thinkingDiv = addMessageToChat('assistant', 'Thinking...', 'jerry thinking');

            try {
                const response = await getAIResponse(message);

                // Replace "Thinking..." with actual response
                thinkingDiv.innerHTML = `<strong>${appState.botName || 'Jerry'}:</strong> ${response}`;
                thinkingDiv.classList.remove('thinking');

                // Keep chat history within limit
                const MAX_CHAT_HISTORY = 20;
                if (appState.chatHistory.length > MAX_CHAT_HISTORY) {
                    appState.chatHistory = appState.chatHistory.slice(-MAX_CHAT_HISTORY);
                }

            } catch (error) {
                console.error('sendMessage error:', error);

                // Replace thinking indicator with fallback response
                thinkingDiv.innerHTML = `<strong>${appState.botName || 'Jerry'}:</strong> ${getFallbackResponse(message)}`;
                thinkingDiv.classList.remove('thinking');
            }
        }


        /**
         * Adds a message to the chat and returns the created div for later updates.
         * @param {string} speaker - 'assistant' or 'user'
         * @param {string} message - The message text
         * @param {string} className - Additional class for styling (e.g., 'jerry', 'thinking')
         * @returns {HTMLElement} - The created message div
         */
        function addMessageToChat(speaker, message, className = '') {
            const chatLog = document.getElementById('chatLog');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`.trim();

            const displayName = speaker === 'assistant' ? (appState.botName || 'Jerry') : 'You';
            messageDiv.innerHTML = `<strong>${displayName}:</strong> ${message}`;

            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            return messageDiv;
        }

        async function getAIResponse(message) {
            if (!appState) appState = { chatHistory: [], botName: 'Jerry', apiKey: '' };
            if (!subscriptionState) subscriptionState = { isSubscribed: false, messageCount: 0 };

            // Pick API key
            const apiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
            let apiKey;
            if (apiOption === 'premium') {
                if (!subscriptionState.isSubscribed) throw new Error('Premium subscription required');
                if (subscriptionState.messageCount >= 1000) throw new Error('Monthly message limit reached');
                apiKey = PREMIUM_API_KEY;
                subscriptionState.messageCount++; 
                localStorage.setItem('jerry_message_count', String(subscriptionState.messageCount));
                updateUsageDisplay();
            } else {
                apiKey = appState.apiKey || document.getElementById('apiKey')?.value?.trim();
                if (!apiKey) throw new Error('Please enter your API key or subscribe to Premium');
            }

            // Keep only last 15 messages
            if (appState.chatHistory.length > 15) {
                appState.chatHistory = appState.chatHistory.slice(-15);
            }

            // Only add system prompt once at the very beginning
            const systemPromptText = 'You are Jerry, a friendly, gentle, and supportive AI companion focused on mental health. Keep responses brief and caring, offering emotional support and encouragement. You help users with CBT and DBT techniques when appropriate.';

            const contents = [];
            if (!appState.chatHistory.some(m => m.role === 'system')) {
                contents.push({ role: 'user', parts: [{ text: systemPromptText }] });
                appState.chatHistory.unshift({ role: 'system', content: systemPromptText });
            }

            // Add conversation history
            contents.push(
                ...appState.chatHistory
                    .filter(m => m.role !== 'system')
                    .map(m => ({
                        role: m.role === 'assistant' ? 'assistant' : 'user',
                        parts: [{ text: m.content }]
                    }))
            );

            let data;
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents,
                        generationConfig: { maxOutputTokens: 1000, temperature: 0.7, topK: 40, topP: 0.95 }
                    })
                });

                if (!resp.ok) {
                    const text = await resp.text();
                    console.error('Generative API error:', resp.status, text);
                    throw new Error('API request failed');
                }

                data = await resp.json();
                console.log('Generative API response:', data);

            } catch (err) {
                console.error('Fetch failed', err);
                return getFallbackResponse(message);
            }

            // Parse reply defensively
            let reply = 'Sorry, I\'m having trouble composing a response right now.';
            try {
                reply = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim()
                     || data?.outputs?.[0]?.content?.text?.trim()
                     || reply;
            } catch (e) {
                console.error('Parsing AI response failed', e);
            }

            // Push assistant reply
            appState.chatHistory.push({ role: 'assistant', content: reply });

            return reply;
        }

        // API option switching
        function setupApiOptionHandlers() {
        const ownApiRadio = document.getElementById('useOwnApi');
        const premiumRadio = document.getElementById('usePremium');
        const ownApiSection = document.getElementById('ownApiSection');
        const premiumSection = document.getElementById('premiumSection');

        function switchApiOption() {
                const selectedOption = document.querySelector('input[name="apiOption"]:checked')?.value;

                if (selectedOption === 'premium') {
                ownApiSection.style.display = 'none';
                premiumSection.style.display = 'block';
                setupPayPalButton();
                } else {
                ownApiSection.style.display = 'block';
                premiumSection.style.display = 'none';
                }

                localStorage.setItem('jerry_api_option', selectedOption);
                updateChatInterface();
        }

        ownApiRadio?.addEventListener('change', switchApiOption);
        premiumRadio?.addEventListener('change', switchApiOption);
        }

        // PayPal integration
        function setupPayPalButton() {
        const container = document.getElementById('paypal-button-container');
        if (!container) return;

        container.innerHTML = ''; // Clear existing buttons

        if (subscriptionState.isSubscribed) {
                container.style.display = 'none'; // Hide if already subscribed
                return;
        } else {
                container.style.display = 'block'; // Show if not subscribed
        }

        paypal.Buttons({
                style: {
                shape: 'pill',
                color: 'gold',
                layout: 'vertical',
                label: 'subscribe'
                },

                createSubscription: function(data, actions) {
                return actions.subscription.create({
                        'plan_id': 'P-7LR41432T4749780UNC7UVBY', // Replace with your actual PayPal plan ID
                        'custom_id': 'jerry_premium_' + Date.now()
                });
                },

                onApprove: function(data, actions) {
                subscriptionState.isSubscribed = true;
                subscriptionState.subscriptionId = data.subscriptionID;
                subscriptionState.messageCount = 0; // Reset counter
                subscriptionState.billingCycle = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(); // 30 days from now

                // Save to localStorage
                localStorage.setItem('jerry_subscription_active', 'true');
                localStorage.setItem('jerry_subscription_id', data.subscriptionID);
                localStorage.setItem('jerry_message_count', '0');
                localStorage.setItem('jerry_billing_cycle', subscriptionState.billingCycle);

                showNotification('🌟 Premium subscription activated! Welcome to Jerry Premium!');
                updateSubscriptionDisplay();
                updateChatInterface();

                container.style.display = 'none';
                },

                onError: function(err) {
                console.error('PayPal error:', err);
                showNotification('Subscription failed. Please try again.', 'error');
                }
        }).render('#paypal-button-container');
        }


        // Update subscription display
        function updateSubscriptionDisplay() {
        const statusDisplay = document.getElementById('subscriptionStatusDisplay');
        const subscribeSection = document.getElementById('paypalSubscribeSection');
        const messageUsageDisplay = document.getElementById('messageUsageDisplay');
        const nextBillingDate = document.getElementById('nextBillingDate');

        if (subscriptionState.isSubscribed) {
                statusDisplay.style.display = 'block';
                subscribeSection.style.display = 'none';

                if (messageUsageDisplay) {
                messageUsageDisplay.textContent = `${subscriptionState.messageCount} / 1000`;
                }

                if (nextBillingDate && subscriptionState.billingCycle) {
                const date = new Date(subscriptionState.billingCycle);
                nextBillingDate.textContent = date.toLocaleDateString();
                }
        } else {
                statusDisplay.style.display = 'none';
                subscribeSection.style.display = 'block';
        }
        }

        // Update usage display in Jerry screen
        function updateUsageDisplay() {
        const messageCountEl = document.getElementById('messageCount');
        const usageFillEl = document.getElementById('usageFill');
        const subscriptionStatusEl = document.getElementById('subscriptionStatus');

        if (subscriptionState.isSubscribed && subscriptionStatusEl) {
                subscriptionStatusEl.style.display = 'block';

                if (messageCountEl) {
                messageCountEl.textContent = subscriptionState.messageCount;
                }

                if (usageFillEl) {
                const percentage = (subscriptionState.messageCount / 1000) * 100;
                usageFillEl.style.width = `${percentage}%`;
                }
        } else if (subscriptionStatusEl) {
                subscriptionStatusEl.style.display = 'none';
        }
        }

        // Update chat interface based on API option
        function updateChatInterface() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const apiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
        
            if (!chatInput || !sendButton) return;
        
            let canSend = false;
            
            // NEVER disable or make readonly the textarea
            chatInput.disabled = false;
            chatInput.readOnly = false;
            
            if (apiOption === 'premium') {
                if (subscriptionState.isSubscribed) {
                    if (subscriptionState.messageCount >= 1000) {
                        chatInput.placeholder = 'Monthly limit reached. Resets next billing cycle.';
                    } else {
                        chatInput.placeholder = 'Type your message... (Premium)';
                        canSend = true;
                    }
                } else {
                    chatInput.placeholder = 'Premium subscription required';
                }
            } else {
                const hasApiKey = appState.apiKey || document.getElementById('apiKey')?.value?.trim();
                if (hasApiKey) {
                    chatInput.placeholder = 'Type your message...';
                    canSend = true;
                } else {
                    chatInput.placeholder = 'Please enter your API key in Settings';
                }
            }
            
            // Only disable the send button, never the input
            sendButton.disabled = !canSend;
        }


        // Cancel subscription
        async function cancelSubscription() {
        if (!confirm('Are you sure you want to cancel your Premium subscription? You will lose access at the end of your current billing period.')) {
                return;
        }

        try {
                // In a real implementation, you would call your backend to cancel the PayPal subscription
                // For now, we'll just clear local storage
                subscriptionState.isSubscribed = false;
                subscriptionState.subscriptionId = null;

                localStorage.removeItem('jerry_subscription_active');
                localStorage.removeItem('jerry_subscription_id');
                localStorage.removeItem('jerry_billing_cycle');

                showNotification('Subscription cancelled. You can continue using Premium until your next billing date.');
                updateSubscriptionDisplay();
                updateChatInterface();

                // Switch back to own API option
                document.getElementById('useOwnApi').checked = true;
                document.querySelector('input[name="apiOption"][value="own"]').dispatchEvent(new Event('change'));

        } catch (error) {
                showNotification('Failed to cancel subscription. Please try again.', 'error');
        }
        }

        function getFallbackResponse(message) {
        const lowerMessage = message.toLowerCase();
        const responses = {
                'hello': "Hello! It's good to see you.",
                'hi': "Hello! It's good to see you.",
                'how are you': "I'm doing well, thank you! How can I help you today?",
                'thank': "You're very welcome!",
                'bye': "Goodbye! Have a great day!",
                'help': "I'm here to listen and support you. You can talk to me about anything, or try the CBT and DBT tools in the other tabs.",
                'sad': "I'm sorry you're feeling sad. Your emotions are valid. Would you like to talk about what's bothering you?",
                'anxious': "Anxiety can be really difficult. Remember to breathe deeply. I'm here to listen if you'd like to share what's making you anxious.",
                'angry': "It's okay to feel angry. Let's talk about what's causing these feelings."
        };

        for (const [key, response] of Object.entries(responses)) {
                if (lowerMessage.includes(key)) {
                return response;
                }
        }

        return "I'm here to listen. Tell me what's on your mind.";
        }

        // Check-in Functions
        function setCheckinResponse(button, category, choice) {
            appState.checkinData[category] = choice;

            // Remove 'active' from all buttons in the same category
            const buttons = document.querySelectorAll(`[onclick*="${category}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));

            // Set active class on tapped button
            button.classList.add('active');
        }

        function completeCheckin() {
            const requiredFields = ['emotion', 'physical', 'mental'];
            const missing = requiredFields.filter(f => !appState.checkinData[f]);

            if (missing.length > 0) {
                showNotification('Please answer all questions before continuing.', 'error');
                return;
            }

            const entry = {
                timestamp: new Date().toISOString(),
                type: 'Check-in',
                data: { ...appState.checkinData }
            };
            
            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);

            feedJerry('clarity', 50);
            addXP(10);

            showNotification('Check-in completed! Jerry gained clarity.');

            // Reset for
            appState.checkinData = {};
            document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));

            // Switch back to Jerry tab
            switchTab('jerry');

            // Refresh entries screen if needed
            loadEntries();
        }

        // =====================
        // CBT Functions
        // =====================
        function completeCBT() {
            const situation = document.getElementById('cbtSituation').value.trim();
            const emotions = document.getElementById('cbtEmotions').value.trim();
            const thoughts = document.getElementById('cbtThoughts').value.trim();

            if (!situation || !emotions || !thoughts) {
                showNotification('Please fill in all fields.', 'error');
                return;
            }

            // Get selected distortions
            const distortions = [];
            document.querySelectorAll('#cbtDistortions input:checked').forEach(checkbox => {
                distortions.push(checkbox.nextElementSibling.textContent);
            });

            const entry = {
                timestamp: new Date().toISOString(),
                type: 'CBT',
                data: {
                    situation,
                    emotions,
                    thoughts,
                    distortions
                }
            };

            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);

            feedJerry('insight', 50);
            addXP(20);

            showNotification('CBT session completed! Jerry gained insight.');
            
            // Reset form
            document.getElementById('cbtSituation').value = '';
            document.getElementById('cbtEmotions').value = '';
            document.getElementById('cbtThoughts').value = '';
            document.querySelectorAll('#cbtDistortions input').forEach(cb => cb.checked = false);

            // Switch back to Jerry tab
            switchTab('jerry');

            // Refresh entries
            loadEntries();
        }

       // =====================
        // DBT Functions
        // =====================
        function setDBTRating(button, emotion, value) {
            appState.dbtData[emotion] = value;

            // Remove 'active' from all buttons in this emotion group
            const buttons = document.querySelectorAll(`[onclick*="${emotion}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));

            // Set active class on tapped button
            button.classList.add('active');
        }

        function completeDBT() {
            const requiredRatings = ['anger', 'sadness', 'fear', 'shame'];
            const missing = requiredRatings.filter(r => appState.dbtData[r] === undefined);

            if (missing.length > 0) {
                showNotification('Please rate all emotions.', 'error');
                return;
            }

            // Get selected skills
            const skills = [];
            document.querySelectorAll('#dbtSkills input:checked').forEach(cb => {
                skills.push(cb.nextElementSibling.textContent);
            });

            const entry = {
                timestamp: new Date().toISOString(),
                type: 'DBT',
                data: {
                    ...appState.dbtData,
                    skills
                }
            };

            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);

            feedJerry('calm', 50);
            addXP(20);

            showNotification('DBT session completed! Jerry feels calmer.');

            // Reset form
            appState.dbtData = {};
            document.querySelectorAll('#dbt .rating-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#dbtSkills input').forEach(cb => cb.checked = false);

            // Switch back to Jerry tab
            switchTab('jerry');

            // Refresh entries
            loadEntries();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const openBtn = document.getElementById('openDBTOverlay');
            const overlay = document.getElementById('dbtDefinitionsOverlay');
            const closeBtn = document.getElementById('closeDBTDefinitions');

            overlay.style.display = 'none';

            // Function to apply theme to overlay
            function applyOverlayTheme() {
                if (document.body.classList.contains('light-theme')) {
                    overlay.style.background = '#A0522D';
                    overlay.style.color = '#ffffff';
                    closeBtn.style.background = '#e3b88d';
                    closeBtn.style.color = '#3e3e3e';
                } else {
                    overlay.style.background = 'rgba(26,32,44,0.95)';
                    overlay.style.color = '#e2e8f0';
                    closeBtn.style.background = '#3355d4';
                    closeBtn.style.color = '#ffffff';
                }
            }

            // Open overlay
            openBtn.addEventListener('click', (e) => {
                e.preventDefault();
                overlay.style.display = 'block';
                applyOverlayTheme();
            });

            // Close overlay
            closeBtn.addEventListener('click', () => {
                overlay.style.display = 'none';
            });

            // Close overlay if clicking outside content
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                }
            });

            // Optional: listen for theme changes dynamically
            const observer = new MutationObserver(applyOverlayTheme);
            observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
        });

        function renderJournalEntries() {
            const entriesList = document.getElementById('entriesList');
            if (!entriesList) return;
        
            entriesList.innerHTML = '';
        
            if (!appState.journal || appState.journal.length === 0) {
                entriesList.innerHTML = '<p style="text-align:center;color:#a0aec0;">No journal entries yet. Write something to see it here!</p>';
                return;
            }
        
            // Sort newest first
            const sortedJournal = [...appState.journal].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
            sortedJournal.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journalEntry preview';
        
                const date = new Date(entry.timestamp).toLocaleDateString();
                const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
                const fullContent = entry.content;
                const truncatedContent = fullContent.length > 100 ? fullContent.slice(0, 100) + '…' : fullContent;
        
                entryDiv.innerHTML = `
                    <div class="entry-date">${date} at ${time}</div>
                    <div class="entry-content">${truncatedContent}</div>
                    <button class="delete-entry">Delete</button>
                `;
        
                const contentDiv = entryDiv.querySelector('.entry-content');
        
                // Expand/collapse
                if (fullContent.length > 100) {
                    entryDiv.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-entry')) return;
        
                        const isExpanded = entryDiv.classList.toggle('expanded');
                        contentDiv.textContent = isExpanded ? fullContent : truncatedContent;
                    });
                }
        
                // Delete entry
                entryDiv.querySelector('.delete-entry').addEventListener('click', () => {
                    if (!confirm('Delete this entry?')) return;
        
                    appState.journal = appState.journal.filter(j => j.timestamp !== entry.timestamp);
                    saveToLocalStorage('hush_journal', appState.journal);
                    renderJournalEntries();
                });
        
                entriesList.appendChild(entryDiv);
            });
        }

        // Initialize journal if it doesn't exist
        if (!appState.journal) appState.journal = [];

        // Save a new entry
        function saveJournalEntry() {
            const input = document.getElementById('journalInput');
            const content = input.value.trim();
            if (!content) return;

            const timestamp = new Date().toISOString();
            const entry = { content, timestamp };

            appState.journal.push(entry);
            saveToLocalStorage('hush_journal', appState.journal);

            feedAllJerry();
            addXP(30);

            showNotification('Journal Saved!', 'success');

            switchTab('jerry');
            
            input.value = '';
            renderJournalEntries();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const saveBtn = document.getElementById('saveJournalEntry');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveJournalEntry);
            }
        });

        // Timer Functions
        function toggleTimer() {
        if (!appState.timer.active) {
                startTimer();
        } else {
                stopTimer();
        }
        }

        function startTimer() {
        appState.timer.active = true;
        appState.timer.remaining = 180; // 3 minutes

        document.getElementById('timerButton').textContent = 'Stop';

        appState.timer.interval = setInterval(() => {
                appState.timer.remaining--;
                updateTimerDisplay();

                if (appState.timer.remaining <= 0) {
                completeTimer();
                }
        }, 1000);

        updateTimerDisplay();
        }

        function stopTimer() {
        appState.timer.active = false;
        appState.timer.remaining = 180;

        if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
        }

        document.getElementById('timerButton').textContent = 'Start';
        document.getElementById('timerDisplay').textContent = '03:00';
        }

        function completeTimer() {
        appState.timer.active = false;

        if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
        }

        document.getElementById('timerButton').textContent = 'Start';
        document.getElementById('timerDisplay').textContent = 'Done';

        feedJerry('calm', 30);
        addXP(15);

        showNotification('Mindfulness session completed!');

        setTimeout(() => {
                document.getElementById('timerDisplay').textContent = '03:00';
                appState.timer.remaining = 180;
        }, 2000);
        }

        function updateTimerDisplay() {
        const minutes = Math.floor(appState.timer.remaining / 60);
        const seconds = appState.timer.remaining % 60;
        document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function loadEntries() {
            const entriesList = document.getElementById('entriesList');
            entriesList.innerHTML = '';

            // Merge activity entries and journal entries
            const allEntries = [
                ...(appState.entries || []),  // existing activity/check-in entries
                ...(appState.journal || []).map(j => ({ 
                    type: 'Journal',
                    data: { content: j.content },
                    timestamp: j.timestamp
                }))
            ];

            if (allEntries.length === 0) {
                entriesList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No entries yet. Complete activities or write in your journal to see progress here!</p>';
                return;
            }

            // Sort newest first
            allEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Optional: filter by type
            const filterValue = document.getElementById('entryFilter')?.value || 'all';
            const filteredEntries = allEntries.filter(entry => filterValue === 'all' || entry.type === filterValue);

            // Render filtered entries
            filteredEntries.forEach((entry) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = entry.type === 'Journal' ? 'journalEntry preview' : 'entry-item';

                const date = new Date(entry.timestamp).toLocaleDateString();
                const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let content = '';
                if (entry.type === 'Journal') {
                    content = entry.data.content;
                } else if (entry.type === 'Check-in') {
                    content = `Feeling ${entry.data.emotion || 'N/A'} emotionally, ${entry.data.physical || 'N/A'} physically, ${entry.data.mental || 'N/A'} mentally.`;
                } else if (entry.type === 'CBT') {
                    content = `Situation: ${entry.data.situation || ''}`;
                } else if (entry.type === 'DBT') {
                    const ratings = Object.entries(entry.data)
                        .filter(([key]) => ['anger', 'sadness', 'fear', 'shame'].includes(key))
                        .map(([key, value]) => `${key}: ${value}`)
                        .join(', ');
                    content = `Emotion ratings: ${ratings}`;
                }

                const previewText = (entry.type === 'Journal' || entry.type === 'CBT') && content.length > 100
                    ? content.slice(0, 100) + '…'
                    : content;

                // Build entry HTML (once)
                entryDiv.innerHTML = `
                    <div class="entry-date">${date} at ${time}</div>
                    <div class="entry-content"><strong>${entry.type}</strong><br>${previewText}</div>
                    <button class="delete-entry">Delete</button>
                `;

                // Expand/collapse for journal and CBT entries
                if (entry.type === 'Journal' || entry.type === 'CBT') {
                    const contentDiv = entryDiv.querySelector('.entry-content');
                    entryDiv.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-entry')) return;
                        
                        const isExpanded = entryDiv.classList.toggle('expanded');
                        contentDiv.innerHTML = `<strong>${entry.type}</strong><br>` + (isExpanded ? content : previewText);
                    });
                }

                // Delete button
                entryDiv.querySelector('.delete-entry').addEventListener('click', () => {
                    if (!confirm('Delete this entry?')) return;

                    if (entry.type === 'Journal') {
                        appState.journal = appState.journal.filter(j => j.timestamp !== entry.timestamp);
                        saveToLocalStorage('hush_journal', appState.journal);
                    } else {
                        appState.entries = appState.entries.filter(e => e.timestamp !== entry.timestamp);
                        saveToLocalStorage('hush_entries', appState.entries);
                    }

                    loadEntries();
                });

                entriesList.appendChild(entryDiv);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const entryFilter = document.getElementById('entryFilter');
            if (entryFilter) {
                entryFilter.addEventListener('change', () => {
                    loadEntries();
                });
            }

            // Initial load
            loadEntries();
        });

        function loadHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';
        
        if (appState.chatHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No conversation history yet. Chat with Jerry to see your conversations here!</p>';
                return;
        }
        
        // Group conversations by session (this is a simplified approach)
        const sessions = [];
        let currentSession = [];
        
        appState.chatHistory.forEach(message => {
                currentSession.push(message);
        });
        
        if (currentSession.length > 0) {
                sessions.push({
                timestamp: new Date().toISOString(),
                conversation: currentSession
                });
        }
        
        sessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'entry-item';
                
                const date = new Date(session.timestamp).toLocaleDateString();
                const time = new Date(session.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const messageCount = session.conversation.length;
                
                sessionDiv.innerHTML = `
                <div class="entry-date">${date} at ${time}</div>
                <div class="entry-content">Conversation with ${messageCount} messages</div>
                `;
                
                historyList.appendChild(sessionDiv);
        });
        }

        // =======================
        // Subscription Verification
        // =======================
        function verifySubscriptionOnLoad() {
        const subscriptionId = localStorage.getItem('jerry_subscription_id');
        const isActive = localStorage.getItem('jerry_subscription_active') === 'true';

        subscriptionState.isSubscribed = isActive;
        subscriptionState.subscriptionId = subscriptionId;
        subscriptionState.messageCount = parseInt(localStorage.getItem('jerry_message_count') || '0', 10);
        subscriptionState.billingCycle = localStorage.getItem('jerry_billing_cycle') || null;

        // Update UI
        updateSubscriptionDisplay();
        updateUsageDisplay();
        updateChatInterface();
        }

        // =======================
        // Settings Loader/Saver
        // =======================
        function loadSettings() {
            // Basic settings
            document.getElementById('apiKey').value = appState.apiKey || '';
            document.getElementById('botName').value = appState.botName || 'Jerry';
        
            // API option
            const apiOption = localStorage.getItem('jerry_api_option') || 'own';
            document.querySelector(`input[name="apiOption"][value="${apiOption}"]`).checked = true;
        
            // Load Jerry settings (style + theme together)
            const savedJerry = JSON.parse(localStorage.getItem('jerrySettings') || '{}');
            const savedStyle = savedJerry.style || 'default';
            const savedTheme = savedJerry.theme || 'default';
        
            const spriteStyleSelect = document.getElementById('spriteStyle');
            const spriteThemeSelect = document.getElementById('spriteTheme');
        
            if (spriteStyleSelect) spriteStyleSelect.value = savedStyle;
            if (spriteThemeSelect) spriteThemeSelect.value = savedTheme;
        
            // Update appState
            if (!appState.jerry) appState.jerry = {};
            appState.jerry.currentSprite = savedStyle;
            appState.spriteTheme = savedTheme;
        
            // Wire up event handlers
            setupApiOptionHandlers();
        }
        
        function saveSettings() {
            const apiKey = document.getElementById('apiKey').value.trim();
            appState.apiKey = apiKey;
            localStorage.setItem('hush_api_key', apiKey);
        
            const botName = document.getElementById('botName').value.trim() || 'Jerry';
            appState.botName = botName;
            localStorage.setItem('botName', botName);
        
            const selectedApiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
            localStorage.setItem('jerry_api_option', selectedApiOption);
        
            // Save Jerry settings (style + theme together)
            const spriteStyleSelect = document.getElementById('spriteStyle');
            const spriteThemeSelect = document.getElementById('spriteTheme');
            const style = spriteStyleSelect?.value || 'default';
            const theme = spriteThemeSelect?.value || 'default';
        
            const jerrySettings = { style, theme };
            localStorage.setItem('jerrySettings', JSON.stringify(jerrySettings));
        
            appState.jerry.currentSprite = style;
            appState.spriteTheme = theme;
        
            showNotification('Settings saved successfully!');
            updateChatInterface();
            updateJerrySprite();
        }


        function updateThemeColor() {
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            if (!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = "theme-color";
                document.head.appendChild(metaTheme);
            }

            if (document.body.classList.contains('light-theme')) {
                metaTheme.setAttribute('content', '#A0522D'); // brown for light mode
            } else {
                metaTheme.setAttribute('content', '#3355d4'); // dark mode color
            }
        }

        function toggleTheme() {
        document.body.classList.toggle('light-theme');

        const isLightMode = document.body.classList.contains('light-theme');
        localStorage.setItem('hush_theme', isLightMode ? 'light' : 'dark');

        showNotification('Theme updated!');

        updateJerrySprite();

        updateThemeColor();
        }

        function resetMonthlyUsageIfNeeded() {
        if (subscriptionState.billingCycle) {
                const now = new Date();
                const billingDate = new Date(subscriptionState.billingCycle);

                if (now >= billingDate) {
                subscriptionState.messageCount = 0;
                subscriptionState.billingCycle = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();

                localStorage.setItem('jerry_message_count', '0');
                localStorage.setItem('jerry_billing_cycle', subscriptionState.billingCycle);

                updateUsageDisplay();
                updateSubscriptionDisplay();
                updateChatInterface();
                }
        }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let isPlaying = false;
            let startTime = 0;
            const loopLength = 20; // seconds
            let loopInterval = null;
            let activeSources = [];

            // Master gain for volume control
            const masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);

            // Create a subtle reverb effect
            const reverb = audioCtx.createDelay();
            reverb.delayTime.value = 0.2; // 150ms delay
            const reverbGain = audioCtx.createGain();
            reverbGain.gain.value = 0.2; // low volume for subtlety
            reverb.connect(reverbGain).connect(masterGain);

            // Load saved volume
            const savedVolume = localStorage.getItem("ambientMusicVolume");
            masterGain.gain.value = savedVolume !== null ? parseFloat(savedVolume) : 0.5;

            // Volume slider
            const volumeSlider = document.getElementById("ambientMusicVolume");
            volumeSlider.value = masterGain.gain.value;
            volumeSlider.addEventListener("input", (e) => {
                masterGain.gain.value = parseFloat(e.target.value);
                localStorage.setItem("ambientMusicVolume", e.target.value);
            });

            // Stop all currently playing sources
            function stopAllSources() {
                activeSources.forEach(src => { try { src.stop(); } catch(e) {} });
                activeSources = [];
            }

            // === Tri-Tone Chirp ===
            function playTriToneChirp(time, baseFreq = 963) {
                const randomBase = 940 + Math.random() * 50;
                
                const triToneFreq = randomBase * Math.pow(2, 6/12); // 6 semitones up

                [randomBase, triToneFreq].forEach(freq => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    const filter = audioCtx.createBiquadFilter();

                    filter.type = "lowpass";
                    filter.frequency.setValueAtTime(2000, time);

                    osc.type = "sine";
                    osc.frequency.setValueAtTime(freq, time);
                    osc.detune.setValueAtTime((Math.random() - 0.5) * 15, time);

                    // Quick ethereal chirp envelope
                    gain.gain.setValueAtTime(0, time);
                    gain.gain.linearRampToValueAtTime(0.3, time + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);

                    osc.connect(filter).connect(gain).connect(masterGain);
                    osc.connect(filter).connect(gain).connect(reverb);
                    osc.start(time);
                    osc.stop(time + 1.5);
                    activeSources.push(osc);
                });
            }

            function startChirpLoop(duration = 5, minInterval = 1, maxInterval = 3) {
                if (isPlaying) return;
                isPlaying = true;
 
                function scheduleNextChirp() {
                    if (!isPlaying) return;

                    const startTime = audioCtx.currentTime + 0.1;
                    playTriToneChirp(startTime);

                    // Random interval between minInterval and maxInterval
                    const nextInterval = Math.random() * (maxInterval - minInterval) + minInterval;
                    loopInterval = setTimeout(scheduleNextChirp, nextInterval * 1000);
                }

                scheduleNextChirp();

                // Stop after duration
                setTimeout(() => {
                    clearTimeout(loopInterval);
                    stopAllSources();
                    isPlaying = false;
                }, duration * 1000);
            }

            // === Trigger: sprite click ===
            const sprite = document.getElementById("jerrySprite"); // your sprite element
            sprite.addEventListener("click", async () => {
                await audioCtx.resume();
                startChirpLoop(1.5, 0.2, 0.5); // start a fresh 10-second loop
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const jerryContainer = document.getElementById('jerryWrapper');
            const bgOptions = document.querySelectorAll('.background-option');

            // Map keys to CSS classes
            const BACKGROUNDS = {
                default: 'bg-default',
                neonLights: 'bg-neonLights',
                noir: 'bg-noir',
                petal: 'bg-petal',
                eclipse: 'bg-eclipse',
                aurora: 'bg-aurora',
                ember: 'bg-ember',
                woods: 'bg-woods',
                galactic: 'bg-galactic',
                spooky: 'bg-spooky',
                dreamland: 'bg-dreamland',
                beach: 'bg-beach',
                arcane: 'bg-arcane',
                matrix: 'bg-matrix',
                flare: 'bg-flare'
            };

            // Apply a background class
            function applyBackground(bgKey) {
                // Remove all existing background classes
                jerryContainer.classList.remove(...Object.values(BACKGROUNDS));
                // Add the new class
                jerryContainer.classList.add(BACKGROUNDS[bgKey]);
            }

            // Highlight selected swatch
            function markSelected(bgKey) {
                bgOptions.forEach(option => {
                    option.classList.toggle('selected', option.dataset.bg === bgKey);
                });
            }

            // Load saved background on page load
            let savedBg = localStorage.getItem('jerryBackground');
            if (!BACKGROUNDS[savedBg]) {
                savedBg = 'default';
                localStorage.setItem('jerryBackground', savedBg);
            }
            applyBackground(savedBg);
            markSelected(savedBg);

            // Click listeners for swatches
            bgOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const selected = option.dataset.bg;
                    applyBackground(selected);
                    markSelected(selected);
                    localStorage.setItem('jerryBackground', selected);
                });
            });
        });

        async function fadeSplash() {
            const splash = document.getElementById('splashScreen');
            const splashImg = document.getElementById('splashImage');
            if (!splash) return;

            // Make splash visible immediately
            splash.style.opacity = '1';
            splash.style.pointerEvents = 'none';
            splash.style.transition = 'opacity 0.5s ease';
            splash.style.background = document.body.classList.contains('light-theme') ? '#f7ede5' : '#1a202c';

            // Wait for splash image to load or fail
            if (splashImg && !splashImg.complete) {
                await new Promise(resolve => {
                    splashImg.addEventListener('load', resolve, { once: true });
                    splashImg.addEventListener('error', resolve, { once: true });
                });
            }

            // Keep splash on screen for 3 seconds
            await new Promise(resolve => setTimeout(resolve, 3000));

            // Fade out
            splash.style.opacity = '0';
            splash.style.pointerEvents = 'none';

            // Wait for CSS transition to finish
            await new Promise(resolve => setTimeout(resolve, 500));

            // Remove splash from DOM to prevent blocking
            splash.remove();
        }

        // =======================
        // Async App Initialization
        // =======================
        async function initializeApp() {
            const splash = document.getElementById('splashScreen');
            const splashImg = document.getElementById('splashImage');

            // --- Helper: wait for milliseconds ---
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- Load theme ---
            const savedTheme = localStorage.getItem('hush_theme');
            if (savedTheme === 'light') document.body.classList.add('light-theme');

            // --- Load Jerry state ---
            if (typeof loadJerryStateAsync === 'function') {
                await loadJerryStateAsync();
            } else {
                loadJerryState();
            } // use async version if available
            // === Initialize base sprite after Jerry state is ready ===
            baseSprite = JSON.parse(JSON.stringify(jerrySprites[appState.jerry?.currentSprite || 'default']));

            // Ensure lastFed exists
            ['clarity', 'insight', 'calm'].forEach(need => {
                if (!appState.jerry.lastFed[need]) {
                    appState.jerry.lastFed[need] = Date.now() - (10 * 60 * 1000 + 1000);
                }
            });

            if (typeof loadSettingsAsync === 'function') {
                await loadSettingsAsync();
            } else {
                loadSettings();
            }

            // --- Load bot name ---
            appState.botName = localStorage.getItem('botName') || 'Jerry';
            const nameInput = document.getElementById('botName');
            if (nameInput) {
                nameInput.value = appState.botName;
                nameInput.addEventListener('input', (e) => {
                    const val = e.target.value.trim();
                    appState.botName = val || 'Jerry';
                    localStorage.setItem('botName', appState.botName);
                });
            }

            // --- Initialize UI ---
            // --- Initialize base sprite and render both main + preview ---
            initializePetSystem();
            updateJerrySprite();
            updateJerryUI();
            initializeJerryDecay();
            scheduleBlink();
            updateAffirmationBanner('jerry');
            updateThemeColor();

            // --- Load journal ---
            appState.journal = getFromLocalStorage('hush_journal') || [];
            renderJournalEntries();
            loadEntries();

            // --- Verify subscription ---
            verifySubscriptionOnLoad();

            // --- Intervals ---
            setInterval(updateJerrySprite, 3000);
            setInterval(() => {
                if (appState.currentTab === 'jerry' || appState.currentTab === 'checkin') {
                    updateAffirmationBanner(appState.currentTab);
                }
            }, 10000);
            setInterval(resetMonthlyUsageIfNeeded, 24 * 60 * 60 * 1000);

            // --- Update usage and chat ---
            updateUsageDisplay();
            updateChatInterface();

            // --- Service Worker registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const swCode = `
                        const CACHE_NAME = 'jerry-pwa-v35';
                        const urlsToCache = ['/', '/index.html', '/manifest.json', '/JerryIcon.png'];
                        self.addEventListener('install', (event) => {
                            event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache)));
                        });
                        self.addEventListener('fetch', (event) => {
                            event.respondWith(caches.match(event.request).then((response) => response || fetch(event.request)));
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then(() => console.log('ServiceWorker registration successful'))
                        .catch(() => console.log('ServiceWorker registration failed'));
                });
            }
        }
        
        // Initialize splash and app when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            await fadeSplash();  // show splash first
            await initializeApp();  // then initialize the app
        });

    </script>
</body>
</html>
