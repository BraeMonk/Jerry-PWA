<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jerry - Mental Health Companion</title>

    <script src="https://www.paypal.com/sdk/js?client-id=AQQjfHs0zv-KHqb4Rtn8c8UYMZSb1chU62eafw_y7s3XzUNLZ3HQpQvfV3M-lx5oesJaaC6hNSr1qG7_&vault=true&intent=subscription"></script>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#3355d4">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#A0522D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Jerry">
    <!-- iOS Home Screen icons -->
    <link rel="apple-touch-icon" href="./jerryIcon2.png.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./jerryIcon2.png.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./jerryIcon2.png.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./jerryIcon2.png.png">
    <link rel="apple-touch-icon" sizes="167x167" href="./jerryIcon2.png.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Light Theme Overrides */
        body.light-theme {
            background: linear-gradient(135deg, #fdf6f0 0%, #f7ede5 100%);
            color: #3e3e3e;
    }

        body.light-theme .app-container {
            background: #f7ede5;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        body.light-theme .affirmation-banner {
            background: linear-gradient(90deg, #e3b88d, #f0c9a2);
            color: #3e3e3e;
        }

        body.light-theme .tab-container {
            background: #eae3de;
            border-bottom: 1px solid #d8cfc4;
        }

        body.light-theme .tab {
            color: #6b7280;
        }

        body.light-theme .tab.active {
            color: #e3b88d;
            background: #f7ede5;
            border-bottom: 2px solid #e3b88d;
        }

        body.light-theme .tab:hover {
            background: rgba(227,184,141,0.1);
            color: #c27c48;
        }

        body.light-theme .screen {
            background-color: #f7ede5;
        }

        body.light-theme .form-label {
            color: #4b4b4b;
        }

        body.light-theme .form-input,
        body.light-theme .form-textarea {
            background: #ffffff;
            border: 1px solid #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .form-input:focus {
            border-color: #e3b88d;
        }

        body.light-theme .btn {
            background: #e3b88d;
            color: #3e3e3e;
        }

        body.light-theme .btn:hover {
            background: #cfa273;
        }

        body.light-theme .btn-secondary {
            background: #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .btn-secondary:hover {
            background: #cbb7a2;
        }

        body.light-theme .rating-btn {
            background: #ffffff;
            border: 1px solid #d8cfc4;
            color: #6b7280;
        }

        body.light-theme .rating-btn.active,
        body.light-theme .rating-btn:hover {
            background: #e3b88d;
            color: #3e3e3e;
            border-color: #e3b88d;
        }

        body.light-theme .timer-display {
            color: #e3b88d;
        }

        body.light-theme .progress-section,
        body.light-theme .entry-item,
        body.light-theme .checkbox-container {
            background: #ffffff;
            border-color: #d8cfc4;
            color: #3e3e3e;
        }

        body.light-theme .notification {
            background: #e3b88d;
            color: #3e3e3e;
        }

        /* Light Theme Overrides */
        body.light-theme #journalInput {
            background: #ffffff;
            color: #3e3e3e;
            border: 1px solid #d8cfc4;
        }

        body.light-theme #saveJournalEntry {
            background: #e3b88d;
            color: #3e3e3e;
        }

        body.light-theme #saveJournalEntry:hover {
            background: #cfa273;
        }

        /* Light mode premium subscription card */
        body.light-theme #premiumSection .subscription-card {
            background: #A0522D;          /* main brown background */
            border: 2px solid #8B4513;    /* slightly darker brown border */
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            color: #ffffff;               /* default text color */
        }

        /* Title */
        body.light-theme #premiumSection .subscription-title {
            color: #ffffff;               /* white text */
        }

        /* Price */
        body.light-theme #premiumSection .subscription-price {
            color: #ffffff;
        }

        body.light-theme #premiumSection .subscription-price span {
            color: #f0e6d2; /* slightly lighter for /month text */
        }

        /* Features list */
        body.light-theme #premiumSection .subscription-features li {
            color: #ffffff;               /* white text */
        }

        body.light-theme #premiumSection .subscription-features li span {
            color: #68d391;               /* keep green checkmarks */
        }

        /* Subscription status */
        body.light-theme #premiumSection #subscriptionStatusDisplay .subscription-status.active {
            background: #8B4513;          /* darker brown for status box */
            border: 1px solid #cfa273;   /* matching border */
            color: #ffffff;               /* white text */
        }

        body.light-theme #premiumSection #subscriptionStatusDisplay .subscription-status.active div {
            color: #ffffff;               /* white text */
        }

        /* Cancel button */
        body.light-theme #premiumSection #subscriptionStatusDisplay .btn.btn-danger {
            background: #c03b1f;          /* dark reddish-brown button */
            color: #ffffff;               /* white text */
            width: 100%;
        }

        body.light-theme #premiumSection #subscriptionStatusDisplay .btn.btn-danger:hover {
            background: #a52d1a;          /* slightly darker on hover */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            background: #1a202c;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .affirmation-banner {
            background: linear-gradient(90deg, #3355d4, #4f46e5);
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            color: white;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-container {
            display: flex;
            background: #2d3748;
            border-bottom: 1px solid #4a5568;
        }
        
        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
            font-weight: 500;
        }
        
        .tab.active {
            color: #3355d4;
            background: #1a202c;
            border-bottom: 2px solid #3355d4;
        }
        
        .tab:hover {
            background: rgba(51, 85, 212, 0.1);
            color: #63b3ed;
        }
        
        .screen {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 120px);
        }
        
        .screen.active {
            display: block;
        }
        
        /* Jerry Sprite Styles */
        .jerry-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .jerry-sprite {
            width: 160px;
            height: 160px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .pixel {
            width: 10px;
            height: 10px;
            position: absolute;
        }

        /* Ensure Jerry sprite pixels are full like the preview */
        .jerry-sprite .pixel {
            width: 10px;        /* same as sprite pixel size */
            height: 10px;
            position: absolute;
            border-radius: 0;   /* remove subtle rounding */
            margin: 0;
            padding: 0;
        }
        
        .jerry-stats {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }
        
        .stat-bar {
            margin-bottom: 12px;
        }
        
        .stat-label {
            font-size: 12px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .clarity-bar { background: linear-gradient(90deg, #3b82f6, #1d4ed8); }
        .insight-bar { background: linear-gradient(90deg, #8b5cf6, #5b21b6); }
        .calm-bar { background: linear-gradient(90deg, #10b981, #047857); }
        
        /* Chat Interface */
        .chat-container {
            background: #2d3748;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-log {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: #1a202c;
            border-radius: 8px;
        }
        
        .message {
            margin-bottom: 12px;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .message.user {
            color: #63b3ed;
        }
        
        .message.jerry {
            color: #68d391;
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        
        .chat-input {
            flex: 1;
            padding: 8px 12px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 20px;
            color: #e2e8f0;
            outline: none;
            font-size: 14px;

            resize: none;               /* prevent manual resizing */
            overflow-y: auto;           /* scroll when text exceeds box height */
            min-height: 36px;           /* same as original input height */
            max-height: 100px;          /* maximum height before scroll */
            white-space: pre-wrap;
        }
        
        .send-button {
            background: #3355d4;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .send-button:hover {
            background: #2d4aa7;
        }

        /* Light mode chat box */
        body.light-theme .chat-container {
            background: #A0522D;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        body.light-theme .chat-log {
            background: #e3b88d; /* darker brown for messages area */
            border-radius: 8px;
        }

        body.light-theme .message.user {
            color: #ffffff; /* user messages white */
        }

        body.light-theme .message.jerry {
            color: #3e3e3e; /* Jerry messages dark for contrast */
        }

        body.light-theme .chat-input {
            background: #ffffff; /* input box light */
            color: #3e3e3e;      /* text dark */
            border: 1px solid #d8cfc4;

            resize: none;               /* prevent manual resizing */
            overflow-y: auto;           /* scroll when text exceeds box height */
            min-height: 36px;           /* same as original input height */
            max-height: 100px;          /* maximum height before scroll */
            white-space: pre-wrap;
        }

        body.light-theme .chat-input::placeholder {
            color: #a0aec0; /* placeholder text lighter */
        }

        body.light-theme .send-button {
            background: #e3b88d; /* button brown */
            color: #3e3e3e;      /* button text dark */
        }

        body.light-theme .send-button:hover {
            background: #cfa273; /* slightly darker on hover */
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #cbd5e0;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #3355d4;
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 24px;
            background: #3355d4;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            text-align: center;
            text-decoration: none;
            margin: 8px auto;
        }
        
        .btn:hover {
            background: #2d4aa7;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #2d3748;
        }
        
        /* Rating buttons */
        .rating-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .rating-btn {
            flex: 1;
            padding: 8px;
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #a0aec0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .rating-btn.active,
        .rating-btn:hover {
            background: #3355d4;
            color: white;
            border-color: #3355d4;
        }
        
        /* Timer Styles */
        .timer-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #3355d4;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
        }
        
        .timer-btn {
            font-size: 18px;
            padding: 16px 32px;
            border-radius: 50px;
        }
        
        /* Progress Tracking */
        .progress-section {
            background: #2d3748;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .progress-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e2e8f0;
        }
        
        /* Entries and History */
        .entry-item {
            background: #2d3748;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #3355d4;
        }
        
        .entry-date {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 8px;
        }
        
        .entry-content {
            line-height: 1.5;
        }
        
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .notification {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #48bb78;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px;
            background: #2d3748;
            border-radius: 6px;
        }
        
        .checkbox {
            margin-right: 12px;
            margin-top: 2px;
        }
        
        .checkbox-label {
            flex: 1;
            line-height: 1.4;
            font-size: 14px;
        }

        #spritePreview {
            position: relative;       /* so child .pixel divs can be absolutely positioned */
            width: 160px;             /* 16 pixels * 10px per pixel */
            height: 160px;            /* same as above */
            background-color: transparent;
            border: none;
            outline: none;
            box-shadow: none;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
        }

        #spritePreview .pixel {
            position: absolute;
            width: 10px;
            height: 10px;
        }

        #journal {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 0px);        /* fill full viewport */
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        #journalInput {
            flex: 1;        /* fill remaining space above button */
            min-height: 200px;
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            border: 1px solid #4a5568;
            border-radius: 8px;
            background: #2d3748;
            color: #e2e8f0;
            resize: none;
            overflow-y: auto;
            box-sizing: border-box;
            margin-bottom: 80px;   /* spacing above button */
        }

        #saveJournalEntry {
            position: relative;       /* fixed at bottom of viewport */
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            padding: 12px 30px;
            width: 100%;           /* inherits button style */
            border-radius: 8px;
            background: #3355d4;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            margin-top: 12px;
        }

        #saveJournalEntry:hover {
            background: #2d4aa7;
            transform: translateX(-50%);
        }

        /* --- Journal Entries & Delete Buttons --- */

        /* Entry container */
        .journalEntry,
        .entry-item {
            background: #2d3748;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #3355d4;
            color: #e2e8f0;
            line-height: 1.5;
            transition: background 0.3s ease;
            cursor: default;
        }

        /* Entry date */
        .entry-date {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 8px;
        }

        /* Delete button */
        .delete-entry {
            margin-top: 8px;
            padding: 8px 16px;
            background: #c53030;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .delete-entry:hover {
            background: #9b2c2c;
            transform: translateY(-1px);
        }

        /* --- Filter Dropdown --- */
        #entryFilter {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid #4a5568;
            background: #2d3748;
            color: #e2e8f0;
            margin-bottom: 12px;
            outline: none;
        }

        #entryFilter:focus {
            border-color: #3355d4;
        }

        /* --- Light Theme Overrides --- */
        body.light-theme .journalEntry,
        body.light-theme .entry-item {
            background: #ffffff;
            color: #3e3e3e;
            border-left-color: #e3b88d;
        }

        body.light-theme .journalEntry.expanded {
            background: #f0e8e0;
        }

        body.light-theme .delete-entry {
            background: #e53e3e;
            color: white;
        }

        body.light-theme .delete-entry:hover {
            background: #c53030;
        }

        body.light-theme #entryFilter {
            background: #ffffff;
            color: #3e3e3e;
            border: 1px solid #d8cfc4;
        }

        /* Ensure hover, focus, and expanded states look good */
        body.light-theme #entryFilter:focus {
            border-color: #e3b88d;
        }

        /* Splash Screen */
        #splashScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a202c;           /* dark theme default */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;                /* above everything */
            transition: opacity 0.5s ease; /* smooth fade-out */
        }

        /* Light theme version */
        body.light-theme #splashScreen {
            background: #f7ede5;           /* match app's light background */
        }

        /* Splash image */
        #splashScreen img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            border-radius: 12px;           /* soft edges like your UI */
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); /* subtle depth */
        }

        /* Header always visible */
        .journalEntry .entryHeader {
            font-weight: bold;
            margin-bottom: 0.25em;
        }

        /* Preview state: clamp to 1 line */
        .journalEntry .entryContent {
            display: -webkit-box;
            -webkit-line-clamp: 1;     /* number of lines to show in preview */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 1.5em;         /* ~1 line of text */
            transition: max-height 0.3s ease;
        }

        /* Expanded: show full text */
        .journalEntry.expanded .entryContent {
            -webkit-line-clamp: unset;
            max-height: 100vh;         /* large enough to fit */
        }

        /* Light mode API option text */
        body.light-theme .api-toggle {
            background: #8B4513 !important; /* dark brown background for contrast */
        }

        body.light-theme .api-toggle .api-option label {
            color: #ffffff; /* main label text */
        }

        body.light-theme .api-toggle .api-option label div {
            color: #f0e6d2; /* description text, slightly lighter */
        }

        body.light-theme .api-toggle input[type="radio"] {
            accent-color: #f0c9a2; /* makes the radio dot match the theme */
        }

        /* Dark theme (default) */
        .def-button {
            color: white;
            text-decoration: none;
            font-weight: bold;
            display: block;
            padding: 10px 20px;
            border-radius: 8px;
            background: #3355d4;
            transition: background 0.3s ease;
            border: none;
            text-align: center;
        }

        .def-button:hover {
            background: #2d4aa7;
        }

        /* Light theme */
        body.light-theme .def-button {
            color: #ffffff; /* text stays white if you want */
            background: #A0522D; /* brown theme color */
        }

        body.light-theme .def-button:hover {
            background: #8b421f; /* slightly darker on hover */
        }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .jerry-sprite {
                width: 120px;
                height: 120px;
            }
            
            .pixel {
                width: 10px;
                height: 10px;
            }
            
            .timer-display {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
    <div id="splashScreen">
        <img src="./jerrySplash.png.png" alt="Splash" id="splashImage" />
    </div>
    <div class="app-container">
        <div class="affirmation-banner" id="affirmationBanner">
            Your feelings are valid, even the difficult ones.
        </div>
        
        <div class="tab-container">
            <button class="tab active" onclick="switchTab('jerry', event)">Jerry</button>
            <button class="tab" onclick="switchTab('checkin', event)">Check-in</button>
            <button class="tab" onclick="switchTab('cbt', event)">CBT</button>
            <button class="tab" onclick="switchTab('dbt', event)">DBT</button>
            <button class="tab" onclick="switchTab('journalTab', event)">Journal</button>
            <button class="tab" onclick="switchTab('hush', event)">Hush</button>
            <button class="tab" onclick="switchTab('entries', event)">Entries</button>
            <!--<button class="tab" style="display: none;" onclick="switchTab('history')">History</button>-->
            <button class="tab" onclick="switchTab('settings', event)">Settings</button>
        </div>
        
        <!-- Jerry Screen -->
        <div class="screen active" id="jerry">
            <div class="jerry-container">
                <div class="jerry-sprite" id="jerrySprite"></div>
                <div class="jerry-stats">
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Clarity</span>
                            <span id="clarityValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill clarity-bar" id="clarityBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Insight</span>
                            <span id="insightValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill insight-bar" id="insightBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Calm</span>
                            <span id="calmValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill calm-bar" id="calmBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span id="levelLabel">Level 1</span>
                            <span id="xpLabel">XP: 0 / 100</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-log" id="chatLog">
                    <div class="message jerry">It's good to see you again.</div>
                </div>
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chatInput" placeholder="Type your message..." 
                         onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                    <button class="send-button" onclick="sendMessage()">â†’</button>
                </div>
            </div>
        </div>
        
        <!-- Check-in Screen -->
        <div class="screen" id="checkin">
            <h2 style="margin-bottom: 20px;">Daily Check-in</h2>
            <div id="checkinContent">
                <div class="form-group">
                    <div class="form-label">How are you feeling emotionally?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse('emotion', 'Good')">Good</button>
                        <button class="rating-btn" onclick="setCheckinResponse('emotion', 'Okay')">Okay</button>
                        <button class="rating-btn" onclick="setCheckinResponse('emotion', 'Bad')">Bad</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your body feeling?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse('physical', 'Energetic')">Energetic</button>
                        <button class="rating-btn" onclick="setCheckinResponse('physical', 'Tired')">Tired</button>
                        <button class="rating-btn" onclick="setCheckinResponse('physical', 'Pain')">Pain</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your mind today?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse('mental', 'Clear')">Clear</button>
                        <button class="rating-btn" onclick="setCheckinResponse('mental', 'Foggy')">Foggy</button>
                        <button class="rating-btn" onclick="setCheckinResponse('mental', 'Overwhelmed')">Overwhelmed</button>
                    </div>
                </div>
                <button class="btn" onclick="completeCheckin()">Complete Check-in</button>
            </div>
        </div>
        
        <!-- CBT Screen -->
        <div class="screen" id="cbt">
            <h2 style="margin-bottom: 20px;">CBT Thought Record</h2>
            <div id="cbtContent">
                <div class="form-group">
                    <label class="form-label" for="cbtSituation">What was the situation or event that triggered the difficult feeling?</label>
                    <textarea class="form-input form-textarea" id="cbtSituation" placeholder="e.g., I had a disagreement with a friend."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtEmotions">What emotions did you feel? (e.g., sad, angry, anxious)</label>
                    <textarea class="form-input form-textarea" id="cbtEmotions" placeholder="List the primary emotions."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtThoughts">What were the automatic thoughts that went through your mind?</label>
                    <textarea class="form-input form-textarea" id="cbtThoughts" placeholder="What did you immediately think or believe?"></textarea>
                </div>
                
                <h3 style="margin: 20px 0 12px;">Which cognitive distortions apply?</h3>
                <div id="cbtDistortions">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="allOrNothing">
                        <label class="checkbox-label" for="allOrNothing"><strong>All-or-Nothing Thinking:</strong> Viewing things in black-and-white categories.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="overgeneralization">
                        <label class="checkbox-label" for="overgeneralization"><strong>Overgeneralization:</strong> Seeing a single negative event as a never-ending pattern of defeat.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mentalFilter">
                        <label class="checkbox-label" for="mentalFilter"><strong>Mental Filter:</strong> Picking out a single negative detail and dwelling on it exclusively.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="jumpingConclusions">
                        <label class="checkbox-label" for="jumpingConclusions"><strong>Jumping to Conclusions:</strong> Making a negative interpretation despite no definite facts.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionalReasoning">
                        <label class="checkbox-label" for="emotionalReasoning"><strong>Emotional Reasoning:</strong> Assuming that your negative emotions necessarily reflect the way things really are.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="shouldStatements">
                        <label class="checkbox-label" for="shouldStatements"><strong>Should Statements:</strong> Motivating yourself with 'shoulds' and 'shouldn'ts'.</label>
                    </div>
                </div>
                
                <button class="btn" onclick="completeCBT()">Complete CBT Session</button>
            </div>
        </div>
        
        <!-- DBT Screen -->
        <div class="screen" id="dbt">
            <h2 style="margin-bottom: 20px;">DBT Skills Check</h2>
            <div id="dbtContent">
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your ANGER (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('anger', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('anger', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SADNESS (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('sadness', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('sadness', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your FEAR (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('fear', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('fear', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SHAME (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating('shame', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating('shame', 5)">5</button>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 12px;">DBT Skills to Practice</h3>
                <div id="dbtSkills">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mindfulness">
                        <label class="checkbox-label" for="mindfulness"><strong>Mindfulness:</strong> Observe, Describe, Participate</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="distressTolerance">
                        <label class="checkbox-label" for="distressTolerance"><strong>Distress Tolerance:</strong> TIP, ACCEPTS, Self-Soothe</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionRegulation">
                        <label class="checkbox-label" for="emotionRegulation"><strong>Emotion Regulation:</strong> Check the Facts, Opposite Action</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="interpersonalEffectiveness">
                        <label class="checkbox-label" for="interpersonalEffectiveness"><strong>Interpersonal Effectiveness:</strong> DEAR MAN, GIVE, FAST</label>
                    </div>
                </div>

                <button class="def-button" id="openDBTOverlay">Definitions</button>
                
                <button class="btn" onclick="completeDBT()">Complete DBT Session</button>
            </div>
        </div>

        <!-- Journal Tab -->
        <div class="screen" id="journalTab">
            <h2>Journal</h2>
            <!-- New Entry Input -->
            <textarea id="journalInput" placeholder="Write your thoughts here..." rows="5"></textarea>
            <button id="saveJournalEntry">Save Entry</button>
        </div>

        <!-- Hush Timer Screen -->
        <div class="screen" id="hush">
            <div class="timer-container">
                <h2 style="margin-bottom: 30px;">Mindfulness Timer</h2>
                <div class="timer-display" id="timerDisplay">03:00</div>
                <button class="btn timer-btn" id="timerButton" onclick="toggleTimer()">Start</button>
            </div>
        </div>
        
        <!-- Entries Screen -->
        <div class="screen" id="entries">
            <h2 style="margin-bottom: 20px;">Your Entries</h2>
            <div class="filter-container">
                <label for="entryFilter" class="form-label">Filter by type:</label>
                <select id="entryFilter" class="form-input">
                    <option value="all">All</option>
                    <option value="Check-in">Check-in</option>
                    <option value="CBT">CBT</option>
                    <option value="DBT">DBT</option>
                    <option value="Journal">Journal</option>
                </select>
  
            </div>
            <div id="entriesList">
                <!-- Entries will be populated here -->
            </div>
        </div>
        
        <!-- History Screen -->
        <div class="screen" style="display: none;" id="history">
            <h2 style="margin-bottom: 20px;">Conversation History</h2>
            <div id="historyList">
                <!-- History will be populated here -->
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div class="screen" id="settings">
            <h2 style="margin-bottom: 20px;">Settings</h2>
            
            <!-- Bot Name Input -->
            <div class="form-group">
                <label class="form-label" for="botName">Companion Name</label>
                <input type="text" class="form-input" id="botName" placeholder="Enter a name for your companion.">
            </div>

            <!-- API Configuration Section -->
            <div class="form-group">
                <label class="form-label">AI Configuration</label>
                
                <!-- API Option Selection -->
                <div class="api-toggle" style="background: #2d3748; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div class="api-option" style="display: flex; align-items: center; margin-bottom: 12px;">
                        <input type="radio" name="apiOption" id="useOwnApi" value="own" checked style="margin-right: 12px; transform: scale(1.2);">
                        <label for="useOwnApi" style="flex: 1; cursor: pointer;">
                            Use Your Own API Key
                            <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                Free - Bring your own Google AI Studio API key
                            </div>
                        </label>
                    </div>
            
                    <div class="api-option" style="display: flex; align-items: center; margin-bottom: 12px;">
                        <input type="radio" name="apiOption" id="usePremium" value="premium" style="margin-right: 12px; transform: scale(1.2);">
                        <label for="usePremium" style="flex: 1; cursor: pointer;">
                            Use Premium API Service
                            <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                $4.99/month - No setup required, built-in API access
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Own API Key Input (shown by default) -->
                <div id="ownApiSection">
                    <input type="text" class="form-input" id="apiKey" placeholder="Enter your Google AI Studio API key here.">
                    <div style="font-size: 12px; color: #a0aec0; margin-top: 8px;">
                        Get your free API key at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #3355d4;">Google AI Studio</a>
                    </div>
                </div>

                <!-- Premium Subscription Section (hidden by default) -->
                <div id="premiumSection" style="display: none;">
                    <div class="subscription-card" style="background: #2d3748; border-radius: 12px; padding: 20px; border: 2px solid #4a5568; transition: all 0.3s ease;">
                        <div class="subscription-title" style="font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #3355d4;">
                            ðŸŒŸ Premium API Access
                        </div>
                        <div class="subscription-price" style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">
                            $4.99<span style="font-size: 16px; color: #a0aec0;">/month</span>
                        </div>
                
                        <ul class="subscription-features" style="list-style: none; margin-bottom: 20px;">
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">âœ“</span>
                                No API key setup required
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">âœ“</span>
                                1,000 messages per month
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">âœ“</span>
                                Faster response times
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">âœ“</span>
                                Priority support
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">âœ“</span>
                                Cancel anytime
                            </li>
                        </ul>
                        <div id="paypal-button-container-P-7LR41432T4749780UNC7UVBY"></div>
                        <script src="https://www.paypal.com/sdk/js?client-id=AQQjfHs0zv-KHqb4Rtn8c8UYMZSb1chU62eafw_y7s3XzUNLZ3HQpQvfV3M-lx5oesJaaC6hNSr1qG7_&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

                        <!-- Subscription Status Display -->
                        <div id="subscriptionStatusDisplay" style="display: none;">
                            <div class="subscription-status active" style="background: #1a365d; border: 1px solid #38a169; border-radius: 8px; padding: 16px; margin-bottom: 16px; text-align: center;">
                                <div style="color: #68d391; font-weight: bold; margin-bottom: 8px;">âœ“ Premium Active</div>
                                <div style="font-size: 12px; color: #a0aec0;">
                                    Messages used this month: <span id="messageUsageDisplay">0 / 1000</span>
                                </div>
                                <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                    Next billing: <span id="nextBillingDate">--</span>
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="cancelSubscription()" style="background: #e53e3e; width: 100%;">
                                Cancel Subscription
                            </button>
                        </div>

                        <!-- PayPal Subscribe Button -->
                        <div id="paypalSubscribeSection">
                            <div id="paypal-button-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="saveSettings()">Save Settings</button>

            <!-- Rest of your existing settings content -->
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Sprite Preview</label>
                <div id="spritePreview" style="width: 100px; height: 100px; position: relative; background: #f0f0f0; border: 1px solid #ccc;"></div>
            </div>
            <div class="form-group">
                <label class="form-label" for="spriteTheme">Sprite Theme:</label>
                <select class="form-input" id="spriteTheme">
                    <option value="default">Default</option>
                    <option value="chaotic">Chaotic</option>
                    <option value="neutral">Neutral</option>
                    <option value="dreamy">Dreamy</option>
                    <option value="forest">Forest</option>
                    <option value="neon">Neon</option>
                </select>
            </div>
    
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Theme</h3>
                <button class="btn btn-secondary" onclick="toggleTheme()">Toggle Dark/Light Mode</button>
            </div>
        </div>
    </div>

    <!-- DBT Definitions Overlay -->
    <div id="dbtDefinitionsOverlay" style="
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        min-height: 100vh;
        background: rgba(26,32,44,0.95);
        color: #e2e8f0;
        z-index: 9999;
        padding: 20px;
        ">
        <h2 style="margin-bottom: 20px; text-align:center;">DBT Skills Definitions</h2>

        <p><strong>Mindfulness</strong> â€“ Observe, Describe, Participate in the moment without judgment.</p>

        <p><strong>Distress Tolerance</strong> â€“ 
            <em>TIP</em> (Temperature, Intense exercise, Paced breathing, Progressive relaxation), 
            <em>ACCEPTS</em> (Activities, Contributing, Comparisons, Emotions, Pushing away, Thoughts, Sensations), 
            and Self-Soothe (use the five senses to calm yourself).
        </p>
        <p><strong>Emotion Regulation</strong> â€“ 
            <em>Check the Facts</em> (do your emotions fit the facts?), 
            <em>Opposite Action</em> (act opposite to unhelpful emotions).
        </p>
        <p><strong>Interpersonal Effectiveness</strong> â€“ 
            <em>DEAR MAN</em> (assert needs), 
            <em>GIVE</em> (relationship skills), 
            <em>FAST</em> (self-respect effectiveness).
        </p>
        <div style="text-align:center; margin-top: 30px;">
            <button id="closeDBTDefinitions" style="
                padding: 10px 20px;
                background: #3355d4;
                color: white;
                border-radius: 8px;
                border: none;
                font-weight: bold;
                cursor: pointer;
                ">â† Back</button>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Application State
        const appState = {
        jerry: {},
        apiKey: localStorage.getItem('hush_api_key') || '',
        currentTab: 'jerry',
        checkinData: {},
        cbtData: {},
        dbtData: {},
        chatHistory: [],
        entries: JSON.parse(localStorage.getItem('hush_entries') || '[]'),
        conversationHistory: JSON.parse(localStorage.getItem('hush_conversations') || '[]'),
        botName: localStorage.getItem('botName') || 'Jerry', // default
        timer: {
                active: false,
                remaining: 180,
                interval: null
        },
        spriteTheme: localStorage.getItem('spriteTheme') || 'default',
        };
        const subscriptionState = {
        isSubscribed: localStorage.getItem('jerry_subscription_active') === 'true',
        subscriptionId: localStorage.getItem('jerry_subscription_id') || null,
        messageCount: parseInt(localStorage.getItem('jerry_message_count') || '0'),
        billingCycle: localStorage.getItem('jerry_billing_cycle') || null,
        apiOption: localStorage.getItem('jerry_api_option') || 'own'
        };

        const PREMIUM_API_KEY = 'GITHUB_SECRET_PREMIUM_API_KEY';

        // Jerry Sprite Data
        const jerrySprites = {
        content: [
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [3, 1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ],
        lowInsight: [
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [3, 1, 1, 1, 4, 4, 1, 1, 1, 1, 4, 4, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 4, 4, 1, 1, 4, 4, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 4, 4, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 4, 1, 1, 4, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ],
        lowCalm: [
                [0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0, 0, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0, 0],
                [3, 1, 1, 1, 4, 4, 1, 1, 1, 4, 4, 1, 1, 1, 3, 0],
                [3, 1, 1, 1, 4, 4, 1, 1, 1, 4, 4, 1, 1, 1, 3, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0, 0],
                [0, 0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0, 0, 0],
                [0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ]
        };

        const affirmations = [
        "Your feelings are valid, even the difficult ones.",
        "Be kind and patient with yourself today.",
        "Each breath is a new, gentle beginning.",
        "It's okay to rest; you are doing enough.",
        "You are resilient, and you can get through this moment.",
        "Allow yourself to simply be, without judgment."
        ];

        // Utility Functions
        function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification show ${type}`;
        setTimeout(() => {
                notification.classList.remove('show');
        }, 3000);
        }

        function saveToLocalStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
        }

        function getFromLocalStorage(key, defaultValue = null) {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : defaultValue;
        }

        // Tab Management
        function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Update screens
        document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');

        appState.currentTab = tabName;

        // Update affirmation banner
        updateAffirmationBanner(tabName);

        // Load screen-specific data
        if (tabName === 'entries') {
                loadEntries();
        } else if (tabName === 'history') {
                loadHistory();
        } else if (tabName === 'settings') {
                loadSettings();
        }
        }

        function updateAffirmationBanner(screenName) {
        const banner = document.getElementById('affirmationBanner');
        if (screenName === 'jerry' || screenName === 'checkin') {
                banner.textContent = affirmations[Math.floor(Math.random() * affirmations.length)];
        } else {
                banner.textContent = '';
        }
        }

        // Function to update bot name
        function setBotName(newName) {
        appState.botName = newName.trim() || 'Jerry';
        localStorage.setItem('botName', appState.botName);
        }

        // Real-time Jerry Needs Decay
        const NEEDS_TICK_INTERVAL = 2000; // 2 seconds

        function updateJerryNeeds() {
            const now = Date.now();
            const decayRates = { clarity: 6, insight: 24, calm: 12 }; // hours to fully deplete
            const gracePeriod = 10 * 60 * 1000; // 10 minutes

            Object.keys(appState.jerry.needs).forEach(need => {
                const lastFed = appState.jerry.lastFed[need] || now;
                const elapsedMs = now - lastFed;

                if (elapsedMs < gracePeriod) {
                    // Grace period: stay full
                    appState.jerry.needs[need] = 100;
                } else {
                    // Calculate percent remaining based on total elapsed time
                    const totalDecayMs = decayRates[need] * 60 * 60 * 1000; // ms until empty
                    const percentRemaining = Math.max(0, 100 - (elapsedMs / totalDecayMs) * 100);

                    appState.jerry.needs[need] = percentRemaining;
                }
            });

            // Mood based on lowest need
            const minNeed = Math.min(...Object.values(appState.jerry.needs));
            let newMood = 'content';
            if (minNeed < 50) {
                if (appState.jerry.needs.insight === minNeed) newMood = 'lowInsight';
                else if (appState.jerry.needs.calm === minNeed) newMood = 'lowCalm';
            }

            setMood(newMood);
            updateJerryUI();
            saveJerryState();
        }
            

        function feedJerry(need, amount = 50) {
        appState.jerry.needs[need] = Math.min(100, appState.jerry.needs[need] + amount);
        appState.jerry.lastFed[need] = Date.now();
        addXP(10);
        saveJerryState();
        updateJerryUI();
        }

        function addXP(amount) {
        appState.jerry.xp += amount;
        if (appState.jerry.xp >= appState.jerry.xpToNext) {
                levelUp();
        }
        saveJerryState();
        updateJerryUI();
        }

        function levelUp() {
        appState.jerry.level++;
        appState.jerry.xp -= appState.jerry.xpToNext;
        appState.jerry.xpToNext = Math.floor(appState.jerry.xpToNext * 1.5);
        showNotification(`Jerry leveled up! Now level ${appState.jerry.level}!`);
        }

        function updateJerryUI() {
        // Update progress bars
        document.getElementById('clarityBar').style.width = `${appState.jerry.needs.clarity}%`;
        document.getElementById('insightBar').style.width = `${appState.jerry.needs.insight}%`;
        document.getElementById('calmBar').style.width = `${appState.jerry.needs.calm}%`;

        // Update text values
        document.getElementById('clarityValue').textContent = `${Math.round(appState.jerry.needs.clarity)}%`;
        document.getElementById('insightValue').textContent = `${Math.round(appState.jerry.needs.insight)}%`;
        document.getElementById('calmValue').textContent = `${Math.round(appState.jerry.needs.calm)}%`;

        // Update level and XP
        document.getElementById('levelLabel').textContent = `Level ${appState.jerry.level}`;
        document.getElementById('xpLabel').textContent = `XP: ${appState.jerry.xp} / ${appState.jerry.xpToNext}`;

        // Update Jerry sprite based on needs
        updateJerrySprite();
        }

        // Replaced updateJerrySprite with a single, reliable update function
        function updateJerrySprite() {
        const needs = appState.jerry.needs;
        let spriteType = 'content';

        const minNeed = Math.min(needs.clarity, needs.insight, needs.calm);
        if (minNeed < 50) {
                if (needs.insight === minNeed) {
                spriteType = 'lowInsight';
                } else if (needs.calm === minNeed) {
                spriteType = 'lowCalm';
                }
        }
        
        // Pass the correct data to the rendering functions
        const spriteData = jerrySprites[spriteType];
        const spriteTheme = appState.spriteTheme;

        renderJerrySprite(spriteData, spriteTheme);
        renderSpritePreview(spriteData, spriteTheme);
        }

        // Fixed rendering functions to accept and use parameters
        function renderJerrySprite(spriteData, spriteTheme) {
        const container = document.getElementById('jerrySprite');
        container.innerHTML = '';

        const isLightMode = document.body.classList.contains('light-theme');

        const colorSets = {
                // DEFAULT: Warm, bright, defined in light mode, blue-based in dark mode
                default: isLightMode
                ? { 0: 'transparent', 1: '#8B5E3C', 2: '#FFD8A6', 3: '#5C3A25', 4: '#FFCB88' } // brown body, cream eyes, darker brown outline, lighter features
                : { 0: 'transparent', 1: '#4a90e2', 2: '#ffffff', 3: '#1f5fbf', 4: '#9cc7f0' }, // defined blue body, white eyes, dark blue outline, light features

                // CHAOTIC: Aggressive, high contrast, stands out on both themes
                chaotic: isLightMode
                ? { 0: 'transparent', 1: '#8B0000', 2: '#FF4500', 3: '#4B0000', 4: '#FF6347' } // dark red body, bright orange eyes, dark outline, vivid features
                : { 0: 'transparent', 1: '#FF4500', 2: '#8B0000', 3: '#FF6347', 4: '#4B0000' }, // bright orange body, dark red eyes, vivid features, dark outline

                // NEUTRAL: Calm, balanced, slightly muted but defined
                neutral: isLightMode
                ? { 0: 'transparent', 1: '#6A0DAD', 2: '#E0CFFF', 3: '#4B0082', 4: '#D8BFFF' } // deep purple body, lavender eyes, darker outline, soft features
                : { 0: 'transparent', 1: '#E0CFFF', 2: '#6A0DAD', 3: '#D8BFFF', 4: '#4B0082' }, // lavender body, deep purple eyes, soft features, darker outline
                
                // DREAMY: Soft, ethereal pastels, calming vibe
                dreamy: isLightMode
                ? { 0: 'transparent', 1: '#FFC0CB', 2: '#FFF0F5', 3: '#FF69B4', 4: '#FFD6E8' }  // pink body, lavender eyes, darker pink outline, soft features
                : { 0: 'transparent', 1: '#FFF0F5', 2: '#FFC0CB', 3: '#FFD6E8', 4: '#FF69B4' }, // soft lavender body, pink eyes, subtle features, dark outline
            
                // FOREST: Earthy, natural, grounded
                forest: isLightMode
                ? { 0: 'transparent', 1: '#2E8B57', 2: '#A9DFBF', 3: '#1B5E20', 4: '#82E0AA' }  // green body, light mint eyes, dark outline, soft highlights
                : { 0: 'transparent', 1: '#A9DFBF', 2: '#2E8B57', 3: '#82E0AA', 4: '#1B5E20' }, // mint body, green eyes, soft highlights, dark outline
            
                // NEON: Bright, playful, stands out in dark mode
                neon: isLightMode
                ? { 0: 'transparent', 1: '#FF00FF', 2: '#00FFFF', 3: '#990099', 4: '#66FFFF' } // magenta body, cyan eyes, dark magenta outline, bright accents
                : { 0: 'transparent', 1: '#00FFFF', 2: '#FF00FF', 3: '#66FFFF', 4: '#990099' } // cyan body, magenta eyes, bright accents, dark outline
        };

        const colors = colorSets[spriteTheme || 'default'];

        spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        container.appendChild(pixelDiv);
                }
                });
        });
        }

        function renderSpritePreview(spriteData, spriteTheme) {
        const previewContainer = document.getElementById('spritePreview');
        previewContainer.innerHTML = ''; // clear previous pixels
        if (!spriteData) return;

        const isLightMode = document.body.classList.contains('light-theme');
        const colorSets = {
                default: isLightMode
                ? { 0: 'transparent', 1: '#8B5E3C', 2: '#FFD8A6', 3: '#5C3A25', 4: '#FFCB88' }
                : { 0: 'transparent', 1: '#4a90e2', 2: '#ffffff', 3: '#1f5fbf', 4: '#9cc7f0' },
                chaotic: isLightMode
                ? { 0: 'transparent', 1: '#8B0000', 2: '#FF4500', 3: '#4B0000', 4: '#FF6347' }
                : { 0: 'transparent', 1: '#FF4500', 2: '#8B0000', 3: '#FF6347', 4: '#4B0000' },
                neutral: isLightMode
                ? { 0: 'transparent', 1: '#6A0DAD', 2: '#E0CFFF', 3: '#4B0082', 4: '#D8BFFF' }
                : { 0: 'transparent', 1: '#E0CFFF', 2: '#6A0DAD', 3: '#D8BFFF', 4: '#4B0082' },
                // DREAMY: Soft, ethereal pastels, calming vibe
                dreamy: isLightMode
                ? { 0: 'transparent', 1: '#FFC0CB', 2: '#FFF0F5', 3: '#FF69B4', 4: '#FFD6E8' }  // pink body, lavender eyes, darker pink outline, soft features
                : { 0: 'transparent', 1: '#FFF0F5', 2: '#FFC0CB', 3: '#FFD6E8', 4: '#FF69B4' }, // soft lavender body, pink eyes, subtle features, dark outline
                // FOREST: Earthy, natural, grounded
                forest: isLightMode
                ? { 0: 'transparent', 1: '#2E8B57', 2: '#A9DFBF', 3: '#1B5E20', 4: '#82E0AA' }  // green body, light mint eyes, dark outline, soft highlights
                : { 0: 'transparent', 1: '#A9DFBF', 2: '#2E8B57', 3: '#82E0AA', 4: '#1B5E20' }, // mint body, green eyes, soft highlights, dark outline

                // NEON: Bright, playful, stands out in dark mode
                neon: isLightMode
                ? { 0: 'transparent', 1: '#FF00FF', 2: '#00FFFF', 3: '#990099', 4: '#66FFFF' } // magenta body, cyan eyes, dark magenta outline, bright accents
                : { 0: 'transparent', 1: '#00FFFF', 2: '#FF00FF', 3: '#66FFFF', 4: '#990099' } // cyan body, magenta eyes, bright accents, dark outline
        };
        const colors = colorSets[spriteTheme || 'default'];

        // Auto-size the container based on sprite dimensions
        const rows = spriteData.length;
        const cols = spriteData[0].length;
        previewContainer.style.position = 'relative';
        previewContainer.style.width = `${cols * 10}px`;
        previewContainer.style.height = `${rows * 10}px`;
        previewContainer.style.background = 'transparent';

        spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.position = 'absolute';
                        pixelDiv.style.width = '10px';
                        pixelDiv.style.height = '10px';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        previewContainer.appendChild(pixelDiv);
                }
                });
        });
        }

        // === Jerry Animation Controller ===
        let currentMood = "content";
        let jerryTalking = false;
        let breathTime = 0;

        // Grab Jerry container
        const jerryContainer = document.getElementById('jerrySprite');

        // === Persistent base sprite (includes evolutions/mood) ===
        let baseSprite = JSON.parse(JSON.stringify(jerrySprites[currentMood]));

        // === Helper Functions ===
        function getCurrentSprite() {
        return baseSprite;
        }

        // Redraw Jerry sprite
        function drawJerry(spriteData = baseSprite) {
        jerryContainer.innerHTML = '';
        const isLightMode = document.body.classList.contains('light-theme');
        const spriteTheme = appState.spriteTheme || 'default';

        const colorSets = {
                default: isLightMode
                ? { 0: 'transparent', 1: '#8B5E3C', 2: '#FFD8A6', 3: '#5C3A25', 4: '#FFCB88' }
                : { 0: 'transparent', 1: '#4a90e2', 2: '#ffffff', 3: '#1f5fbf', 4: '#9cc7f0' },
                chaotic: isLightMode
                ? { 0: 'transparent', 1: '#8B0000', 2: '#FF4500', 3: '#4B0000', 4: '#FF6347' }
                : { 0: 'transparent', 1: '#FF4500', 2: '#8B0000', 3: '#FF6347', 4: '#4B0000' },
                neutral: isLightMode
                ? { 0: 'transparent', 1: '#6A0DAD', 2: '#E0CFFF', 3: '#4B0082', 4: '#D8BFFF' }
                : { 0: 'transparent', 1: '#E0CFFF', 2: '#6A0DAD', 3: '#D8BFFF', 4: '#4B0082' },
                // DREAMY: Soft, ethereal pastels, calming vibe
                dreamy: isLightMode
                ? { 0: 'transparent', 1: '#FFC0CB', 2: '#FFF0F5', 3: '#FF69B4', 4: '#FFD6E8' }  // pink body, lavender eyes, darker pink outline, soft features
                : { 0: 'transparent', 1: '#FFF0F5', 2: '#FFC0CB', 3: '#FFD6E8', 4: '#FF69B4' }, // soft lavender body, pink eyes, subtle features, dark outline
            
                // FOREST: Earthy, natural, grounded
                forest: isLightMode
                ? { 0: 'transparent', 1: '#2E8B57', 2: '#A9DFBF', 3: '#1B5E20', 4: '#82E0AA' }  // green body, light mint eyes, dark outline, soft highlights
                : { 0: 'transparent', 1: '#A9DFBF', 2: '#2E8B57', 3: '#82E0AA', 4: '#1B5E20' }, // mint body, green eyes, soft highlights, dark outline
            
                // NEON: Bright, playful, stands out in dark mode
                neon: isLightMode
                ? { 0: 'transparent', 1: '#FF00FF', 2: '#00FFFF', 3: '#990099', 4: '#66FFFF' } // magenta body, cyan eyes, dark magenta outline, bright accents
                : { 0: 'transparent', 1: '#00FFFF', 2: '#FF00FF', 3: '#66FFFF', 4: '#990099' } // cyan body, magenta eyes, bright accents, dark outline
        };

        const colors = colorSets[spriteTheme];

        spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.position = 'absolute';
                        pixelDiv.style.width = '10px';
                        pixelDiv.style.height = '10px';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        jerryContainer.appendChild(pixelDiv);
                }
                });
        });
        }

        // === Animations ===

        // Blinking
        function blinkJerry() {
        if (Math.random() < 0.003 && !jerryTalking) {
                const sprite = JSON.parse(JSON.stringify(getCurrentSprite()));
                let eyes;
                const bodyColor = 1; // blink = body color
                switch (currentMood) {
                case 'content': eyes = [[4, 5], [4, 10]]; break;
                case 'lowInsight': eyes = [[4, 4], [4, 11]]; break;
                case 'lowCalm': eyes = [[3, 4], [3, 11]]; break;
                }
                eyes.forEach(([r, c]) => {
                sprite[r][c] = bodyColor;
                sprite[r + 1][c] = bodyColor;
                });
                drawJerry(sprite);
                setTimeout(() => drawJerry(getCurrentSprite()), 200);
        }
        }

        // Breathing (brightness + scale)
        function breatheJerry() {
        breathTime += 0.05;
        const brightness = 1 + 0.1 * Math.sin(breathTime); // noticeable pulse
        const scale = 1 + 0.02 * Math.sin(breathTime);
        jerryContainer.style.filter = `brightness(${brightness})`;
        jerryContainer.style.transform = `scale(${scale})`;
        }

        // Mood switching
        function setMood(mood) {
        if (jerrySprites[mood]) {
                currentMood = mood;
                baseSprite = JSON.parse(JSON.stringify(jerrySprites[mood]));
                drawJerry(getCurrentSprite());
        }
        }

        // Talking animation
        async function jerryTalk(text) {
        jerryTalking = true;
        let frame = 0;
        const talkInterval = setInterval(() => {
                frame = 1 - frame;
                const sprite = JSON.parse(JSON.stringify(getCurrentSprite()));
                let mouth;
                switch (currentMood) {
                case 'content': mouth = [[6, 7], [6, 8]]; break;
                case 'lowInsight': mouth = [[5, 6], [5, 9]]; break;
                case 'lowCalm': mouth = [[4, 6], [4, 9]]; break;
                }
                mouth.forEach(([r, c]) => sprite[r][c] = frame ? 0 : 1);
                drawJerry(sprite);
        }, 200);

        await renderText(text); // your existing text rendering
        clearInterval(talkInterval);
        jerryTalking = false;
        drawJerry(getCurrentSprite());
        }

        // Evolution overlay
        function evolveJerry(level) {
        baseSprite = JSON.parse(JSON.stringify(getCurrentSprite()));
        if (level >= 5) baseSprite[2][7] = 4; // glowing eye
        if (level >= 10) baseSprite[0][6] = 2; // halo
        drawJerry(getCurrentSprite());
        }

        // === Main Update Loop ===
        function updateJerry() {
        if (!jerryTalking) {
                blinkJerry();
                breatheJerry();
        }
        requestAnimationFrame(updateJerry);
        }

        // Start animation
        drawJerry(); // initial draw
        updateJerry();

        function saveJerryState() {
            // Ensure lastFed exists before saving
            if (!appState.jerry.lastFed) {
                appState.jerry.lastFed = {};
            }

            ['clarity', 'insight', 'calm'].forEach(need => {
                if (!appState.jerry.lastFed[need]) {
                    appState.jerry.lastFed[need] = Date.now();
                }
            });
            saveToLocalStorage('hush_jerry_state', appState.jerry);
        }

        function loadJerryState() {
            const defaultJerryState = {
                needs: { clarity: 100, insight: 100, calm: 100 },
                lastFed: { clarity: Date.now(), insight: Date.now(), calm: Date.now() },
                level: 1,
                xp: 0,
                xpToNext: 100
            };
    
            const saved = getFromLocalStorage('hush_jerry_state');
            if (saved) {
                // Merge saved state with defaults, but keep saved lastFed
                appState.jerry = { ...defaultJerryState, ...saved };
                appState.jerry.lastFed = { ...defaultJerryState.lastFed, ...saved.lastFed };
            } else {
                appState.jerry = defaultJerryState;
            }

            // Ensure lastFed exists for all needs (for any missing keys)
            ['clarity', 'insight', 'calm'].forEach(need => {
                if (!appState.jerry.lastFed[need]) {
                    appState.jerry.lastFed[need] = Date.now();
                }
            });
        }

        // === Chat Functions ===
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessageToChat('user', message, 'user');
            input.value = '';

            // Add to history
            appState.chatHistory.push({ role: 'user', content: message });

            // Add thinking indicator and keep reference
            const thinkingDiv = addMessageToChat('assistant', 'Thinking...', 'jerry thinking');

            try {
                const response = await getAIResponse(message);

                // Replace "Thinking..." with actual response
                thinkingDiv.innerHTML = `<strong>${appState.botName || 'Jerry'}:</strong> ${response}`;
                thinkingDiv.classList.remove('thinking');

                // Keep chat history within limit
                const MAX_CHAT_HISTORY = 20;
                if (appState.chatHistory.length > MAX_CHAT_HISTORY) {
                    appState.chatHistory = appState.chatHistory.slice(-MAX_CHAT_HISTORY);
                }

            } catch (error) {
                console.error('sendMessage error:', error);

                // Replace thinking indicator with fallback response
                thinkingDiv.innerHTML = `<strong>${appState.botName || 'Jerry'}:</strong> ${getFallbackResponse(message)}`;
                thinkingDiv.classList.remove('thinking');
            }
        }

        /**
         * Adds a message to the chat and returns the created div for later updates.
         * @param {string} speaker - 'assistant' or 'user'
         * @param {string} message - The message text
         * @param {string} className - Additional class for styling (e.g., 'jerry', 'thinking')
         * @returns {HTMLElement} - The created message div
         */
        function addMessageToChat(speaker, message, className = '') {
            const chatLog = document.getElementById('chatLog');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`.trim();

            const displayName = speaker === 'assistant' ? (appState.botName || 'Jerry') : 'You';
            messageDiv.innerHTML = `<strong>${displayName}:</strong> ${message}`;

            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            return messageDiv;
        }

        async function getAIResponse(message) {
            if (!appState) appState = { chatHistory: [], botName: 'Jerry', apiKey: '' };
            if (!subscriptionState) subscriptionState = { isSubscribed: false, messageCount: 0 };

            // Pick API key
            const apiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
            let apiKey;
            if (apiOption === 'premium') {
                if (!subscriptionState.isSubscribed) throw new Error('Premium subscription required');
                if (subscriptionState.messageCount >= 1000) throw new Error('Monthly message limit reached');
                apiKey = PREMIUM_API_KEY;
                subscriptionState.messageCount++; 
                localStorage.setItem('jerry_message_count', String(subscriptionState.messageCount));
                updateUsageDisplay();
            } else {
                apiKey = appState.apiKey || document.getElementById('apiKey')?.value?.trim();
                if (!apiKey) throw new Error('Please enter your API key or subscribe to Premium');
            }

            // Keep only last 15 messages
            if (appState.chatHistory.length > 15) {
                appState.chatHistory = appState.chatHistory.slice(-15);
            }

            // Only add system prompt once at the very beginning
            const systemPromptText = 'You are Jerry, a friendly, gentle, and supportive AI companion focused on mental health. Keep responses brief and caring, offering emotional support and encouragement. You help users with CBT and DBT techniques when appropriate.';

            const contents = [];
            if (!appState.chatHistory.some(m => m.role === 'system')) {
                contents.push({ role: 'user', parts: [{ text: systemPromptText }] });
                appState.chatHistory.unshift({ role: 'system', content: systemPromptText });
            }

            // Add conversation history
            contents.push(
                ...appState.chatHistory
                    .filter(m => m.role !== 'system')
                    .map(m => ({
                        role: m.role === 'assistant' ? 'assistant' : 'user',
                        parts: [{ text: m.content }]
                    }))
            );

            let data;
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents,
                        generationConfig: { maxOutputTokens: 1000, temperature: 0.7, topK: 40, topP: 0.95 }
                    })
                });

                if (!resp.ok) {
                    const text = await resp.text();
                    console.error('Generative API error:', resp.status, text);
                    throw new Error('API request failed');
                }

                data = await resp.json();
                console.log('Generative API response:', data);

            } catch (err) {
                console.error('Fetch failed', err);
                return getFallbackResponse(message);
            }

            // Parse reply defensively
            let reply = 'Sorry, I\'m having trouble composing a response right now.';
            try {
                reply = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim()
                     || data?.outputs?.[0]?.content?.text?.trim()
                     || reply;
            } catch (e) {
                console.error('Parsing AI response failed', e);
            }

            // Push assistant reply
            appState.chatHistory.push({ role: 'assistant', content: reply });

            return reply;
        }

        // API option switching
        function setupApiOptionHandlers() {
        const ownApiRadio = document.getElementById('useOwnApi');
        const premiumRadio = document.getElementById('usePremium');
        const ownApiSection = document.getElementById('ownApiSection');
        const premiumSection = document.getElementById('premiumSection');

        function switchApiOption() {
                const selectedOption = document.querySelector('input[name="apiOption"]:checked')?.value;

                if (selectedOption === 'premium') {
                ownApiSection.style.display = 'none';
                premiumSection.style.display = 'block';
                setupPayPalButton();
                } else {
                ownApiSection.style.display = 'block';
                premiumSection.style.display = 'none';
                }

                localStorage.setItem('jerry_api_option', selectedOption);
                updateChatInterface();
        }

        ownApiRadio?.addEventListener('change', switchApiOption);
        premiumRadio?.addEventListener('change', switchApiOption);
        }

        // PayPal integration
        function setupPayPalButton() {
        const container = document.getElementById('paypal-button-container');
        if (!container) return;

        container.innerHTML = ''; // Clear existing buttons

        if (subscriptionState.isSubscribed) {
                container.style.display = 'none'; // Hide if already subscribed
                return;
        } else {
                container.style.display = 'block'; // Show if not subscribed
        }

        paypal.Buttons({
                style: {
                shape: 'pill',
                color: 'gold',
                layout: 'vertical',
                label: 'subscribe'
                },

                createSubscription: function(data, actions) {
                return actions.subscription.create({
                        'plan_id': 'P-7LR41432T4749780UNC7UVBY', // Replace with your actual PayPal plan ID
                        'custom_id': 'jerry_premium_' + Date.now()
                });
                },

                onApprove: function(data, actions) {
                subscriptionState.isSubscribed = true;
                subscriptionState.subscriptionId = data.subscriptionID;
                subscriptionState.messageCount = 0; // Reset counter
                subscriptionState.billingCycle = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(); // 30 days from now

                // Save to localStorage
                localStorage.setItem('jerry_subscription_active', 'true');
                localStorage.setItem('jerry_subscription_id', data.subscriptionID);
                localStorage.setItem('jerry_message_count', '0');
                localStorage.setItem('jerry_billing_cycle', subscriptionState.billingCycle);

                showNotification('ðŸŒŸ Premium subscription activated! Welcome to Jerry Premium!');
                updateSubscriptionDisplay();
                updateChatInterface();

                container.style.display = 'none';
                },

                onError: function(err) {
                console.error('PayPal error:', err);
                showNotification('Subscription failed. Please try again.', 'error');
                }
        }).render('#paypal-button-container');
        }


        // Update subscription display
        function updateSubscriptionDisplay() {
        const statusDisplay = document.getElementById('subscriptionStatusDisplay');
        const subscribeSection = document.getElementById('paypalSubscribeSection');
        const messageUsageDisplay = document.getElementById('messageUsageDisplay');
        const nextBillingDate = document.getElementById('nextBillingDate');

        if (subscriptionState.isSubscribed) {
                statusDisplay.style.display = 'block';
                subscribeSection.style.display = 'none';

                if (messageUsageDisplay) {
                messageUsageDisplay.textContent = `${subscriptionState.messageCount} / 1000`;
                }

                if (nextBillingDate && subscriptionState.billingCycle) {
                const date = new Date(subscriptionState.billingCycle);
                nextBillingDate.textContent = date.toLocaleDateString();
                }
        } else {
                statusDisplay.style.display = 'none';
                subscribeSection.style.display = 'block';
        }
        }

        // Update usage display in Jerry screen
        function updateUsageDisplay() {
        const messageCountEl = document.getElementById('messageCount');
        const usageFillEl = document.getElementById('usageFill');
        const subscriptionStatusEl = document.getElementById('subscriptionStatus');

        if (subscriptionState.isSubscribed && subscriptionStatusEl) {
                subscriptionStatusEl.style.display = 'block';

                if (messageCountEl) {
                messageCountEl.textContent = subscriptionState.messageCount;
                }

                if (usageFillEl) {
                const percentage = (subscriptionState.messageCount / 1000) * 100;
                usageFillEl.style.width = `${percentage}%`;
                }
        } else if (subscriptionStatusEl) {
                subscriptionStatusEl.style.display = 'none';
        }
        }

        // Update chat interface based on API option
        function updateChatInterface() {
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const apiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';

        if (apiOption === 'premium') {
                if (subscriptionState.isSubscribed) {
                if (subscriptionState.messageCount >= 1000) {
                        chatInput.disabled = true;
                        sendButton.disabled = true;
                        chatInput.placeholder = 'Monthly limit reached. Resets next billing cycle.';
                } else {
                        chatInput.disabled = false;
                        sendButton.disabled = false;
                        chatInput.placeholder = 'Type your message... (Premium)';
                }
                } else {
                chatInput.disabled = true;
                sendButton.disabled = true;
                chatInput.placeholder = 'Premium subscription required';
                }
        } else {
                const hasApiKey = appState.apiKey || document.getElementById('apiKey')?.value?.trim();
                chatInput.disabled = !hasApiKey;
                sendButton.disabled = !hasApiKey;
                chatInput.placeholder = hasApiKey ? 'Type your message...' : 'Please enter your API key in Settings';
        }
        }

        // Cancel subscription
        async function cancelSubscription() {
        if (!confirm('Are you sure you want to cancel your Premium subscription? You will lose access at the end of your current billing period.')) {
                return;
        }

        try {
                // In a real implementation, you would call your backend to cancel the PayPal subscription
                // For now, we'll just clear local storage
                subscriptionState.isSubscribed = false;
                subscriptionState.subscriptionId = null;

                localStorage.removeItem('jerry_subscription_active');
                localStorage.removeItem('jerry_subscription_id');
                localStorage.removeItem('jerry_billing_cycle');

                showNotification('Subscription cancelled. You can continue using Premium until your next billing date.');
                updateSubscriptionDisplay();
                updateChatInterface();

                // Switch back to own API option
                document.getElementById('useOwnApi').checked = true;
                document.querySelector('input[name="apiOption"][value="own"]').dispatchEvent(new Event('change'));

        } catch (error) {
                showNotification('Failed to cancel subscription. Please try again.', 'error');
        }
        }

        function getFallbackResponse(message) {
        const lowerMessage = message.toLowerCase();
        const responses = {
                'hello': "Hello! It's good to see you.",
                'hi': "Hello! It's good to see you.",
                'how are you': "I'm doing well, thank you! How can I help you today?",
                'thank': "You're very welcome!",
                'bye': "Goodbye! Have a great day!",
                'help': "I'm here to listen and support you. You can talk to me about anything, or try the CBT and DBT tools in the other tabs.",
                'sad': "I'm sorry you're feeling sad. Your emotions are valid. Would you like to talk about what's bothering you?",
                'anxious': "Anxiety can be really difficult. Remember to breathe deeply. I'm here to listen if you'd like to share what's making you anxious.",
                'angry': "It's okay to feel angry. Let's talk about what's causing these feelings."
        };

        for (const [key, response] of Object.entries(responses)) {
                if (lowerMessage.includes(key)) {
                return response;
                }
        }

        return "I'm here to listen. Tell me what's on your mind.";
        }

        // Check-in Functions
        function setCheckinResponse(category, choice) {
        appState.checkinData[category] = choice;

        // Update button states
        const buttons = document.querySelectorAll(`[onclick*="${category}"]`);
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        }

        function completeCheckin() {
        if (Object.keys(appState.checkinData).length < 3) {
                showNotification('Please answer all questions before continuing.', 'error');
                return;
        }

        const entry = {
                timestamp: new Date().toISOString(),
                type: 'Check-in',
                data: { ...appState.checkinData }
        };

        appState.entries.unshift(entry);
        saveToLocalStorage('hush_entries', appState.entries);

        feedJerry('clarity', 50);
        addXP(10);

        showNotification('Check-in completed! Jerry gained clarity.');

        // Reset form
        appState.checkinData = {};
        document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));

        // Switch to Jerry tab
        switchTab('jerry');
        }

        // CBT Functions
        function completeCBT() {
        const situation = document.getElementById('cbtSituation').value.trim();
        const emotions = document.getElementById('cbtEmotions').value.trim();
        const thoughts = document.getElementById('cbtThoughts').value.trim();

        if (!situation || !emotions || !thoughts) {
                showNotification('Please fill in all fields.', 'error');
                return;
        }

        // Get selected distortions
        const distortions = [];
        document.querySelectorAll('#cbtDistortions input:checked').forEach(checkbox => {
                distortions.push(checkbox.nextElementSibling.textContent);
        });

        const entry = {
                timestamp: new Date().toISOString(),
                type: 'CBT',
                data: {
                situation,
                emotions,
                thoughts,
                distortions
                }
        };

        appState.entries.unshift(entry);
        saveToLocalStorage('hush_entries', appState.entries);

        feedJerry('insight', 50);
        addXP(20);

        showNotification('CBT session completed! Jerry gained insight.');

        // Reset form
        document.getElementById('cbtSituation').value = '';
        document.getElementById('cbtEmotions').value = '';
        document.getElementById('cbtThoughts').value = '';
        document.querySelectorAll('#cbtDistortions input').forEach(checkbox => checkbox.checked = false);

        // Switch to Jerry tab
        switchTab('jerry');
        }

        // DBT Functions
        function setDBTRating(emotion, value) {
        appState.dbtData[emotion] = value;

        // Update button states
        const buttons = document.querySelectorAll(`[onclick*="${emotion}"]`);
        buttons.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        }

        function completeDBT() {
        const requiredRatings = ['anger', 'sadness', 'fear', 'shame'];
        const missingRatings = requiredRatings.filter(rating => appState.dbtData[rating] === undefined);

        if (missingRatings.length > 0) {
                showNotification('Please rate all emotions.', 'error');
                return;
        }

        // Get selected skills
        const skills = [];
        document.querySelectorAll('#dbtSkills input:checked').forEach(checkbox => {
                skills.push(checkbox.nextElementSibling.textContent);
        });

        const entry = {
                timestamp: new Date().toISOString(),
                type: 'DBT',
                data: {
                ...appState.dbtData,
                skills
                }
        };

        appState.entries.unshift(entry);
        saveToLocalStorage('hush_entries', appState.entries);

        feedJerry('calm', 50);
        addXP(20);

        showNotification('DBT session completed! Jerry feels calmer.');

        // Reset form
        appState.dbtData = {};
        document.querySelectorAll('#dbt .rating-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#dbtSkills input').forEach(checkbox => checkbox.checked = false);

        // Switch to Jerry tab
        switchTab('jerry');
        }

        document.addEventListener('DOMContentLoaded', () => {       
            // Get references
            const openBtn = document.getElementById('openDBTOverlay');
            const overlay = document.getElementById('dbtDefinitionsOverlay');
            const closeBtn = document.getElementById('closeDBTDefinitions');
            // Open overlay
            openBtn.addEventListener('click', (e) => {
                e.preventDefault();
                overlay.style.display = 'block';
                // Optional: prevent background scrolling while overlay is open
                document.body.style.overflow = 'hidden';
            });

            // Close overlay
            closeBtn.addEventListener('click', () => {
                overlay.style.display = 'none';
                document.body.style.overflow = ''; // restore scrolling
            });
            
            // Optional: close overlay if user clicks outside content
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });

            // Apply light theme if needed
            if (document.body.classList.contains('light-theme')) {
                overlay.style.background = 'rgba(247,237,229,0.95)';
                overlay.style.color = '#3e3e3e';
                closeBtn.style.background = '#A0522D';
                closeBtn.style.color = '#ffffff';
            }
        });

        // Initialize journal if it doesn't exist
        if (!appState.journal) appState.journal = [];

        // Save a new entry
        function saveJournalEntry() {
            const input = document.getElementById('journalInput');
            const content = input.value.trim();
            if (!content) return;

            const timestamp = new Date().toISOString();
            const entry = { content, timestamp };

            appState.journal.push(entry);
            saveToLocalStorage('hush_journal', appState.journal);

            input.value = '';
            renderJournalEntries();
            // Optional: switch to Entries tab automatically
            switchTab('jerry');
        }

        // Wire up save button
        document.getElementById('saveJournalEntry')?.addEventListener('click', saveJournalEntry);

        // Timer Functions
        function toggleTimer() {
        if (!appState.timer.active) {
                startTimer();
        } else {
                stopTimer();
        }
        }

        function startTimer() {
        appState.timer.active = true;
        appState.timer.remaining = 180; // 3 minutes

        document.getElementById('timerButton').textContent = 'Stop';

        appState.timer.interval = setInterval(() => {
                appState.timer.remaining--;
                updateTimerDisplay();

                if (appState.timer.remaining <= 0) {
                completeTimer();
                }
        }, 1000);

        updateTimerDisplay();
        }

        function stopTimer() {
        appState.timer.active = false;
        appState.timer.remaining = 180;

        if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
        }

        document.getElementById('timerButton').textContent = 'Start';
        document.getElementById('timerDisplay').textContent = '03:00';
        }

        function completeTimer() {
        appState.timer.active = false;

        if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
        }

        document.getElementById('timerButton').textContent = 'Start';
        document.getElementById('timerDisplay').textContent = 'Done';

        feedJerry('calm', 30);
        addXP(15);

        showNotification('Mindfulness session completed!');

        setTimeout(() => {
                document.getElementById('timerDisplay').textContent = '03:00';
                appState.timer.remaining = 180;
        }, 2000);
        }

        function updateTimerDisplay() {
        const minutes = Math.floor(appState.timer.remaining / 60);
        const seconds = appState.timer.remaining % 60;
        document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function loadEntries() {
            const entriesList = document.getElementById('entriesList');
            entriesList.innerHTML = '';

            // Merge activity entries and journal entries
            const allEntries = [
                ...(appState.entries || []),  // existing activity/check-in entries
                ...(appState.journal || []).map(j => ({ 
                    type: 'Journal',
                    data: { content: j.content },
                    timestamp: j.timestamp
                }))
            ];

            if (allEntries.length === 0) {
                entriesList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No entries yet. Complete activities or write in your journal to see progress here!</p>';
                return;
            }

            // Sort newest first
            allEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Optional: filter by type
            const filterValue = document.getElementById('entryFilter')?.value || 'all';
            const filteredEntries = allEntries.filter(entry => filterValue === 'all' || entry.type === filterValue);

            // Render filtered entries
            filteredEntries.forEach((entry) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = entry.type === 'Journal' ? 'journalEntry preview' : 'entry-item';

                const date = new Date(entry.timestamp).toLocaleDateString();
                const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let content = '';
                if (entry.type === 'Journal') {
                    content = entry.data.content;
                } else if (entry.type === 'Check-in') {
                    content = `Feeling ${entry.data.emotion || 'N/A'} emotionally, ${entry.data.physical || 'N/A'} physically, ${entry.data.mental || 'N/A'} mentally.`;
                } else if (entry.type === 'CBT') {
                    content = `Situation: ${entry.data.situation || ''}`;
                } else if (entry.type === 'DBT') {
                    const ratings = Object.entries(entry.data)
                        .filter(([key]) => ['anger', 'sadness', 'fear', 'shame'].includes(key))
                        .map(([key, value]) => `${key}: ${value}`)
                        .join(', ');
                    content = `Emotion ratings: ${ratings}`;
                }

                const previewText = (entry.type === 'Journal' || entry.type === 'CBT') && content.length > 100
                    ? content.slice(0, 100) + 'â€¦'
                    : content;

                // Build entry HTML (once)
                entryDiv.innerHTML = `
                    <div class="entry-date">${date} at ${time}</div>
                    <div class="entry-content"><strong>${entry.type}</strong><br>${previewText}</div>
                    <button class="delete-entry">Delete</button>
                `;

                // Expand/collapse for journal and CBT entries
                if (entry.type === 'Journal' || entry.type === 'CBT') {
                    const contentDiv = entryDiv.querySelector('.entry-content');
                    entryDiv.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-entry')) return;
                        
                        const isExpanded = entryDiv.classList.toggle('expanded');
                        contentDiv.innerHTML = `<strong>${entry.type}</strong><br>` + (isExpanded ? content : previewText);
                    });
                }

                // Delete button
                entryDiv.querySelector('.delete-entry').addEventListener('click', () => {
                    if (!confirm('Delete this entry?')) return;

                    if (entry.type === 'Journal') {
                        appState.journal = appState.journal.filter(j => j.timestamp !== entry.timestamp);
                        saveToLocalStorage('hush_journal', appState.journal);
                    } else {
                        appState.entries = appState.entries.filter(e => e.timestamp !== entry.timestamp);
                        saveToLocalStorage('hush_entries', appState.entries);
                    }

                    loadEntries();
                });

                entriesList.appendChild(entryDiv);
            });
        }

        function loadHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';
        
        if (appState.chatHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No conversation history yet. Chat with Jerry to see your conversations here!</p>';
                return;
        }
        
        // Group conversations by session (this is a simplified approach)
        const sessions = [];
        let currentSession = [];
        
        appState.chatHistory.forEach(message => {
                currentSession.push(message);
        });
        
        if (currentSession.length > 0) {
                sessions.push({
                timestamp: new Date().toISOString(),
                conversation: currentSession
                });
        }
        
        sessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'entry-item';
                
                const date = new Date(session.timestamp).toLocaleDateString();
                const time = new Date(session.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const messageCount = session.conversation.length;
                
                sessionDiv.innerHTML = `
                <div class="entry-date">${date} at ${time}</div>
                <div class="entry-content">Conversation with ${messageCount} messages</div>
                `;
                
                historyList.appendChild(sessionDiv);
        });
        }

        // =======================
        // Subscription Verification
        // =======================
        function verifySubscriptionOnLoad() {
        const subscriptionId = localStorage.getItem('jerry_subscription_id');
        const isActive = localStorage.getItem('jerry_subscription_active') === 'true';

        subscriptionState.isSubscribed = isActive;
        subscriptionState.subscriptionId = subscriptionId;
        subscriptionState.messageCount = parseInt(localStorage.getItem('jerry_message_count') || '0', 10);
        subscriptionState.billingCycle = localStorage.getItem('jerry_billing_cycle') || null;

        // Update UI
        updateSubscriptionDisplay();
        updateUsageDisplay();
        updateChatInterface();
        }

        // =======================
        // Settings Loader/Saver
        // =======================
        function loadSettings() {
        // Basic settings
        document.getElementById('apiKey').value = appState.apiKey || '';
        document.getElementById('botName').value = appState.botName || 'Jerry';

        // Theme
        const storedTheme = localStorage.getItem('spriteTheme') || 'default';
        appState.spriteTheme = storedTheme;
        document.getElementById('spriteTheme').value = appState.spriteTheme;

        // API option
        const apiOption = localStorage.getItem('jerry_api_option') || 'own';
        document.querySelector(`input[name="apiOption"][value="${apiOption}"]`).checked = true;

        // Wire up event handlers
        setupApiOptionHandlers();
        }

        function saveSettings() {
        const apiKey = document.getElementById('apiKey').value.trim();
        appState.apiKey = apiKey;
        localStorage.setItem('hush_api_key', apiKey);

        const botName = document.getElementById('botName').value.trim() || 'Jerry';
        appState.botName = botName;
        localStorage.setItem('botName', botName);

        const selectedApiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
        localStorage.setItem('jerry_api_option', selectedApiOption);

        appState.spriteTheme = document.getElementById('spriteTheme').value;
        localStorage.setItem('spriteTheme', appState.spriteTheme);

        showNotification('Settings saved successfully!');
        updateChatInterface();
        updateJerrySprite();
        }

        function updateThemeColor() {
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            if (!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = "theme-color";
                document.head.appendChild(metaTheme);
            }

            if (document.body.classList.contains('light-theme')) {
                metaTheme.setAttribute('content', '#A0522D'); // brown for light mode
            } else {
                metaTheme.setAttribute('content', '#3355d4'); // dark mode color
            }
        }

        function toggleTheme() {
        document.body.classList.toggle('light-theme');

        const isLightMode = document.body.classList.contains('light-theme');
        localStorage.setItem('hush_theme', isLightMode ? 'light' : 'dark');

        showNotification('Theme updated!');

        updateJerrySprite();

        updateThemeColor();
        }

        function resetMonthlyUsageIfNeeded() {
        if (subscriptionState.billingCycle) {
                const now = new Date();
                const billingDate = new Date(subscriptionState.billingCycle);

                if (now >= billingDate) {
                subscriptionState.messageCount = 0;
                subscriptionState.billingCycle = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();

                localStorage.setItem('jerry_message_count', '0');
                localStorage.setItem('jerry_billing_cycle', subscriptionState.billingCycle);

                updateUsageDisplay();
                updateSubscriptionDisplay();
                updateChatInterface();
                }
        }
        }

        // =======================
        // App Initialization
        // =======================
        function initializeApp() {
            const splash = document.getElementById('splashScreen');
            const splashImg = document.getElementById('splashImage');

            if (splash && splashImg) {
                // Ensure splash is fully visible immediately
                splash.style.opacity = '1';
                splash.style.transition = 'opacity 0.5s ease';

                const fadeSplash = () => {
                    // Wait 3 seconds before starting fade
                    setTimeout(() => {
                        // Use requestAnimationFrame to ensure opacity=1 is rendered first
                        requestAnimationFrame(() => {
                            splash.style.opacity = '0';  // trigger fade
                        });
                        // Remove splash after transition completes
                        splash.addEventListener('transitionend', () => splash.remove(), { once: true });
                    }, 3000);
                };

                if (splashImg.complete) {
                    fadeSplash(); // image cached, start fade timer
                } else {
                    splashImg.addEventListener('load', fadeSplash);
                    splashImg.addEventListener('error', fadeSplash);
                }

                // Set background based on theme
                const isLightMode = document.body.classList.contains('light-theme');
                splash.style.background = isLightMode ? '#f7ede5' : '#1a202c';
            }
            // --- Theme ---
            const savedTheme = localStorage.getItem('hush_theme');
            if (savedTheme === 'light') document.body.classList.add('light-theme');

            // --- Load bot name ---
            appState.botName = localStorage.getItem('botName') || 'Jerry';
            const nameInput = document.getElementById('botName');
            if (nameInput) {
                nameInput.value = appState.botName;
                nameInput.addEventListener('input', (e) => {
                const val = e.target.value.trim();
                appState.botName = val || 'Jerry';
                localStorage.setItem('botName', appState.botName);
                });
            }
        
            // --- Load Jerry state FIRST ---
            loadJerryState();

            // Ensure lastFed exists for every need
            ['clarity', 'insight', 'calm'].forEach(need => {
                if (!appState.jerry.lastFed[need]) {
                    appState.jerry.lastFed[need] = Date.now() - (10 * 60 * 1000 + 1000); // just past grace period
                }
            });

            updateJerryNeeds();

            // Start real-time decay
            setInterval(updateJerryNeeds, NEEDS_TICK_INTERVAL);
        
            // --- Load settings FIRST ---
            loadSettings();

            // --- Wire up instant sprite theme updates ---
            const spriteThemeSelect = document.getElementById('spriteTheme');
            if (spriteThemeSelect) {
                spriteThemeSelect.addEventListener('change', (e) => {
                    const value = e.target.value;
                    appState.spriteTheme = value;
                    localStorage.setItem('spriteTheme', value);
                    updateJerrySprite(); // updates main sprite and preview immediately
                });
            }

            // --- Initial rendering ---
            updateJerryUI();
            updateAffirmationBanner('jerry');
            updateThemeColor();

            // Load journal
            appState.journal = getFromLocalStorage('hush_journal') || [];

            // Wire up Entries filter
            const entryFilter = document.getElementById('entryFilter');
            if (entryFilter) {
                entryFilter.addEventListener('change', loadEntries);
            }
            
            renderJournalEntries();
            loadEntries();

            // --- Verify subscription (localStorage backup) ---
            verifySubscriptionOnLoad();
            
            // --- Start intervals ---
            // Start interval for smooth decay
            setInterval(updateJerrySprite, 2000); // animate sprite
            setInterval(() => {
                if (appState.currentTab === 'jerry' || appState.currentTab === 'checkin') {
                    updateAffirmationBanner(appState.currentTab);
                }
            }, 10000); // refresh affirmations
            setInterval(resetMonthlyUsageIfNeeded, 24 * 60 * 60 * 1000); // daily usage check

            // --- Update usage and chat interface after everything is loaded ---
            updateUsageDisplay();
            updateChatInterface();

            
            // --- Service Worker registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const swCode = `
                        const CACHE_NAME = 'jerry-pwa-v3';
                        const urlsToCache = ['/', '/index.html', '/manifest.json', '/JerryIcon.png'];
                        self.addEventListener('install', (event) => {
                            event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache)));
                        });
                        self.addEventListener('fetch', (event) => {
                            event.respondWith(caches.match(event.request).then((response) => response || fetch(event.request)));
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then(() => console.log('ServiceWorker registration successful'))
                        .catch(() => console.log('ServiceWorker registration failed'));
                });
            }
        } // <-- THIS CLOSES initializeApp

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
