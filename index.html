<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.5, user-scalable=yes">
    <title>Jerry - Mental Health Companion</title>

    <script src="https://www.paypal.com/sdk/js?client-id=AQQjfHs0zv-KHqb4Rtn8c8UYMZSb1chU62eafw_y7s3XzUNLZ3HQpQvfV3M-lx5oesJaaC6hNSr1qG7_&vault=true&intent=subscription"></script>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#3355d4">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#A0522D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Jerry">
    <!-- iOS Home Screen icons -->
    <link rel="apple-touch-icon" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="180x180" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="152x152" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="120x120" href="./jerryIcon3.PNG">
    <link rel="apple-touch-icon" sizes="167x167" href="./jerryIcon3.PNG">
    
    <style>
/* ============================= */
/* GLOBAL RESET & BOX-SIZING */
/* ============================= */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* ============================= */
/* BODY & THEMES */
/* ============================= */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1e1e2e 0%, #2d3748 100%);
    color: #e2e8f0;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Light Theme */
body.light-theme {
    background: linear-gradient(135deg, #fdf6f0 0%, #f7ede5 100%);
    color: #3e3e3e;
}

/* ============================= */
/* APP CONTAINER */
/* ============================= */
.app-container {
    max-width: 430px;
    margin: 0 auto;
    min-height: 100vh;
    background: #1a202c;
    position: relative;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

body.light-theme .app-container {
    background: #f7ede5;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

/* ============================= */
/* AFFIRMATION BANNER */
/* ============================= */
.affirmation-banner {
    background: linear-gradient(90deg, #3355d4, #4f46e5);
    padding: 8px 16px;
    text-align: center;
    font-size: 12px;
    color: white;
    min-height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

body.light-theme .affirmation-banner {
    background: linear-gradient(90deg, #e3b88d, #f0c9a2);
    color: #3e3e3e;
}

/* ============================= */
/* TABS */
/* ============================= */
.tab-container {
    display: flex;
    background: #2d3748;
    border-bottom: 1px solid #4a5568;
}

body.light-theme .tab-container {
    background: #eae3de;
    border-bottom: 1px solid #d8cfc4;
}

.tab {
    flex: 1;
    padding: 12px 8px;
    text-align: center;
    background: none;
    border: none;
    color: #a0aec0;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 11px;
    font-weight: 500;
}

.tab.active {
    color: #3355d4;
    background: #1a202c;
    border-bottom: 2px solid #3355d4;
}

.tab:hover {
    background: rgba(51, 85, 212, 0.1);
    color: #63b3ed;
}

body.light-theme .tab {
    color: #6b7280;
}

body.light-theme .tab.active {
    color: #e3b88d;
    background: #f7ede5;
    border-bottom: 2px solid #e3b88d;
}

body.light-theme .tab:hover {
    background: rgba(227,184,141,0.1);
    color: #c27c48;
}

/* ============================= */
/* SCREENS */
/* ============================= */
.screen {
    display: none;
    padding: 20px;
    min-height: 100vh;
    position: relative;
}

.screen.active {
    display: block;
}

body.light-theme .screen {
    background-color: #f7ede5;
}

/* ============================= */
/* FORM STYLES */
/* ============================= */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #cbd5e0;
}

body.light-theme .form-label {
    color: #4b4b4b;
}

.form-input,
.form-textarea,
#journalInput,
.chat-input,
textarea,
input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s ease;
    position: relative;
    z-index: 500;
}

.form-input,
.form-textarea {
    background: #2d3748;
    border: 1px solid #4a5568;
    color: #e2e8f0;
}

.form-input:focus,
.form-textarea:focus {
    border-color: #3355d4;
}

body.light-theme .form-input,
body.light-theme .form-textarea,
body.light-theme #journalInput,
body.light-theme .chat-input {
    background: #ffffff;
    color: #3e3e3e;
    border: 1px solid #d8cfc4;
}

body.light-theme .form-input:focus,
body.light-theme .form-textarea:focus,
body.light-theme #journalInput:focus,
body.light-theme .chat-input:focus {
    border-color: #e3b88d;
}

.form-textarea,
#journalInput {
    resize: vertical;
}

#journalInput {
    flex: 1;
    min-height: 200px;
    margin-bottom: 80px;
    box-sizing: border-box;
}

#saveJournalEntry {
    position: relative;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    padding: 12px 30px;
    width: 100%;
    border-radius: 8px;
    background: #3355d4;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    margin-top: 12px;
}

#saveJournalEntry:hover {
    background: #2d4aa7;
    transform: translateX(-50%);
}

body.light-theme #saveJournalEntry {
    background: #e3b88d;
    color: #3e3e3e;
}

body.light-theme #saveJournalEntry:hover {
    background: #cfa273;
}

/* ============================= */
/* BUTTONS */
/* ============================= */
.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: block;
    text-align: center;
    text-decoration: none;
    margin: 8px auto;
    border: none;
    transition: all 0.3s ease;
}

.btn {
    background: #3355d4;
    color: white;
}

.btn:hover {
    background: #2d4aa7;
    transform: translateY(-1px);
}

.btn-secondary {
    background: #4a5568;
    color: white;
}

.btn-secondary:hover {
    background: #2d3748;
}

.rating-group {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.rating-btn {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    background: #2d3748;
    border: 1px solid #4a5568;
    color: #a0aec0;
}

.rating-btn.active,
.rating-btn:hover {
    background: #3355d4;
    color: white;
    border-color: #3355d4;
}

body.light-theme .btn {
    background: #e3b88d;
    color: #3e3e3e;
}

body.light-theme .btn:hover {
    background: #cfa273;
}

body.light-theme .btn-secondary {
    background: #d8cfc4;
    color: #3e3e3e;
}

body.light-theme .btn-secondary:hover {
    background: #cbb7a2;
}

body.light-theme .rating-btn {
    background: #ffffff;
    border: 1px solid #d8cfc4;
    color: #6b7280;
}

body.light-theme .rating-btn.active,
body.light-theme .rating-btn:hover {
    background: #e3b88d;
    color: #3e3e3e;
    border-color: #e3b88d;
}

/* ============================= */
/* TIMER DISPLAY */
/* ============================= */
.timer-container {
    text-align: center;
    padding: 40px 20px;
}

.timer-display {
    font-size: 48px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    color: #3355d4;
    margin-bottom: 30px;
}

body.light-theme .timer-display {
    color: #e3b88d;
}

/* ============================= */
/* PROGRESS & STATS */
/* ============================= */
.progress-section,
.entry-item,
.checkbox-container {
    background: #2d3748;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 12px;
    color: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

body.light-theme .progress-section,
body.light-theme .entry-item,
body.light-theme .checkbox-container {
    background: #f7ede5;
    color: #3e3e3e;
}

.entry-item label {
    flex: 1;
    cursor: pointer;
}

.checkbox-container input[type="checkbox"] {
    margin-right: 12px;
    accent-color: #3355d4;
}

body.light-theme .checkbox-container input[type="checkbox"] {
    accent-color: #e3b88d;
}

/* ============================= */
/* NOTIFICATIONS */
/* ============================= */
.notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #3355d4;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 1000;
}

.notification.show {
    opacity: 1;
    pointer-events: auto;
}

.notification.success {
    background: #38a169;
}

.notification.error {
    background: #e53e3e;
}

body.light-theme .notification {
    background: #e3b88d;
    color: #3e3e3e;
}

body.light-theme .notification.success {
    background: #81c784;
}

body.light-theme .notification.error {
    background: #f56565;
}

/* ============================= */
/* RADIAL MENU */
/* ============================= */
.radial-menu {
    position: fixed;
    bottom: 40px;
    right: 40px;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #3355d4;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s ease;
}

.radial-menu:hover {
    transform: scale(1.05);
}

body.light-theme .radial-menu {
    background: #e3b88d;
}

.radial-menu-item {
    position: absolute;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #4a5568;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    transition: all 0.3s ease;
    pointer-events: auto;
}

body.light-theme .radial-menu-item {
    background: #d8cfc4;
    color: #3e3e3e;
}

/* ============================= */
/* PET SPRITE PREVIEW */
/* ============================= */
#petPreview {
    position: relative;
    width: 128px;
    height: 128px;
    margin: 20px auto;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none; /* Prevent blocking clicks */
    z-index: 50;
}

body.light-theme #petPreview {
    background: rgba(0,0,0,0.05);
}

#petPreview canvas {
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
}

/* ============================= */
/* CHAT AREA */
/* ============================= */
.chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 12px;
    background: #1a202c;
    overflow-y: auto;
}

body.light-theme .chat-container {
    background: #f7ede5;
}

.chat-message {
    margin-bottom: 8px;
    padding: 10px 14px;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
}

.chat-message.user {
    background: #3355d4;
    color: white;
    align-self: flex-end;
}

.chat-message.bot {
    background: #4a5568;
    color: white;
    align-self: flex-start;
}

body.light-theme .chat-message.user {
    background: #e3b88d;
    color: #3e3e3e;
}

body.light-theme .chat-message.bot {
    background: #d8cfc4;
    color: #3e3e3e;
}

.chat-input-container {
    display: flex;
    gap: 8px;
    padding: 8px;
    background: #2d3748;
}

body.light-theme .chat-input-container {
    background: #ffffff;
}

/* ============================= */
/* JOURNAL ENTRIES LIST */
/* ============================= */
.journal-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
}

.journal-list-item {
    padding: 12px;
    border-radius: 8px;
    background: #2d3748;
    color: #e2e8f0;
}

body.light-theme .journal-list-item {
    background: #f7ede5;
    color: #3e3e3e;
}

/* ============================= */
/* MISC UI ELEMENTS */
/* ============================= */
.scrollable {
    overflow-y: auto;
}

.hidden {
    display: none !important;
}

.fade-in {
    animation: fadeIn 0.3s ease forwards;
}

.fade-out {
    animation: fadeOut 0.3s ease forwards;
}

@keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
}

@keyframes fadeOut {
    from {opacity: 1;}
    to {opacity: 0;}
}
</style>
</head>
<body>
    <div id="splashScreen">
        <img src="./jerrySplash2.PNG" alt="Splash" id="splashImage" />
    </div>
    <div class="app-container">
        <div class="affirmation-banner" id="affirmationBanner">
            Your feelings are valid, even the difficult ones.
        </div>

        <div id="menuTrigger">‚ò∞</div>

        <div id="radialMenuOverlay"></div>
        <div id="radialMenuApp">
            <div class="radial-center">üè†</div>
            <button class="radial-item" onclick="switchTab('jerry', event)">üßç</button>
            <button class="radial-item" onclick="switchTab('checkin', event)">‚úÖ</button>
            <button class="radial-item" onclick="switchTab('cbt', event)">üí≠</button>
            <button class="radial-item" onclick="switchTab('dbt', event)">üßò‚Äç‚ôÇÔ∏è</button>
            <button class="radial-item" onclick="switchTab('journalTab', event)">üìì</button>
            <button class="radial-item" onclick="switchTab('hush', event)">ü§´</button>
            <button class="radial-item" onclick="switchTab('entries', event)">üóÇ</button>
            <button class="radial-item" onclick="switchTab('settings', event)">‚öôÔ∏è</button>
        </div>

        <!-- Pet Sprite -->
        <div id="petContainer">
            <div class="pet-sprite" id="petSprite"></div>
        </div>
        
        <!-- Jerry Screen -->
        <div class="screen active" id="jerry">
            <div class="jerry-container" id="jerryWrapper">
                <!--- <div id="jerryHalo"></div> --->
                <div class="jerry-sprite" id="jerrySprite"></div>
                <div class="jerry-shadow"></div>
                <div class="jerry-stats">
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Clarity</span>
                            <span id="clarityValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill clarity-bar" id="clarityBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Insight</span>
                            <span id="insightValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill insight-bar" id="insightBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>Calm</span>
                            <span id="calmValue">100%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill calm-bar" id="calmBar" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span id="levelLabel">Level 1</span>
                            <span id="xpLabel">XP: 0 / 100</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-log" id="chatLog">
                    <div class="message jerry">It's good to see you again.</div>
                </div>
                <div class="chat-input-container">
                    <textarea inputmode="text" class="chat-input" id="chatInput" placeholder="Type your message..." ></textarea>
                    <button id="sendButton" class="send-button" onclick="sendMessage()">‚Üí</button>
                </div>
            </div>
        </div>
        
        <!-- Check-in Screen -->
        <div class="screen" id="checkin">
            <h2 style="margin-bottom: 20px;">Daily Check-in</h2>
            <div id="checkinContent">
                <div class="form-group">
                    <div class="form-label">How are you feeling emotionally?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'emotion', 'Good')">Good</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'emotion', 'Okay')">Okay</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'emotion', 'Bad')">Bad</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your body feeling?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'physical', 'Energetic')">Energetic</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'physical', 'Tired')">Tired</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'physical', 'Pain')">Pain</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">How is your mind today?</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'mental', 'Clear')">Clear</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'mental', 'Foggy')">Foggy</button>
                        <button class="rating-btn" onclick="setCheckinResponse(this, 'mental', 'Overwhelmed')">Overwhelmed</button>
                    </div>
                </div>
                <button class="btn" onclick="completeCheckin()">Complete Check-in</button>
            </div>
        </div>
        
        <!-- CBT Screen -->
        <div class="screen" id="cbt">
            <h2 style="margin-bottom: 20px;">CBT Thought Record</h2>
            <div id="cbtContent">
                <div class="form-group">
                    <label class="form-label" for="cbtSituation">What was the situation or event that triggered the difficult feeling?</label>
                    <textarea inputmode="text" class="form-input form-textarea" id="cbtSituation" placeholder="e.g., I had a disagreement with a friend."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtEmotions">What emotions did you feel? (e.g., sad, angry, anxious)</label>
                    <textarea inputmode="text" class="form-input form-textarea" id="cbtEmotions" placeholder="List the primary emotions."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cbtThoughts">What were the automatic thoughts that went through your mind?</label>
                    <textarea inputmode="text" class="form-input form-textarea" id="cbtThoughts" placeholder="What did you immediately think or believe?"></textarea>
                </div>
                
                <h3 style="margin: 20px 0 12px;">Which cognitive distortions apply?</h3>
                <div id="cbtDistortions">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="allOrNothing">
                        <label class="checkbox-label" for="allOrNothing"><strong>All-or-Nothing Thinking:</strong> Viewing things in black-and-white categories.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="overgeneralization">
                        <label class="checkbox-label" for="overgeneralization"><strong>Overgeneralization:</strong> Seeing a single negative event as a never-ending pattern of defeat.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mentalFilter">
                        <label class="checkbox-label" for="mentalFilter"><strong>Mental Filter:</strong> Picking out a single negative detail and dwelling on it exclusively.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="jumpingConclusions">
                        <label class="checkbox-label" for="jumpingConclusions"><strong>Jumping to Conclusions:</strong> Making a negative interpretation despite no definite facts.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionalReasoning">
                        <label class="checkbox-label" for="emotionalReasoning"><strong>Emotional Reasoning:</strong> Assuming that your negative emotions necessarily reflect the way things really are.</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="shouldStatements">
                        <label class="checkbox-label" for="shouldStatements"><strong>Should Statements:</strong> Motivating yourself with 'shoulds' and 'shouldn'ts'.</label>
                    </div>
                </div>
                
                <button class="btn" onclick="completeCBT()">Complete CBT Session</button>
            </div>
        </div>
        
        <!-- DBT Screen -->
        <div class="screen" id="dbt">
            <h2 style="margin-bottom: 20px;">DBT Skills Check</h2>
            <div id="dbtContent">
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your ANGER (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'anger', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SADNESS (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'sadness', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your FEAR (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'fear', 5)">5</button>
                    </div>
                </div>
                <div class="form-group">
                    <div class="form-label">Rate the intensity of your SHAME (0-5)</div>
                    <div class="rating-group">
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 0)">0</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 1)">1</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 2)">2</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 3)">3</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 4)">4</button>
                        <button class="rating-btn" onclick="setDBTRating(this, 'shame', 5)">5</button>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 12px;">DBT Skills to Practice</h3>
                <div id="dbtSkills">
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="mindfulness">
                        <label class="checkbox-label" for="mindfulness"><strong>Mindfulness:</strong> Observe, Describe, Participate</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="distressTolerance">
                        <label class="checkbox-label" for="distressTolerance"><strong>Distress Tolerance:</strong> TIP, ACCEPTS, Self-Soothe</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="emotionRegulation">
                        <label class="checkbox-label" for="emotionRegulation"><strong>Emotion Regulation:</strong> Check the Facts, Opposite Action</label>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" class="checkbox" id="interpersonalEffectiveness">
                        <label class="checkbox-label" for="interpersonalEffectiveness"><strong>Interpersonal Effectiveness:</strong> DEAR MAN, GIVE, FAST</label>
                    </div>
                </div>
                
                <button class="btn" onclick="completeDBT()">Complete DBT Session</button>
            </div>
        </div>

        <!-- Journal Tab -->
        <div class="screen" id="journalTab">
            <h2 style="margin-bottom: 16px;">Journal</h2>
            <!-- New Entry Input -->
            <textarea inputmode="text" id="journalInput" placeholder="Write your thoughts here..." rows="5"></textarea>
            <button id="saveJournalEntry">Save Entry</button>
        </div>

        <!-- Hush Timer Screen -->
        <div class="screen" id="hush">
            <div class="timer-container">
                <h2 style="margin-bottom: 30px;">Mindfulness Timer</h2>
                <div class="timer-display" id="timerDisplay">03:00</div>
                <button class="btn timer-btn" id="timerButton" onclick="toggleTimer()">Start</button>
            </div>
        </div>
        
        <!-- Entries Screen -->
        <div class="screen" id="entries">
            <h2 style="margin-bottom: 20px;">Your Entries</h2>
            <div class="filter-container">
                <label for="entryFilter" class="form-label">Filter by type:</label>
                <select id="entryFilter" class="form-input">
                    <option value="all">All</option>
                    <option value="Check-in">Check-in</option>
                    <option value="CBT">CBT</option>
                    <option value="DBT">DBT</option>
                    <option value="Journal">Journal</option>
                </select>
  
            </div>
            <div id="entriesList">
                <!-- Entries will be populated here -->
            </div>
        </div>
        
        <!-- History Screen -->
        <div class="screen" style="display: none;" id="history">
            <h2 style="margin-bottom: 20px;">Conversation History</h2>
            <div id="historyList">
                <!-- History will be populated here -->
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div class="screen" id="settings">
            <h2 style="margin-bottom: 20px;">Settings</h2>

            <!-- Add this inside your settings tab HTML -->
            <div style="margin-bottom: 16px;" id="ambientMusicToggleContainer">
                <label style="margin-left:10px;">
                    Chirp Volume:
                    <input type="range" id="ambientMusicVolume" min="0" max="1" step="0.01" value="0.5">
                </label>
            </div>

            
            <!-- Bot Name Input -->
            <div class="form-group">
                <label class="form-label" for="botName">Companion Name</label>
                <input type="text" inputmode="text" class="form-input" id="botName" placeholder="Enter a name for your companion.">
            </div>

            <!-- API Configuration Section -->
            <div class="form-group">
                <label class="form-label">AI Configuration</label>
                
                <!-- API Option Selection -->
                <div class="api-toggle" style="background: #2d3748; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div class="api-option" style="display: flex; align-items: center; margin-bottom: 12px;">
                        <input type="radio" name="apiOption" id="useOwnApi" value="own" checked style="margin-right: 12px; transform: scale(1.2);">
                        <label for="useOwnApi" style="flex: 1; cursor: pointer;">
                            Use Your Own API Key
                            <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                Free - Bring your own Google AI Studio API key
                            </div>
                        </label>
                    </div>
            
                    <div class="api-option" style="display: flex; align-items: center; margin-bottom: 12px;">
                        <input type="radio" name="apiOption" id="usePremium" value="premium" style="margin-right: 12px; transform: scale(1.2);">
                        <label for="usePremium" style="flex: 1; cursor: pointer;">
                            Use Premium API Service
                            <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                $4.99/month - No setup required, built-in API access
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Own API Key Input (shown by default) -->
                <div id="ownApiSection">
                    <input type="text" inputmode="text" class="form-input" id="apiKey" placeholder="Enter your Google AI Studio API key here.">
                    <div style="font-size: 12px; color: #a0aec0; margin-top: 8px;">
                        Get your free API key at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #3355d4;">Google AI Studio</a>
                    </div>
                </div>

                <!-- Premium Subscription Section (hidden by default) -->
                <div id="premiumSection" style="display: none;">
                    <div class="subscription-card" style="background: #2d3748; border-radius: 12px; padding: 20px; border: 2px solid #4a5568; transition: all 0.3s ease;">
                        <div class="subscription-title" style="font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #3355d4;">
                            üåü Premium API Access
                        </div>
                        <div class="subscription-price" style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">
                            $4.99<span style="font-size: 16px; color: #a0aec0;">/month</span>
                        </div>
                
                        <ul class="subscription-features" style="list-style: none; margin-bottom: 20px;">
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">‚úì</span>
                                No API key setup required
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">‚úì</span>
                                1,000 messages per month
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">‚úì</span>
                                Faster response times
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">‚úì</span>
                                Priority support
                            </li>
                            <li style="padding: 6px 0; padding-left: 20px; position: relative;">
                                <span style="position: absolute; left: 0; color: #48bb78; font-weight: bold;">‚úì</span>
                                Cancel anytime
                            </li>
                        </ul>
                        <div id="paypal-button-container-P-7LR41432T4749780UNC7UVBY"></div>
                        <script src="https://www.paypal.com/sdk/js?client-id=AQQjfHs0zv-KHqb4Rtn8c8UYMZSb1chU62eafw_y7s3XzUNLZ3HQpQvfV3M-lx5oesJaaC6hNSr1qG7_&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

                        <!-- Subscription Status Display -->
                        <div id="subscriptionStatusDisplay" style="display: none;">
                            <div class="subscription-status active" style="background: #1a365d; border: 1px solid #38a169; border-radius: 8px; padding: 16px; margin-bottom: 16px; text-align: center;">
                                <div style="color: #68d391; font-weight: bold; margin-bottom: 8px;">‚úì Premium Active</div>
                                <div style="font-size: 12px; color: #a0aec0;">
                                    Messages used this month: <span id="messageUsageDisplay">0 / 1000</span>
                                </div>
                                <div style="font-size: 12px; color: #a0aec0; margin-top: 4px;">
                                    Next billing: <span id="nextBillingDate">--</span>
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="cancelSubscription()" style="background: #e53e3e; width: 100%;">
                                Cancel Subscription
                            </button>
                        </div>

                        <!-- PayPal Subscribe Button -->
                        <div id="paypalSubscribeSection">
                            <div id="paypal-button-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="saveSettings()">Save Settings</button>

            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Sprite</h3>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Sprite Preview</label>
                <div id="spritePreview" style="width: 100px; height: 100px; position: relative; background: transparent; border: none;"></div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" for="spriteStyle">Sprite Style:</label>
                <select class="form-input" id="spriteStyle">
                    <option value="default">Jerry</option>
                    <option value="cornelius">Cornelius</option>
                    <option value="scott">Scott</option>
                    <option value="xeno">Xeno</option>
                    <option value="nano">Nano</option>
                    <option value="astro">Astro</option>
                    <option value="castle">Outpost</option>
                    <option value="ember">Ember</option>
                    <option value="wisp">Wisp</option>
                    <option value="python">Snowball</option>
                    <option value="luna">Luna</option>
                    <option value="matrix">Matrix</option>
                    <option value="glyphton">Glyphton</option>
                    <option value="sassy">Squachi</option>
                    <option value="bramble">Bramble</option>
                    <option value="apples">Apples</option>
                    <option value="earthy">Rootling</option>
                    <option value="drago">Drago</option>
                    <option value="egg">Yolk</option>
                    <option value="lilguy">Lil' Guy</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="spriteTheme">Sprite Theme:</label>
                <select class="form-input" id="spriteTheme">
                    <option value="default">Default</option>
                    <option value="candy">Candy</option>
                    <option value="ocean">Ocean</option>
                    <option value="ember">Ember</option>
                    <option value="meadow">Meadow</option>
                    <option value="neon">Neon</option>
                    <option value="pastel">Pastel</option>
                    <option value="gothic">Gothic</option>
                    <option value="aurora">Aurora</option>
                    <option value="fantasySprite">Fantasy</option>
                    <option value="retroPixel">Retro</option>
                </select>
            </div>
            <!-- Background Environment Selection -->
            <div id="backgroundSettings">
                <h4 class="form-label">Sprite Environment:</h4>
                <div class="background-scroll">
                    <div class="background-option" data-bg="default">
                        <span>üö´</span>
                    </div>
                    <div class="background-option" data-bg="neonLights">
                        <div class="bg-swatch swatch-neonLights"></div>
                        <span>Neon Lights</span>
                    </div>
                    <div class="background-option" data-bg="noir">
                        <div class="bg-swatch swatch-noir"></div>
                        <span>Noir</span>
                    </div>
                    <div class="background-option" data-bg="petal">
                        <div class="bg-swatch swatch-petal"></div>
                        <span>Petal</span>
                    </div>

                    <div class="background-option" data-bg="eclipse">
                        <div class="bg-swatch swatch-eclipse"></div>
                        <span>Eclipse</span>
                    </div>

                    <div class="background-option" data-bg="aurora">
                        <div class="bg-swatch swatch-aurora"></div>
                        <span>Aurora</span>
                    </div>

                    <div class="background-option" data-bg="ember">
                        <div class="bg-swatch swatch-ember"></div>
                        <span>Ember</span>
                    </div>
                    <div class="background-option" data-bg="woods">
                        <div class="bg-swatch swatch-woods"></div>
                        <span>Woods</span>
                    </div>

                    <div class="background-option" data-bg="galactic">
                        <div class="bg-swatch swatch-galactic"></div>
                        <span>Galactic</span>
                    </div>
                    <div class="background-option" data-bg="spooky">
                        <div class="bg-swatch swatch-spooky"></div>
                        <span>Spooky</span>
                    </div>
                    <div class="background-option" data-bg="dreamland">
                        <div class="bg-swatch swatch-dreamland"></div>
                        <span>Dreamy</span>
                    </div>
                    <div class="background-option" data-bg="beach">
                        <div class="bg-swatch swatch-beach"></div>
                        <span>Beach</span>
                    </div>
                    <div class="background-option" data-bg="arcane">
                        <div class="bg-swatch swatch-arcane"></div>
                        <span>Arcane</span>
                    </div>
                    <div class="background-option" data-bg="matrix">
                        <div class="bg-swatch swatch-matrix"></div>
                        <span>01001101</span>
                    </div>
                    <div class="background-option" data-bg="flare">
                        <div class="bg-swatch swatch-flare"></div>
                        <span>Flare</span>
                    </div>
                </div>
            </div>
            <div style="margin-top: 40px;">
                <h3 style="margin-bottom: 15px;">Pet</h3>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Pet Preview</label>
                <div id="petPreview"></div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label" for="petStyle">Pet Style:</label>
                <select class="form-input" id="petStyle">
                    <option value="none">üö´</option>
                    <option value="miniJerry">Mini Jerry</option>
                    <option value="puff">Puff</option>
                    <option value="spark">Spark</option>
                    <option value="buddy">Buddy</option>
                    <option value="orb">The Visitor</option>
                    <option value="flame">Flame</option>
                    <option value="leaf">Leaf</option>
                    <option value="gem">Crisp</option>
                    <option value="beetle">Bob</option>
                    <option value="star">Nightlight</option>
                    <option value="peepaw">Pee-Paw</option>
                    <option value="flicker">Flicker</option>
                    <option value="grumple">Grumple</option>
                    <option value="dragojr">Drago Jr.</option>
                    <option value="tube">Tube</option>
                    <option value="qube">Qube</option>
                    <option value="chromeo">T-420</option>
                    <option value="rainbow">Stormy</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="petTheme">Pet Theme:</label>
                <select class="form-input" id="petTheme">
        
                    <!-- same themes as sprite -->
                    <option value="default">Default</option>
                    <option value="candy">Candy</option>
                    <option value="ocean">Ocean</option>
                    <option value="ember">Ember</option>
                    <option value="meadow">Meadow</option>
                    <option value="neon">Neon</option>
                    <option value="pastel">Pastel</option>
                    <option value="gothic">Gothic</option>
                    <option value="aurora">Aurora</option>
                    <option value="fantasySprite">Fantasy</option>
                    <option value="retroPixel">Retro</option>
                </select>
            </div>

            <div id="spriteUploadZone" class="upload-zone">
                <p>Drag & drop your sprite JSON here or click to upload</p>
                <input type="file" id="spriteFileInput" accept=".json" hidden>
            </div>

            <!-- Inline inputs for naming and category -->
            <div id="spriteUploadInputs" style="display:none; margin-top:10px;">
                <input type="text" id="spriteNameInputInline" placeholder="Sprite Name" style="width:100%; margin-bottom:5px;">
                <select id="spriteCategorySelectInline" style="width:100%; margin-bottom:5px;">
                    <option value="jerry">Jerry</option>
                    <option value="pet">Pet</option>
                </select>
                <button id="spriteUploadSubmitInline" style="width:100%;">Add Sprite</button>
            </div>
            <div>
            <ul id="uploadedSpritesList"></ul>
            </div>
            <div style="font-size: 12px; color: #a0aec0; margin-top: 8px;">
                Draw your own Jerry!<a href="https://braemonk.github.io/QuikEdit/" target="_blank" style="color: #3355d4;">Jerry Editor</a>
            </div>
            <!-- Rest of your existing settings content -->
            <div style="margin-top: 30px;">
                <button class="overlay-open-btn" id="openDBTOverlay">Cheat Sheet</button>
            </div>
    
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px;">Theme</h3>
                <button class="btn btn-secondary" onclick="toggleTheme()">Toggle Dark/Light Mode</button>
            </div>
        </div>
        
        <div class="notification" id="notification"></div>
        <!-- Overlay -->
        <div id="dbtDefinitionsOverlay" class="overlay">
          <div class="overlay-content">
            <!-- Close Button -->
            <button id="closeDBTDefinitions" class="overlay-close-btn">&times; Close</button>
        
            <!-- DBT Section -->
            <h2>üåÄ DBT Definitions</h2>
            <ul>
              <li>üßò <strong>Mindfulness:</strong> Staying present in the moment, non-judgmentally.</li>
              <li>üî• <strong>Distress Tolerance:</strong> Surviving crises without making them worse.</li>
              <li>üé≠ <strong>Emotion Regulation:</strong> Understanding and managing intense emotions.</li>
              <li>ü§ù <strong>Interpersonal Effectiveness:</strong> Balancing your needs with others while maintaining relationships.</li>
            </ul>
        
            <!-- CBT Section -->
            <h2>üß† CBT Definitions</h2>
            <ul>
              <li>üîç <strong>Cognitive Distortions:</strong> Biased ways of thinking (e.g., all-or-nothing thinking).</li>
              <li>üìù <strong>Thought Records:</strong> Tracking situations, thoughts, feelings, and evidence for/against beliefs.</li>
              <li>üèÉ <strong>Behavioral Activation:</strong> Increasing activities that boost mood and motivation.</li>
              <li>‚ö° <strong>Exposure:</strong> Gradually facing fears to reduce avoidance.</li>
            </ul>
        
            <!-- Mental Health Tips Section -->
            <h2>üí° Mental Health Tips & Tricks</h2>
            <ul>
              <li>üå¨Ô∏è Use <strong>box breathing</strong>: inhale 4s, hold 4s, exhale 4s, hold 4s.</li>
              <li>üå≥ Practice <strong>grounding</strong> with ‚Äú5-4-3-2-1‚Äù senses technique.</li>
              <li>üìñ <strong>Journal daily</strong> for self-reflection and thought awareness.</li>
              <li>üèÉ‚Äç‚ôÇÔ∏è <strong>Movement:</strong> even a 10-minute walk reduces stress and clears the mind.</li>
              <li>üíñ <strong>Self-validation:</strong> remind yourself that your feelings make sense in context.</li>
            </ul>
          </div>
        </div>
        

    <script>
        // Application State
        const appState = {
        jerry: {},
        apiKey: localStorage.getItem('hush_api_key') || '',
        currentTab: 'jerry',
        checkinData: {},
        cbtData: {},
        dbtData: {},
        chatHistory: [],
        entries: JSON.parse(localStorage.getItem('hush_entries') || '[]'),
        conversationHistory: JSON.parse(localStorage.getItem('hush_conversations') || '[]'),
        botName: localStorage.getItem('botName') || 'Jerry', // default
        timer: {
                active: false,
                remaining: 180,
                interval: null
        },
        spriteTheme: localStorage.getItem('spriteTheme') || 'default',
        };
        const subscriptionState = {
        isSubscribed: localStorage.getItem('jerry_subscription_active') === 'true',
        subscriptionId: localStorage.getItem('jerry_subscription_id') || null,
        messageCount: parseInt(localStorage.getItem('jerry_message_count') || '0'),
        billingCycle: localStorage.getItem('jerry_billing_cycle') || null,
        apiOption: localStorage.getItem('jerry_api_option') || 'own'
        };

        const PREMIUM_API_KEY = 'GITHUB_SECRET_PREMIUM_API_KEY';

        let currentSpriteStyle = localStorage.getItem('jerrySpriteStyle') || 'default';

        const jerrySprites = {
            default: [
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [3, 1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 0],
                [0, 0, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 3, 3, 0, 0],
                [0, 0, 0, 0, 3, 3, 3, 3, 3, 3, 3, 3, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],
            
            python: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,9,9,9,9,9,9,9,0,0,0,0,0],
                [0,0,0,0,0,9,3,3,3,3,3,3,8,9,0,0,0,0],
                [0,0,0,0,9,5,3,3,3,3,3,3,7,8,9,0,0,0],
                [0,0,0,9,3,3,3,3,9,3,3,3,3,7,8,9,0,0],
                [0,0,0,9,3,3,3,9,1,9,3,3,3,7,8,9,0,0],
                [0,0,0,9,3,3,9,1,1,1,9,3,3,7,8,9,0,0],
                [0,0,0,9,3,9,1,8,8,8,1,9,3,7,8,9,0,0],
                [0,0,0,9,3,9,1,8,9,8,1,9,3,7,8,9,0,0],
                [0,0,0,0,9,9,1,8,9,8,1,9,7,8,9,0,0,0],
                [0,0,0,0,9,9,1,8,8,8,1,9,8,9,9,0,0,0],
                [0,0,0,0,9,4,9,1,1,1,9,9,9,8,9,0,0,0],
                [0,0,0,0,9,7,9,9,1,9,9,7,9,9,0,0,0,0],
                [0,0,0,0,9,8,9,4,9,4,9,8,9,0,0,0,0,0],
                [0,0,0,0,0,9,9,7,9,7,9,9,0,0,0,0,0,0],
                [0,0,0,0,0,0,9,8,9,8,9,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,9,9,9,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,9,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
            
            cornelius: [ // Happy, energetic Jerry - lots of sparkles and bright energy
                [0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0],
                [0,0,0,2,2,2,0,0,0,2,2,2,0,0,0,0],
                [0,0,2,3,3,3,2,0,2,3,3,3,2,0,0,0],
                [0,2,3,4,4,4,3,2,3,4,4,4,3,2,0,0],
                [1,3,4,4,4,4,4,3,4,4,4,4,4,3,1,0],
                [0,3,4,4,4,4,4,3,4,4,4,4,4,3,0,0],
                [0,2,3,4,4,4,3,2,3,4,4,4,3,2,0,0],
                [0,0,2,3,3,3,2,1,2,3,3,3,2,0,0,0],
                [0,0,0,2,2,2,3,3,3,2,2,2,0,0,0,0],
                [0,1,0,0,3,3,4,4,4,3,3,0,0,1,0,0],
                [0,0,0,0,2,4,4,4,4,4,2,0,0,0,0,0],
                [0,0,0,0,0,3,4,4,4,3,0,0,0,0,0,0],
                [0,0,1,0,0,2,3,3,3,2,0,0,1,0,0,0],
                [0,0,0,0,0,0,2,2,2,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            scott: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,2,2,2,2,0,0,2,2,2,0,0,0,0],
                [0,0,2,3,3,3,3,2,2,3,3,3,2,0,0,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [2,3,3,4,4,4,3,3,3,4,4,4,3,3,2,0],
                [2,3,3,3,3,3,3,3,3,3,3,3,3,3,2,0],
                [2,3,3,3,3,3,3,3,3,3,3,3,3,3,2,0],
                [2,3,3,3,3,3,3,3,3,3,3,3,3,3,2,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [0,2,3,3,3,3,3,3,3,3,3,3,3,2,0,0],
                [0,0,2,3,3,3,3,3,3,3,3,3,2,0,0,0],
                [0,0,0,2,2,3,3,3,3,3,2,2,0,0,0,0],
                [0,0,0,0,0,2,2,2,2,2,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            xeno: [
                [0,0,0,0,2,2,2,0,0,2,2,2,0,0,0,0],
                [0,0,0,2,1,1,2,0,0,2,1,1,2,0,0,0],
                [0,0,2,1,4,4,1,0,0,1,4,4,1,2,0,0],
                [0,2,1,4,3,3,4,2,2,4,3,3,4,1,2,0],
                [2,1,4,3,0,1,3,1,1,3,1,0,3,4,1,2],
                [2,4,1,1,0,0,1,3,3,1,0,0,1,1,4,2],
                [2,4,1,0,0,1,0,1,1,0,1,0,0,1,4,2],
                [2,4,1,0,1,1,1,1,1,1,1,1,0,1,4,2],
                [2,4,1,0,0,1,0,1,1,0,1,0,0,1,4,2],
                [2,4,1,1,0,0,1,3,3,1,0,0,1,1,4,2],
                [2,1,4,3,0,1,3,1,1,3,1,0,3,4,1,2],
                [0,2,1,4,3,3,4,2,2,4,3,3,4,1,2,0],
                [0,0,2,1,4,4,1,0,0,1,4,4,1,2,0,0],
                [0,0,0,2,1,1,2,0,0,2,1,1,2,0,0,0],
                [0,0,0,0,2,2,2,0,0,2,2,2,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            nano: [
                [0,0,2,2,2,2,0,0,0,0,2,2,2,2,0,0],
                [0,2,1,1,3,1,2,0,0,2,1,3,1,1,2,0],
                [2,1,4,4,1,4,1,2,2,1,4,1,4,4,1,2],
                [2,4,1,1,0,1,1,4,4,1,1,0,1,1,4,2],
                [2,4,1,0,0,0,0,1,1,0,0,0,0,1,4,2],
                [2,4,1,0,1,1,1,1,1,1,1,1,0,1,4,2],
                [2,4,1,0,0,1,0,1,1,0,1,0,0,1,4,2],
                [2,4,1,1,0,0,0,1,1,0,0,0,1,1,4,2],
                [2,1,4,1,0,1,1,1,1,1,1,0,1,4,1,2],
                [0,2,1,4,1,4,1,2,2,1,4,1,4,1,2,0],
                [0,0,2,1,3,1,2,0,0,2,1,3,1,2,0,0],
                [0,0,0,2,2,2,0,0,0,0,2,2,2,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            astro: [ // A cosmic, starry Jerry with darker space theme
                [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
                [0,0,0,1,1,2,2,4,4,2,2,1,1,0,0,0],
                [0,0,1,2,4,3,2,1,1,2,3,4,2,1,0,0],
                [0,1,2,3,4,1,3,2,2,3,1,4,3,2,1,0],
                [0,1,2,4,1,2,1,3,3,1,2,1,4,2,1,0],
                [1,2,3,4,2,3,4,1,1,4,3,2,4,3,2,1],
                [1,2,4,1,3,2,4,0,0,4,2,3,1,4,2,1],
                [1,2,2,3,1,4,0,0,0,0,4,1,3,2,2,1],
                [1,2,4,1,3,2,4,0,0,4,2,3,1,4,2,1],
                [1,2,3,4,2,3,4,1,1,4,3,2,4,3,2,1],
                [0,1,2,4,1,2,1,3,3,1,2,1,4,2,1,0],
                [0,1,2,3,4,1,3,2,2,3,1,4,3,2,1,0],
                [0,0,1,2,4,3,2,1,1,2,3,4,2,1,0,0],
                [0,0,0,1,1,2,2,4,4,2,2,1,1,0,0,0],
                [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            castle: [
                [5,0,5,0,5,0,5,5,5,5,0,5,0,5,0,5],
                [5,5,5,5,5,5,7,7,7,7,5,5,5,5,5,5],
                [5,7,7,7,7,5,6,6,6,6,5,7,7,7,7,5],
                [5,7,6,6,7,5,5,5,5,5,5,7,6,6,7,5],
                [0,5,7,6,7,7,7,7,7,7,7,7,6,7,5,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,9,7,9,9,7,9,7,6,5,0,0],
                [0,0,5,6,7,7,7,7,7,7,7,7,6,5,0,0],
                [0,0,5,6,7,5,5,5,5,5,5,7,6,5,0,0],
                [0,0,5,6,7,7,6,6,6,6,7,7,6,5,0,0],
                [0,5,7,6,6,7,7,7,7,7,7,6,6,7,5,0],
                [0,5,7,5,5,5,6,6,6,6,5,5,5,7,5,0],
                [5,7,6,5,0,0,5,5,5,5,0,0,5,6,7,5]
            ],

            ember: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,1,1,2,2,0,0,2,2,1,1,0,0,0],
                [0,0,1,2,3,3,3,2,2,3,3,3,2,1,0,0],
                [0,1,2,3,3,4,4,3,3,4,4,3,3,2,1,0],
                [0,1,2,3,4,4,4,4,4,4,4,4,3,2,1,0],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [1,2,3,4,4,4,4,4,4,4,4,4,4,3,2,1],
                [0,1,2,3,4,4,4,4,4,4,4,4,3,2,1,0],
                [0,1,2,3,4,4,4,4,4,4,4,4,3,2,1,0],
                [0,0,1,2,3,4,4,4,4,4,4,3,2,1,0,0],
                [0,0,0,1,2,3,3,4,4,3,3,2,1,0,0,0],
                [0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0],
                [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],


            wisp: [
                [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,2,1,1,2,0,0,0,0,0,0],
                [0,0,0,0,0,2,1,4,4,1,2,0,0,0,0,0],
                [0,0,0,0,2,1,4,3,3,4,1,2,0,0,0,0],
                [0,0,0,2,1,4,4,1,1,4,4,1,2,0,0,0],
                [0,0,2,1,4,1,1,4,4,1,1,4,1,2,0,0],
                [0,2,1,4,1,1,1,1,1,1,1,1,4,1,2,0],
                [0,2,1,1,4,1,1,4,4,1,1,4,1,1,2,0],
                [0,0,2,1,1,4,4,1,1,4,4,1,1,2,0,0],
                [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
                [0,0,0,0,2,1,1,1,1,1,1,2,0,0,0,0],
                [0,0,0,0,0,2,1,1,1,1,2,0,0,0,0,0],
                [0,0,0,0,0,0,2,1,1,2,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            luna: [
                [0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0],
                [0,0,0,0,3,1,1,1,1,1,1,3,0,0,0,0],
                [0,0,0,3,1,1,2,1,1,2,1,1,3,0,0,0],
                [0,0,3,1,1,2,1,4,4,1,2,1,1,3,0,0],
                [0,3,1,1,2,1,4,4,4,4,1,2,1,1,3,0],
                [0,3,1,2,1,4,4,4,4,4,4,1,2,1,3,0],
                [3,1,1,2,4,4,4,4,4,4,4,4,1,2,1,3],
                [3,1,2,1,4,4,4,4,4,4,4,4,1,2,1,3],
                [3,1,1,2,1,4,4,4,4,4,4,1,2,1,1,3],
                [0,3,1,1,2,1,4,4,4,4,1,2,1,1,3,0],
                [0,3,1,1,1,2,1,1,1,1,2,1,1,1,3,0],
                [0,0,3,1,1,1,2,2,2,2,1,1,1,3,0,0],
                [0,0,0,3,1,1,1,1,1,1,1,1,3,0,0,0],
                [0,0,0,0,3,3,3,2,2,3,3,3,0,0,0,0],
                [0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            matrix: [
                [0,0,0,0,0,0,2,2,2,2,0,0,0,0,0,0],
                [0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0],
                [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
                [0,0,2,1,1,1,3,1,1,3,1,1,1,2,0,0],
                [0,2,1,1,3,3,3,3,3,3,3,3,1,1,2,0],
                [2,1,1,3,3,3,4,4,4,4,3,3,3,1,1,2],
                [2,1,3,3,4,4,4,1,1,4,4,4,3,3,1,2],
                [2,1,3,4,4,1,1,3,3,1,1,4,4,3,1,2],
                [2,1,3,4,1,3,3,3,3,3,3,1,4,3,1,2],
                [2,1,3,4,1,3,3,3,3,3,3,1,4,3,1,2],
                [2,1,3,4,4,1,1,3,3,1,1,4,4,3,1,2],
                [2,1,1,3,3,3,4,4,4,4,3,3,3,1,1,2],
                [0,2,1,1,3,3,3,3,3,3,3,3,1,1,2,0],
                [0,0,2,1,1,1,3,1,1,3,1,1,1,2,0,0],
                [0,0,0,2,1,1,1,1,1,1,1,1,2,0,0,0],
                [0,0,0,0,2,2,1,1,1,1,2,2,0,0,0,0]
            ],

            sassy: [
                [0, 0, 0, 0, 0, 0, 9, 9, 9, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 9, 1, 1, 1, 1, 9, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0, 0],
                [0, 0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0, 0],
                [0, 0, 0, 0, 9, 9, 9, 1, 1, 9, 9, 9, 0, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 9, 1, 1, 9, 1, 1, 9, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 1, 9, 9, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 9, 1, 9, 1, 1, 1, 1, 1, 1, 9, 1, 9, 0, 0],
                [0, 9, 1, 1, 1, 9, 1, 9, 9, 1, 9, 1, 1, 1, 9, 0],
                [0, 9, 1, 1, 1, 9, 9, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0],
                [0, 9, 1, 9, 1, 1, 1, 9, 1, 1, 1, 1, 9, 1, 9, 0],
                [0, 9, 1, 9, 1, 1, 1, 9, 9, 1, 1, 1, 9, 1, 9, 0],
                [0, 9, 1, 1, 9, 1, 1, 1, 1, 1, 1, 9, 1, 1, 9, 0]
            ],

            bramble: [
                [0,0,0,0,1,1,2,2,2,1,1,0,0,0,0,0],
                [0,0,0,1,2,3,4,4,4,3,2,1,0,0,0,0],
                [0,0,1,2,4,5,6,6,6,5,4,2,1,0,0,0],
                [0,1,2,4,5,6,6,6,6,6,5,4,2,1,0,0],
                [0,2,3,5,6,6,6,6,6,6,6,5,3,2,0,0],
                [0,2,4,5,6,6,6,6,6,6,6,5,4,2,0,0],
                [0,2,4,5,6,6,6,6,6,6,6,5,4,2,0,0],
                [0,1,3,4,5,6,6,6,6,6,5,4,3,1,0,0],
                [0,1,2,3,4,5,6,6,6,5,4,3,2,1,0,0],
                [0,0,1,2,3,4,5,5,5,4,3,2,1,0,0,0],
                [0,0,0,1,2,3,4,4,4,3,2,1,0,0,0,0],
                [0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
                [0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0],
                [0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            apples: [
                [0,0,0,8,10,10,10,8,10,10,9,9,0,0,0,0],
                [0,0,8,9,8,9,8,9,9,5,9,8,9,0,0,0],
                [0,10,9,5,9,9,9,9,9,9,9,9,9,9,0,0],
                [0,8,9,9,5,9,8,10,10,5,9,9,8,5,10,0],
                [0,10,9,9,9,9,9,5,9,9,9,10,10,10,8,0],
                [0,10,8,5,10,9,9,9,9,8,9,5,10,10,10,0],
                [0,0,10,8,10,10,10,10,10,10,10,10,8,10,0,0],
                [0,0,10,10,10,10,9,0,9,7,10,8,10,0,0,0],
                [0,0,0,0,3,0,0,0,0,7,0,7,0,0,0,0],
                [0,0,0,0,3,4,4,6,6,7,7,7,0,0,0,0],
                [0,0,0,0,0,3,4,4,0,7,7,0,0,0,0,0],
                [0,0,0,0,0,0,4,4,0,7,0,0,0,0,0,0],
                [0,0,0,0,0,0,4,4,6,7,0,0,0,0,0,0],
                [0,0,0,0,0,3,4,4,6,6,7,0,0,0,0,0],
                [0,0,0,0,3,4,4,6,6,6,6,7,0,0,0,0],
                [0,0,0,3,4,0,0,6,0,0,0,6,7,0,0,0]
            ],

            earthy: [
                [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0],
                [0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0],
                [0,0,0,1,2,3,3,4,4,3,3,2,1,0,0,0],
                [0,0,1,2,3,4,4,5,5,4,4,3,2,1,0,0],
                [0,0,1,3,4,5,5,6,6,5,5,4,3,1,0,0],
                [0,1,2,3,5,6,2,6,6,2,6,5,3,2,1,0],
                [0,1,2,3,5,6,6,5,5,6,6,5,3,2,1,0],
                [1,2,3,4,5,6,5,4,4,5,6,5,4,3,2,1],
                [1,2,3,4,5,6,5,4,4,5,6,5,4,3,2,1],
                [0,1,2,3,5,6,6,5,5,6,6,5,3,2,1,0],
                [0,1,2,3,5,6,2,6,6,2,6,5,3,2,1,0],
                [0,0,1,3,4,5,5,6,6,5,5,4,3,1,0,0],
                [0,0,1,2,3,4,4,5,5,4,4,3,2,1,0,0],
                [0,0,0,1,2,3,3,4,4,3,3,2,1,0,0,0],
                [0,0,0,0,1,2,2,3,3,2,2,1,0,0,0,0],
                [0,0,0,0,0,1,1,2,2,1,1,0,0,0,0,0]
            ],

            drago: [
                [0,9,9,9,0,9,9,9,0,0,0,0,0,0,0,0],
                [9,9,4,9,0,9,4,9,9,0,0,0,0,0,0,0],
                [9,4,4,9,9,9,4,4,9,9,0,0,0,0,0,0],
                [9,9,4,4,4,4,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,9,9,9,0,0,0,0,0],
                [9,4,4,4,4,4,4,4,9,7,9,0,0,0,0,0],
                [9,9,4,9,4,4,4,9,9,7,9,0,0,0,0,0],
                [9,4,4,4,4,4,9,9,1,9,7,9,0,9,0,0],
                [0,9,9,9,9,9,1,9,1,1,9,7,9,4,9,0],
                [0,0,9,1,1,1,9,1,1,1,1,9,9,4,9,0],
                [0,9,1,4,1,9,1,1,1,1,1,4,4,9,0,0],
                [0,9,9,4,4,9,9,1,9,4,4,4,9,0,0,0],
                [0,0,0,9,4,4,4,9,0,9,9,9,0,0,0,0],
                [0,0,0,0,9,9,9,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            egg: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,9,9,9,9,9,0,0,0,0,0,0],
                [0,0,0,0,9,1,1,2,2,2,9,0,0,0,0,0],
                [0,0,0,9,1,1,1,2,2,2,3,9,0,0,0,0],
                [0,0,9,1,1,1,1,2,2,3,3,3,9,0,0,0],
                [0,0,9,1,1,1,2,2,2,3,3,3,9,0,0,0],
                [0,9,1,1,1,2,2,2,3,3,3,3,4,9,0,0],
                [9,2,2,2,2,2,2,2,3,3,3,3,4,4,9,0],
                [9,2,2,2,2,2,2,3,3,3,3,3,4,4,9,0],
                [9,2,2,2,2,3,3,3,3,3,3,4,4,4,9,0],
                [9,2,2,2,3,3,3,3,3,4,4,4,4,4,9,0],
                [0,9,2,3,3,3,3,3,4,4,4,4,4,9,0,0],
                [0,9,3,3,3,3,4,4,4,4,4,4,4,9,0,0],
                [0,0,9,9,3,4,4,4,4,4,4,9,9,0,0,0],
                [0,0,0,0,9,9,9,9,9,9,9,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            glyphton: [
                [9,9,1,3,5,7,9,9,9,9,7,5,3,1,9,9],
                [9,9,1,3,5,7,9,1,1,9,7,5,3,1,9,9],
                [1,1,9,3,5,7,9,1,1,9,7,5,3,9,1,1],
                [3,3,3,9,7,9,1,1,1,1,9,7,9,3,3,3],
                [5,5,5,7,9,1,0,0,0,0,1,9,7,5,5,5],
                [7,7,7,9,1,9,3,3,3,3,9,1,9,7,7,7],
                [9,9,9,1,0,3,9,0,0,9,3,0,1,9,9,9],
                [9,1,1,1,0,3,0,9,9,0,3,0,1,1,1,9],
                [9,1,1,1,0,3,0,9,9,0,3,0,1,1,1,9],
                [9,9,9,1,0,3,9,0,0,9,3,0,1,9,9,9],
                [7,7,7,9,1,9,3,3,3,3,9,1,9,7,7,7],
                [5,5,5,7,9,1,0,0,0,0,1,9,7,5,5,5],
                [3,3,3,9,7,9,1,1,1,1,9,7,9,3,3,3],
                [1,1,9,3,5,7,9,1,1,9,7,5,3,9,1,1],
                [9,9,1,3,5,7,9,1,1,9,7,5,3,1,9,9],
                [9,9,1,3,5,7,9,9,9,9,7,5,3,1,9,9]
            ],

            lilguy: [
                [0,0,0,10,10,10,10,0,0,0,0,0,0,0,0,0],
                [0,0,10,1,1,10,7,10,0,0,0,0,0,0,0,0],
                [0,10,1,1,1,1,10,7,10,10,0,0,0,0,0,0],
                [0,1,5,5,1,1,10,7,7,7,10,0,0,0,0,0],
                [0,5,1,10,5,1,1,10,7,7,10,0,0,0,0,0],
                [0,5,10,10,5,1,1,10,7,7,10,0,0,0,0,0],
                [0,1,5,5,1,1,10,7,7,7,10,0,0,0,0,0],
                [0,10,1,1,1,1,10,7,10,10,0,0,0,0,0,0],
                [0,0,10,1,1,10,7,10,7,7,10,10,10,0,0,0],
                [0,0,0,10,10,10,10,0,10,7,7,7,10,0,0,0],
                [0,0,0,0,0,0,0,0,0,10,10,7,10,10,0,0],
                [0,0,0,0,0,0,0,0,10,7,7,10,7,7,10,0],
                [0,0,0,0,0,0,0,10,7,10,10,0,10,10,7,10],
                [0,0,0,0,0,0,0,10,7,10,0,0,0,10,7,10],
                [0,0,0,0,0,0,0,10,7,10,0,0,0,10,7,10],
                [0,0,0,0,0,0,0,0,10,0,0,0,0,0,10,0]
            ],
        };
            


        const affirmations = [
        "Your feelings are valid, even the difficult ones.",
        "Be kind and patient with yourself today.",
        "Each breath is a new, gentle beginning.",
        "It's okay to rest; you are doing enough.",
        "You are resilient, and you can get through this moment.",
        "Allow yourself to simply be, without judgment."
        ];

        // Utility Functions
        function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification show ${type}`;
        setTimeout(() => {
                notification.classList.remove('show');
        }, 3000);
        }

        function saveToLocalStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
        }

        function getFromLocalStorage(key, defaultValue = null) {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : defaultValue;
        }

        // POSITION RADIAL MENU ITEMS
        function positionRadialMenu() {
            const items = document.querySelectorAll('.radial-item');
            const radius = 130;
            const centerX = 160;
            const centerY = 160;
            const angleStep = (2 * Math.PI) / items.length;

            items.forEach((item, index) => {
                const angle = index * angleStep - Math.PI / 2; // start at top
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                item.style.left = `${x}px`;
                item.style.top = `${y}px`;
                item.style.transform = 'translate(-50%, -50%)';
            });
        }

        window.addEventListener('DOMContentLoaded', positionRadialMenu);
        window.addEventListener('resize', positionRadialMenu);

        // ELEMENT REFERENCES
        const menuTrigger = document.getElementById('menuTrigger');
        const radialMenu = document.getElementById('radialMenuApp');
        const radialOverlay = document.getElementById('radialMenuOverlay'); // <div id="radialMenuOverlay"></div>

        // TOGGLE RADIAL MENU
        menuTrigger.addEventListener('click', () => {
            const isOpen = radialMenu.classList.toggle('open');
            radialOverlay.classList.toggle('active', isOpen);
        });

        // CLOSE MENU WHEN CLICKING OUTSIDE (overlay)
        radialOverlay.addEventListener('click', () => {
            radialMenu.classList.remove('open');
            radialOverlay.classList.remove('active');
        });
        

        // UPDATED SWITCH TAB FUNCTION
        function switchTab(tabName, event) {
            // Update active state
            document.querySelectorAll('.radial-item').forEach(item => item.classList.remove('active'));
            if (event && event.currentTarget) event.currentTarget.classList.add('active');

            // Switch screens
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Custom tab-specific logic
            if (typeof updateAffirmationBanner === 'function') updateAffirmationBanner(tabName);
            if (tabName === 'entries' && typeof loadEntries === 'function') loadEntries();
            else if (tabName === 'history' && typeof loadHistory === 'function') loadHistory();
            else if (tabName === 'settings' && typeof loadSettings === 'function') loadSettings();

            // Close menu + overlay after selecting
            radialMenu.classList.remove('open');
            radialOverlay.classList.remove('active');
        }

        function updateAffirmationBanner(screenName) {
        const banner = document.getElementById('affirmationBanner');
        if (screenName === 'jerry' || screenName === 'checkin') {
                banner.textContent = affirmations[Math.floor(Math.random() * affirmations.length)];
        } else {
                banner.textContent = '';
        }
        }

        // Function to update bot name
        function setBotName(newName) {
        appState.botName = newName.trim() || 'Jerry';
        localStorage.setItem('botName', appState.botName);
        }

        // Real-time Jerry Needs Decay
        const NEEDS_TICK_INTERVAL = 500; // 500 ms

        function updateJerryNeeds() {
            const now = Date.now();
            const decayRates = { clarity: 6, insight: 24, calm: 12 }; // hours to fully deplete
            const gracePeriod = 10 * 60 * 1000; // 10 minutes

            Object.keys(appState.jerry.needs).forEach(need => {
                const lastFed = appState.jerry.lastFed[need] || now;
                const elapsedSinceLastFed = now - lastFed - gracePeriod;
                const totalDecayMs = decayRates[need] * 60 * 60 * 1000;

                // Only decay if past grace period
                if (elapsedSinceLastFed > 0) {
                    appState.jerry.needs[need] = Math.max(0, 100 - (elapsedSinceLastFed / totalDecayMs) * 100);
                } else {
                    appState.jerry.needs[need] = 100; // still in grace period
                }
            });

            // Track mood
            const minNeed = Math.min(...Object.values(appState.jerry.needs));
            let newMood = 'content';
            if (minNeed < 50) {
                if (appState.jerry.needs.insight === minNeed) newMood = 'lowInsight';
                else if (appState.jerry.needs.calm === minNeed) newMood = 'lowCalm';
            }
            currentMood = newMood;

            updateJerryUI();
            saveJerryState();
        }

        function initializeJerryDecay() {
            setInterval(updateJerryNeeds, NEEDS_TICK_INTERVAL);
        }
            

        function feedJerry(need, amount = 50) {
        appState.jerry.needs[need] = Math.min(100, appState.jerry.needs[need] + amount);
        appState.jerry.lastFed[need] = Date.now();
        addXP(20);
        saveJerryState();
        updateJerryUI();
        }

        function feedAllJerry(amount) {
            ['clarity', 'insight', 'calm'].forEach(need => feedJerry(need, amount));
        }


        function addXP(amount) {
        appState.jerry.xp += amount;
        if (appState.jerry.xp >= appState.jerry.xpToNext) {
                levelUp();
        }
        saveJerryState();
        updateJerryUI();
        }

        function levelUp() {
        appState.jerry.level++;
        appState.jerry.xp -= appState.jerry.xpToNext;
        appState.jerry.xpToNext = Math.floor(appState.jerry.xpToNext * 1.5);
        showNotification(`Jerry leveled up! Now level ${appState.jerry.level}!`);
        }

        function updateJerryUI() {
        // Update progress bars
        document.getElementById('clarityBar').style.width = `${appState.jerry.needs.clarity}%`;
        document.getElementById('insightBar').style.width = `${appState.jerry.needs.insight}%`;
        document.getElementById('calmBar').style.width = `${appState.jerry.needs.calm}%`;

        // Update text values
        document.getElementById('clarityValue').textContent = `${Math.round(appState.jerry.needs.clarity)}%`;
        document.getElementById('insightValue').textContent = `${Math.round(appState.jerry.needs.insight)}%`;
        document.getElementById('calmValue').textContent = `${Math.round(appState.jerry.needs.calm)}%`;

        // Update level and XP
        document.getElementById('levelLabel').textContent = `Level ${appState.jerry.level}`;
        document.getElementById('xpLabel').textContent = `XP: ${appState.jerry.xp} / ${appState.jerry.xpToNext}`;

        // Update Jerry sprite based on needs
        updateJerrySprite();
        }

        // =====================
        // Update Jerry Sprite
        // =====================
        function updateJerrySprite() {
            try {
                // Fetch saved values from localStorage
                const savedSpriteStyle = localStorage.getItem('jerryCurrentSprite');
                const savedTheme = localStorage.getItem('spriteTheme');

                // Detect light/dark mode
                const isLightMode = document.body.classList.contains('light-theme');
                const colorSets = getColorSets(isLightMode);

                // Resolve sprite style safely
                const currentSpriteStyle = jerrySprites[savedSpriteStyle]
                    ? savedSpriteStyle
                    : Object.keys(jerrySprites)[0]; // first sprite if saved one missing

                // Resolve theme safely
                const spriteTheme = colorSets[savedTheme]
                    ? savedTheme
                    : Object.keys(colorSets)[0]; // first available theme

                // Get sprite data
                let spriteData = jerrySprites[currentSpriteStyle];
                if (!Array.isArray(spriteData) || !Array.isArray(spriteData[0])) {
                    console.warn('Invalid Jerry sprite data, falling back to first sprite');
                    spriteData = jerrySprites[Object.keys(jerrySprites)[0]];
                }

                // Clone sprite data
                baseSprite = JSON.parse(JSON.stringify(spriteData));
                
                // Get colors for the theme
                const colors = colorSets[spriteTheme];

                // Render sprite and preview
                if (typeof renderJerrySprite === 'function') renderJerrySprite(baseSprite, spriteTheme);
                if (typeof renderSpritePreview === 'function') renderSpritePreview(baseSprite, spriteTheme);

                // Persist selections
                localStorage.setItem('jerryCurrentSprite', currentSpriteStyle);
                localStorage.setItem('spriteTheme', spriteTheme);

                // Sync app state
                appState.jerry.currentSprite = currentSpriteStyle;
                appState.spriteTheme = spriteTheme;

                // Sync dropdown (if exists)
                const spriteSelect = document.getElementById('spriteStyle');
                if (spriteSelect) spriteSelect.value = currentSpriteStyle;
                const themeSelect = document.getElementById('spriteTheme');
                if (themeSelect) themeSelect.value = spriteTheme;

            } catch (err) {
                console.error('Failed to update Jerry sprite:', err);
                fallbackJerry();
            }
        }

        // =====================
        // Fallback
        // =====================
        function fallbackJerry() {
            const firstSprite = Object.keys(jerrySprites)[0];
            baseSprite = JSON.parse(JSON.stringify(jerrySprites[firstSprite]));

            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            const firstTheme = Object.keys(colorSets)[0];
            const colors = colorSets[firstTheme];

            if (typeof renderJerrySprite === 'function') renderJerrySprite(baseSprite, spriteTheme);
            if (typeof renderSpritePreview === 'function') renderSpritePreview(baseSprite, spriteTheme);

            appState.jerry.currentSprite = firstSprite;
            appState.spriteTheme = firstTheme;

            localStorage.setItem('jerryCurrentSprite', firstSprite);
            localStorage.setItem('spriteTheme', firstTheme);

            // Sync dropdowns
            const spriteSelect = document.getElementById('spriteStyle');
            if (spriteSelect) spriteSelect.value = firstSprite
                const themeSelect = document.getElementById('spriteTheme');
            if (themeSelect) themeSelect.value = firstTheme;
        }

        // =====================
        // Dropdown Event Listeners
        // =====================
        const spriteSelect = document.getElementById('spriteStyle');
        if (spriteSelect) {
            spriteSelect.addEventListener('change', e => {
                const selected = e.target.value;
                localStorage.setItem('jerryCurrentSprite', selected);
                updateJerrySprite();
            });
        }

        const themeSelect = document.getElementById('spriteTheme');
        if (themeSelect) {
            themeSelect.addEventListener('change', e => {
                const selected = e.target.value;
                localStorage.setItem('spriteTheme', selected);
                updateJerrySprite();
            });
        }

        // =====================
        // Initialize on page load
        // =====================
        document.addEventListener('DOMContentLoaded', () => {
            updateJerrySprite();
        });



        function getColorSets(isLightMode) {
            return {
                default: isLightMode
                    ? {
                        0: 'transparent',
                        1: '#FFF2E0', 2: '#FFE0B3', 3: '#FFD8A6',
                        4: '#FFCB88', 5: '#E6B273', 6: '#C4945E',
                        7: '#A9745B', 8: '#8B5E3C', 9: '#6B4226', 10: '#4A2B17'
                    }
                    : {
                        0: 'transparent',
                        1: '#E0ECFA', 2: '#C2DAF7', 3: '#9CC7F0',
                        4: '#6FA6E0', 5: '#4A90E2', 6: '#2B6FB2',
                        7: '#1F5FBF', 8: '#173F80', 9: '#0D264D', 10: '#08162B'
                    },

                candy: isLightMode
                    ? {0: 'transparent', 1: '#FF6B6B', 2: '#FFA94D', 3: '#FFD93D', 4: '#6BCB77', 5: '#4D96FF', 6: '#9D4EDD', 7: '#FF8FAB', 8: '#FFB5E8', 9: '#FFDEE9', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#FF8787', 2: '#FFB86B', 3: '#FFE066', 4: '#8CE99A', 5: '#74C0FC', 6: '#B197FC', 7: '#FF99C8', 8: '#FFB3DE', 9: '#FFC2E5', 10: '#F8F9FA'},
                ocean: isLightMode
                    ? {0: 'transparent', 1: '#A2D2FF', 2: '#80C0FF', 3: '#5AA9FA', 4: '#4682B4', 5: '#2E5984', 6: '#1B3B5F', 7: '#0F2A44', 8: '#082136', 9: '#041626', 10: '#000814'}
                    : {0: 'transparent', 1: '#90C8F8', 2: '#66AEEF', 3: '#3D91E0', 4: '#2E6FA3', 5: '#1D4E72', 6: '#103552', 7: '#0A2438', 8: '#061C2B', 9: '#03111B', 10: '#000814'},
                ember: isLightMode
                    ? {0: 'transparent', 1: '#FFF3B0', 2: '#FFD93D', 3: '#FFA200', 4: '#FF6B35', 5: '#E63946', 6: '#B51709', 7: '#800F00', 8: '#4D0600', 9: '#260300', 10: '#0D0000'}
                    : {0: 'transparent', 1: '#FFE066', 2: '#FFC300', 3: '#FF8C00', 4: '#FF5733', 5: '#C70039', 6: '#900C3F', 7: '#581845', 8: '#2C0B27', 9: '#160513', 10: '#0B0208'},
                meadow: isLightMode
                    ? {0: 'transparent', 1: '#E0F7E9', 2: '#B2F2BB', 3: '#8CE99A', 4: '#69DB7C', 5: '#38D9A9', 6: '#20C997', 7: '#12B886', 8: '#0CA678', 9: '#087F5B', 10: '#045040'}
                    : {0: 'transparent', 1: '#C3F5D5', 2: '#96E6A8', 3: '#70D78B', 4: '#4CB372', 5: '#31A67F', 6: '#24916B', 7: '#1A7257', 8: '#115745', 9: '#0A3A2D', 10: '#041E16'},
                neon: isLightMode
                    ? {0: 'transparent', 1: '#FF00FF', 2: '#FF1493', 3: '#FF4500', 4: '#FFD700', 5: '#ADFF2F', 6: '#00FF7F', 7: '#00FFFF', 8: '#1E90FF', 9: '#8A2BE2', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#FF4DFF', 2: '#FF69B4', 3: '#FF6347', 4: '#FFE066', 5: '#C0FF66', 6: '#66FFB2', 7: '#66FFFF', 8: '#66A3FF', 9: '#B266FF', 10: '#F8F9FA'},
                pastel: isLightMode
                    ? {0: 'transparent', 1: '#FFB5E8', 2: '#FFDEB4', 3: '#FFF5BA', 4: '#B5EAD7', 5: '#C7CEEA', 6: '#E0BBE4', 7: '#FEC8D8', 8: '#D8E2DC', 9: '#F1F0C0', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#FF99CC', 2: '#FFCC99', 3: '#FFF2A8', 4: '#99E2C3', 5: '#A8B9E6', 6: '#C7A9D6', 7: '#F5A3C7', 8: '#CFCFCF', 9: '#EAE6B8', 10: '#F8F9FA'},
                gothic: isLightMode
                    ? {0: 'transparent', 1: '#1A1A1A', 2: '#2E2E2E', 3: '#444444', 4: '#5E2750', 5: '#87255B', 6: '#D90368', 7: '#FF6F61', 8: '#C9ADA7', 9: '#EAEAEA', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#000000', 2: '#1A1A1A', 3: '#333333', 4: '#5E2750', 5: '#7A1E48', 6: '#B30C5C', 7: '#FF4F5E', 8: '#A99A93', 9: '#D6D6D6', 10: '#F5F5F5'},
                aurora: isLightMode
                    ? {0: 'transparent', 1: '#A5FFD6', 2: '#82FFC7', 3: '#5DFDCB', 4: '#3EDBF0', 5: '#3B9AE1', 6: '#6F69AC', 7: '#9D4EDD', 8: '#FF5D8F', 9: '#FF87AB', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#7DFFBF', 2: '#5AF7B0', 3: '#32E1B5', 4: '#1EB7D8', 5: '#2070B0', 6: '#514080', 7: '#7A29C6', 8: '#FF4D7A', 9: '#FF6F9F', 10: '#F8F9FA'},
                retroPixel: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#FFD800', 3: '#FF8C00', 4: '#FF0000', 5: '#C000C0', 6: '#0000FF', 7: '#008080', 8: '#00C000', 9: '#404040', 10: '#000000'}
                    : {0: 'transparent', 1: '#E0E0E0', 2: '#E0C000', 3: '#D07000', 4: '#C00000', 5: '#A000A0', 6: '#0000A0', 7: '#006060', 8: '#00A000', 9: '#303030', 10: '#000000'},
                fantasySprite: isLightMode
                    ? {0: 'transparent', 1: '#F0EAD6', 2: '#C2B280', 3: '#8E735B', 4: '#5C4B3B', 5: '#3B2F2F', 6: '#6B8E23', 7: '#4682B4', 8: '#9370DB', 9: '#FFD700', 10: '#000000'}
                    : {0: 'transparent', 1: '#D8D2BE', 2: '#A89C6E', 3: '#6E5B45', 4: '#44362C', 5: '#2C2222', 6: '#556B2F', 7: '#36648B', 8: '#7A5DC7', 9: '#E6C200', 10: '#000000'},
            };
        }

        // Fixed rendering functions to accept and use parameters
        function renderJerrySprite(spriteData, spriteTheme) {
            if (!spriteData) return;
            const container = document.getElementById('jerrySprite');
            container.innerHTML = '';

            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            const colors = colorSets[spriteTheme] || colorSets['default'];

            spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                    if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.position = 'absolute';
                        pixelDiv.style.width = '10px';
                        pixelDiv.style.height = '10px';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        pixelDiv.style.pointerEvents = 'none';
                        container.appendChild(pixelDiv);
                    }
                });
            });
        }

        function renderSpritePreview(spriteData, spriteTheme) {
            if (!spriteData) return;
            const previewContainer = document.getElementById('spritePreview');
            previewContainer.innerHTML = '';
        
            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            const colors = colorSets[spriteTheme] || colorSets['default'];
        
            const rows = spriteData.length;
            const cols = spriteData[0].length;
        
            // Base pixel size for preview
            let pixelSize = 10;
        
            // Max container size
            const maxWidth = 160;
            const maxHeight = 160;
        
            // Only scale down if sprite is too large
            if (cols * pixelSize > maxWidth || rows * pixelSize > maxHeight) {
                pixelSize = Math.floor(Math.min(maxWidth / cols, maxHeight / rows));
            }
        
            previewContainer.style.width = `${cols * pixelSize}px`;
            previewContainer.style.height = `${rows * pixelSize}px`;
            previewContainer.style.position = 'relative';
            previewContainer.style.background = 'transparent';
        
            spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                    if (pixel > 0) {
                        const px = document.createElement('div');
                        px.className = 'pixel';
                        px.style.position = 'absolute';
                        px.style.width = `${pixelSize}px`;
                        px.style.height = `${pixelSize}px`;
                        px.style.backgroundColor = colors[pixel];
                        px.style.left = `${x * pixelSize}px`;
                        px.style.top = `${y * pixelSize}px`;
                        px.style.pointerEvents = 'none';
                        previewContainer.appendChild(px);
                    }
                });
            });
        }


        // === Jerry Animation Controller ==
        const jerryContainer = document.getElementById('jerrySprite');

        
        let currentMood = "content";
        let jerryTalking = false;
        let tapActive = false; // is the tap animation running
        let breathTime = 0;
        let shakeOffset = 0;
        let shakeActive = false;

        
        // === Persistent base sprite (includes evolutions/mood) ===
        let baseSprite;


        // === Helper Functions ===
        function getCurrentSprite() {
        return baseSprite;
        }

        // Redraw Jerry sprite
        function drawJerry(spriteData = baseSprite, spriteTheme = appState.spriteTheme || 'default') {
            if (!spriteData) return;
            const container = document.getElementById('jerrySprite');
            container.innerHTML = '';

            const isLightMode = document.body.classList.contains('light-theme');
            const colorSets = getColorSets(isLightMode);
            const colors = colorSets[spriteTheme] || colorSets['default'];

            spriteData.forEach((row, y) => {
                row.forEach((pixel, x) => {
                    if (pixel > 0) {
                        const pixelDiv = document.createElement('div');
                        pixelDiv.className = 'pixel';
                        pixelDiv.style.position = 'absolute';
                        pixelDiv.style.width = '10px';
                        pixelDiv.style.height = '10px';
                        pixelDiv.style.backgroundColor = colors[pixel];
                        pixelDiv.style.left = `${x * 10}px`;
                        pixelDiv.style.top = `${y * 10}px`;
                        container.appendChild(pixelDiv);
                    }
                });
            });
        }

        // === Animations ===
        const blinkableSprites = ['cornelius', 'scott'];
        const blinkTargets = {
            4: [
                // Left eye block
                [4,4],[4,5],[4,6],
                [5,3],[5,4],[5,5],[5,6],[5,7],
                [6,3],[6,4],[6,5],[6,6],[6,7],
                [7,4],[7,5],[7,6],

                // Right eye block
                [4,10],[4,11],[4,12],
                [5,9],[5,10],[5,11],[5,12],[5,13],
                [6,9],[6,10],[6,11],[6,12],[6,13],
                [7,10],[7,11],[7,12],

                //Bottom eye block
                [10,7],[10,8],[10,9],
                [11,6],[11,7],[11,8],[11,9],[11,10],
                [12,7],[12,8],[12,9]
            ]
        };

        const BLINK_DURATION = 150; // 1/2 second

        function blinkJerry() {
            const currentSprite = getCurrentSprite();
            const spriteCopy = JSON.parse(JSON.stringify(currentSprite));

            const blinkPixels = blinkTargets[4]; // Use the full eye block
            blinkPixels.forEach(([r, c]) => {
                const newR = r - 1;
                const newC = c - 1;
                if (spriteCopy[newR] && spriteCopy[newR][newC] !== undefined) {
                    spriteCopy[newR][newC] = 3; // blink color
                }
            });

            drawJerry(spriteCopy);

            setTimeout(() => {
                drawJerry(currentSprite);
            }, BLINK_DURATION);
        }

        
        // Breathing (brightness + scale)
        function breatheJerry() {
            breathTime += 0.05;
            const brightness = 1 + 0.1 * Math.sin(breathTime); // noticeable pulse
            const scale = 1 + 0.02 * Math.sin(breathTime);
            jerryContainer.style.filter = `brightness(${brightness})`;
            jerryContainer.style.transform = `scale(${scale})`;
        }

        // Mood switching
        function setMood(mood) {
            // Always use the currently selected sprite style, ignore mood variations
            const currentSpriteStyle = localStorage.getItem('jerrySpriteStyle') || 'default';
    
            if (jerrySprites[currentSpriteStyle]) {
                currentMood = mood; // track mood but don't change sprite
                baseSprite = JSON.parse(JSON.stringify(jerrySprites[currentSpriteStyle]));
                drawJerry(getCurrentSprite());
            }
        }

        // Talking animation
        async function jerryTalk(text) {
        jerryTalking = true;
        let frame = 0;
        const talkInterval = setInterval(() => {
                frame = 1 - frame;
                const sprite = JSON.parse(JSON.stringify(getCurrentSprite()));
                let mouth;
                switch (currentMood) {
                case 'content': mouth = [[6, 7], [6, 8]]; break;
                case 'lowInsight': mouth = [[5, 6], [5, 9]]; break;
                case 'lowCalm': mouth = [[4, 6], [4, 9]]; break;
                }
                mouth.forEach(([r, c]) => sprite[r][c] = frame ? 0 : 1);
                drawJerry(sprite);
        }, 200);

        await renderText(text); // your existing text rendering
        clearInterval(talkInterval);
        jerryTalking = false;
        drawJerry(getCurrentSprite());
        }

        //function evolveJerry(level) {
            //if (!jerryContainer) return;

            // Remove any existing halo
            //const oldHalo = document.getElementById('jerryHalo');
            //if (oldHalo) oldHalo.remove();

            //if (level >= 5) {
                // Create halo div
                //const halo = document.createElement('div');
                //halo.id = 'jerryHalo';
                // Minimal inline styles; CSS handles position, transform, and animation
                //halo.style.position = 'absolute';
                //halo.style.width = '40px';
                //halo.style.height = '8px';
                //halo.style.backgroundColor = 'gold';
                //halo.style.borderRadius = '50%';
                //halo.style.zIndex = '10';
                //jerryContainer.appendChild(halo);
            //}

            // Redraw Jerry sprite (sprite will be below the halo due to z-index)
            //drawJerry(getCurrentSprite());
        //}

        function triggerShake() {
            if (shakeActive || !jerryContainer) return; // Add jerryContainer check
            shakeActive = true;
            let i = 0;
            const shakeFrames = 10;
            const amplitude = 5;
            const interval = setInterval(() => {
                shakeOffset = (i % 2 === 0 ? amplitude : -amplitude);
                i++;
                if (i > shakeFrames) {
                    clearInterval(interval);
                    shakeOffset = 0;
                    shakeActive = false;
                }
            }, 30);
        }

        // Add safety check before adding event listener
        if (jerryContainer) {
            jerryContainer.addEventListener('click', triggerShake);
        }        

        function updateJerry() {
            // Safety check - exit if jerryContainer doesn't exist
            if (!jerryContainer) {
                console.warn('jerryContainer not found, stopping animation');
                return;
            }

            breathTime += 0.05;


            // Breathing scale
            const baseScale = 1 + 0.02 * Math.sin(breathTime);

            // Apply transform: shake + breathing
            jerryContainer.style.transform = `translateX(${shakeOffset}px) scale(${baseScale})`;

            // Animate halo (if it exists)
            const halo = document.getElementById('jerryHalo');
            if (halo) {
                const floatOffset = 2 * Math.sin(breathTime); // 2px up/down
                halo.style.top = `${-10 + floatOffset}px`;
            }

            requestAnimationFrame(updateJerry);
        }

        // Only start the animation loop if jerryContainer exists
        if (jerryContainer) {
            updateJerry();
            scheduleBlink();
        }

        function scheduleBlink() {
            if (!blinkableSprites.includes(appState.jerry.sprite)) return;
            
            const delay = 3000 + Math.random() * 3000; // 2‚Äì4 seconds
            setTimeout(() => {
                blinkJerry();
                scheduleBlink(); // repeat indefinitely
            }, delay);
        }

        function saveJerryState() {
            // Only ensure lastFed exists for undefined needs, don't overwrite existing timestamps
            if (!appState.jerry.lastFed) appState.jerry.lastFed = {};

            ['clarity', 'insight', 'calm'].forEach(need => {
                if (typeof appState.jerry.lastFed[need] === 'undefined') {
                    appState.jerry.lastFed[need] = Date.now();
                }
            });

            saveToLocalStorage('hush_jerry_state', appState.jerry);
        }

        function loadJerryState() {
            const defaultJerryState = {
                needs: { clarity: 100, insight: 100, calm: 100 },
                lastFed: { clarity: Date.now(), insight: Date.now(), calm: Date.now() },
                level: 1,
                xp: 0,
                xpToNext: 100,
                currentSprite: 'default'
            };

            const saved = getFromLocalStorage('hush_jerry_state');
            if (saved && saved.lastFed) {
                appState.jerry = { ...defaultJerryState, ...saved };
                appState.jerry.lastFed = { ...saved.lastFed }; // <‚Äî don‚Äôt mix with default lastFed
            } else {
                appState.jerry = defaultJerryState;
            }

            // Ensure lastFed exists for any missing needs
            ['clarity', 'insight', 'calm'].forEach(need => {
                if (typeof appState.jerry.lastFed[need] === 'undefined') {
                    appState.jerry.lastFed[need] = Date.now();
                }
            });

            // Apply immediate decay based on real elapsed time since lastFed
            const now = Date.now();
            const decayRates = { clarity: 6, insight: 24, calm: 12 }; // hours to fully deplete
            const gracePeriod = 10 * 60 * 1000; // 10 minutes

            Object.keys(appState.jerry.needs).forEach(need => {
                const elapsedSinceLastFed = Math.max(0, now - appState.jerry.lastFed[need] - gracePeriod);
                const totalDecayMs = decayRates[need] * 60 * 60 * 1000;
                appState.jerry.needs[need] = Math.max(0, 100 - (elapsedSinceLastFed / totalDecayMs) * 100);
            });
            updateJerryNeeds();
        }

        const petSprites = {
            miniJerry: [
                [0,0,2,2,2,2,0,0],
                [0,2,1,1,1,1,2,0],
                [2,1,0,0,0,0,1,2],
                [2,1,0,2,2,0,1,2],
                [2,1,0,0,0,0,1,2],
                [2,1,0,0,0,0,1,2],
                [0,2,1,1,1,1,2,0],
                [0,0,2,2,2,2,0,0]
            ],

            puff: [
                [0,0,3,3,3,3,0,0],
                [0,3,3,3,3,3,3,0],
                [3,3,0,3,3,0,3,3],
                [3,3,3,3,3,3,3,3],
                [3,3,3,0,0,3,3,3],
                [0,3,3,3,3,3,3,0],
                [0,0,3,3,3,3,0,0],
                [0,0,0,3,3,0,0,0]
            ],

            spark: [
                [0,0,2,0,0,2,0,0],
                [0,2,0,3,3,0,2,0],
                [2,0,3,4,4,3,0,2],
                [0,3,4,4,4,4,3,0],
                [0,3,4,4,4,4,3,0],
                [2,0,3,4,4,3,0,2],
                [0,2,0,3,3,0,2,0],
                [0,0,2,0,0,2,0,0]
            ],

            buddy: [
                [0, 0, 0, 9, 9, 9, 9, 9, 9, 9, 9, 9, 0, 0, 0, 0],
                [0, 0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0],
                [9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0],
                [9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0],
                [9, 1, 9, 9, 1, 1, 1, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [9, 1, 9, 9, 1, 1, 1, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [9, 1, 9, 9, 1, 1, 9, 1, 1, 9, 9, 1, 1, 1, 9, 0],
                [9, 1, 1, 1, 1, 9, 9, 9, 1, 1, 1, 1, 1, 1, 9, 0],
                [0, 9, 1, 1, 1, 9, 1, 9, 1, 1, 1, 1, 1, 9, 0, 0],
                [0, 9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 9, 0, 0, 0],
                [0, 0, 9, 9, 1, 1, 1, 1, 1, 1, 9, 9, 0, 0, 0, 0],
                [0, 0, 0, 9, 1, 9, 1, 9, 1, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 9, 1, 9, 1, 9, 1, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 9, 9, 9, 9, 9, 9, 9, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],

            orb: [
                [0,0,1,2,2,2,1,0],
                [0,1,3,4,4,4,3,1],
                [0,3,5,6,6,6,5,3],
                [0,3,5,6,6,6,5,3],
                [0,3,5,6,6,6,5,3],
                [0,1,3,5,5,5,3,1],
                [0,0,1,3,3,3,1,0],
                [0,0,0,1,1,1,0,0]
            ],

            flame: [
                [0,0,0,2,2,0,0,0],
                [0,0,2,3,3,2,0,0],
                [0,2,3,4,4,3,2,0],
                [2,3,4,4,4,4,3,2],
                [0,2,3,4,4,3,2,0],
                [0,0,2,3,3,2,0,0],
                [0,0,0,2,2,0,0,0],
                [0,0,0,0,0,0,0,0]
            ],

            leaf: [
                [0,0,0,2,2,0,0,0],
                [0,0,2,3,3,2,0,0],
                [0,2,3,3,3,3,2,0],
                [2,3,3,4,4,3,3,2],
                [0,2,3,3,3,3,2,0],
                [0,0,2,3,3,2,0,0],
                [0,0,0,2,2,0,0,0],
                [0,0,0,0,0,0,0,0]
            ],

            gem: [
                [0,0,2,2,2,2,0,0],
                [0,2,3,3,3,3,2,0],
                [2,3,1,3,3,1,3,2],  // eyes (1s)
                [2,3,3,3,3,3,3,2],
                [2,3,3,1,1,3,3,2],  // mouth start
                [2,3,3,3,3,3,3,2],
                [0,2,3,3,3,3,2,0],
                [0,0,2,2,2,2,0,0]
            ],

            beetle: [
                [0,0,0,2,2,0,0,0],
                [0,0,2,3,3,2,0,0],
                [0,2,3,1,1,3,2,0],
                [2,3,3,3,3,3,3,2],
                [2,3,3,3,3,3,3,2],
                [0,2,3,2,2,3,2,0],
                [0,0,2,3,3,2,0,0],
                [0,0,0,2,2,0,0,0]
            ],

            star: [
                [0,0,0,2,0,2,0,0],
                [0,0,2,3,2,3,2,0],
                [0,2,3,4,4,4,3,2],
                [0,3,4,4,4,4,4,3],
                [0,2,3,4,4,4,3,2],
                [0,0,2,3,4,3,2,0],
                [0,0,0,2,3,2,0,0],
                [0,0,0,0,2,0,0,0]
            ],

            peepaw: [
                [0,0,5,5,5,5,0,0],
                [0,6,3,3,3,3,6,0],
                [3,3,1,1,1,1,3,3],
                [3,3,1,1,1,1,3,3],
                [0,4,4,4,4,4,4,0],  
                [5,5,5,5,5,5,5,5],
                [0,3,3,3,3,3,3,0],
                [0,0,3,3,3,3,0,0]
            ],

            flicker: [
                [0,0,1,2,2,1,0,0],
                [0,1,2,3,3,2,1,0],
                [1,2,4,5,5,4,2,1],
                [0,3,5,6,6,5,3,0],
                [0,3,5,6,6,5,3,0],
                [1,2,4,5,5,4,2,1],
                [0,1,2,3,3,2,1,0],
                [0,0,1,2,2,1,0,0]
            ],

            grumple: [
                [0,0,2,2,2,2,0,0],
                [0,2,3,3,3,3,2,0],
                [2,3,4,5,5,4,3,2],
                [2,3,5,6,6,5,3,2],
                [2,3,5,6,6,5,3,2],
                [2,3,4,5,5,4,3,2],
                [0,2,3,3,3,3,2,0],
                [0,0,2,2,2,2,0,0]
            ],

            dragojr: [
                [0,9,9,9,0,9,9,9,0,0,0,0,0,0,0,0],
                [9,9,4,9,0,9,4,9,9,0,0,0,0,0,0,0],
                [9,4,4,9,9,9,4,4,9,9,0,0,0,0,0,0],
                [9,9,4,4,4,4,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,4,9,0,0,0,0,0,0],
                [0,9,4,9,4,9,4,4,9,9,9,0,0,0,0,0],
                [9,4,4,4,4,4,4,4,9,7,9,0,0,0,0,0],
                [9,9,4,9,4,4,4,9,9,7,9,0,0,0,0,0],
                [9,4,4,4,4,4,9,9,1,9,7,9,0,9,0,0],
                [0,9,9,9,9,9,1,1,1,1,9,7,9,4,9,0],
                [0,0,9,1,1,1,1,1,1,1,1,9,9,4,9,0],
                [0,9,1,4,1,1,9,1,1,1,1,4,4,9,0,0],
                [0,9,9,4,4,1,9,1,9,4,4,4,9,0,0,0],
                [0,0,0,9,4,4,4,9,0,9,9,9,0,0,0,0],
                [0,0,0,0,9,9,9,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            tube: [
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
                [7, 3, 7, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 4, 4, 4, 4, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 3, 4, 4, 3, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 3, 4, 4, 3, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 4, 4, 4, 4, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 4, 4, 4, 4, 4, 4, 4, 4, 5, 7, 3, 7],
                [7, 3, 7, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 7, 3, 7],
                [7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
                [0, 0, 0, 0, 7, 0, 7, 0, 0, 7, 0, 7, 0, 0, 0, 0],
                [0, 0, 0, 0, 7, 0, 7, 0, 0, 7, 0, 7, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 7, 0, 0, 7, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 5, 5, 0, 0, 5, 5, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],
            
            qube: [
                [0, 0, 0, 0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7],
                [0, 0, 0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3],
                [0, 0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3],
                [0, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 3],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 3, 0],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 3, 0, 0],
                [0, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],

            chromeo: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,4,4,0,0,0,0,0,0,0,0,0,4,4],
                [0,0,4,0,4,0,0,0,0,0,0,0,0,4,0,4],
                [0,4,0,0,0,0,0,0,0,0,0,0,4,0,0,0],
                [5,5,5,5,5,5,5,5,5,5,5,5,0,0,0,0],
                [9,9,9,1,9,9,9,9,9,9,1,9,0,0,0,0],
                [9,9,1,9,9,9,9,9,9,1,9,9,0,0,0,0],
                [9,1,9,9,9,0,0,9,1,9,9,9,0,0,0,0],
                [0,9,9,9,0,0,0,0,9,9,9,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],

            rainbow: [
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,8,8,8,8,8,8,0,0,0,0,0],
                [0,0,0,0,8,8,4,4,4,4,8,8,0,0,0,0],
                [0,0,0,8,8,4,4,3,3,4,4,8,8,0,0,0],
                [0,0,0,8,4,3,3,0,0,3,3,4,8,0,0,0],
                [0,0,0,8,4,3,0,0,0,0,3,4,8,0,0,0],
                [0,0,0,8,4,3,0,0,0,0,3,4,8,0,0,0],
                [0,0,0,8,4,3,10,0,0,10,3,4,8,0,0,0],
                [0,0,10,10,10,10,10,0,0,10,10,10,10,10,0,0],
                [0,10,10,10,10,10,10,0,0,10,10,10,10,10,10,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            ],
        };

        // Get the current light/dark mode state
        function isLightModeActive() {
            // Check for a theme class on body, or localStorage, or system preference
            const body = document.body;
            const savedTheme = localStorage.getItem('theme');

            if (savedTheme) {
                return savedTheme === 'light';
            }

            // Check for theme classes
            if (body.classList.contains('light-theme') || body.classList.contains('light-mode')) {
                return true;
            }
            if (body.classList.contains('dark-theme') || body.classList.contains('dark-mode')) {
                return false;
            }
            
            // Fall back to system preference
            return !window.matchMedia('(prefers-color-scheme: dark)').matches;
        }

        // Get pet theme colors based on current mode
        function getPetThemeColors(themeName) {
            const isLightMode = isLightModeActive();
            const petThemes = {
                default: isLightMode
                    ? {
                        0: 'transparent',
                        1: '#FFF2E0', 2: '#FFE0B3', 3: '#FFD8A6',
                        4: '#FFCB88', 5: '#E6B273', 6: '#C4945E',
                        7: '#A9745B', 8: '#8B5E3C', 9: '#6B4226', 10: '#4A2B17'
                    }
                    : {
                        0: 'transparent',
                        1: '#E0ECFA', 2: '#C2DAF7', 3: '#9CC7F0',
                        4: '#6FA6E0', 5: '#4A90E2', 6: '#2B6FB2',
                        7: '#1F5FBF', 8: '#173F80', 9: '#0D264D', 10: '#08162B'
                    },

                candy: isLightMode
                    ? {0: 'transparent', 1: '#FF6B6B', 2: '#FFA94D', 3: '#FFD93D', 4: '#6BCB77', 5: '#4D96FF', 6: '#9D4EDD', 7: '#FF8FAB', 8: '#FFB5E8', 9: '#FFDEE9', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#FF8787', 2: '#FFB86B', 3: '#FFE066', 4: '#8CE99A', 5: '#74C0FC', 6: '#B197FC', 7: '#FF99C8', 8: '#FFB3DE', 9: '#FFC2E5', 10: '#F8F9FA'},
                ocean: isLightMode
                    ? {0: 'transparent', 1: '#A2D2FF', 2: '#80C0FF', 3: '#5AA9FA', 4: '#4682B4', 5: '#2E5984', 6: '#1B3B5F', 7: '#0F2A44', 8: '#082136', 9: '#041626', 10: '#000814'}
                    : {0: 'transparent', 1: '#90C8F8', 2: '#66AEEF', 3: '#3D91E0', 4: '#2E6FA3', 5: '#1D4E72', 6: '#103552', 7: '#0A2438', 8: '#061C2B', 9: '#03111B', 10: '#000814'},
                ember: isLightMode
                    ? {0: 'transparent', 1: '#FFF3B0', 2: '#FFD93D', 3: '#FFA200', 4: '#FF6B35', 5: '#E63946', 6: '#B51709', 7: '#800F00', 8: '#4D0600', 9: '#260300', 10: '#0D0000'}
                    : {0: 'transparent', 1: '#FFE066', 2: '#FFC300', 3: '#FF8C00', 4: '#FF5733', 5: '#C70039', 6: '#900C3F', 7: '#581845', 8: '#2C0B27', 9: '#160513', 10: '#0B0208'},
                meadow: isLightMode
                    ? {0: 'transparent', 1: '#E0F7E9', 2: '#B2F2BB', 3: '#8CE99A', 4: '#69DB7C', 5: '#38D9A9', 6: '#20C997', 7: '#12B886', 8: '#0CA678', 9: '#087F5B', 10: '#045040'}
                    : {0: 'transparent', 1: '#C3F5D5', 2: '#96E6A8', 3: '#70D78B', 4: '#4CB372', 5: '#31A67F', 6: '#24916B', 7: '#1A7257', 8: '#115745', 9: '#0A3A2D', 10: '#041E16'},
                neon: isLightMode
                    ? {0: 'transparent', 1: '#FF00FF', 2: '#FF1493', 3: '#FF4500', 4: '#FFD700', 5: '#ADFF2F', 6: '#00FF7F', 7: '#00FFFF', 8: '#1E90FF', 9: '#8A2BE2', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#FF4DFF', 2: '#FF69B4', 3: '#FF6347', 4: '#FFE066', 5: '#C0FF66', 6: '#66FFB2', 7: '#66FFFF', 8: '#66A3FF', 9: '#B266FF', 10: '#F8F9FA'},
                pastel: isLightMode
                    ? {0: 'transparent', 1: '#FFB5E8', 2: '#FFDEB4', 3: '#FFF5BA', 4: '#B5EAD7', 5: '#C7CEEA', 6: '#E0BBE4', 7: '#FEC8D8', 8: '#D8E2DC', 9: '#F1F0C0', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#FF99CC', 2: '#FFCC99', 3: '#FFF2A8', 4: '#99E2C3', 5: '#A8B9E6', 6: '#C7A9D6', 7: '#F5A3C7', 8: '#CFCFCF', 9: '#EAE6B8', 10: '#F8F9FA'},
                gothic: isLightMode
                    ? {0: 'transparent', 1: '#1A1A1A', 2: '#2E2E2E', 3: '#444444', 4: '#5E2750', 5: '#87255B', 6: '#D90368', 7: '#FF6F61', 8: '#C9ADA7', 9: '#EAEAEA', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#000000', 2: '#1A1A1A', 3: '#333333', 4: '#5E2750', 5: '#7A1E48', 6: '#B30C5C', 7: '#FF4F5E', 8: '#A99A93', 9: '#D6D6D6', 10: '#F5F5F5'},
                aurora: isLightMode
                    ? {0: 'transparent', 1: '#A5FFD6', 2: '#82FFC7', 3: '#5DFDCB', 4: '#3EDBF0', 5: '#3B9AE1', 6: '#6F69AC', 7: '#9D4EDD', 8: '#FF5D8F', 9: '#FF87AB', 10: '#FFFFFF'}
                    : {0: 'transparent', 1: '#7DFFBF', 2: '#5AF7B0', 3: '#32E1B5', 4: '#1EB7D8', 5: '#2070B0', 6: '#514080', 7: '#7A29C6', 8: '#FF4D7A', 9: '#FF6F9F', 10: '#F8F9FA'},
                retroPixel: isLightMode
                    ? {0: 'transparent', 1: '#FFFFFF', 2: '#FFD800', 3: '#FF8C00', 4: '#FF0000', 5: '#C000C0', 6: '#0000FF', 7: '#008080', 8: '#00C000', 9: '#404040', 10: '#000000'}
                    : {0: 'transparent', 1: '#E0E0E0', 2: '#E0C000', 3: '#D07000', 4: '#C00000', 5: '#A000A0', 6: '#0000A0', 7: '#006060', 8: '#00A000', 9: '#303030', 10: '#000000'},
                fantasySprite: isLightMode
                    ? {0: 'transparent', 1: '#F0EAD6', 2: '#C2B280', 3: '#8E735B', 4: '#5C4B3B', 5: '#3B2F2F', 6: '#6B8E23', 7: '#4682B4', 8: '#9370DB', 9: '#FFD700', 10: '#000000'}
                    : {0: 'transparent', 1: '#D8D2BE', 2: '#A89C6E', 3: '#6E5B45', 4: '#44362C', 5: '#2C2222', 6: '#556B2F', 7: '#36648B', 8: '#7A5DC7', 9: '#E6C200', 10: '#000000'},
            };

            return petThemes[themeName] || petThemes.default;
        }

        // =====================
        // Sprite Rendering
        // =====================

        // Render a pet sprite from array + theme colors
        function renderPetSprite(spriteArray, colors, maxSize = 50) {
            const rows = spriteArray.length;
            const cols = spriteArray[0].length;
        
            // Calculate pixel size to fit sprite inside maxSize
            const pixelSize = Math.floor(Math.min(maxSize / cols, maxSize / rows));
        
            const spriteDiv = document.createElement('div');
            spriteDiv.classList.add('pet-sprite', 'pulse');
            spriteDiv.style.display = 'grid';
            spriteDiv.style.gridTemplateColumns = `repeat(${cols}, ${pixelSize}px)`;
            spriteDiv.style.gridTemplateRows = `repeat(${rows}, ${pixelSize}px)`;
            spriteDiv.style.width = `${cols * pixelSize}px`;
            spriteDiv.style.height = `${rows * pixelSize}px`;
            spriteDiv.style.background = 'transparent';
            spriteDiv.style.pointerEvents = 'none'; // allow click animation
            spriteDiv.style.boxSizing = 'border-box';
        
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const pixelValue = spriteArray[y][x];
                    const px = document.createElement('div');
        
                    px.style.width = `${pixelSize}px`;
                    px.style.height = `${pixelSize}px`;
                    px.style.backgroundColor = pixelValue !== 0 ? colors[pixelValue] : 'transparent';
        
                    spriteDiv.appendChild(px);
                }
            }
        
            // Optional click animation
            spriteDiv.addEventListener('click', () => {
                spriteDiv.style.transform = 'scale(1.2)';
                setTimeout(() => spriteDiv.style.transform = '', 200);
            });
        
            return spriteDiv;
        }


        function renderPetPreview() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');
            const preview = document.getElementById('petPreview');
        
            if (!styleElement || !themeElement || !preview) {
                console.warn('Pet preview elements not found');
                return;
            }
        
            const style = styleElement.value;
            const theme = themeElement.value;
            preview.innerHTML = '';
        
            if (style === 'none') return;
        
            const spriteData = petSprites[style];
            const themeColors = getPetThemeColors(theme);
        
            if (spriteData && themeColors) {
                const rows = spriteData.length;
                const cols = spriteData[0].length;
        
                // Fixed preview size (like #spritePreview)
                const previewWidth = preview.clientWidth || 60;
                const previewHeight = preview.clientHeight || 60;
        
                // Calculate pixel size to fit inside the container
                const pixelSize = Math.floor(Math.min(previewWidth / cols, previewHeight / rows));
        
                // Offset to center the sprite inside preview
                const offsetX = Math.floor((previewWidth - cols * pixelSize) / 2);
                const offsetY = Math.floor((previewHeight - rows * pixelSize) / 2);
        
                spriteData.forEach((row, y) => {
                    row.forEach((pixel, x) => {
                        if (pixel > 0) {
                            const px = document.createElement('div');
                            px.className = 'pixel';
                            px.style.position = 'absolute';
                            px.style.width = `${pixelSize}px`;
                            px.style.height = `${pixelSize}px`;
                            px.style.backgroundColor = themeColors[pixel];
                            px.style.left = `${offsetX + x * pixelSize}px`;
                            px.style.top = `${offsetY + y * pixelSize}px`;
                            preview.appendChild(px);
                        }
                    });
                });
            }
        }

        
        // Render the sticky top-right pet on every page
        function updateStickyPet() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');
            const petContainer = document.getElementById('petContainer');
        
            if (!styleElement || !themeElement || !petContainer) {
                console.warn('Pet sticky elements not found');
                return;
            }
        
            const style = styleElement.value;
            const theme = themeElement.value;
            petContainer.innerHTML = '';
        
            if (style === 'none') return;
        
            const spriteData = petSprites[style];
            const themeColors = getPetThemeColors(theme);
        
            if (spriteData && themeColors) {
                // Use maxSize to scale sprite to fit container
                const maxContainerSize = Math.min(petContainer.clientWidth, petContainer.clientHeight);
                const petSpriteDiv = renderPetSprite(spriteData, themeColors, maxContainerSize);
        
                // Ensure container is fixed at top-right
                petContainer.style.position = 'fixed';
                petContainer.style.top = '10px';
                petContainer.style.right = '10px';
                petContainer.style.zIndex = '50';
                petContainer.style.pointerEvents = 'none'; // optional: pass clicks through
        
                petContainer.appendChild(petSpriteDiv);
            }
        }

        function savePetSettings() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');

            if (!styleElement || !themeElement) return;

            const settings = {
                style: styleElement.value,
                theme: themeElement.value
            };

            try {
                localStorage.setItem('petSettings', JSON.stringify(settings));
            } catch (error) {
                console.warn('Failed to save pet settings:', error);
            }
        }

        function loadPetSettings() {
            const styleElement = document.getElementById('petStyle');
            const themeElement = document.getElementById('petTheme');
        
            if (!styleElement || !themeElement) return;
        
            // Clear existing options
            styleElement.innerHTML = '';
            themeElement.innerHTML = '';
        
            // Populate sprite styles
            styleElement.appendChild(new Option('None', 'none'));
            for (const key in petSprites) {
                styleElement.appendChild(new Option(key, key));
            }
        
            // Populate themes
            const availableThemes = [
                'default', 'candy', 'ocean', 'ember', 'meadow', 'neon', 
                'pastel', 'gothic', 'aurora', 'retroPixel', 'fantasySprite'
            ];
            for (const theme of availableThemes) {
                themeElement.appendChild(new Option(theme, theme));
            }
        
            // Load saved settings
            const savedStyle = localStorage.getItem('petStyle') || 'miniJerry';
            const savedTheme = localStorage.getItem('petTheme') || 'default';
        
            styleElement.value = petSprites[savedStyle] ? savedStyle : 'miniJerry';
            themeElement.value = availableThemes.includes(savedTheme) ? savedTheme : 'default';
        
            // Initial render
            renderPetPreview();
            updateStickyPet();
        
            // Update preview on change
            styleElement.addEventListener('change', () => {
                renderPetPreview();
                updateStickyPet();
                localStorage.setItem('petStyle', styleElement.value);
            });
        
            themeElement.addEventListener('change', () => {
                renderPetPreview();
                updateStickyPet();
                localStorage.setItem('petTheme', themeElement.value);
            });
        }


        function initializePetSystem() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializePetSystem);
                return;
            }
        
            // -----------------------------
            // Initialize appState.pet
            // -----------------------------
            if (!appState.pet) appState.pet = {};
            if (!appState.pet.currentSprite) appState.pet.currentSprite = 'miniJerry';
            if (!appState.pet.theme) appState.pet.theme = 'default';
        
            // -----------------------------
            // Load custom sprites
            // -----------------------------
            let customSprites = getFromLocalStorage('customSprites', { jerry: {}, pet: {} });
            if (!customSprites.jerry) customSprites.jerry = {};
            if (!customSprites.pet) customSprites.pet = {};
        
            Object.entries(customSprites.jerry).forEach(([id, sprite]) => {
                if (sprite?.data && Array.isArray(sprite.data) && Array.isArray(sprite.data[0])) {
                    jerrySprites[id] = sprite.data;
                } else delete customSprites.jerry[id];
            });
        
            Object.entries(customSprites.pet).forEach(([id, sprite]) => {
                if (sprite?.data && Array.isArray(sprite.data) && Array.isArray(sprite.data[0])) {
                    petSprites[id] = sprite.data;
                } else delete customSprites.pet[id];
            });
        
            saveToLocalStorage('customSprites', customSprites);
        
            // -----------------------------
            // Available themes
            // -----------------------------
            const availableThemes = ['default', 'candy', 'ocean', 'ember', 'meadow', 'neon', 'pastel', 'gothic', 'aurora', 'retroPixel', 'fantasySprite'];
        
            // -----------------------------
            // DOM elements
            // -----------------------------
            const petStyleSelect = document.getElementById('petStyle');
            const petThemeSelect = document.getElementById('petTheme');
            const petPreview = document.getElementById('petPreview');
            const petContainer = document.getElementById('petContainer');
            const uploadedSpritesList = document.getElementById('uploadedSpritesList');
            const spriteFileInput = document.getElementById('spriteFileInput');
            const spriteUploadZone = document.getElementById('spriteUploadZone');
            const uploadInputs = document.getElementById('spriteUploadInputs');
            const nameInput = document.getElementById('spriteNameInputInline');
            const categorySelect = document.getElementById('spriteCategorySelectInline');
            const uploadSubmit = document.getElementById('spriteUploadSubmitInline');
        
            if (!petStyleSelect || !petThemeSelect || !petPreview || !petContainer) {
                console.warn('Pet elements not found');
                return;
            }
        
            let pendingUpload = null;
        
            // -----------------------------
            // Populate pet dropdowns
            // -----------------------------
            function populatePetDropdowns() {
                petStyleSelect.innerHTML = '';
                petThemeSelect.innerHTML = '';
        
                petStyleSelect.appendChild(new Option('None', 'none'));
                Object.keys(petSprites).forEach(key => {
                    petStyleSelect.appendChild(new Option(key.charAt(0).toUpperCase() + key.slice(1), key));
                });
        
                availableThemes.forEach(theme => {
                    petThemeSelect.appendChild(new Option(theme.charAt(0).toUpperCase() + theme.slice(1), theme));
                });
        
                // Load saved settings
                const savedSettings = JSON.parse(localStorage.getItem('petSettings') || '{}');
                const savedStyle = savedSettings.style && petSprites[savedSettings.style] ? savedSettings.style : 'miniJerry';
                const savedTheme = savedSettings.theme && availableThemes.includes(savedSettings.theme) ? savedSettings.theme : 'default';
        
                appState.pet.currentSprite = savedStyle;
                appState.pet.theme = savedTheme;
        
                petStyleSelect.value = savedStyle;
                petThemeSelect.value = savedTheme;
            }
        
            populatePetDropdowns();
        
            // -----------------------------
            // Render preview / sticky pet
            // -----------------------------
            function refreshPetRender() {
                renderPetPreview();
                updateStickyPet();
            }
        
            // -----------------------------
            // Pet dropdown listeners
            // -----------------------------
            petStyleSelect.addEventListener('change', () => {
                const style = petStyleSelect.value;
                appState.pet.currentSprite = style;
                localStorage.setItem('petSettings', JSON.stringify({ style, theme: appState.pet.theme || 'default' }));
                refreshPetRender();
            });
        
            petThemeSelect.addEventListener('change', () => {
                const theme = petThemeSelect.value;
                appState.pet.theme = theme;
                localStorage.setItem('petSettings', JSON.stringify({ style: appState.pet.currentSprite || 'none', theme }));
                refreshPetRender();
            });
        
            // -----------------------------
            // Uploaded sprites list
            // -----------------------------
            function updateUploadList() {
                if (!uploadedSpritesList) return;
                uploadedSpritesList.innerHTML = '';
        
                Object.entries(customSprites.jerry).forEach(([id, sprite]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>Jerry: ${sprite.name}</span>
                        <button onclick="deleteSprite('jerry','${id}','${sprite.name}')">Delete</button>`;
                    uploadedSpritesList.appendChild(li);
                });
        
                Object.entries(customSprites.pet).forEach(([id, sprite]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>Pet: ${sprite.name}</span>
                        <button onclick="deleteSprite('pet','${id}','${sprite.name}')">Delete</button>`;
                    uploadedSpritesList.appendChild(li);
                });
            }
        
            window.deleteSprite = function(category, id, name) {
                if (!confirm(`Delete sprite "${name}"?`)) return;
                delete customSprites[category][id];
                if (category === 'jerry') delete jerrySprites[id];
                else delete petSprites[id];
                saveToLocalStorage('customSprites', customSprites);
        
                // Reset current sprite if deleted
                if (category === 'pet' && appState.pet.currentSprite === id) {
                    appState.pet.currentSprite = 'miniJerry';
                    refreshPetRender();
                }
        
                populatePetDropdowns();
                updateUploadList();
            };
        
            updateUploadList();
        
            // -----------------------------
            // Handle sprite file uploads
            // -----------------------------
            async function handleFile(file) {
                if (!file || !nameInput) return;
                try {
                    const text = await file.text();
                    let data = JSON.parse(text);
        
                    if (Array.isArray(data)) data = { sprites: data };
                    pendingUpload = null;
        
                    const spriteData = data.sprite || (data.sprites && data.sprites[0]);
                    if (spriteData && (Array.isArray(spriteData.data) || Array.isArray(spriteData))) {
                        pendingUpload = { type: 'sprite', data: spriteData.data || spriteData, name: spriteData.name || '' };
                        nameInput.value = pendingUpload.name;
                        if (categorySelect) categorySelect.style.display = 'block';
                        if (uploadInputs) uploadInputs.style.display = 'block';
                    } else {
                        alert('No valid sprite found.');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                } finally {
                    if (spriteFileInput) spriteFileInput.value = '';
                }
            }
        
            if (uploadSubmit) {
                uploadSubmit.addEventListener('click', () => {
                    if (!pendingUpload || !nameInput) return;
                    const name = nameInput.value.trim();
                    if (!name) return alert('Please enter a name.');
        
                    const category = categorySelect.value;
                    const id = `${category}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    customSprites[category][id] = { name, data: pendingUpload.data };
        
                    if (category === 'jerry') jerrySprites[id] = pendingUpload.data;
                    else petSprites[id] = pendingUpload.data;
        
                    saveToLocalStorage('customSprites', customSprites);
        
                    pendingUpload = null;
                    nameInput.value = '';
                    if (uploadInputs) uploadInputs.style.display = 'none';
        
                    populatePetDropdowns();
                    updateUploadList();
                    refreshPetRender();
                });
            }
        
            if (spriteUploadZone && spriteFileInput) {
                spriteUploadZone.addEventListener('click', () => spriteFileInput.click());
                spriteFileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
                spriteUploadZone.addEventListener('dragover', (e) => { e.preventDefault(); spriteUploadZone.classList.add('dragover'); });
                spriteUploadZone.addEventListener('dragleave', () => spriteUploadZone.classList.remove('dragover'));
                spriteUploadZone.addEventListener('drop', (e) => { e.preventDefault(); spriteUploadZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
            }
        
            // -----------------------------
            // Final render
            // -----------------------------
            refreshPetRender();
        }

        // === Chat Functions ===
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addMessageToChat('user', message, 'user');
            input.value = '';

            // Add to history
            appState.chatHistory.push({ role: 'user', content: message });

            // Add thinking indicator and keep reference
            const thinkingDiv = addMessageToChat('assistant', 'Thinking...', 'jerry thinking');

            try {
                const response = await getAIResponse(message);

                // Replace "Thinking..." with actual response
                thinkingDiv.innerHTML = `<strong>${appState.botName || 'Jerry'}:</strong> ${response}`;
                thinkingDiv.classList.remove('thinking');

                // Keep chat history within limit
                const MAX_CHAT_HISTORY = 20;
                if (appState.chatHistory.length > MAX_CHAT_HISTORY) {
                    appState.chatHistory = appState.chatHistory.slice(-MAX_CHAT_HISTORY);
                }

            } catch (error) {
                console.error('sendMessage error:', error);

                // Replace thinking indicator with fallback response
                thinkingDiv.innerHTML = `<strong>${appState.botName || 'Jerry'}:</strong> ${getFallbackResponse(message)}`;
                thinkingDiv.classList.remove('thinking');
            }
        }


        /**
         * Adds a message to the chat and returns the created div for later updates.
         * @param {string} speaker - 'assistant' or 'user'
         * @param {string} message - The message text
         * @param {string} className - Additional class for styling (e.g., 'jerry', 'thinking')
         * @returns {HTMLElement} - The created message div
         */
        function addMessageToChat(speaker, message, className = '') {
            const chatLog = document.getElementById('chatLog');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`.trim();

            const displayName = speaker === 'assistant' ? (appState.botName || 'Jerry') : 'You';
            messageDiv.innerHTML = `<strong>${displayName}:</strong> ${message}`;

            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            return messageDiv;
        }

        async function getAIResponse(message) {
            if (!appState) appState = { chatHistory: [], botName: 'Jerry', apiKey: '' };
            if (!subscriptionState) subscriptionState = { isSubscribed: false, messageCount: 0 };

            // Pick API key
            const apiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
            let apiKey;
            if (apiOption === 'premium') {
                if (!subscriptionState.isSubscribed) throw new Error('Premium subscription required');
                if (subscriptionState.messageCount >= 1000) throw new Error('Monthly message limit reached');
                apiKey = PREMIUM_API_KEY;
                subscriptionState.messageCount++; 
                localStorage.setItem('jerry_message_count', String(subscriptionState.messageCount));
                updateUsageDisplay();
            } else {
                apiKey = appState.apiKey || document.getElementById('apiKey')?.value?.trim();
                if (!apiKey) throw new Error('Please enter your API key or subscribe to Premium');
            }

            // Keep only last 15 messages
            if (appState.chatHistory.length > 15) {
                appState.chatHistory = appState.chatHistory.slice(-15);
            }

            // Only add system prompt once at the very beginning
            const systemPromptText = 'You are Jerry, a friendly, gentle, and supportive AI companion focused on mental health. Keep responses brief and caring, offering emotional support and encouragement. You help users with CBT and DBT techniques when appropriate.';

            const contents = [];
            if (!appState.chatHistory.some(m => m.role === 'system')) {
                contents.push({ role: 'user', parts: [{ text: systemPromptText }] });
                appState.chatHistory.unshift({ role: 'system', content: systemPromptText });
            }

            // Add conversation history
            contents.push(
                ...appState.chatHistory
                    .filter(m => m.role !== 'system')
                    .map(m => ({
                        role: m.role === 'assistant' ? 'assistant' : 'user',
                        parts: [{ text: m.content }]
                    }))
            );

            let data;
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents,
                        generationConfig: { maxOutputTokens: 1000, temperature: 0.7, topK: 40, topP: 0.95 }
                    })
                });

                if (!resp.ok) {
                    const text = await resp.text();
                    console.error('Generative API error:', resp.status, text);
                    throw new Error('API request failed');
                }

                data = await resp.json();
                console.log('Generative API response:', data);

            } catch (err) {
                console.error('Fetch failed', err);
                return getFallbackResponse(message);
            }

            // Parse reply defensively
            let reply = 'Sorry, I\'m having trouble composing a response right now.';
            try {
                reply = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim()
                     || data?.outputs?.[0]?.content?.text?.trim()
                     || reply;
            } catch (e) {
                console.error('Parsing AI response failed', e);
            }

            // Push assistant reply
            appState.chatHistory.push({ role: 'assistant', content: reply });

            return reply;
        }

        // API option switching
        function setupApiOptionHandlers() {
        const ownApiRadio = document.getElementById('useOwnApi');
        const premiumRadio = document.getElementById('usePremium');
        const ownApiSection = document.getElementById('ownApiSection');
        const premiumSection = document.getElementById('premiumSection');

        function switchApiOption() {
                const selectedOption = document.querySelector('input[name="apiOption"]:checked')?.value;

                if (selectedOption === 'premium') {
                ownApiSection.style.display = 'none';
                premiumSection.style.display = 'block';
                setupPayPalButton();
                } else {
                ownApiSection.style.display = 'block';
                premiumSection.style.display = 'none';
                }

                localStorage.setItem('jerry_api_option', selectedOption);
                updateChatInterface();
        }

        ownApiRadio?.addEventListener('change', switchApiOption);
        premiumRadio?.addEventListener('change', switchApiOption);
        }

        // PayPal integration
        function setupPayPalButton() {
        const container = document.getElementById('paypal-button-container');
        if (!container) return;

        container.innerHTML = ''; // Clear existing buttons

        if (subscriptionState.isSubscribed) {
                container.style.display = 'none'; // Hide if already subscribed
                return;
        } else {
                container.style.display = 'block'; // Show if not subscribed
        }

        paypal.Buttons({
                style: {
                shape: 'pill',
                color: 'gold',
                layout: 'vertical',
                label: 'subscribe'
                },

                createSubscription: function(data, actions) {
                return actions.subscription.create({
                        'plan_id': 'P-7LR41432T4749780UNC7UVBY', // Replace with your actual PayPal plan ID
                        'custom_id': 'jerry_premium_' + Date.now()
                });
                },

                onApprove: function(data, actions) {
                subscriptionState.isSubscribed = true;
                subscriptionState.subscriptionId = data.subscriptionID;
                subscriptionState.messageCount = 0; // Reset counter
                subscriptionState.billingCycle = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(); // 30 days from now

                // Save to localStorage
                localStorage.setItem('jerry_subscription_active', 'true');
                localStorage.setItem('jerry_subscription_id', data.subscriptionID);
                localStorage.setItem('jerry_message_count', '0');
                localStorage.setItem('jerry_billing_cycle', subscriptionState.billingCycle);

                showNotification('üåü Premium subscription activated! Welcome to Jerry Premium!');
                updateSubscriptionDisplay();
                updateChatInterface();

                container.style.display = 'none';
                },

                onError: function(err) {
                console.error('PayPal error:', err);
                showNotification('Subscription failed. Please try again.', 'error');
                }
        }).render('#paypal-button-container');
        }


        // Update subscription display
        function updateSubscriptionDisplay() {
        const statusDisplay = document.getElementById('subscriptionStatusDisplay');
        const subscribeSection = document.getElementById('paypalSubscribeSection');
        const messageUsageDisplay = document.getElementById('messageUsageDisplay');
        const nextBillingDate = document.getElementById('nextBillingDate');

        if (subscriptionState.isSubscribed) {
                statusDisplay.style.display = 'block';
                subscribeSection.style.display = 'none';

                if (messageUsageDisplay) {
                messageUsageDisplay.textContent = `${subscriptionState.messageCount} / 1000`;
                }

                if (nextBillingDate && subscriptionState.billingCycle) {
                const date = new Date(subscriptionState.billingCycle);
                nextBillingDate.textContent = date.toLocaleDateString();
                }
        } else {
                statusDisplay.style.display = 'none';
                subscribeSection.style.display = 'block';
        }
        }

        // Update usage display in Jerry screen
        function updateUsageDisplay() {
        const messageCountEl = document.getElementById('messageCount');
        const usageFillEl = document.getElementById('usageFill');
        const subscriptionStatusEl = document.getElementById('subscriptionStatus');

        if (subscriptionState.isSubscribed && subscriptionStatusEl) {
                subscriptionStatusEl.style.display = 'block';

                if (messageCountEl) {
                messageCountEl.textContent = subscriptionState.messageCount;
                }

                if (usageFillEl) {
                const percentage = (subscriptionState.messageCount / 1000) * 100;
                usageFillEl.style.width = `${percentage}%`;
                }
        } else if (subscriptionStatusEl) {
                subscriptionStatusEl.style.display = 'none';
        }
        }

        // Update chat interface based on API option
        function updateChatInterface() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const apiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
        
            // Always keep inputs enabled so iOS can bring up the keyboard
            if (!chatInput || !sendButton) return;
        
            let canSend = false;
        
            if (apiOption === 'premium') {
                if (subscriptionState.isSubscribed) {
                    if (subscriptionState.messageCount >= 1000) {
                        chatInput.placeholder = 'Monthly limit reached. Resets next billing cycle.';
                    } else {
                        chatInput.placeholder = 'Type your message... (Premium)';
                        canSend = true;
                    }
                } else {
                    chatInput.placeholder = 'Premium subscription required';
                }
            } else {
                const hasApiKey = appState.apiKey || document.getElementById('apiKey')?.value?.trim();
                if (hasApiKey) {
                    chatInput.placeholder = 'Type your message...';
                    canSend = true;
                } else {
                    chatInput.placeholder = 'Please enter your API key in Settings';
                }
            }
        
            // Never disable the textarea ‚Üí only toggle the send button
            chatInput.readOnly = false; 
            chatInput.disabled = false;
            sendButton.disabled = !canSend;
        }


        // Cancel subscription
        async function cancelSubscription() {
        if (!confirm('Are you sure you want to cancel your Premium subscription? You will lose access at the end of your current billing period.')) {
                return;
        }

        try {
                // In a real implementation, you would call your backend to cancel the PayPal subscription
                // For now, we'll just clear local storage
                subscriptionState.isSubscribed = false;
                subscriptionState.subscriptionId = null;

                localStorage.removeItem('jerry_subscription_active');
                localStorage.removeItem('jerry_subscription_id');
                localStorage.removeItem('jerry_billing_cycle');

                showNotification('Subscription cancelled. You can continue using Premium until your next billing date.');
                updateSubscriptionDisplay();
                updateChatInterface();

                // Switch back to own API option
                document.getElementById('useOwnApi').checked = true;
                document.querySelector('input[name="apiOption"][value="own"]').dispatchEvent(new Event('change'));

        } catch (error) {
                showNotification('Failed to cancel subscription. Please try again.', 'error');
        }
        }

        function getFallbackResponse(message) {
        const lowerMessage = message.toLowerCase();
        const responses = {
                'hello': "Hello! It's good to see you.",
                'hi': "Hello! It's good to see you.",
                'how are you': "I'm doing well, thank you! How can I help you today?",
                'thank': "You're very welcome!",
                'bye': "Goodbye! Have a great day!",
                'help': "I'm here to listen and support you. You can talk to me about anything, or try the CBT and DBT tools in the other tabs.",
                'sad': "I'm sorry you're feeling sad. Your emotions are valid. Would you like to talk about what's bothering you?",
                'anxious': "Anxiety can be really difficult. Remember to breathe deeply. I'm here to listen if you'd like to share what's making you anxious.",
                'angry': "It's okay to feel angry. Let's talk about what's causing these feelings."
        };

        for (const [key, response] of Object.entries(responses)) {
                if (lowerMessage.includes(key)) {
                return response;
                }
        }

        return "I'm here to listen. Tell me what's on your mind.";
        }

        // Check-in Functions
        function setCheckinResponse(button, category, choice) {
            appState.checkinData[category] = choice;

            // Remove 'active' from all buttons in the same category
            const buttons = document.querySelectorAll(`[onclick*="${category}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));

            // Set active class on tapped button
            button.classList.add('active');
        }

        function completeCheckin() {
            const requiredFields = ['emotion', 'physical', 'mental'];
            const missing = requiredFields.filter(f => !appState.checkinData[f]);

            if (missing.length > 0) {
                showNotification('Please answer all questions before continuing.', 'error');
                return;
            }

            const entry = {
                timestamp: new Date().toISOString(),
                type: 'Check-in',
                data: { ...appState.checkinData }
            };
            
            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);

            feedJerry('clarity', 50);
            addXP(10);

            showNotification('Check-in completed! Jerry gained clarity.');

            // Reset for
            appState.checkinData = {};
            document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));

            // Switch back to Jerry tab
            switchTab('jerry');

            // Refresh entries screen if needed
            loadEntries();
        }

        // =====================
        // CBT Functions
        // =====================
        function completeCBT() {
            const situation = document.getElementById('cbtSituation').value.trim();
            const emotions = document.getElementById('cbtEmotions').value.trim();
            const thoughts = document.getElementById('cbtThoughts').value.trim();

            if (!situation || !emotions || !thoughts) {
                showNotification('Please fill in all fields.', 'error');
                return;
            }

            // Get selected distortions
            const distortions = [];
            document.querySelectorAll('#cbtDistortions input:checked').forEach(checkbox => {
                distortions.push(checkbox.nextElementSibling.textContent);
            });

            const entry = {
                timestamp: new Date().toISOString(),
                type: 'CBT',
                data: {
                    situation,
                    emotions,
                    thoughts,
                    distortions
                }
            };

            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);

            feedJerry('insight', 50);
            addXP(20);

            showNotification('CBT session completed! Jerry gained insight.');
            
            // Reset form
            document.getElementById('cbtSituation').value = '';
            document.getElementById('cbtEmotions').value = '';
            document.getElementById('cbtThoughts').value = '';
            document.querySelectorAll('#cbtDistortions input').forEach(cb => cb.checked = false);

            // Switch back to Jerry tab
            switchTab('jerry');

            // Refresh entries
            loadEntries();
        }

       // =====================
        // DBT Functions
        // =====================
        function setDBTRating(button, emotion, value) {
            appState.dbtData[emotion] = value;

            // Remove 'active' from all buttons in this emotion group
            const buttons = document.querySelectorAll(`[onclick*="${emotion}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));

            // Set active class on tapped button
            button.classList.add('active');
        }

        function completeDBT() {
            const requiredRatings = ['anger', 'sadness', 'fear', 'shame'];
            const missing = requiredRatings.filter(r => appState.dbtData[r] === undefined);

            if (missing.length > 0) {
                showNotification('Please rate all emotions.', 'error');
                return;
            }

            // Get selected skills
            const skills = [];
            document.querySelectorAll('#dbtSkills input:checked').forEach(cb => {
                skills.push(cb.nextElementSibling.textContent);
            });

            const entry = {
                timestamp: new Date().toISOString(),
                type: 'DBT',
                data: {
                    ...appState.dbtData,
                    skills
                }
            };

            appState.entries.unshift(entry);
            saveToLocalStorage('hush_entries', appState.entries);

            feedJerry('calm', 50);
            addXP(20);

            showNotification('DBT session completed! Jerry feels calmer.');

            // Reset form
            appState.dbtData = {};
            document.querySelectorAll('#dbt .rating-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#dbtSkills input').forEach(cb => cb.checked = false);

            // Switch back to Jerry tab
            switchTab('jerry');

            // Refresh entries
            loadEntries();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const openBtn = document.getElementById('openDBTOverlay');
            const overlay = document.getElementById('dbtDefinitionsOverlay');
            const closeBtn = document.getElementById('closeDBTDefinitions');

            // Function to apply theme to overlay
            function applyOverlayTheme() {
                if (document.body.classList.contains('light-theme')) {
                    overlay.style.background = '#A0522D';
                    overlay.style.color = '#ffffff';
                    closeBtn.style.background = '#e3b88d';
                    closeBtn.style.color = '#3e3e3e';
                } else {
                    overlay.style.background = 'rgba(26,32,44,0.95)';
                    overlay.style.color = '#e2e8f0';
                    closeBtn.style.background = '#3355d4';
                    closeBtn.style.color = '#ffffff';
                }
            }

            // Open overlay
            openBtn.addEventListener('click', (e) => {
                e.preventDefault();
                overlay.style.display = 'block';
                applyOverlayTheme();
            });

            // Close overlay
            closeBtn.addEventListener('click', () => {
                overlay.style.display = 'none';
            });

            // Close overlay if clicking outside content
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                }
            });

            // Optional: listen for theme changes dynamically
            const observer = new MutationObserver(applyOverlayTheme);
            observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
        });

        function renderJournalEntries() {
            const entriesList = document.getElementById('entriesList');
            if (!entriesList) return;
        
            entriesList.innerHTML = '';
        
            if (!appState.journal || appState.journal.length === 0) {
                entriesList.innerHTML = '<p style="text-align:center;color:#a0aec0;">No journal entries yet. Write something to see it here!</p>';
                return;
            }
        
            // Sort newest first
            const sortedJournal = [...appState.journal].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
            sortedJournal.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journalEntry preview';
        
                const date = new Date(entry.timestamp).toLocaleDateString();
                const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
                const fullContent = entry.content;
                const truncatedContent = fullContent.length > 100 ? fullContent.slice(0, 100) + '‚Ä¶' : fullContent;
        
                entryDiv.innerHTML = `
                    <div class="entry-date">${date} at ${time}</div>
                    <div class="entry-content">${truncatedContent}</div>
                    <button class="delete-entry">Delete</button>
                `;
        
                const contentDiv = entryDiv.querySelector('.entry-content');
        
                // Expand/collapse
                if (fullContent.length > 100) {
                    entryDiv.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-entry')) return;
        
                        const isExpanded = entryDiv.classList.toggle('expanded');
                        contentDiv.textContent = isExpanded ? fullContent : truncatedContent;
                    });
                }
        
                // Delete entry
                entryDiv.querySelector('.delete-entry').addEventListener('click', () => {
                    if (!confirm('Delete this entry?')) return;
        
                    appState.journal = appState.journal.filter(j => j.timestamp !== entry.timestamp);
                    saveToLocalStorage('hush_journal', appState.journal);
                    renderJournalEntries();
                });
        
                entriesList.appendChild(entryDiv);
            });
        }

        // Initialize journal if it doesn't exist
        if (!appState.journal) appState.journal = [];

        // Save a new entry
        function saveJournalEntry() {
            const input = document.getElementById('journalInput');
            const content = input.value.trim();
            if (!content) return;

            const timestamp = new Date().toISOString();
            const entry = { content, timestamp };

            appState.journal.push(entry);
            saveToLocalStorage('hush_journal', appState.journal);

            feedAllJerry();
            addXP(30);

            showNotification('Journal Saved!', 'success');

            switchTab('jerry');
            
            input.value = '';
            renderJournalEntries();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const saveBtn = document.getElementById('saveJournalEntry');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveJournalEntry);
            }
        });

        // Timer Functions
        function toggleTimer() {
        if (!appState.timer.active) {
                startTimer();
        } else {
                stopTimer();
        }
        }

        function startTimer() {
        appState.timer.active = true;
        appState.timer.remaining = 180; // 3 minutes

        document.getElementById('timerButton').textContent = 'Stop';

        appState.timer.interval = setInterval(() => {
                appState.timer.remaining--;
                updateTimerDisplay();

                if (appState.timer.remaining <= 0) {
                completeTimer();
                }
        }, 1000);

        updateTimerDisplay();
        }

        function stopTimer() {
        appState.timer.active = false;
        appState.timer.remaining = 180;

        if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
        }

        document.getElementById('timerButton').textContent = 'Start';
        document.getElementById('timerDisplay').textContent = '03:00';
        }

        function completeTimer() {
        appState.timer.active = false;

        if (appState.timer.interval) {
                clearInterval(appState.timer.interval);
                appState.timer.interval = null;
        }

        document.getElementById('timerButton').textContent = 'Start';
        document.getElementById('timerDisplay').textContent = 'Done';

        feedJerry('calm', 30);
        addXP(15);

        showNotification('Mindfulness session completed!');

        setTimeout(() => {
                document.getElementById('timerDisplay').textContent = '03:00';
                appState.timer.remaining = 180;
        }, 2000);
        }

        function updateTimerDisplay() {
        const minutes = Math.floor(appState.timer.remaining / 60);
        const seconds = appState.timer.remaining % 60;
        document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function loadEntries() {
            const entriesList = document.getElementById('entriesList');
            entriesList.innerHTML = '';

            // Merge activity entries and journal entries
            const allEntries = [
                ...(appState.entries || []),  // existing activity/check-in entries
                ...(appState.journal || []).map(j => ({ 
                    type: 'Journal',
                    data: { content: j.content },
                    timestamp: j.timestamp
                }))
            ];

            if (allEntries.length === 0) {
                entriesList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No entries yet. Complete activities or write in your journal to see progress here!</p>';
                return;
            }

            // Sort newest first
            allEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Optional: filter by type
            const filterValue = document.getElementById('entryFilter')?.value || 'all';
            const filteredEntries = allEntries.filter(entry => filterValue === 'all' || entry.type === filterValue);

            // Render filtered entries
            filteredEntries.forEach((entry) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = entry.type === 'Journal' ? 'journalEntry preview' : 'entry-item';

                const date = new Date(entry.timestamp).toLocaleDateString();
                const time = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let content = '';
                if (entry.type === 'Journal') {
                    content = entry.data.content;
                } else if (entry.type === 'Check-in') {
                    content = `Feeling ${entry.data.emotion || 'N/A'} emotionally, ${entry.data.physical || 'N/A'} physically, ${entry.data.mental || 'N/A'} mentally.`;
                } else if (entry.type === 'CBT') {
                    content = `Situation: ${entry.data.situation || ''}`;
                } else if (entry.type === 'DBT') {
                    const ratings = Object.entries(entry.data)
                        .filter(([key]) => ['anger', 'sadness', 'fear', 'shame'].includes(key))
                        .map(([key, value]) => `${key}: ${value}`)
                        .join(', ');
                    content = `Emotion ratings: ${ratings}`;
                }

                const previewText = (entry.type === 'Journal' || entry.type === 'CBT') && content.length > 100
                    ? content.slice(0, 100) + '‚Ä¶'
                    : content;

                // Build entry HTML (once)
                entryDiv.innerHTML = `
                    <div class="entry-date">${date} at ${time}</div>
                    <div class="entry-content"><strong>${entry.type}</strong><br>${previewText}</div>
                    <button class="delete-entry">Delete</button>
                `;

                // Expand/collapse for journal and CBT entries
                if (entry.type === 'Journal' || entry.type === 'CBT') {
                    const contentDiv = entryDiv.querySelector('.entry-content');
                    entryDiv.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-entry')) return;
                        
                        const isExpanded = entryDiv.classList.toggle('expanded');
                        contentDiv.innerHTML = `<strong>${entry.type}</strong><br>` + (isExpanded ? content : previewText);
                    });
                }

                // Delete button
                entryDiv.querySelector('.delete-entry').addEventListener('click', () => {
                    if (!confirm('Delete this entry?')) return;

                    if (entry.type === 'Journal') {
                        appState.journal = appState.journal.filter(j => j.timestamp !== entry.timestamp);
                        saveToLocalStorage('hush_journal', appState.journal);
                    } else {
                        appState.entries = appState.entries.filter(e => e.timestamp !== entry.timestamp);
                        saveToLocalStorage('hush_entries', appState.entries);
                    }

                    loadEntries();
                });

                entriesList.appendChild(entryDiv);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const entryFilter = document.getElementById('entryFilter');
            if (entryFilter) {
                entryFilter.addEventListener('change', () => {
                    loadEntries();
                });
            }

            // Initial load
            loadEntries();
        });

        function loadHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';
        
        if (appState.chatHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #a0aec0;">No conversation history yet. Chat with Jerry to see your conversations here!</p>';
                return;
        }
        
        // Group conversations by session (this is a simplified approach)
        const sessions = [];
        let currentSession = [];
        
        appState.chatHistory.forEach(message => {
                currentSession.push(message);
        });
        
        if (currentSession.length > 0) {
                sessions.push({
                timestamp: new Date().toISOString(),
                conversation: currentSession
                });
        }
        
        sessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'entry-item';
                
                const date = new Date(session.timestamp).toLocaleDateString();
                const time = new Date(session.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const messageCount = session.conversation.length;
                
                sessionDiv.innerHTML = `
                <div class="entry-date">${date} at ${time}</div>
                <div class="entry-content">Conversation with ${messageCount} messages</div>
                `;
                
                historyList.appendChild(sessionDiv);
        });
        }

        // =======================
        // Subscription Verification
        // =======================
        function verifySubscriptionOnLoad() {
        const subscriptionId = localStorage.getItem('jerry_subscription_id');
        const isActive = localStorage.getItem('jerry_subscription_active') === 'true';

        subscriptionState.isSubscribed = isActive;
        subscriptionState.subscriptionId = subscriptionId;
        subscriptionState.messageCount = parseInt(localStorage.getItem('jerry_message_count') || '0', 10);
        subscriptionState.billingCycle = localStorage.getItem('jerry_billing_cycle') || null;

        // Update UI
        updateSubscriptionDisplay();
        updateUsageDisplay();
        updateChatInterface();
        }

        // =======================
        // Settings Loader/Saver
        // =======================
        function loadSettings() {
            // Basic settings
            document.getElementById('apiKey').value = appState.apiKey || '';
            document.getElementById('botName').value = appState.botName || 'Jerry';

            // Theme
            const storedTheme = localStorage.getItem('spriteTheme') || 'default';
            appState.spriteTheme = storedTheme;
            document.getElementById('spriteTheme').value = appState.spriteTheme;

            // API option
            const apiOption = localStorage.getItem('jerry_api_option') || 'own';
            document.querySelector(`input[name="apiOption"][value="${apiOption}"]`).checked = true;

            const spriteStyleSelect = document.getElementById('spriteStyle');
            if (spriteStyleSelect) {
                spriteStyleSelect.value = appState.jerry.currentSprite || 'default';
            }
   

        // Wire up event handlers
        setupApiOptionHandlers();
        }

        function saveSettings() {
        const apiKey = document.getElementById('apiKey').value.trim();
        appState.apiKey = apiKey;
        localStorage.setItem('hush_api_key', apiKey);

        const botName = document.getElementById('botName').value.trim() || 'Jerry';
        appState.botName = botName;
        localStorage.setItem('botName', botName);

        const selectedApiOption = document.querySelector('input[name="apiOption"]:checked')?.value || 'own';
        localStorage.setItem('jerry_api_option', selectedApiOption);

        appState.spriteTheme = document.getElementById('spriteTheme').value;
        localStorage.setItem('spriteTheme', appState.spriteTheme);

        showNotification('Settings saved successfully!');
        updateChatInterface();
        updateJerrySprite();
        }

        function updateThemeColor() {
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            if (!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = "theme-color";
                document.head.appendChild(metaTheme);
            }

            if (document.body.classList.contains('light-theme')) {
                metaTheme.setAttribute('content', '#A0522D'); // brown for light mode
            } else {
                metaTheme.setAttribute('content', '#3355d4'); // dark mode color
            }
        }

        function toggleTheme() {
        document.body.classList.toggle('light-theme');

        const isLightMode = document.body.classList.contains('light-theme');
        localStorage.setItem('hush_theme', isLightMode ? 'light' : 'dark');

        showNotification('Theme updated!');

        updateJerrySprite();

        updateThemeColor();
        }

        function resetMonthlyUsageIfNeeded() {
        if (subscriptionState.billingCycle) {
                const now = new Date();
                const billingDate = new Date(subscriptionState.billingCycle);

                if (now >= billingDate) {
                subscriptionState.messageCount = 0;
                subscriptionState.billingCycle = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString();

                localStorage.setItem('jerry_message_count', '0');
                localStorage.setItem('jerry_billing_cycle', subscriptionState.billingCycle);

                updateUsageDisplay();
                updateSubscriptionDisplay();
                updateChatInterface();
                }
        }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let isPlaying = false;
            let startTime = 0;
            const loopLength = 20; // seconds
            let loopInterval = null;
            let activeSources = [];

            // Master gain for volume control
            const masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);

            // Create a subtle reverb effect
            const reverb = audioCtx.createDelay();
            reverb.delayTime.value = 0.2; // 150ms delay
            const reverbGain = audioCtx.createGain();
            reverbGain.gain.value = 0.2; // low volume for subtlety
            reverb.connect(reverbGain).connect(masterGain);

            // Load saved volume
            const savedVolume = localStorage.getItem("ambientMusicVolume");
            masterGain.gain.value = savedVolume !== null ? parseFloat(savedVolume) : 0.5;

            // Volume slider
            const volumeSlider = document.getElementById("ambientMusicVolume");
            volumeSlider.value = masterGain.gain.value;
            volumeSlider.addEventListener("input", (e) => {
                masterGain.gain.value = parseFloat(e.target.value);
                localStorage.setItem("ambientMusicVolume", e.target.value);
            });

            // Stop all currently playing sources
            function stopAllSources() {
                activeSources.forEach(src => { try { src.stop(); } catch(e) {} });
                activeSources = [];
            }

            // === Tri-Tone Chirp ===
            function playTriToneChirp(time, baseFreq = 963) {
                const randomBase = 940 + Math.random() * 50;
                
                const triToneFreq = randomBase * Math.pow(2, 6/12); // 6 semitones up

                [randomBase, triToneFreq].forEach(freq => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    const filter = audioCtx.createBiquadFilter();

                    filter.type = "lowpass";
                    filter.frequency.setValueAtTime(2000, time);

                    osc.type = "sine";
                    osc.frequency.setValueAtTime(freq, time);
                    osc.detune.setValueAtTime((Math.random() - 0.5) * 15, time);

                    // Quick ethereal chirp envelope
                    gain.gain.setValueAtTime(0, time);
                    gain.gain.linearRampToValueAtTime(0.3, time + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);

                    osc.connect(filter).connect(gain).connect(masterGain);
                    osc.connect(filter).connect(gain).connect(reverb);
                    osc.start(time);
                    osc.stop(time + 1.5);
                    activeSources.push(osc);
                });
            }

            function startChirpLoop(duration = 5, minInterval = 1, maxInterval = 3) {
                if (isPlaying) return;
                isPlaying = true;
 
                function scheduleNextChirp() {
                    if (!isPlaying) return;

                    const startTime = audioCtx.currentTime + 0.1;
                    playTriToneChirp(startTime);

                    // Random interval between minInterval and maxInterval
                    const nextInterval = Math.random() * (maxInterval - minInterval) + minInterval;
                    loopInterval = setTimeout(scheduleNextChirp, nextInterval * 1000);
                }

                scheduleNextChirp();

                // Stop after duration
                setTimeout(() => {
                    clearTimeout(loopInterval);
                    stopAllSources();
                    isPlaying = false;
                }, duration * 1000);
            }

            // === Trigger: sprite click ===
            const sprite = document.getElementById("jerrySprite"); // your sprite element
            sprite.addEventListener("click", async () => {
                await audioCtx.resume();
                startChirpLoop(1.5, 0.2, 0.5); // start a fresh 10-second loop
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const jerryContainer = document.getElementById('jerryWrapper');
            const bgOptions = document.querySelectorAll('.background-option');

            // Map keys to CSS classes
            const BACKGROUNDS = {
                default: 'bg-default',
                neonLights: 'bg-neonLights',
                noir: 'bg-noir',
                petal: 'bg-petal',
                eclipse: 'bg-eclipse',
                aurora: 'bg-aurora',
                ember: 'bg-ember',
                woods: 'bg-woods',
                galactic: 'bg-galactic',
                spooky: 'bg-spooky',
                dreamland: 'bg-dreamland',
                beach: 'bg-beach',
                arcane: 'bg-arcane',
                matrix: 'bg-matrix',
                flare: 'bg-flare'
            };

            // Apply a background class
            function applyBackground(bgKey) {
                // Remove all existing background classes
                jerryContainer.classList.remove(...Object.values(BACKGROUNDS));
                // Add the new class
                jerryContainer.classList.add(BACKGROUNDS[bgKey]);
            }

            // Highlight selected swatch
            function markSelected(bgKey) {
                bgOptions.forEach(option => {
                    option.classList.toggle('selected', option.dataset.bg === bgKey);
                });
            }

            // Load saved background on page load
            let savedBg = localStorage.getItem('jerryBackground');
            if (!BACKGROUNDS[savedBg]) {
                savedBg = 'default';
                localStorage.setItem('jerryBackground', savedBg);
            }
            applyBackground(savedBg);
            markSelected(savedBg);

            // Click listeners for swatches
            bgOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const selected = option.dataset.bg;
                    applyBackground(selected);
                    markSelected(selected);
                    localStorage.setItem('jerryBackground', selected);
                });
            });
        });

        async function fadeSplash() {
            const splash = document.getElementById('splashScreen');
            const splashImg = document.getElementById('splashImage');
            if (!splash) return;

            // Make splash visible immediately
            splash.style.opacity = '1';
            splash.style.pointerEvents = 'auto';
            splash.style.transition = 'opacity 0.5s ease';
            splash.style.background = document.body.classList.contains('light-theme') ? '#f7ede5' : '#1a202c';

            // Wait for splash image to load or fail
            if (splashImg && !splashImg.complete) {
                await new Promise(resolve => {
                    splashImg.addEventListener('load', resolve, { once: true });
                    splashImg.addEventListener('error', resolve, { once: true });
                });
            }

            // Keep splash on screen for 3 seconds
            await new Promise(resolve => setTimeout(resolve, 3000));

            // Fade out
            splash.style.opacity = '0';
            splash.style.pointerEvents = 'none';

            // Wait for CSS transition to finish
            await new Promise(resolve => setTimeout(resolve, 500));

            // Remove splash from DOM to prevent blocking
            splash.remove();
        }

        // =======================
        // Async App Initialization
        // =======================
        async function initializeApp() {
            const splash = document.getElementById('splashScreen');
            const splashImg = document.getElementById('splashImage');

            // --- Helper: wait for milliseconds ---
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- Load theme ---
            const savedTheme = localStorage.getItem('hush_theme');
            if (savedTheme === 'light') document.body.classList.add('light-theme');

            // --- Load Jerry state ---
            if (typeof loadJerryStateAsync === 'function') {
                await loadJerryStateAsync();
            } else {
                loadJerryState();
            } // use async version if available
            // === Initialize base sprite after Jerry state is ready ===
            baseSprite = JSON.parse(JSON.stringify(jerrySprites[appState.jerry?.currentSprite || 'default']));

            // Ensure lastFed exists
            ['clarity', 'insight', 'calm'].forEach(need => {
                if (!appState.jerry.lastFed[need]) {
                    appState.jerry.lastFed[need] = Date.now() - (10 * 60 * 1000 + 1000);
                }
            });

            if (typeof loadSettingsAsync === 'function') {
                await loadSettingsAsync();
            } else {
                loadSettings();
            }

            // --- Load bot name ---
            appState.botName = localStorage.getItem('botName') || 'Jerry';
            const nameInput = document.getElementById('botName');
            if (nameInput) {
                nameInput.value = appState.botName;
                nameInput.addEventListener('input', (e) => {
                    const val = e.target.value.trim();
                    appState.botName = val || 'Jerry';
                    localStorage.setItem('botName', appState.botName);
                });
            }

            // --- Initialize UI ---
            // --- Initialize base sprite and render both main + preview ---
            updateJerrySprite();
            updateJerryUI();
            initializeJerryDecay();
            initializePetSystem();
            scheduleBlink();
            updateAffirmationBanner('jerry');
            updateThemeColor();

            initializePetSystem();

            // --- Load journal ---
            appState.journal = getFromLocalStorage('hush_journal') || [];
            renderJournalEntries();
            loadEntries();

            // --- Verify subscription ---
            verifySubscriptionOnLoad();

            // --- Intervals ---
            setInterval(updateJerrySprite, 3000);
            setInterval(() => {
                if (appState.currentTab === 'jerry' || appState.currentTab === 'checkin') {
                    updateAffirmationBanner(appState.currentTab);
                }
            }, 10000);
            setInterval(resetMonthlyUsageIfNeeded, 24 * 60 * 60 * 1000);

            // --- Update usage and chat ---
            updateUsageDisplay();
            updateChatInterface();

            // --- Service Worker registration ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    const swCode = `
                        const CACHE_NAME = 'jerry-pwa-v29';
                        const urlsToCache = ['/', '/index.html', '/manifest.json', '/JerryIcon.png'];
                        self.addEventListener('install', (event) => {
                            event.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(urlsToCache)));
                        });
                        self.addEventListener('fetch', (event) => {
                            event.respondWith(caches.match(event.request).then((response) => response || fetch(event.request)));
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then(() => console.log('ServiceWorker registration successful'))
                        .catch(() => console.log('ServiceWorker registration failed'));
                });
            }
        }
        
        // Initialize splash and app when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            await fadeSplash();  // show splash first
            await initializeApp();  // then initialize the app
        });

    </script>
</body>
</html>
